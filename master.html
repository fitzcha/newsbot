<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Sovereign HQ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root{--admin:#ff4d4f;--primary:#007bff;--success:#28a745;--dev:#6f42c1;--dark:#1a1a2e;--warn:#fd7e14;--bg:#f8f9fa}
*{box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;margin:0;background:var(--bg);color:#222}
.wrap{max-width:1050px;margin:0 auto;padding:20px}

.sec-bar{background:#111;color:#eee;padding:12px 20px;border-radius:14px;margin-bottom:18px;display:flex;gap:12px;align-items:center;font-size:.85rem;flex-wrap:wrap}
.sec-bar input{flex:1;min-width:220px;padding:6px 12px;background:rgba(255,255,255,.1);border:1px solid #444;color:#fff;border-radius:8px;font-size:.85rem}
.sec-bar button{padding:6px 14px;background:#ff4d4f;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:.82rem}
.auto-badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700}

.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.hdr h1{margin:0;font-size:1.8rem;letter-spacing:-2px;cursor:pointer}
.hdr small{color:var(--admin);font-weight:700;display:block;font-size:.8rem}
.hdr-btns{display:flex;gap:8px}

.tabs{display:flex;gap:4px;border-bottom:2px solid #e9ecef;margin-bottom:22px;overflow-x:auto}
.tab{padding:12px 18px;cursor:pointer;font-weight:800;color:#999;border-bottom:4px solid transparent;margin-bottom:-2px;transition:.2s;white-space:nowrap;font-size:.9rem}
.tab.on{color:var(--admin);border-bottom-color:var(--admin)}
.badge{background:var(--admin);color:#fff;border-radius:20px;padding:1px 7px;font-size:.72rem;margin-left:5px;font-weight:700}

.card{background:#fff;border:1px solid #eee;padding:18px;border-radius:16px;margin-bottom:14px;border-left:6px solid var(--admin);box-shadow:0 2px 8px rgba(0,0,0,.04)}
.box{background:#f8f9fa;padding:13px;border-radius:10px;font-size:.88rem;border:1px solid #efefef;margin:8px 0;white-space:pre-wrap;line-height:1.6}
.btn{padding:9px 18px;border-radius:10px;border:1px solid #ddd;cursor:pointer;font-weight:700;transition:.2s;background:#fff;font-size:.88rem}
.btn:hover{opacity:.85}
.sm{padding:7px 13px;font-size:.82rem;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:700}
textarea,select{width:100%;padding:13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem;resize:vertical}
.row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
.row>*{flex:1;min-width:150px}
h3{margin:0 0 14px;font-size:1rem;color:#444}
.empty{color:#aaa;font-style:italic;padding:20px;text-align:center}

.s-tag{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:700;margin-left:6px}
.s-PENDING{background:#fff3cd;color:#856404}
.s-CONFIRMED{background:#cce5ff;color:#004085}
.s-DEVELOPING{background:#d4edda;color:#155724}
.s-DEPLOYED{background:#d1ecf1;color:#0c5460}
.s-APPROVED{background:#d4edda;color:#155724}
.s-REJECTED{background:#f8d7da;color:#721c24}

#forum-box{background:#0d1117;color:#50fa7b;padding:18px;border-radius:14px;font-family:'Courier New',monospace;height:320px;overflow-y:auto;font-size:.82rem;line-height:1.7}
#forum-box .err{color:#ff5555}
#forum-box .warn{color:#ffb86c}
#forum-box .info{color:#8be9fd}

.countdown{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#eee;padding:14px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:14px;font-size:.88rem}
.countdown .timer{font-size:1.4rem;font-weight:900;color:#50fa7b;letter-spacing:1px;min-width:80px}
.countdown .timer.warn{color:#ffb86c}
.countdown .timer.danger{color:#ff5555}

.evo-card{background:#fff;border:1px solid #e0e0e0;border-left:6px solid var(--warn);padding:18px;border-radius:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.evo-card .meta{font-size:.78rem;color:#999;margin-bottom:6px}
.evo-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

/* â˜… ë²„ê·¸ ìˆ˜ì •: infe â†’ infinite */
.pulse{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

#hr-content{background:var(--dark);color:#dde;padding:32px;border-radius:18px;min-height:260px;margin-top:14px;line-height:1.8;font-size:.92rem}
#hr-content h1,#hr-content h2,#hr-content h3{color:#7eb8ff}
#hr-content a{color:#50fa7b}

#toast{position:fixed;bottom:30px;right:30px;background:#222;color:#fff;padding:12px 22px;border-radius:12px;font-size:.88rem;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}
#toast.show{opacity:1}

.cost-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.cost-card{background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.cost-label{font-size:.72rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.cost-value{font-size:2rem;font-weight:900;color:#111;line-height:1.1}
.cost-unit{font-size:.78rem;color:#6b7280;margin-top:4px}

.directive-section{background:#fff;border:1px solid #eee;border-left:6px solid #333;padding:18px;border-radius:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.directive-section h3{margin:0 0 14px;color:#222}
.mode-tabs{display:flex;gap:6px;margin-bottom:14px}
.mode-tab{padding:7px 16px;border-radius:20px;border:1.5px solid #ddd;background:#fff;font-size:.82rem;font-weight:700;cursor:pointer;transition:.15s;color:#666}
.mode-tab.on{background:#111;color:#fff;border-color:#111}
.char-count{font-size:.75rem;color:#aaa;text-align:right;margin-top:-8px;margin-bottom:8px}
.char-count.warn{color:#f59e0b;font-weight:700}
.char-count.over{color:#ef4444;font-weight:700}
.one-rule-warn{background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.82rem;color:#c2410c;margin-bottom:10px;display:none}
.one-rule-warn.show{display:block}

.feedback-thumb{display:flex;gap:10px;margin-bottom:12px}
.thumb-btn{flex:1;padding:14px;border-radius:12px;border:2px solid #e5e7eb;background:#fff;font-size:1.5rem;cursor:pointer;transition:.15s;text-align:center}
.thumb-btn:hover{border-color:#6366f1;background:#f5f3ff}
.thumb-btn.selected-up{border-color:#10b981;background:#ecfdf5}
.thumb-btn.selected-down{border-color:#ef4444;background:#fef2f2}
.feedback-optional{font-size:.78rem;color:#9ca3af;margin-bottom:6px}
</style>
</head>
<body>
<div class="wrap">

  <div class="sec-bar">
    <span>ğŸ”’ <b>Auth Center</b></span>
    <input type="password" id="ghp-token" placeholder="ghp_... GitHub Personal Access Token">
    <button onclick="saveToken()">ì €ì¥</button>
    <span id="token-status" style="color:#aaa">í† í° ë¯¸ì…ë ¥</span>
    <span class="auto-badge" id="auto-badge" style="display:none">â± ìë™ìŠ¹ì¸ ON</span>
  </div>

  <div class="hdr">
    <div>
      <h1 onclick="location.href='index.html'">Sovereign HQ</h1>
      <small>v19.0 Â· <span id="now-time"></span></small>
    </div>
    <div class="hdr-btns">
      <button class="btn" onclick="location.href='index.html'">ğŸŒ í™ˆ</button>
      <button class="btn" onclick="location.href='app.html'">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn" onclick="refreshAll()" style="background:#111;color:#fff;border:none">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="tabs">
    <div id="t-hr"   class="tab on" onclick="tab('hr')">ğŸ•µï¸ ì „ëµ</div>
    <div id="t-evo"  class="tab"    onclick="tab('evo')">ğŸ§  ì§€ëŠ¥ <span class="badge" id="evo-cnt" style="display:none">0</span></div>
    <div id="t-dev"  class="tab"    onclick="tab('dev')">ğŸ› ï¸ ê°œë°œ <span class="badge" id="dev-cnt" style="display:none">0</span></div>
    <div id="t-log"  class="tab"    onclick="tab('log')">ğŸ“‹ í¬ëŸ¼</div>
    <div id="t-voc"  class="tab"    onclick="tab('voc')">ğŸ’¬ VOC</div>
    <div id="t-cost" class="tab"    onclick="tab('cost')">ğŸ’° ë¹„ìš©</div>
  </div>

  <!-- ì „ëµ íƒ­ -->
  <div id="v-hr">
    <div class="row" style="align-items:center;margin-bottom:14px">
      <h3 style="margin:0">ğŸ“… ë§ˆìŠ¤í„° ë¦¬í¬íŠ¸</h3>
      <select id="hr-date" onchange="loadHrReport()" style="margin:0;max-width:200px"></select>
    </div>
    <div id="hr-content">ë¡œë“œ ì¤‘...</div>
  </div>

  <!-- ì§€ëŠ¥ íƒ­ -->
  <div id="v-evo" style="display:none">
    <div class="countdown" id="countdown-bar">
      <div>
        <div style="font-weight:700;margin-bottom:2px">â³ 23:30 ìë™ìŠ¹ì¸ê¹Œì§€</div>
        <div style="font-size:.78rem;color:#aaa">ë¯¸ê²° ì•ˆê±´ì€ ìë™ìœ¼ë¡œ APPROVED ì²˜ë¦¬ë©ë‹ˆë‹¤</div>
      </div>
      <div class="timer" id="countdown-timer">--:--:--</div>
    </div>

    <div class="directive-section">
      <h3>âœï¸ ì§€ëŠ¥ í•˜ë‹¬</h3>
      <div class="mode-tabs">
        <button class="mode-tab on" id="mode-single" onclick="setDirectiveMode('single')">ğŸ¯ ê°œë³„ ì—ì´ì „íŠ¸</button>
        <button class="mode-tab" id="mode-all" onclick="setDirectiveMode('all')">ğŸ“¢ ì „ì²´ ì—ì´ì „íŠ¸ ë™ì‹œ í•˜ë‹¬</button>
      </div>
      <div id="directive-single">
        <select id="m-role" style="margin:0 0 10px">
          <option value="">â³ ì—ì´ì „íŠ¸ ë¡œë”© ì¤‘...</option>
        </select>
      </div>
      <div id="directive-all" style="display:none;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.84rem;color:#92400e;margin-bottom:10px;">
        ğŸ“¢ ì•„ë˜ ì§€ì¹¨ì´ <b>í˜„ì¬ ë“±ë¡ëœ ëª¨ë“  ì—ì´ì „íŠ¸</b>ì—ê²Œ ë™ì‹œ ì ìš©ë©ë‹ˆë‹¤.
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="append" checked> â• ê¸°ì¡´ ì§€ì¹¨ì— ì¶”ê°€
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="replace"> ğŸ”„ ê¸°ì¡´ ì§€ì¹¨ ëŒ€ì²´
        </label>
      </div>
      <div class="one-rule-warn" id="one-rule-warn">
        âš ï¸ ì§€ì¹¨ì€ <b>1ê°œ ì•ˆê±´ë§Œ</b> ì…ë ¥í•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ ë‚´ìš©ì„ ë™ì‹œì— ì…ë ¥í•˜ë©´ ë°˜ì˜ íš¨ê³¼ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.<br>
        ì˜ˆì‹œ âœ…: "ê²°ë¡ ì„ í•­ìƒ ì²« ë¬¸ì¥ì— ë°°ì¹˜í•  ê²ƒ"<br>
        ì˜ˆì‹œ âŒ: "ê²°ë¡ ì„ ì²« ë¬¸ì¥ì— ì“°ê³ , ë°ì´í„°ë¥¼ ì¸ìš©í•˜ë©°, 300ì ì´ë‚´ë¡œ ìš”ì•½í•˜ê³ , í•œêµ­ ì‹œì¥ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„í•  ê²ƒ"
      </div>
      <textarea id="m-text" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ì§ì ‘ ì§€ì¹¨ì„ í•˜ë‹¬í•˜ì„¸ìš”. 1ê°œ ì•ˆê±´ë§Œ ì…ë ¥í•˜ì„¸ìš”." oninput="onDirectiveInput(this)"></textarea>
      <div class="char-count" id="char-count">0ì</div>
      <button class="btn" style="background:#111;color:#fff;border:none;width:100%" onclick="sendDirectOrder()">âš¡ ì¦‰ì‹œ í•˜ë‹¬ (ë°”ë¡œ ì ìš©)</button>
    </div>

    <div id="pending-evo-list"></div>
    <div id="live-agent-list"></div>
  </div>

  <!-- ê°œë°œ íƒ­ -->
  <div id="v-dev" style="display:none">
    <div class="card" style="border-left-color:var(--dev);background:#f5f0ff">
      <h3>ğŸ› ï¸ ìƒˆ ê°œë°œ ì•ˆê±´ ë“±ë¡</h3>
      <input id="d-title" placeholder="ì•ˆê±´ ì œëª©" style="width:100%;padding:11px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-size:.9rem">
      <textarea id="d-task" rows="4" placeholder="ìš”êµ¬ì‚¬í•­ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”."></textarea>
      <button class="btn" style="background:var(--dev);color:#fff;border:none;width:100%" onclick="addDev()">ğŸ“‹ ë°±ë¡œê·¸ ë“±ë¡</button>
    </div>
    <div id="dev-list"></div>
  </div>

  <!-- í¬ëŸ¼ íƒ­ -->
  <div id="v-log" style="display:none">
    <div id="forum-box"><span style="color:#8be9fd"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸</span><br>ë¡œë”© ì¤‘...</div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" style="flex:1;background:var(--admin);color:#fff;border:none;padding:15px" onclick="triggerRun()">ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™</button>
      <button class="btn" style="background:#333;color:#fff;border:none;padding:15px" onclick="loadLogs()">ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- VOC íƒ­ -->
  <div id="v-voc" style="display:none">
    <div id="voc-list"></div>
  </div>

  <!-- ë¹„ìš© íƒ­ -->
  <div id="v-cost" style="display:none">
    <!-- íšŒì› í˜„í™© ì¹´ë“œ -->
    <div class="card" style="border-left-color:#6366f1;margin-bottom:14px;">
      <h3 style="margin-bottom:16px;">ğŸ‘¥ íšŒì› í˜„í™© ë° ê°€ì… ì œí•œ ì„¤ì •</h3>
      <div style="display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;">
        <div class="cost-card" style="border-top:3px solid #6366f1;flex:1;min-width:120px;">
          <div class="cost-label">í˜„ì¬ íšŒì› ìˆ˜</div>
          <div class="cost-value" id="m-current-count" style="color:#4f46e5;">â€”</div>
          <div class="cost-unit">ëª…</div>
        </div>
        <div class="cost-card" style="border-top:3px solid #10b981;flex:1;min-width:120px;">
          <div class="cost-label">ìµœëŒ€ í—ˆìš© íšŒì›</div>
          <div class="cost-value" id="m-max-count" style="color:#059669;">â€”</div>
          <div class="cost-unit">ëª…</div>
        </div>
        <div class="cost-card" style="border-top:3px solid #f59e0b;flex:1;min-width:120px;">
          <div class="cost-label">ëŒ€ê¸° ì‹ ì²­ì</div>
          <div class="cost-value" id="m-waitlist-count" style="color:#d97706;">â€”</div>
          <div class="cost-unit">ëª…</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
        <label style="font-size:.84rem;font-weight:700;color:#555;white-space:nowrap;">ìµœëŒ€ íšŒì› ìˆ˜ ë³€ê²½:</label>
        <input id="m-max-input" type="number" min="1" max="9999"
               style="width:90px;padding:8px 12px;border:1.5px solid #ddd;border-radius:8px;font-size:.9rem;font-family:inherit;"
               placeholder="ì˜ˆ: 100">
        <button class="sm" style="background:#6366f1;" onclick="saveMaxMembers()">ì €ì¥</button>
      </div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;">
        <div style="flex:1;">
          <div style="font-size:.88rem;font-weight:700;color:#222;margin-bottom:3px;">íšŒì›ê°€ì… ìƒíƒœ</div>
          <div style="font-size:.78rem;color:#6b7280;" id="signup-status-desc">í˜„ì¬ ìƒíƒœ í™•ì¸ ì¤‘...</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="sm" id="btn-signup-open"  style="background:#10b981;" onclick="setSignupStatus(true)">âœ… í—ˆìš©</button>
          <button class="sm" id="btn-signup-close" style="background:#ef4444;" onclick="setSignupStatus(false)">ğŸ”’ ì œí•œ</button>
        </div>
      </div>
      <div style="margin-top:14px;padding:14px;background:#fffbeb;border:1px solid #fde68a;border-radius:12px;">
        <div style="font-size:.84rem;font-weight:700;color:#92400e;margin-bottom:8px;">ğŸ“¬ ëŒ€ê¸°ì ì¼ê´„ ì´ë©”ì¼ ë°œì†¡</div>
        <div style="font-size:.78rem;color:#78350f;margin-bottom:10px;">ê°€ì…ì´ ì—´ë¦¬ë©´ ëŒ€ê¸° ì‹ ì²­ìì—ê²Œ ì•Œë¦¼ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤. (ë¯¸ë°œì†¡ ëŒ€ê¸°ì: <span id="m-unsent-count">â€”</span>ëª…)</div>
        <button class="sm" style="background:#f59e0b;" onclick="notifyWaitlist()">ğŸ“¨ ëŒ€ê¸°ì ì•Œë¦¼ ë°œì†¡</button>
        <span id="notify-result" style="font-size:.78rem;margin-left:10px;color:#059669;display:none;"></span>
      </div>
    </div>

    <div class="cost-grid">
      <div class="cost-card" style="border-top:3px solid #f59e0b">
        <div class="cost-label">ì˜¤ëŠ˜ Gemini í˜¸ì¶œ</div>
        <div class="cost-value" id="c-calls">â€”</div>
        <div class="cost-unit">íšŒ</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #10b981">
        <div class="cost-label">ì˜¤ëŠ˜ ì¶”ì • ë¹„ìš©</div>
        <div class="cost-value" id="c-cost" style="color:#059669">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #6366f1">
        <div class="cost-label">Supabase ì´ rows</div>
        <div class="cost-value" id="c-rows">â€”</div>
        <div class="cost-unit">/ 500,000 ë¬´ë£Œ í•œë„</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #ec4899">
        <div class="cost-label">7ì¼ ëˆ„ì  ë¹„ìš©</div>
        <div class="cost-value" id="c-week">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
    </div>
    <div class="card" style="border-left-color:#f59e0b">
      <h3>ğŸ“ˆ 7ì¼ Gemini í˜¸ì¶œ ì¶”ì´</h3>
      <canvas id="cost-chart" height="180"></canvas>
    </div>
    <div class="card" style="border-left-color:#6366f1">
      <h3>ğŸ—„ï¸ Supabase í…Œì´ë¸”ë³„ row ìˆ˜</h3>
      <div id="c-row-detail">ë¡œë“œ ì¤‘...</div>
    </div>
    <div class="card" style="border-left-color:#e5e7eb">
      <h3>ğŸ“‹ ì˜¤ëŠ˜ í˜¸ì¶œ ìœ í˜•ë³„ ë‚´ì—­</h3>
      <div id="c-breakdown">ë¡œë“œ ì¤‘...</div>
    </div>
  </div>

</div><!-- /.wrap -->

<div id="toast"></div>

<script>
const CFG = {
  url:      'https://zrlpwmpbrvohautldcon.supabase.co',
  key:      'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G',
  master:   'positivecha@gmail.com',
  owner:    'fitzcha',
  repo:     'newsbot',
  workflow: 'daily_run.yml'
};
const sc = supabase.createClient(CFG.url, CFG.key);
let me = null, autoTimer = null, costChartInstance = null;
let directiveMode = 'single';

/* â”€â”€ ìœ í‹¸ â”€â”€ */
function toast(msg, dur=2800) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}
function $id(id) { return document.getElementById(id); }
function render(id, html) { const el=$id(id); if(el) el.innerHTML=html; }

/* â˜… ë²„ê·¸ ìˆ˜ì •: escHtmlì„ <script> ì•ˆìœ¼ë¡œ ì´ë™ */
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ í† í° â”€â”€ */
function saveToken() {
  const v = $id('ghp-token').value.trim();
  if(!v) return toast('âŒ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('ghp_token', v);
  updateTokenStatus(v);
  toast('âœ… í† í° ì €ì¥ ì™„ë£Œ');
}
function getToken() { return localStorage.getItem('ghp_token') || ''; }
function updateTokenStatus(t) {
  $id('token-status').textContent = t ? 'âœ… í† í° í™œì„±í™”' : 'âš ï¸ í† í° ë¯¸ì…ë ¥';
  $id('token-status').style.color = t ? '#50fa7b' : '#ffb86c';
}

/* â”€â”€ íƒ­ â”€â”€ */
function tab(t) {
  ['hr','evo','dev','log','voc','cost'].forEach(x => {
    $id('v-'+x).style.display = x===t ? 'block' : 'none';
    $id('t-'+x).classList.toggle('on', x===t);
  });
  if(t === 'cost') loadCost();
}

/* â”€â”€ ì‹œê³„ â”€â”€ */
function startClock() {
  const tick = () => {
    const now = new Date();
    const kst = new Date(now.getTime() + (9*60 - now.getTimezoneOffset())*60000);
    $id('now-time').textContent = kst.toLocaleTimeString('ko-KR');
  };
  tick(); setInterval(tick, 1000);
}

/* â”€â”€ 23:30 ìë™ìŠ¹ì¸ ì¹´ìš´íŠ¸ë‹¤ìš´ â”€â”€ */
function startAutoApprovalTimer() {
  $id('auto-badge').style.display = '';
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(async () => {
    const now = new Date();
    const kst = new Date(now.getTime() + (9*60 - now.getTimezoneOffset())*60000);
    const h = kst.getHours(), m = kst.getMinutes(), s = kst.getSeconds();
    if(h === 23 && m === 30 && s < 5) { await runAutoApproval(); return; }
    let nowSecs = h*3600 + m*60 + s;
    let tgtSecs = 23*3600 + 30*60;
    if(nowSecs >= tgtSecs) tgtSecs += 86400;
    let diff = tgtSecs - nowSecs;
    let rh = Math.floor(diff/3600), rm = Math.floor((diff%3600)/60), rs = diff%60;
    const el = $id('countdown-timer');
    el.textContent = `${String(rh).padStart(2,'0')}:${String(rm).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
    el.className = 'timer' + (rh < 1 ? (rm < 30 ? ' danger' : ' warn') : '');
  }, 1000);
}

async function runAutoApproval() {
  try {
    const { data: pending } = await sc.from('pending_approvals').select('*').eq('status','PENDING');
    if(!pending?.length) return;
    for(const p of pending) {
      await sc.from('agents').update({ instruction: p.proposed_instruction }).eq('agent_role', p.agent_role);
      await sc.from('pending_approvals').update({ status:'APPROVED' }).eq('id', p.id);
    }
    toast(`â° 23:30 ìë™ìŠ¹ì¸ ì™„ë£Œ â€” ${pending.length}ê±´ ì ìš©ë¨`);
    loadEvo();
  } catch(e) { console.error('ìë™ìŠ¹ì¸ ì˜¤ë¥˜:', e); }
}

/* â”€â”€ ì§€ëŠ¥ í•˜ë‹¬ â”€â”€ */
function setDirectiveMode(mode) {
  directiveMode = mode;
  $id('mode-single').classList.toggle('on', mode==='single');
  $id('mode-all').classList.toggle('on', mode==='all');
  $id('directive-single').style.display = mode==='single' ? 'block' : 'none';
  $id('directive-all').style.display = mode==='all' ? 'block' : 'none';
}

function onDirectiveInput(el) {
  const len = el.value.length;
  const ccEl = $id('char-count');
  ccEl.textContent = `${len}ì`;
  ccEl.className = 'char-count' + (len > 300 ? ' over' : len > 200 ? ' warn' : '');
  const multiPattern = /(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  $id('one-rule-warn').classList.toggle('show', multiPattern.test(el.value) && el.value.length > 30);
}

async function loadAgentSelect() {
  try {
    const { data, error } = await sc.from('agents').select('agent_role').order('agent_role');
    if(error) throw error;
    const roles = (data||[]).map(a => a.agent_role);
    const icons = {BA:'ğŸ”',STOCK:'ğŸ“ˆ',PM:'ğŸ—‚',HR:'ğŸ‘¤',DEV:'ğŸ’»',QA:'âœ…',BRIEF:'ğŸ“',KW:'ğŸ”‘',DATA:'ğŸ“‰',INFO:'ğŸŒ'};
    render('m-role', roles.length === 0
      ? `<option value="BA">ğŸ” BA</option><option value="STOCK">ğŸ“ˆ STOCK</option><option value="PM">ğŸ—‚ PM</option><option value="HR">ğŸ‘¤ HR</option><option value="BRIEF">ğŸ“ BRIEF</option>`
      : roles.map(r => `<option value="${r}">${icons[r]||'ğŸ¤–'} ${r}</option>`).join('')
    );
  } catch(e) {
    render('m-role', `<option value="BA">ğŸ” BA</option><option value="STOCK">ğŸ“ˆ STOCK</option><option value="PM">ğŸ—‚ PM</option>`);
  }
}

async function sendDirectOrder() {
  const text = $id('m-text').value.trim();
  if(!text) return toast('âŒ ì§€ì¹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
  const multiPattern = /(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  if(multiPattern.test(text) && text.length > 30) {
    if(!confirm('âš ï¸ ì—¬ëŸ¬ ì•ˆê±´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  }
  const applyMode = document.querySelector('input[name="apply-mode"]:checked').value;
  try {
    if(directiveMode === 'single') {
      const role = $id('m-role').value;
      if(!role) return toast('âŒ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      await applyDirective(role, text, applyMode);
      toast(`âš¡ ${role} ì—ì´ì „íŠ¸ ì§€ì¹¨ ì¦‰ì‹œ í•˜ë‹¬ ì™„ë£Œ`);
    } else {
      const { data: agents } = await sc.from('agents').select('agent_role, instruction');
      if(!agents?.length) return toast('âŒ ë“±ë¡ëœ ì—ì´ì „íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
      if(!confirm(`ğŸ“¢ í˜„ì¬ ë“±ë¡ëœ ì—ì´ì „íŠ¸ ${agents.length}ëª… ì „ì²´ì—ê²Œ ì§€ì¹¨ì„ í•˜ë‹¬í•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      for(const a of agents) await applyDirective(a.agent_role, text, applyMode, a.instruction);
      toast(`ğŸ“¢ ì „ì²´ ${agents.length}ê°œ ì—ì´ì „íŠ¸ ì§€ì¹¨ í•˜ë‹¬ ì™„ë£Œ`);
    }
    $id('m-text').value = '';
    $id('char-count').textContent = '0ì';
    $id('one-rule-warn').classList.remove('show');
    loadEvo();
  } catch(e) { toast('âŒ í•˜ë‹¬ ì‹¤íŒ¨: ' + e.message); }
}

async function applyDirective(role, newText, mode, existingInstruction) {
  let currentInstruction = existingInstruction;
  if(currentInstruction === undefined) {
    const { data } = await sc.from('agents').select('instruction').eq('agent_role', role).single();
    currentInstruction = data?.instruction || '';
  }
  let finalInstruction;
  if(mode === 'append') {
    const sep = currentInstruction ? '\n\n---\n[ë§ˆìŠ¤í„° ì¶”ê°€ ì§€ì¹¨ ' + new Date().toLocaleDateString('ko-KR') + ']\n' : '';
    finalInstruction = currentInstruction + sep + newText;
  } else {
    finalInstruction = newText;
  }
  const { error } = await sc.from('agents').update({ instruction: finalInstruction }).eq('agent_role', role);
  if(error) throw error;
  await sc.from('pending_approvals').insert([{
    agent_role: role,
    proposed_instruction: finalInstruction,
    proposal_reason: `ë§ˆìŠ¤í„° ì§ì ‘ í•˜ë‹¬ (${mode === 'append' ? 'ì¶”ê°€' : 'ëŒ€ì²´'})`,
    status: 'APPROVED'
  }]);
}

/* â”€â”€ ì§€ëŠ¥ íƒ­ â”€â”€ */
async function loadEvo() {
  try {
    const [agRes, prRes] = await Promise.all([
      sc.from('agents').select('agent_role, instruction').order('agent_role'),
      sc.from('pending_approvals').select('id, agent_role, proposed_instruction, proposal_reason, created_at')
        .eq('status','PENDING').order('created_at', { ascending: false })
    ]);
    const agents = agRes.data || [];
    const props  = prRes.data || [];
    if(props.length > 0) { $id('evo-cnt').style.display=''; $id('evo-cnt').textContent=props.length; }
    else { $id('evo-cnt').style.display='none'; }

    let pHtml = `<h3>ğŸ“„ ê²°ì¬ ëŒ€ê¸° <span style="color:var(--admin)">(${props.length}ê±´)</span></h3>`;
    pHtml += props.length === 0
      ? `<div class="empty">âœ… í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤</div>`
      : props.map(p => {
          const created = p.created_at ? new Date(p.created_at).toLocaleString('ko-KR') : '';
          return `<div class="evo-card">
            <div class="meta">ğŸ¤– ${p.agent_role} Â· ${created} Â· ${p.proposal_reason||'ì—ì´ì „íŠ¸ ììœ¨ ì œì•ˆ'}</div>
            <strong>ì œì•ˆëœ ì§€ì¹¨</strong>
            <div class="box">${escHtml(p.proposed_instruction)}</div>
            <div class="evo-actions">
              <button class="sm" style="background:var(--success)" onclick="decideEvo('${p.id}','${p.agent_role}','APPROVED')">âœ… ìŠ¹ì¸ â€” ì¦‰ì‹œ ì ìš©</button>
              <button class="sm" style="background:var(--admin)"   onclick="decideEvo('${p.id}','${p.agent_role}','REJECTED')">âŒ ë°˜ë ¤</button>
            </div>
          </div>`;
        }).join('');
    render('pending-evo-list', pHtml);

    let aHtml = `<h3>ğŸš€ í˜„ì¬ ê°€ë™ ì¤‘ì¸ ì—ì´ì „íŠ¸ ì§€ì¹¨</h3>`;
    aHtml += agents.length === 0
      ? `<div class="empty">ì—ì´ì „íŠ¸ ì •ë³´ ì—†ìŒ</div>`
      : agents.map(a => `<div class="card" style="border-left-color:#bbb">
          <strong>ğŸ¤– ${a.agent_role}</strong>
          <div class="box">${escHtml(a.instruction||'ì§€ì¹¨ ì—†ìŒ')}</div>
        </div>`).join('');
    render('live-agent-list', aHtml);
  } catch(e) {
    render('pending-evo-list', `<div class="card" style="border-left-color:var(--admin)">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}

async function decideEvo(id, role, status) {
  try {
    if(status === 'APPROVED') {
      const { data: p } = await sc.from('pending_approvals').select('proposed_instruction').eq('id', id).single();
      if(p) {
        const { error } = await sc.from('agents').update({ instruction: p.proposed_instruction }).eq('agent_role', role);
        if(error) throw error;
      }
    }
    await sc.from('pending_approvals').update({ status }).eq('id', id);
    toast(status === 'APPROVED' ? `âœ… ${role} ì§€ì¹¨ ìŠ¹ì¸ ë° ì ìš© ì™„ë£Œ` : `âŒ ${role} ì•ˆê±´ ë°˜ë ¤ë¨`);
    loadEvo();
  } catch(e) { toast('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ ê°œë°œ íƒ­ â”€â”€ */
async function loadDev() {
  try {
    const { data, error } = await sc.from('dev_backlog').select('*').order('created_at', { ascending: false });
    if(error) throw error;
    const pending = (data||[]).filter(b => b.status === 'PENDING').length;
    if(pending > 0) { $id('dev-cnt').style.display=''; $id('dev-cnt').textContent=pending; }
    else { $id('dev-cnt').style.display='none'; }
    render('dev-list', (data||[]).length === 0
      ? `<div class="empty">ë“±ë¡ëœ ë°±ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>`
      : (data||[]).map(b => {
          const created = b.created_at ? new Date(b.created_at).toLocaleString('ko-KR') : '';
          let btns = '';
          if(b.status==='PENDING')     btns = `<button class="sm" style="background:var(--primary)" onclick="upDev('${b.id}','CONFIRMED')">âœ… ê°œë°œ í™•ì •</button>`;
          else if(b.status==='CONFIRMED')  btns = `<button class="sm" style="background:var(--dev)" onclick="triggerDev('${b.id}')">ğŸš€ ë°°í¬ ì‹œì‘</button>`;
          else if(b.status==='DEVELOPING') btns = `<span class="pulse" style="color:var(--dev);font-weight:700">â³ AI ë°°í¬ ì¤‘...</span>`;
          else btns = `<span style="color:var(--success);font-weight:700">âœ… ë°°í¬ ì™„ë£Œ</span>`;
          return `<div class="card" style="border-left-color:var(--dev)">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
              <div><strong>${escHtml(b.title||'ë¬´ì œ')}</strong><span class="s-tag s-${b.status}">${b.status}</span></div>
              <small style="color:#aaa">${created}</small>
            </div>
            <div class="box">${escHtml(b.task_detail||'')}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">${btns}</div>
          </div>`;
        }).join('')
    );
  } catch(e) {
    render('dev-list', `<div class="card" style="border-left-color:var(--admin)">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}

async function addDev() {
  const title = $id('d-title').value.trim();
  const task  = $id('d-task').value.trim();
  if(!title || !task) return toast('âŒ ì œëª©ê³¼ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
  try {
    const { error } = await sc.from('dev_backlog').insert([{ title, task_detail: task, status: 'PENDING', priority: 5 }]);
    if(error) throw error;
    $id('d-title').value = ''; $id('d-task').value = '';
    toast('ğŸ“‹ ê°œë°œ ì•ˆê±´ ë“±ë¡ ì™„ë£Œ');
    loadDev();
  } catch(e) { toast('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + e.message); }
}

async function upDev(id, status) {
  await sc.from('dev_backlog').update({ status }).eq('id', id);
  toast('âœ… ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  loadDev();
}

async function triggerDev(id) {
  const token = getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').update({ status: 'DEVELOPING' }).eq('id', id);
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: { backlog_id: String(id) } })
      }
    );
    if(res.status === 204) { toast('ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!'); }
    else {
      const e = await res.json().catch(()=>({}));
      await sc.from('dev_backlog').update({ status: 'CONFIRMED' }).eq('id', id);
      throw new Error(`GitHub API ${res.status}: ${e.message||'ì˜¤ë¥˜'}`);
    }
    loadDev();
  } catch(e) { toast('âŒ ë°°í¬ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ í¬ëŸ¼ íƒ­ â”€â”€ */
async function loadLogs() {
  try {
    const { data, error } = await sc.from('action_logs').select('*').order('executed_at', { ascending: false }).limit(30);
    if(error) throw error;
    const lines = (data||[]).map(l => {
      const t   = l.executed_at ? l.executed_at.slice(11,19) : '??:??:??';
      const msg = l.memo || l.details || (l.target_word ? l.target_word+' ë¶„ì„ ì™„ë£Œ' : 'ì‹œìŠ¤í…œ ì´ë²¤íŠ¸');
      const cls = msg.includes('âŒ')||msg.includes('ì‹¤íŒ¨') ? 'err' : msg.includes('âš ï¸') ? 'warn' : 'info';
      return `<div class="${cls}">[${t} KST] ${escHtml(String(msg))}</div>`;
    });
    render('forum-box', `<span class="info"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸ (ìµœê·¼ ${lines.length}ê±´)</span><br>` + (lines.join('')||'<span style="color:#aaa">ë¡œê·¸ ì—†ìŒ</span>'));
  } catch(e) { render('forum-box', `<span class="err">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

async function triggerRun() {
  const token = getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”');
  if(!confirm('ì „ì²´ ì‹œìŠ¤í…œì„ ì¦‰ì‹œ ê°€ë™í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: {} })
      }
    );
    if(res.status === 204) { toast('ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ!'); setTimeout(loadLogs, 3000); }
    else { const e = await res.json().catch(()=>({})); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
  } catch(e) { toast('âŒ ê°€ë™ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ ì „ëµ íƒ­ â”€â”€ */
async function loadHrDates() {
  try {
    const { data } = await sc.from('reports').select('report_date').eq('user_id', me.id).order('report_date', { ascending: false });
    const dates = [...new Set((data||[]).map(d => d.report_date))];
    if(!dates.length) { render('hr-content', '<div style="color:#aaa;text-align:center;padding:40px">ë¦¬í¬íŠ¸ ì—†ìŒ</div>'); return; }
    render('hr-date', dates.map(d => `<option value="${d}">${d}</option>`).join(''));
    loadHrReport();
  } catch(e) { console.error(e); }
}

async function loadHrReport() {
  const date = $id('hr-date')?.value;
  if(!date) return;
  try {
    const { data } = await sc.from('reports').select('content').eq('report_date', date).eq('user_id', me.id).single();
    const c = data?.content;
    let html = '';
    if(c?.hr_proposal)      html += `<h2>ğŸ‘¤ HR ì œì•ˆ</h2>${marked.parse(c.hr_proposal)}`;
    if(c?.ba_brief)         html += `<h2>ğŸ” BA ë¶„ì„</h2>${marked.parse(c.ba_brief)}`;
    if(c?.pm_brief)         html += `<h2>ğŸ—‚ PM ë¸Œë¦¬í•‘</h2>${marked.parse(c.pm_brief)}`;
    if(c?.securities_brief) html += `<h2>ğŸ“ˆ ì¦ê¶Œ ì¸ì‚¬ì´íŠ¸</h2>${marked.parse(c.securities_brief)}`;
    render('hr-content', html || '<div style="color:#aaa;text-align:center;padding:40px">ë‚´ìš© ì—†ìŒ</div>');
  } catch(e) { render('hr-content', `<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

/* â”€â”€ VOC íƒ­ â”€â”€ */
async function loadVoc() {
  try {
    const { data } = await sc.from('report_feedback').select('*').order('created_at', { ascending: false }).limit(15);
    render('voc-list', (data||[]).length === 0
      ? `<div class="empty">VOC ì—†ìŒ</div>`
      : (data||[]).map(v => `<div class="card" style="border-left-color:${v.is_positive?'var(--success)':'var(--admin)'}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:1.5rem">${v.is_positive ? 'ğŸ‘' : 'ğŸ‘'}</span>
            <small style="color:#aaa">${v.created_at?.slice(0,10)||''}</small>
          </div>
          ${v.feedback_text ? `<div class="box" style="margin-top:8px">${escHtml(v.feedback_text)}</div>` : '<div style="color:#aaa;font-size:.82rem;padding:6px 0">ì˜ê²¬ ì—†ìŒ</div>'}
          ${v.target_agent ? `<small style="color:#999">ëŒ€ìƒ ì—ì´ì „íŠ¸: ${v.target_agent}</small>` : ''}
        </div>`).join('')
    );
  } catch(e) { render('voc-list', `<div class="card">âš ï¸ VOC ë¡œë“œ ì‹¤íŒ¨</div>`); }
}

/* â”€â”€ ë¹„ìš© íƒ­ / íšŒì› ì„¤ì • â”€â”€ */
async function loadMemberSettings() {
  try {
    const [countRes, maxRes, waitlistRes, unsentRes] = await Promise.all([
      sc.from('member_count_view').select('count').single(),
      sc.from('app_settings').select('value').eq('key','max_members').maybeSingle(),
      sc.from('signup_waitlist').select('id', { count:'exact', head:true }),
      sc.from('signup_waitlist').select('id', { count:'exact', head:true }).eq('notified', false),
    ]);
    $id('m-current-count').textContent  = countRes.count ?? 'â€”';
    $id('m-max-count').textContent      = maxRes.data?.value ?? 'ì œí•œì—†ìŒ';
    $id('m-waitlist-count').textContent = waitlistRes.count ?? '0';
    $id('m-unsent-count').textContent   = unsentRes.count ?? '0';
    if(maxRes.data?.value) $id('m-max-input').value = maxRes.data.value;

    const openRes = await sc.from('app_settings').select('value').eq('key','signup_open').maybeSingle();
    const isOpen  = openRes.data?.value === 'true' || openRes.data?.value === true;
    updateSignupStatusUI(isOpen);
  } catch(e) { console.error('íšŒì› ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', e); }
}

function updateSignupStatusUI(isOpen) {
  const desc = $id('signup-status-desc');
  const btnO = $id('btn-signup-open');
  const btnC = $id('btn-signup-close');
  if(isOpen) {
    desc.textContent = 'âœ… ê°€ì… í—ˆìš© ì¤‘ â€” ì‹ ê·œ íšŒì›ì´ ììœ ë¡­ê²Œ ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    desc.style.color = '#059669';
    btnO.style.opacity='1'; btnO.style.fontWeight='900';
    btnC.style.opacity='.5'; btnC.style.fontWeight='700';
  } else {
    desc.textContent = 'ğŸ”’ ê°€ì… ì œí•œ ì¤‘ â€” ì‹ ê·œ ê°€ì… ì‹œ ëŒ€ê¸° ì‹ ì²­ í™”ë©´ì´ í‘œì‹œë©ë‹ˆë‹¤.';
    desc.style.color = '#dc2626';
    btnC.style.opacity='1'; btnC.style.fontWeight='900';
    btnO.style.opacity='.5'; btnO.style.fontWeight='700';
  }
}

async function saveMaxMembers() {
  const val = $id('m-max-input').value.trim();
  if(!val || isNaN(val) || Number(val) < 1) return toast('âŒ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('app_settings').upsert({ key:'max_members', value:String(val) }, { onConflict:'key' });
    $id('m-max-count').textContent = val;
    toast(`âœ… ìµœëŒ€ íšŒì› ìˆ˜ ${val}ëª…ìœ¼ë¡œ ì €ì¥ë¨`);
  } catch(e) { toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
}

async function setSignupStatus(open) {
  try {
    await sc.from('app_settings').upsert({ key:'signup_open', value:String(open) }, { onConflict:'key' });
    updateSignupStatusUI(open);
    toast(open ? 'âœ… íšŒì›ê°€ì… í—ˆìš©ìœ¼ë¡œ ë³€ê²½ë¨' : 'ğŸ”’ íšŒì›ê°€ì… ì œí•œìœ¼ë¡œ ë³€ê²½ë¨');
  } catch(e) { toast('âŒ ë³€ê²½ ì‹¤íŒ¨: ' + e.message); }
}

async function notifyWaitlist() {
  if(!confirm('ë¯¸ë°œì†¡ ëŒ€ê¸°ì ì „ì›ì—ê²Œ ì•Œë¦¼ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const { data: list, error } = await sc.from('signup_waitlist').select('id, email').eq('notified', false);
    if(error) throw error;
    if(!list?.length) { toast('ğŸ“­ ë°œì†¡í•  ëŒ€ê¸°ìê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
    const ids = list.map(r => r.id);
    await sc.from('signup_waitlist').update({ notified:true, notified_at:new Date().toISOString() }).in('id', ids);
    await sc.from('action_logs').insert({
      action_type: 'WAITLIST_NOTIFY',
      target_word: 'SYSTEM',
      details: `ğŸ“¬ ëŒ€ê¸°ì ${list.length}ëª… ì´ë©”ì¼ ë°œì†¡ ìš”ì²­. ì´ë©”ì¼: ${list.map(r=>r.email).join(', ')}`
    });
    $id('m-unsent-count').textContent = '0';
    const result = $id('notify-result');
    result.textContent = `âœ… ${list.length}ëª…ì—ê²Œ ë°œì†¡ ìš”ì²­ ì™„ë£Œ!`;
    result.style.display = 'inline';
    setTimeout(() => result.style.display='none', 4000);
    toast(`ğŸ“¨ ëŒ€ê¸°ì ${list.length}ëª… ë°œì†¡ ìš”ì²­ ì™„ë£Œ`);
    loadMemberSettings();
  } catch(e) { toast('âŒ ë°œì†¡ ì‹¤íŒ¨: ' + e.message); }
}

async function loadCost() {
  loadMemberSettings();
  try {
    const todayFmt = new Date(new Date().getTime() + 9*60*60*1000).toISOString().slice(0,10);
    const { data: todayLogs } = await sc.from('cost_log').select('call_type, call_count, cost_usd').eq('log_date', todayFmt);
    const totalCalls = (todayLogs||[]).reduce((s,r)=>s+(r.call_count||0),0);
    const totalCost  = (todayLogs||[]).reduce((s,r)=>s+(r.cost_usd||0),0);
    $id('c-calls').textContent = totalCalls.toLocaleString();
    $id('c-cost').textContent  = `$${totalCost.toFixed(4)}`;

    const byType = {};
    (todayLogs||[]).forEach(r => { byType[r.call_type]=(byType[r.call_type]||0)+(r.call_count||0); });
    const typeIcon = {text:'ğŸ“',json:'ğŸ“Š',batch:'ğŸ—ï¸'};
    $id('c-breakdown').innerHTML = Object.keys(byType).length===0
      ? '<span style="color:#aaa">ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ</span>'
      : `<table style="width:100%;border-collapse:collapse">
          <tr style="background:#f8fafc;font-weight:700"><td style="padding:8px">ìœ í˜•</td><td style="padding:8px;text-align:right">í˜¸ì¶œ ìˆ˜</td></tr>
          ${Object.entries(byType).map(([k,v])=>`<tr style="border-top:1px solid #f0f0f0"><td style="padding:8px">${typeIcon[k]||'â€¢'} ${k}</td><td style="padding:8px;text-align:right;font-weight:700">${v.toLocaleString()}íšŒ</td></tr>`).join('')}
        </table>`;

    const since7 = new Date(new Date().getTime()+9*60*60*1000-6*86400*1000).toISOString().slice(0,10);
    const { data: weekLogs } = await sc.from('cost_log').select('log_date,call_count,cost_usd').gte('log_date',since7);
    $id('c-week').textContent = `$${(weekLogs||[]).reduce((s,r)=>s+(r.cost_usd||0),0).toFixed(3)}`;

    const days = Array.from({length:7},(_,i)=>{
      const d=new Date(new Date().getTime()+9*60*60*1000-(6-i)*86400*1000);
      return d.toISOString().slice(0,10);
    });
    const callByDay={};
    (weekLogs||[]).forEach(r=>{callByDay[r.log_date]=(callByDay[r.log_date]||0)+(r.call_count||0);});
    const ctx=$id('cost-chart').getContext('2d');
    if(costChartInstance) costChartInstance.destroy();
    costChartInstance=new Chart(ctx,{
      type:'bar',
      data:{labels:days.map(d=>d.slice(5)),datasets:[{label:'Gemini í˜¸ì¶œ ìˆ˜',data:days.map(d=>callByDay[d]||0),backgroundColor:'rgba(245,158,11,0.7)',borderColor:'#f59e0b',borderWidth:2,borderRadius:6}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
    });

    const { data: sbStats } = await sc.from('supabase_stats').select('row_counts,total_rows').eq('stat_date',todayFmt).maybeSingle();
    if(sbStats){
      const total=sbStats.total_rows||0, pct=((total/500000)*100).toFixed(1);
      const color=total>400000?'#dc2626':total>250000?'#d97706':'#16a34a';
      $id('c-rows').textContent=total.toLocaleString(); $id('c-rows').style.color=color;
      const counts=sbStats.row_counts||{};
      $id('c-row-detail').innerHTML=`<div style="margin-bottom:10px"><div style="background:#f3f4f6;border-radius:8px;height:12px;overflow:hidden"><div style="background:${color};height:100%;width:${Math.min(pct,100)}%;border-radius:8px;transition:.5s"></div></div><div style="font-size:.8rem;color:#6b7280;margin-top:4px">${pct}% ì‚¬ìš© ì¤‘ (ë¬´ë£Œ í•œë„ 50ë§Œ rows)</div></div><table style="width:100%;border-collapse:collapse;font-size:.88rem">${Object.entries(counts).map(([t,n])=>`<tr style="border-top:1px solid #f0f0f0"><td style="padding:6px 8px;color:#555">${t}</td><td style="padding:6px 8px;text-align:right;font-weight:700;color:${n>100000?'#dc2626':'#111'}">${n.toLocaleString()}</td></tr>`).join('')}</table>`;
    } else {
      $id('c-rows').textContent='â€”';
      $id('c-row-detail').innerHTML='<span style="color:#aaa">ì˜¤ëŠ˜ í†µê³„ ì—†ìŒ</span>';
    }
  } catch(e) {
    console.error('loadCost ì˜¤ë¥˜:',e);
    $id('c-breakdown').innerHTML=`<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`;
  }
}

/* â”€â”€ ì „ì²´ ìƒˆë¡œê³ ì¹¨ â”€â”€ */
async function refreshAll() {
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc(), loadMemberSettings()]);
  toast('ğŸ”„ ì „ì²´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

/* â˜… ë²„ê·¸ ìˆ˜ì •: async function init() ìœ¼ë¡œ í•¨ìˆ˜ëª… ë³µì› */
async function init() {
  startClock();
  const tok = getToken();
  if(tok) { $id('ghp-token').value=tok; updateTokenStatus(tok); }
  else { updateTokenStatus(''); }
  try {
    const { data: { session } } = await sc.auth.getSession();
    if(!session || session.user.email !== CFG.master) {
      toast('âŒ ë§ˆìŠ¤í„° ê¶Œí•œ ì—†ìŒ. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
      setTimeout(() => location.href='app.html', 1500);
      return;
    }
    me = session.user;
  } catch(e) {
    me = { id:'master', email:CFG.master };
    console.warn('ì„¸ì…˜ ì—†ìŒ, ê¸°ë³¸ ëª¨ë“œ ë™ì‘:', e.message);
  }
  startAutoApprovalTimer();
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc(), loadMemberSettings()]);
  loadAgentSelect();

  sc.channel('evo-updates')
    .on('postgres_changes',{event:'*',schema:'public',table:'pending_approvals'},()=>loadEvo())
    .subscribe();
  sc.channel('dev-updates')
    .on('postgres_changes',{event:'*',schema:'public',table:'dev_backlog'},()=>loadDev())
    .subscribe();
  sc.channel('agent-updates')
    .on('postgres_changes',{event:'*',schema:'public',table:'agents'},()=>loadAgentSelect())
    .subscribe();
}

init();
</script>
</body>
</html>
