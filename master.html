<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Sovereign HQ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root{--admin:#ff4d4f;--primary:#007bff;--success:#28a745;--dev:#6f42c1;--dark:#1a1a2e;--warn:#fd7e14;--bg:#f8f9fa}
*{box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;margin:0;background:var(--bg);color:#222}
.wrap{max-width:1050px;margin:0 auto;padding:20px}

/* ë³´ì•ˆë°” */
.sec-bar{background:#111;color:#eee;padding:12px 20px;border-radius:14px;margin-bottom:18px;display:flex;gap:12px;align-items:center;font-size:.85rem;flex-wrap:wrap}
.sec-bar input{flex:1;min-width:220px;padding:6px 12px;background:rgba(255,255,255,.1);border:1px solid #444;color:#fff;border-radius:8px;font-size:.85rem}
.sec-bar button{padding:6px 14px;background:#ff4d4f;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:.82rem}
.auto-badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700}

/* í—¤ë” */
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.hdr h1{margin:0;font-size:1.8rem;letter-spacing:-2px;cursor:pointer}
.hdr small{color:var(--admin);font-weight:700;display:block;font-size:.8rem}
.hdr-btns{display:flex;gap:8px}

/* íƒ­ */
.tabs{display:flex;gap:4px;border-bottom:2px solid #e9ecef;margin-bottom:22px;overflow-x:auto}
.tab{padding:12px 18px;cursor:pointer;font-weight:800;color:#999;border-bottom:4px solid transparent;margin-bottom:-2px;transition:.2s;white-space:nowrap;font-size:.9rem}
.tab.on{color:var(--admin);border-bottom-color:var(--admin)}
.badge{background:var(--admin);color:#fff;border-radius:20px;padding:1px 7px;font-size:.72rem;margin-left:5px;font-weight:700}

/* ê³µí†µ ì»´í¬ë„ŒíŠ¸ */
.card{background:#fff;border:1px solid #eee;padding:18px;border-radius:16px;margin-bottom:14px;border-left:6px solid var(--admin);box-shadow:0 2px 8px rgba(0,0,0,.04)}
.box{background:#f8f9fa;padding:13px;border-radius:10px;font-size:.88rem;border:1px solid #efefef;margin:8px 0;white-space:pre-wrap;line-height:1.6}
.btn{padding:9px 18px;border-radius:10px;border:1px solid #ddd;cursor:pointer;font-weight:700;transition:.2s;background:#fff;font-size:.88rem}
.btn:hover{opacity:.85}
.sm{padding:7px 13px;font-size:.82rem;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:700}
textarea,select{width:100%;padding:13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem;resize:vertical}
.row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
.row>*{flex:1;min-width:150px}
h3{margin:0 0 14px;font-size:1rem;color:#444}
.empty{color:#aaa;font-style:italic;padding:20px;text-align:center}

/* ìƒíƒœ ë±ƒì§€ */
.s-tag{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:700;margin-left:6px}
.s-PENDING{background:#fff3cd;color:#856404}
.s-CONFIRMED{background:#cce5ff;color:#004085}
.s-DEVELOPING{background:#d4edda;color:#155724}
.s-DEPLOYED{background:#d1ecf1;color:#0c5460}
.s-APPROVED{background:#d4edda;color:#155724}
.s-REJECTED{background:#f8d7da;color:#721c24}

/* í¬ëŸ¼ */
#forum-box{background:#0d1117;color:#50fa7b;padding:18px;border-radius:14px;font-family:'Courier New',monospace;height:320px;overflow-y:auto;font-size:.82rem;line-height:1.7}
#forum-box .err{color:#ff5555}
#forum-box .warn{color:#ffb86c}
#forum-box .info{color:#8be9fd}

/* ì¹´ìš´íŠ¸ë‹¤ìš´ */
.countdown{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#eee;padding:14px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:14px;font-size:.88rem}
.countdown .timer{font-size:1.4rem;font-weight:900;color:#50fa7b;letter-spacing:1px;min-width:80px}
.countdown .timer.warn{color:#ffb86c}
.countdown .timer.danger{color:#ff5555}

/* ì§„í™” ê²°ì¬ */
.evo-card{background:#fff;border:1px solid #e0e0e0;border-left:6px solid var(--warn);padding:18px;border-radius:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.evo-card .meta{font-size:.78rem;color:#999;margin-bottom:6px}
.evo-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

/* í„ìŠ¤ */
.pulse{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ë‹¤í¬ ë¦¬í¬íŠ¸ */
#hr-content{background:var(--dark);color:#dde;padding:32px;border-radius:18px;min-height:260px;margin-top:14px;line-height:1.8;font-size:.92rem}
#hr-content h1,#hr-content h2,#hr-content h3{color:#7eb8ff}
#hr-content a{color:#50fa7b}

/* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
#toast{position:fixed;bottom:30px;right:30px;background:#222;color:#fff;padding:12px 22px;border-radius:12px;font-size:.88rem;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}
#toast.show{opacity:1}

/* ë¹„ìš© íƒ­ */
.cost-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.cost-card{background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.cost-label{font-size:.72rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.cost-value{font-size:2rem;font-weight:900;color:#111;line-height:1.1}
.cost-unit{font-size:.78rem;color:#6b7280;margin-top:4px}
</style>
</head>
<body>
<div class="wrap">

  <!-- ë³´ì•ˆë°” -->
  <div class="sec-bar">
    <span>ğŸ”’ <b>Auth Center</b></span>
    <input type="password" id="ghp-token" placeholder="ghp_... GitHub Personal Access Token">
    <button onclick="saveToken()">ì €ì¥</button>
    <span id="token-status" style="color:#aaa">í† í° ë¯¸ì…ë ¥</span>
    <span class="auto-badge" id="auto-badge" style="display:none">â± ìë™ìŠ¹ì¸ ON</span>
  </div>

  <!-- í—¤ë” -->
  <div class="hdr">
    <div>
      <h1 onclick="location.href='index.html'">Sovereign HQ</h1>
      <small>v18.0 Â· <span id="now-time"></span></small>
    </div>
    <div class="hdr-btns">
      <button class="btn" onclick="location.href='index.html'">ğŸŒ í™ˆ</button>
      <button class="btn" onclick="location.href='app.html'">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn" onclick="refreshAll()" style="background:#111;color:#fff;border:none">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- íƒ­ -->
  <div class="tabs">
    <div id="t-hr"   class="tab on" onclick="tab('hr')">ğŸ•µï¸ ì „ëµ</div>
    <div id="t-evo"  class="tab"    onclick="tab('evo')">ğŸ§  ì§€ëŠ¥ <span class="badge" id="evo-cnt" style="display:none">0</span></div>
    <div id="t-dev"  class="tab"    onclick="tab('dev')">ğŸ› ï¸ ê°œë°œ <span class="badge" id="dev-cnt" style="display:none">0</span></div>
    <div id="t-log"  class="tab"    onclick="tab('log')">ğŸ“‹ í¬ëŸ¼</div>
    <div id="t-voc"  class="tab"    onclick="tab('voc')">ğŸ’¬ VOC</div>
    <div id="t-cost" class="tab"    onclick="tab('cost')">ğŸ’° ë¹„ìš©</div>
  </div>

  <!-- â‘  ì „ëµ íƒ­ -->
  <div id="v-hr">
    <div class="row" style="align-items:center;margin-bottom:14px">
      <h3 style="margin:0">ğŸ“… ë§ˆìŠ¤í„° ë¦¬í¬íŠ¸</h3>
      <select id="hr-date" onchange="loadHrReport()" style="margin:0;max-width:200px"></select>
    </div>
    <div id="hr-content">ë¡œë“œ ì¤‘...</div>
  </div>

  <!-- â‘¡ ì§€ëŠ¥ íƒ­ -->
  <div id="v-evo" style="display:none">
    <div class="countdown" id="countdown-bar">
      <div>
        <div style="font-weight:700;margin-bottom:2px">â³ 23:30 ìë™ìŠ¹ì¸ê¹Œì§€</div>
        <div style="font-size:.78rem;color:#aaa">ë¯¸ê²° ì•ˆê±´ì€ ìë™ìœ¼ë¡œ APPROVED ì²˜ë¦¬ë©ë‹ˆë‹¤</div>
      </div>
      <div class="timer" id="countdown-timer">--:--:--</div>
    </div>
    <div class="card" style="border-left-color:#333;background:#fafafa">
      <h3>âœï¸ ì§€ëŠ¥ í•˜ë‹¬</h3>
      <div class="row">
        <select id="m-role" style="margin:0;max-width:160px">
          <option value="BA">ğŸ” BA</option>
          <option value="STOCK">ğŸ“ˆ STOCK</option>
          <option value="PM">ğŸ—‚ PM</option>
          <option value="HR">ğŸ‘¤ HR</option>
          <option value="DEV">ğŸ’» DEV</option>
          <option value="QA">âœ… QA</option>
          <option value="BRIEF">ğŸ“ BRIEF</option>
        </select>
      </div>
      <textarea id="m-text" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ì§ì ‘ ì§€ì¹¨ì„ í•˜ë‹¬í•˜ì„¸ìš”. ì €ì¥ ì¦‰ì‹œ í•´ë‹¹ ì—ì´ì „íŠ¸ì˜ instructionì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤."></textarea>
      <button class="btn" style="background:#111;color:#fff;border:none;width:100%" onclick="sendDirectOrder()">âš¡ ì¦‰ì‹œ í•˜ë‹¬ (ë°”ë¡œ ì ìš©)</button>
    </div>
    <div id="pending-evo-list"></div>
    <div id="live-agent-list"></div>
  </div>

  <!-- â‘¢ ê°œë°œ íƒ­ -->
  <div id="v-dev" style="display:none">
    <div class="card" style="border-left-color:var(--dev);background:#f5f0ff">
      <h3>ğŸ› ï¸ ìƒˆ ê°œë°œ ì•ˆê±´ ë“±ë¡</h3>
      <input id="d-title" placeholder="ì•ˆê±´ ì œëª©" style="width:100%;padding:11px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-size:.9rem">
      <textarea id="d-task" rows="4" placeholder="ìš”êµ¬ì‚¬í•­ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”. AI DEV ì—ì´ì „íŠ¸ê°€ ì´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤."></textarea>
      <button class="btn" style="background:var(--dev);color:#fff;border:none;width:100%" onclick="addDev()">ğŸ“‹ ë°±ë¡œê·¸ ë“±ë¡</button>
    </div>
    <div id="dev-list"></div>
  </div>

  <!-- â‘£ í¬ëŸ¼ íƒ­ -->
  <div id="v-log" style="display:none">
    <div id="forum-box"><span style="color:#8be9fd"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸</span><br>ë¡œë”© ì¤‘...</div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" style="flex:1;background:var(--admin);color:#fff;border:none;padding:15px" onclick="triggerRun()">ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™</button>
      <button class="btn" style="background:#333;color:#fff;border:none;padding:15px" onclick="loadLogs()">ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- â‘¤ VOC íƒ­ -->
  <div id="v-voc" style="display:none">
    <div id="voc-list"></div>
  </div>

  <!-- â‘¥ ë¹„ìš© íƒ­ -->
  <div id="v-cost" style="display:none">

    <!-- ìš”ì•½ ì¹´ë“œ 4ê°œ -->
    <div class="cost-grid">
      <div class="cost-card" style="border-top:3px solid #f59e0b">
        <div class="cost-label">ì˜¤ëŠ˜ Gemini í˜¸ì¶œ</div>
        <div class="cost-value" id="c-calls">â€”</div>
        <div class="cost-unit">íšŒ</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #10b981">
        <div class="cost-label">ì˜¤ëŠ˜ ì¶”ì • ë¹„ìš©</div>
        <div class="cost-value" id="c-cost" style="color:#059669">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #6366f1">
        <div class="cost-label">Supabase ì´ rows</div>
        <div class="cost-value" id="c-rows">â€”</div>
        <div class="cost-unit">/ 500,000 ë¬´ë£Œ í•œë„</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #ec4899">
        <div class="cost-label">7ì¼ ëˆ„ì  ë¹„ìš©</div>
        <div class="cost-value" id="c-week">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
    </div>

    <!-- 7ì¼ ì°¨íŠ¸ -->
    <div class="card" style="border-left-color:#f59e0b">
      <h3>ğŸ“ˆ 7ì¼ Gemini í˜¸ì¶œ ì¶”ì´</h3>
      <canvas id="cost-chart" height="180"></canvas>
    </div>

    <!-- Supabase row ìƒì„¸ -->
    <div class="card" style="border-left-color:#6366f1">
      <h3>ğŸ—„ï¸ Supabase í…Œì´ë¸”ë³„ row ìˆ˜</h3>
      <div id="c-row-detail">ë¡œë“œ ì¤‘...</div>
    </div>

    <!-- í˜¸ì¶œ ìœ í˜•ë³„ ë‚´ì—­ -->
    <div class="card" style="border-left-color:#e5e7eb">
      <h3>ğŸ“‹ ì˜¤ëŠ˜ í˜¸ì¶œ ìœ í˜•ë³„ ë‚´ì—­</h3>
      <div id="c-breakdown">ë¡œë“œ ì¤‘...</div>
    </div>

  </div>

</div>

<div id="toast"></div>

<script>
const CFG = {
  url:      'https://zrlpwmpbrvohautldcon.supabase.co',
  key:      'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G',
  master:   'positivecha@gmail.com',
  owner:    'fitzcha',
  repo:     'newsbot',
  workflow: 'daily_run.yml'
};
const sc = supabase.createClient(CFG.url, CFG.key);
let me = null, autoTimer = null, costChartInstance = null;

/* â”€â”€ ìœ í‹¸ â”€â”€ */
function toast(msg, dur=2800) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}
function $id(id) { return document.getElementById(id); }
function render(id, html) { const el=$id(id); if(el) el.innerHTML=html; }

/* â”€â”€ í† í° â”€â”€ */
function saveToken() {
  const v = $id('ghp-token').value.trim();
  if(!v) return toast('âŒ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('ghp_token', v);
  updateTokenStatus(v);
  toast('âœ… í† í° ì €ì¥ ì™„ë£Œ');
}
function getToken() { return localStorage.getItem('ghp_token') || ''; }
function updateTokenStatus(t) {
  $id('token-status').textContent = t ? 'âœ… í† í° í™œì„±í™”' : 'âš ï¸ í† í° ë¯¸ì…ë ¥';
  $id('token-status').style.color = t ? '#50fa7b' : '#ffb86c';
}

/* â”€â”€ íƒ­ â”€â”€ */
function tab(t) {
  ['hr','evo','dev','log','voc','cost'].forEach(x => {
    $id('v-'+x).style.display = x===t ? 'block' : 'none';
    $id('t-'+x).classList.toggle('on', x===t);
  });
  if(t === 'cost') loadCost();
}

/* â”€â”€ ì‹œê³„ â”€â”€ */
function startClock() {
  const tick = () => {
    const now = new Date();
    const kst = new Date(now.getTime() + (9*60 - now.getTimezoneOffset())*60000);
    $id('now-time').textContent = kst.toLocaleTimeString('ko-KR');
  };
  tick(); setInterval(tick, 1000);
}

/* â”€â”€ 23:30 ìë™ìŠ¹ì¸ ì¹´ìš´íŠ¸ë‹¤ìš´ â”€â”€ */
function startAutoApprovalTimer() {
  $id('auto-badge').style.display = '';
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(async () => {
    const now = new Date();
    const kst = new Date(now.getTime() + (9*60 - now.getTimezoneOffset())*60000);
    const h = kst.getHours(), m = kst.getMinutes(), s = kst.getSeconds();
    if(h === 23 && m === 30 && s < 5) { await runAutoApproval(); return; }
    let nowSecs = h*3600 + m*60 + s;
    let tgtSecs = 23*3600 + 30*60;
    if(nowSecs >= tgtSecs) tgtSecs += 86400;
    let diff = tgtSecs - nowSecs;
    let rh = Math.floor(diff/3600), rm = Math.floor((diff%3600)/60), rs = diff%60;
    const el = $id('countdown-timer');
    el.textContent = `${String(rh).padStart(2,'0')}:${String(rm).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
    el.className = 'timer' + (rh < 1 ? (rm < 30 ? ' danger' : ' warn') : '');
  }, 1000);
}

async function runAutoApproval() {
  try {
    const { data: pending } = await sc.from('pending_approvals').select('*').eq('status','PENDING');
    if(!pending?.length) return;
    for(const p of pending) {
      await sc.from('agents').update({ instruction: p.proposed_instruction }).eq('agent_role', p.agent_role);
      await sc.from('pending_approvals').update({ status:'APPROVED' }).eq('id', p.id);
    }
    toast(`â° 23:30 ìë™ìŠ¹ì¸ ì™„ë£Œ â€” ${pending.length}ê±´ ì ìš©ë¨`);
    loadEvo();
  } catch(e) { console.error('ìë™ìŠ¹ì¸ ì˜¤ë¥˜:', e); }
}

/* â”€â”€ ì§€ëŠ¥ íƒ­ â”€â”€ */
async function loadEvo() {
  try {
    const [agRes, prRes] = await Promise.all([
      sc.from('agents').select('agent_role, instruction').order('agent_role'),
      sc.from('pending_approvals').select('id, agent_role, proposed_instruction, proposal_reason, created_at')
        .eq('status','PENDING').order('created_at', { ascending: false })
    ]);
    const agents = agRes.data || [];
    const props  = prRes.data || [];

    if(props.length > 0) { $id('evo-cnt').style.display=''; $id('evo-cnt').textContent=props.length; }
    else { $id('evo-cnt').style.display='none'; }

    let pHtml = `<h3>ğŸ“„ ê²°ì¬ ëŒ€ê¸° <span style="color:var(--admin)">(${props.length}ê±´)</span></h3>`;
    pHtml += props.length === 0
      ? `<div class="empty">âœ… í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤</div>`
      : props.map(p => {
          const created = p.created_at ? new Date(p.created_at).toLocaleString('ko-KR') : '';
          return `<div class="evo-card">
            <div class="meta">ğŸ¤– ${p.agent_role} Â· ${created} Â· ${p.proposal_reason||'ì—ì´ì „íŠ¸ ììœ¨ ì œì•ˆ'}</div>
            <strong>ì œì•ˆëœ ì§€ì¹¨</strong>
            <div class="box">${escHtml(p.proposed_instruction)}</div>
            <div class="evo-actions">
              <button class="sm" style="background:var(--success)" onclick="decideEvo('${p.id}','${p.agent_role}','APPROVED')">âœ… ìŠ¹ì¸ â€” ì¦‰ì‹œ ì ìš©</button>
              <button class="sm" style="background:var(--admin)"   onclick="decideEvo('${p.id}','${p.agent_role}','REJECTED')">âŒ ë°˜ë ¤</button>
            </div>
          </div>`;
        }).join('');
    render('pending-evo-list', pHtml);

    let aHtml = `<h3>ğŸš€ í˜„ì¬ ê°€ë™ ì¤‘ì¸ ì—ì´ì „íŠ¸ ì§€ì¹¨</h3>`;
    aHtml += agents.length === 0
      ? `<div class="empty">ì—ì´ì „íŠ¸ ì •ë³´ ì—†ìŒ</div>`
      : agents.map(a => `<div class="card" style="border-left-color:#bbb">
          <strong>ğŸ¤– ${a.agent_role}</strong>
          <div class="box">${escHtml(a.instruction||'ì§€ì¹¨ ì—†ìŒ')}</div>
        </div>`).join('');
    render('live-agent-list', aHtml);

  } catch(e) {
    render('pending-evo-list', `<div class="card" style="border-left-color:var(--admin)">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}

async function decideEvo(id, role, status) {
  try {
    if(status === 'APPROVED') {
      const { data: p } = await sc.from('pending_approvals').select('proposed_instruction').eq('id', id).single();
      if(p) {
        const { error } = await sc.from('agents').update({ instruction: p.proposed_instruction }).eq('agent_role', role);
        if(error) throw error;
      }
    }
    await sc.from('pending_approvals').update({ status }).eq('id', id);
    toast(status === 'APPROVED' ? `âœ… ${role} ì§€ì¹¨ ìŠ¹ì¸ ë° ì ìš© ì™„ë£Œ` : `âŒ ${role} ì•ˆê±´ ë°˜ë ¤ë¨`);
    loadEvo();
  } catch(e) { toast('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message); }
}

async function sendDirectOrder() {
  const role = $id('m-role').value;
  const text = $id('m-text').value.trim();
  if(!text) return toast('âŒ ì§€ì¹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
  try {
    const { error } = await sc.from('agents').update({ instruction: text }).eq('agent_role', role);
    if(error) throw error;
    await sc.from('pending_approvals').insert([{
      agent_role: role, proposed_instruction: text,
      proposal_reason: 'ë§ˆìŠ¤í„° ì§ì ‘ í•˜ë‹¬', status: 'APPROVED'
    }]);
    $id('m-text').value = '';
    toast(`âš¡ ${role} ì—ì´ì „íŠ¸ ì§€ì¹¨ ì¦‰ì‹œ í•˜ë‹¬ ì™„ë£Œ`);
    loadEvo();
  } catch(e) { toast('âŒ í•˜ë‹¬ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ ê°œë°œ íƒ­ â”€â”€ */
async function loadDev() {
  try {
    const { data, error } = await sc.from('dev_backlog').select('*').order('created_at', { ascending: false });
    if(error) throw error;
    const pending = (data||[]).filter(b => b.status === 'PENDING').length;
    if(pending > 0) { $id('dev-cnt').style.display=''; $id('dev-cnt').textContent=pending; }
    else { $id('dev-cnt').style.display='none'; }

    render('dev-list', (data||[]).length === 0
      ? `<div class="empty">ë“±ë¡ëœ ë°±ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>`
      : (data||[]).map(b => {
          const created = b.created_at ? new Date(b.created_at).toLocaleString('ko-KR') : '';
          let btns = '';
          if(b.status === 'PENDING')    btns = `<button class="sm" style="background:var(--primary)" onclick="upDev('${b.id}','CONFIRMED')">âœ… ê°œë°œ í™•ì •</button>`;
          else if(b.status==='CONFIRMED') btns = `<button class="sm" style="background:var(--dev)" onclick="triggerDev('${b.id}')">ğŸš€ ë°°í¬ ì‹œì‘</button>`;
          else if(b.status==='DEVELOPING') btns = `<span class="pulse" style="color:var(--dev);font-weight:700">â³ AI ë°°í¬ ì¤‘...</span>`;
          else btns = `<span style="color:var(--success);font-weight:700">âœ… ë°°í¬ ì™„ë£Œ</span>`;
          return `<div class="card" style="border-left-color:var(--dev)">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
              <div><strong>${escHtml(b.title||'ë¬´ì œ')}</strong><span class="s-tag s-${b.status}">${b.status}</span></div>
              <small style="color:#aaa">${created}</small>
            </div>
            <div class="box">${escHtml(b.task_detail||'')}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">${btns}</div>
          </div>`;
        }).join('')
    );
  } catch(e) {
    render('dev-list', `<div class="card" style="border-left-color:var(--admin)">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}

async function addDev() {
  const title = $id('d-title').value.trim();
  const task  = $id('d-task').value.trim();
  if(!title || !task) return toast('âŒ ì œëª©ê³¼ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
  try {
    const { error } = await sc.from('dev_backlog').insert([{ title, task_detail: task, status: 'PENDING', priority: 5 }]);
    if(error) throw error;
    $id('d-title').value = ''; $id('d-task').value = '';
    toast('ğŸ“‹ ê°œë°œ ì•ˆê±´ ë“±ë¡ ì™„ë£Œ');
    loadDev();
  } catch(e) { toast('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + e.message); }
}

async function upDev(id, status) {
  await sc.from('dev_backlog').update({ status }).eq('id', id);
  toast('âœ… ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
  loadDev();
}

async function triggerDev(id) {
  const token = getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').update({ status: 'DEVELOPING' }).eq('id', id);
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: { backlog_id: String(id) } })
      }
    );
    if(res.status === 204) { toast('ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!'); }
    else {
      const e = await res.json().catch(()=>({}));
      await sc.from('dev_backlog').update({ status: 'CONFIRMED' }).eq('id', id);
      throw new Error(`GitHub API ${res.status}: ${e.message||'ì˜¤ë¥˜'}`);
    }
    loadDev();
  } catch(e) { toast('âŒ ë°°í¬ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ í¬ëŸ¼ íƒ­ â”€â”€ */
async function loadLogs() {
  try {
    const { data, error } = await sc.from('action_logs').select('*').order('executed_at', { ascending: false }).limit(30);
    if(error) throw error;
    const lines = (data||[]).map(l => {
      const t   = l.executed_at ? l.executed_at.slice(11,19) : '??:??:??';
      const msg = l.memo || l.details || (l.target_word ? l.target_word+' ë¶„ì„ ì™„ë£Œ' : 'ì‹œìŠ¤í…œ ì´ë²¤íŠ¸');
      const cls = msg.includes('âŒ')||msg.includes('ì‹¤íŒ¨') ? 'err' : msg.includes('âš ï¸') ? 'warn' : 'info';
      return `<div class="${cls}">[${t} KST] ${escHtml(String(msg))}</div>`;
    });
    render('forum-box', `<span class="info"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸ (ìµœê·¼ ${lines.length}ê±´)</span><br>` + (lines.join('')||'<span style="color:#aaa">ë¡œê·¸ ì—†ìŒ</span>'));
  } catch(e) { render('forum-box', `<span class="err">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

async function triggerRun() {
  const token = getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”');
  if(!confirm('ì „ì²´ ì‹œìŠ¤í…œì„ ì¦‰ì‹œ ê°€ë™í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: {} })
      }
    );
    if(res.status === 204) { toast('ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ!'); setTimeout(loadLogs, 3000); }
    else { const e = await res.json().catch(()=>({})); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
  } catch(e) { toast('âŒ ê°€ë™ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ ì „ëµ íƒ­ â”€â”€ */
async function loadHrDates() {
  try {
    const { data } = await sc.from('reports').select('report_date').eq('user_id', me.id).order('report_date', { ascending: false });
    const dates = [...new Set((data||[]).map(d => d.report_date))];
    if(!dates.length) { render('hr-content', '<div style="color:#aaa;text-align:center;padding:40px">ë¦¬í¬íŠ¸ ì—†ìŒ</div>'); return; }
    render('hr-date', dates.map(d => `<option value="${d}">${d}</option>`).join(''));
    loadHrReport();
  } catch(e) { console.error(e); }
}

async function loadHrReport() {
  const date = $id('hr-date')?.value;
  if(!date) return;
  try {
    const { data } = await sc.from('reports').select('content').eq('report_date', date).eq('user_id', me.id).single();
    const c = data?.content;
    let html = '';
    if(c?.hr_proposal)      html += `<h2>ğŸ‘¤ HR ì œì•ˆ</h2>${marked.parse(c.hr_proposal)}`;
    if(c?.ba_brief)         html += `<h2>ğŸ” BA ë¶„ì„</h2>${marked.parse(c.ba_brief)}`;
    if(c?.pm_brief)         html += `<h2>ğŸ—‚ PM ë¸Œë¦¬í•‘</h2>${marked.parse(c.pm_brief)}`;
    if(c?.securities_brief) html += `<h2>ğŸ“ˆ ì¦ê¶Œ ì¸ì‚¬ì´íŠ¸</h2>${marked.parse(c.securities_brief)}`;
    render('hr-content', html || '<div style="color:#aaa;text-align:center;padding:40px">ë‚´ìš© ì—†ìŒ</div>');
  } catch(e) { render('hr-content', `<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

/* â”€â”€ VOC íƒ­ â”€â”€ */
async function loadVoc() {
  try {
    const { data } = await sc.from('report_feedback').select('*').order('created_at', { ascending: false }).limit(15);
    render('voc-list', (data||[]).length === 0
      ? `<div class="empty">VOC ì—†ìŒ</div>`
      : (data||[]).map(v => `<div class="card" style="border-left-color:${v.is_positive?'var(--success)':'var(--admin)'}">
          <div style="display:flex;justify-content:space-between">
            <strong>${v.is_positive?'ğŸ‘ ê¸ì •':'ğŸ‘ ë¶€ì •'}</strong>
            <small style="color:#aaa">${v.created_at?.slice(0,10)||''}</small>
          </div>
          <div class="box">${escHtml(v.feedback_text||'')}</div>
          ${v.target_agent ? `<small style="color:#999">ëŒ€ìƒ ì—ì´ì „íŠ¸: ${v.target_agent}</small>` : ''}
        </div>`).join('')
    );
  } catch(e) { render('voc-list', `<div class="card">âš ï¸ VOC ë¡œë“œ ì‹¤íŒ¨</div>`); }
}

/* â”€â”€ ğŸ’° ë¹„ìš© íƒ­ â”€â”€ */
async function loadCost() {
  try {
    const todayFmt = new Date(new Date().getTime() + 9*60*60*1000).toISOString().slice(0,10);

    // 1. ì˜¤ëŠ˜ cost_log ì§‘ê³„
    const { data: todayLogs } = await sc
      .from('cost_log').select('call_type, call_count, cost_usd').eq('log_date', todayFmt);

    const totalCalls = (todayLogs||[]).reduce((s,r) => s+(r.call_count||0), 0);
    const totalCost  = (todayLogs||[]).reduce((s,r) => s+(r.cost_usd||0),   0);
    $id('c-calls').textContent = totalCalls.toLocaleString();
    $id('c-cost').textContent  = `$${totalCost.toFixed(4)}`;

    // í˜¸ì¶œ ìœ í˜•ë³„ ë‚´ì—­
    const byType = {};
    (todayLogs||[]).forEach(r => { byType[r.call_type] = (byType[r.call_type]||0)+(r.call_count||0); });
    const typeIcon = { text:'ğŸ“', json:'ğŸ“Š', batch:'ğŸ—ï¸' };
    $id('c-breakdown').innerHTML = Object.keys(byType).length === 0
      ? '<span style="color:#aaa">ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ (ì²« ì‹¤í–‰ í›„ í‘œì‹œë©ë‹ˆë‹¤)</span>'
      : `<table style="width:100%;border-collapse:collapse">
          <tr style="background:#f8fafc;font-weight:700"><td style="padding:8px">ìœ í˜•</td><td style="padding:8px;text-align:right">í˜¸ì¶œ ìˆ˜</td></tr>
          ${Object.entries(byType).map(([k,v])=>`
            <tr style="border-top:1px solid #f0f0f0">
              <td style="padding:8px">${typeIcon[k]||'â€¢'} ${k}</td>
              <td style="padding:8px;text-align:right;font-weight:700">${v.toLocaleString()}íšŒ</td>
            </tr>`).join('')}
        </table>`;

    // 2. 7ì¼ ëˆ„ì 
    const since7 = new Date(new Date().getTime() + 9*60*60*1000 - 6*86400*1000).toISOString().slice(0,10);
    const { data: weekLogs } = await sc
      .from('cost_log').select('log_date, call_count, cost_usd').gte('log_date', since7);
    const weekCost = (weekLogs||[]).reduce((s,r) => s+(r.cost_usd||0), 0);
    $id('c-week').textContent = `$${weekCost.toFixed(3)}`;

    // 3. 7ì¼ ì°¨íŠ¸
    const days = Array.from({length:7}, (_,i) => {
      const d = new Date(new Date().getTime() + 9*60*60*1000 - (6-i)*86400*1000);
      return d.toISOString().slice(0,10);
    });
    const callByDay = {};
    (weekLogs||[]).forEach(r => { callByDay[r.log_date] = (callByDay[r.log_date]||0)+(r.call_count||0); });
    const ctx = $id('cost-chart').getContext('2d');
    if(costChartInstance) costChartInstance.destroy();
    costChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: days.map(d => d.slice(5)),
        datasets: [{
          label: 'Gemini í˜¸ì¶œ ìˆ˜',
          data: days.map(d => callByDay[d]||0),
          backgroundColor: 'rgba(245,158,11,0.7)',
          borderColor: '#f59e0b',
          borderWidth: 2,
          borderRadius: 6,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });

    // 4. Supabase row í†µê³„
    const { data: sbStats } = await sc
      .from('supabase_stats').select('row_counts, total_rows').eq('stat_date', todayFmt).maybeSingle();
    if(sbStats) {
      const total = sbStats.total_rows || 0;
      const pct   = ((total/500000)*100).toFixed(1);
      const color = total > 400000 ? '#dc2626' : total > 250000 ? '#d97706' : '#16a34a';
      $id('c-rows').textContent = total.toLocaleString();
      $id('c-rows').style.color = color;
      const counts = sbStats.row_counts || {};
      $id('c-row-detail').innerHTML = `
        <div style="margin-bottom:10px">
          <div style="background:#f3f4f6;border-radius:8px;height:12px;overflow:hidden">
            <div style="background:${color};height:100%;width:${Math.min(pct,100)}%;border-radius:8px;transition:.5s"></div>
          </div>
          <div style="font-size:.8rem;color:#6b7280;margin-top:4px">${pct}% ì‚¬ìš© ì¤‘ (ë¬´ë£Œ í•œë„ 50ë§Œ rows)</div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:.88rem">
          ${Object.entries(counts).map(([t,n])=>`
            <tr style="border-top:1px solid #f0f0f0">
              <td style="padding:6px 8px;color:#555">${t}</td>
              <td style="padding:6px 8px;text-align:right;font-weight:700;color:${n>100000?'#dc2626':'#111'}">${n.toLocaleString()}</td>
            </tr>`).join('')}
        </table>`;
    } else {
      $id('c-rows').textContent = 'â€”';
      $id('c-row-detail').innerHTML = '<span style="color:#aaa">ì˜¤ëŠ˜ í†µê³„ ì—†ìŒ (ì²« ì‹¤í–‰ í›„ í‘œì‹œë©ë‹ˆë‹¤)</span>';
    }

  } catch(e) {
    console.error('loadCost ì˜¤ë¥˜:', e);
    $id('c-breakdown').innerHTML = `<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`;
  }
}

/* â”€â”€ XSS ë°©ì§€ â”€â”€ */
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ ì „ì²´ ìƒˆë¡œê³ ì¹¨ â”€â”€ */
async function refreshAll() {
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc()]);
  toast('ğŸ”„ ì „ì²´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

/* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
async function init() {
  startClock();
  const tok = getToken();
  if(tok) { $id('ghp-token').value = tok; updateTokenStatus(tok); }
  else { updateTokenStatus(''); }
  try {
    const { data: { session } } = await sc.auth.getSession();
    if(!session || session.user.email !== CFG.master) {
      toast('âŒ ë§ˆìŠ¤í„° ê¶Œí•œ ì—†ìŒ. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
      setTimeout(() => location.href = 'app.html', 1500);
      return;
    }
    me = session.user;
  } catch(e) {
    me = { id: 'master', email: CFG.master };
    console.warn('ì„¸ì…˜ ì—†ìŒ, ê¸°ë³¸ ëª¨ë“œ ë™ì‘:', e.message);
  }
  startAutoApprovalTimer();
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc()]);

  sc.channel('evo-updates')
    .on('postgres_changes', { event:'*', schema:'public', table:'pending_approvals' }, () => loadEvo())
    .subscribe();
  sc.channel('dev-updates')
    .on('postgres_changes', { event:'*', schema:'public', table:'dev_backlog' }, () => loadDev())
    .subscribe();
}

init();
</script>
</body>
</html>
