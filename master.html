<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Sovereign HQ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root{--admin:#ff4d4f;--primary:#007bff;--success:#28a745;--dev:#6f42c1;--dark:#1a1a2e;--warn:#fd7e14;--bg:#f8f9fa}
*{box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;margin:0;background:var(--bg);color:#222}
.wrap{max-width:1050px;margin:0 auto;padding:20px}

/* ë³´ì•ˆë°” */
.sec-bar{background:#111;color:#eee;padding:12px 20px;border-radius:14px;margin-bottom:18px;display:flex;gap:12px;align-items:center;font-size:.85rem;flex-wrap:wrap}
.sec-bar input{flex:1;min-width:180px;padding:6px 12px;background:rgba(255,255,255,.1);border:1px solid #444;color:#fff;border-radius:8px;font-size:.85rem}
.sec-bar input::placeholder{color:#888}
.sec-bar button{padding:6px 14px;background:#ff4d4f;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:.82rem;white-space:nowrap}
.sec-bar .sep{color:#444;font-size:1rem;user-select:none}
.auto-badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700;white-space:nowrap}
.sr-badge{background:#7c3aed;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700;white-space:nowrap}

/* í—¤ë” */
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.hdr h1{margin:0;font-size:1.8rem;letter-spacing:-2px;cursor:pointer}
.hdr small{color:var(--admin);font-weight:700;display:block;font-size:.8rem}
.hdr-btns{display:flex;gap:8px}

/* íƒ­ */
.tabs{display:flex;gap:4px;border-bottom:2px solid #e9ecef;margin-bottom:22px;overflow-x:auto}
.tab{padding:12px 18px;cursor:pointer;font-weight:800;color:#999;border-bottom:4px solid transparent;margin-bottom:-2px;transition:.2s;white-space:nowrap;font-size:.9rem}
.tab.on{color:var(--admin);border-bottom-color:var(--admin)}
.badge{background:var(--admin);color:#fff;border-radius:20px;padding:1px 7px;font-size:.72rem;margin-left:5px;font-weight:700}

/* ê³µí†µ ì»´í¬ë„ŒíŠ¸ */
.card{background:#fff;border:1px solid #eee;padding:18px;border-radius:16px;margin-bottom:14px;border-left:6px solid var(--admin);box-shadow:0 2px 8px rgba(0,0,0,.04)}
.box{background:#f8f9fa;padding:13px;border-radius:10px;font-size:.88rem;border:1px solid #efefef;margin:8px 0;white-space:pre-wrap;line-height:1.6}
.btn{padding:9px 18px;border-radius:10px;border:1px solid #ddd;cursor:pointer;font-weight:700;transition:.2s;background:#fff;font-size:.88rem}
.btn:hover{opacity:.85}
.sm{padding:7px 13px;font-size:.82rem;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:700}
textarea,select{width:100%;padding:13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem;resize:vertical}
.row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
.row>*{flex:1;min-width:150px}
h3{margin:0 0 14px;font-size:1rem;color:#444}
.empty{color:#aaa;font-style:italic;padding:20px;text-align:center}

/* ìƒíƒœ ë±ƒì§€ */
.s-tag{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:700;margin-left:6px}
.s-PENDING{background:#fff3cd;color:#856404}
.s-PENDING_HR{background:#fff3cd;color:#856404}
.s-PENDING_MASTER{background:#e0f2fe;color:#075985}
.s-CONFIRMED{background:#cce5ff;color:#004085}
.s-DEVELOPING{background:#d4edda;color:#155724}
.s-DEPLOYED{background:#d1ecf1;color:#0c5460}
.s-COMPLETED{background:#d1ecf1;color:#0c5460}
.s-RUNNING{background:#e0f2fe;color:#075985}
.s-SUCCEEDED{background:#dcfce7;color:#166534}
.s-APPROVED{background:#d4edda;color:#155724}
.s-REJECTED{background:#f8d7da;color:#721c24}
.s-AUTO_APPROVED{background:#dbeafe;color:#1e40af}
.s-ACTIVE{background:#d4edda;color:#155724}
.s-FIRED{background:#f8d7da;color:#721c24}
.s-UNKNOWN{background:#e5e7eb;color:#374151}
.s-FAILED,.s-BACKUP_FAILED,.s-SYNTAX_ERROR,.s-VALIDATION_ERROR,.s-DEPLOY_FAILED{background:#f8d7da;color:#721c24}

/* ìƒíƒœ í•„í„° + í˜ì´ì§• */
.status-filter-row{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
.status-chip{border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:999px;padding:6px 11px;cursor:pointer;font-size:.8rem;font-weight:700}
.status-chip .cnt{margin-left:5px;color:#94a3b8;font-weight:800}
.status-chip.on{background:#111;color:#fff;border-color:#111}
.status-chip.on .cnt{color:#d1d5db}
.list-summary{font-size:.78rem;color:#94a3b8;margin:0 0 8px}
.list-pager{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-top:10px}
.list-pager .pinfo{font-size:.76rem;color:#64748b;min-width:90px;text-align:center}
.list-pager .pbtn{padding:5px 11px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;font-size:.78rem;font-weight:700;color:#475569}
.list-pager .pbtn:disabled{opacity:.4;cursor:default}
.summary-box{background:#f8fafc}
.role-brief{font-size:.8rem;color:#475569;margin:6px 0 8px}
.ledger-table{width:100%;border-collapse:collapse;font-size:.82rem}
.ledger-table th{background:#f8fafc;padding:9px 10px;text-align:left;font-weight:700;color:#64748b;font-size:.75rem;border-bottom:1px solid #e2e8f0}
.ledger-table td{padding:9px 10px;border-bottom:1px solid #f1f5f9;vertical-align:top}
.ledger-table tr:last-child td{border-bottom:none}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono',monospace;font-size:.75rem}

/* í¬ëŸ¼ */
#forum-box{background:#0d1117;color:#50fa7b;padding:18px;border-radius:14px;font-family:'Courier New',monospace;height:320px;overflow-y:auto;font-size:.82rem;line-height:1.7}
#forum-box .err{color:#ff5555}
#forum-box .warn{color:#ffb86c}
#forum-box .info{color:#8be9fd}

/* ì¹´ìš´íŠ¸ë‹¤ìš´ */
.countdown{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#eee;padding:14px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:14px;font-size:.88rem}
.countdown .timer{font-size:1.4rem;font-weight:900;color:#50fa7b;letter-spacing:1px;min-width:80px}
.countdown .timer.warn{color:#ffb86c}
.countdown .timer.danger{color:#ff5555}

/* ì§„í™” ê²°ì¬ */
.evo-card{background:#fff;border:1px solid #e0e0e0;border-left:6px solid var(--warn);padding:18px;border-radius:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.evo-card .meta{font-size:.78rem;color:#999;margin-bottom:6px}
.evo-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

/* í„ìŠ¤ */
.pulse{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ë‹¤í¬ ë¦¬í¬íŠ¸ */
#hr-content{background:var(--dark);color:#dde;padding:32px;border-radius:18px;min-height:260px;margin-top:14px;line-height:1.8;font-size:.92rem}
#hr-content h1,#hr-content h2,#hr-content h3{color:#7eb8ff}
#hr-content a{color:#50fa7b}

/* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
#toast{position:fixed;bottom:30px;right:30px;background:#222;color:#fff;padding:12px 22px;border-radius:12px;font-size:.88rem;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;max-width:360px;word-break:keep-all}
#toast.show{opacity:1}

/* ë¹„ìš© íƒ­ */
.cost-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.cost-card{background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.cost-label{font-size:.72rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.cost-value{font-size:2rem;font-weight:900;color:#111;line-height:1.1}
.cost-unit{font-size:.78rem;color:#6b7280;margin-top:4px}

/* ì§€ëŠ¥í•˜ë‹¬ */
.directive-section{background:#fff;border:1px solid #eee;border-left:6px solid #333;padding:18px;border-radius:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.directive-section h3{margin:0 0 14px;color:#222}
.mode-tabs{display:flex;gap:6px;margin-bottom:14px}
.mode-tab{padding:7px 16px;border-radius:20px;border:1.5px solid #ddd;background:#fff;font-size:.82rem;font-weight:700;cursor:pointer;transition:.15s;color:#666}
.mode-tab.on{background:#111;color:#fff;border-color:#111}
.char-count{font-size:.75rem;color:#aaa;text-align:right;margin-top:-8px;margin-bottom:8px}
.char-count.warn{color:#f59e0b;font-weight:700}
.char-count.over{color:#ef4444;font-weight:700}
.one-rule-warn{background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.82rem;color:#c2410c;margin-bottom:10px;display:none}
.one-rule-warn.show{display:block}

/* íšŒì› ê´€ë¦¬ */
.member-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.member-stat-card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.member-stat-label{font-size:.7rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.member-stat-value{font-size:1.8rem;font-weight:900;color:#111}
.member-stat-unit{font-size:.75rem;color:#6b7280;margin-top:3px}
.signup-control{background:#fff;border:1px solid #eee;border-left:6px solid #10b981;border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.signup-status-row{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.signup-status-badge{padding:6px 18px;border-radius:20px;font-size:.88rem;font-weight:800}
.signup-status-badge.open{background:#dcfce7;color:#15803d}
.signup-status-badge.closed{background:#fee2e2;color:#b91c1c}
.signup-status-badge.auto-closed{background:#fef9c3;color:#854d0e}
.signup-lever-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.lever-card{background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:14px}
.lever-label{font-size:.72rem;font-weight:700;color:#64748b;letter-spacing:.5px;margin-bottom:8px;text-transform:uppercase}
.lever-value{font-size:1rem;font-weight:800;color:#0f172a;margin-bottom:8px}
.lever-btns{display:flex;gap:6px}
.member-table-wrap{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.member-table{width:100%;border-collapse:collapse;font-size:.84rem}
.member-table th{background:#f8fafc;padding:10px 14px;text-align:left;font-weight:700;color:#64748b;font-size:.76rem;letter-spacing:.5px;text-transform:uppercase;border-bottom:2px solid #e2e8f0}
.member-table td{padding:11px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.member-table tr:last-child td{border-bottom:none}
.member-table tr:hover td{background:#f8fafc}
.user-email{font-weight:600;color:#1e293b}
.user-date{color:#94a3b8;font-size:.78rem}
.ban-badge{padding:3px 10px;border-radius:20px;font-size:.74rem;font-weight:700}
.ban-badge.active{background:#dcfce7;color:#15803d}
.ban-badge.banned{background:#fee2e2;color:#b91c1c}
.ban-btn{padding:5px 12px;border-radius:8px;border:none;font-size:.78rem;font-weight:700;cursor:pointer;transition:.15s}
.ban-btn.do-ban{background:#fee2e2;color:#b91c1c}
.ban-btn.do-unban{background:#dcfce7;color:#15803d}
.ban-btn:hover{opacity:.8}
.sr-warn{background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:12px 16px;font-size:.84rem;color:#92400e;margin-bottom:14px;display:none}
.sr-warn.show{display:block}

/* â•â• ì¸ì‚¬(STAFF) íƒ­ â•â• */
.hr-staff-section{background:#fff;border:1px solid #eee;border-left:6px solid #f97316;border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.hr-staff-section h3{margin:0 0 14px;color:#222;font-size:1rem}
.staff-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px;margin-bottom:16px}
.staff-card{background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:14px}
.staff-card.fired{opacity:.55;background:#fff5f5;border-color:#fecaca}
.staff-role-badge{display:inline-block;font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:20px;margin-bottom:8px}
.staff-name{font-size:.92rem;font-weight:800;color:#0f172a;margin-bottom:3px}
.staff-title{font-size:.78rem;color:#64748b;margin-bottom:10px}
.staff-btn{padding:5px 11px;border-radius:8px;border:none;font-size:.76rem;font-weight:700;cursor:pointer}
.staff-fire-btn{background:#fee2e2;color:#b91c1c}
.staff-fire-btn:hover{background:#fecaca}
.hr-proposal-card{background:#fff;border:1px solid #e0e0e0;border-left:6px solid #f59e0b;padding:16px;border-radius:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.hr-proposal-card.master-pending{border-left-color:#3b82f6}
.hr-proposal-type{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:700;margin-right:6px}
.hr-proposal-type.HIRE{background:#dcfce7;color:#15803d}
.hr-proposal-type.FIRE{background:#fee2e2;color:#b91c1c}
.hr-proposal-reason{font-size:.84rem;color:#475569;line-height:1.6;background:#f8fafc;padding:10px 12px;border-radius:8px;margin:8px 0}
.auto-approve-note{font-size:.75rem;color:#6b7280;margin-top:6px}

/* â•â• ì‚¬ì´íŠ¸ ì •ì±… íƒ­ â•â• */
.agent-sites-section{background:#fff;border:1px solid #eee;border-left:6px solid #7c3aed;border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.site-agent-card{background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:14px;padding:16px;margin-bottom:12px}
.site-agent-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.site-agent-role{font-size:.82rem;font-weight:800;padding:4px 12px;border-radius:20px}
.site-table{width:100%;border-collapse:collapse;font-size:.8rem;margin-bottom:10px}
.site-table th{background:#f1f5f9;padding:7px 10px;text-align:left;font-weight:700;color:#64748b;font-size:.73rem;border-bottom:1px solid #e2e8f0}
.site-table td{padding:7px 10px;border-bottom:1px solid #f1f5f9;vertical-align:top}
.site-url{color:#2563eb;font-size:.78rem;word-break:break-all}
.site-policy-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:700}
.site-policy-badge.allow{background:#dcfce7;color:#15803d}
.site-policy-badge.deny{background:#fee2e2;color:#b91c1c}
.site-policy-badge.limit{background:#fef9c3;color:#854d0e}
.site-add-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.site-add-row input{flex:1;min-width:140px;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.82rem;font-family:inherit}
.site-add-row select{width:auto;padding:8px 12px;margin:0;font-size:.82rem}
.site-add-btn{padding:8px 14px;background:#7c3aed;color:#fff;border:none;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer}
.site-remove-btn{padding:3px 8px;background:#fee2e2;color:#b91c1c;border:none;border-radius:6px;font-size:.72rem;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">

  <!-- â”€â”€ ë³´ì•ˆë°” â”€â”€ -->
  <div class="sec-bar">
    <span>ğŸ”’ <b>Auth Center</b></span>
    <input type="password" id="ghp-token" placeholder="ghp_... GitHub PAT">
    <button onclick="saveToken()">GHP ì €ì¥</button>
    <span id="token-status" style="color:#aaa">GHP ë¯¸ì…ë ¥</span>
    <span class="sep">â”‚</span>
    <input type="password" id="sr-key-input" placeholder="eyJ... Supabase service_role key">
    <button onclick="saveSrKey()" style="background:#7c3aed">SR ì €ì¥</button>
    <span id="sr-status" style="color:#aaa">SR ë¯¸ì…ë ¥</span>
    <span class="auto-badge" id="auto-badge" style="display:none">â± ìë™ìŠ¹ì¸ ON</span>
    <span class="sr-badge"   id="sr-badge"   style="display:none">ğŸ”‘ SR í™œì„±í™”</span>
  </div>

  <!-- í—¤ë” -->
  <div class="hdr">
    <div>
      <h1 onclick="location.href='index.html'">Sovereign HQ</h1>
      <small>v21.0 Â· <span id="now-time"></span></small>
    </div>
    <div class="hdr-btns">
      <button class="btn" onclick="location.href='index.html'">ğŸŒ í™ˆ</button>
      <button class="btn" onclick="location.href='app.html'">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn" onclick="refreshAll()" style="background:#111;color:#fff;border:none">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- íƒ­ -->
  <div class="tabs">
    <div id="t-hr"     class="tab on" onclick="tab('hr')">ğŸ•µï¸ ì „ëµ</div>
    <div id="t-evo"    class="tab"    onclick="tab('evo')">ğŸ§  ì§€ëŠ¥ <span class="badge" id="evo-cnt" style="display:none">0</span></div>
    <div id="t-dev"    class="tab"    onclick="tab('dev')">ğŸ› ï¸ ê°œë°œ <span class="badge" id="dev-cnt" style="display:none">0</span></div>
    <div id="t-staff"  class="tab"    onclick="tab('staff')">ğŸ‘¤ ì¸ì‚¬ <span class="badge" id="staff-cnt" style="display:none">0</span></div>
    <div id="t-sites"  class="tab"    onclick="tab('sites')">ğŸŒ ì‚¬ì´íŠ¸</div>
    <div id="t-member" class="tab"    onclick="tab('member')">ğŸ‘¥ íšŒì›</div>
    <div id="t-log"    class="tab"    onclick="tab('log')">ğŸ“‹ í¬ëŸ¼</div>
    <div id="t-voc"    class="tab"    onclick="tab('voc')">ğŸ’¬ VOC</div>
    <div id="t-cost"   class="tab"    onclick="tab('cost')">ğŸ’° ë¹„ìš©</div>
  </div>

  <!-- â‘  ì „ëµ íƒ­ -->
  <div id="v-hr">
    <div class="row" style="align-items:center;margin-bottom:14px">
      <h3 style="margin:0">ğŸ“… ë§ˆìŠ¤í„° ë¦¬í¬íŠ¸</h3>
      <select id="hr-date" onchange="loadHrReport()" style="margin:0;max-width:200px"></select>
    </div>
    <div id="hr-content">ë¡œë“œ ì¤‘...</div>
  </div>

  <!-- â‘¡ ì§€ëŠ¥ íƒ­ -->
  <div id="v-evo" style="display:none">
    <div class="countdown">
      <div>
        <div style="font-weight:700;margin-bottom:2px">â³ 23:30 ìë™ìŠ¹ì¸ê¹Œì§€</div>
        <div style="font-size:.78rem;color:#aaa">ë¯¸ê²° ì•ˆê±´ì€ ìë™ìœ¼ë¡œ APPROVED ì²˜ë¦¬ë©ë‹ˆë‹¤</div>
      </div>
      <div class="timer" id="countdown-timer">--:--:--</div>
    </div>
    <div class="directive-section">
      <h3>âœï¸ ì§€ëŠ¥ í•˜ë‹¬</h3>
      <div class="mode-tabs">
        <button class="mode-tab on" id="mode-single" onclick="setDirectiveMode('single')">ğŸ¯ ê°œë³„ ì—ì´ì „íŠ¸</button>
        <button class="mode-tab"    id="mode-all"    onclick="setDirectiveMode('all')">ğŸ“¢ ì „ì²´ ë™ì‹œ í•˜ë‹¬</button>
      </div>
      <div id="directive-single">
        <select id="m-role" style="margin:0 0 10px"><option value="">â³ ì—ì´ì „íŠ¸ ë¡œë”© ì¤‘...</option></select>
      </div>
      <div id="directive-all" style="display:none;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.84rem;color:#92400e;margin-bottom:10px;">
        ğŸ“¢ ì•„ë˜ ì§€ì¹¨ì´ <b>í˜„ì¬ ë“±ë¡ëœ ëª¨ë“  ì—ì´ì „íŠ¸</b>ì—ê²Œ ë™ì‹œ ì ìš©ë©ë‹ˆë‹¤.
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="append" checked> â• ê¸°ì¡´ ì§€ì¹¨ì— ì¶”ê°€
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="replace"> ğŸ”„ ê¸°ì¡´ ì§€ì¹¨ ëŒ€ì²´
        </label>
      </div>
      <div class="one-rule-warn" id="one-rule-warn">
        âš ï¸ ì§€ì¹¨ì€ <b>1ê°œ ì•ˆê±´ë§Œ</b> ì…ë ¥í•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ ë‚´ìš©ì„ ë™ì‹œì— ì…ë ¥í•˜ë©´ ë°˜ì˜ íš¨ê³¼ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.
      </div>
      <textarea id="m-text" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ì§ì ‘ ì§€ì¹¨ì„ í•˜ë‹¬í•˜ì„¸ìš”." oninput="onDirectiveInput(this)"></textarea>
      <div class="char-count" id="char-count">0ì</div>
      <button class="btn" style="background:#111;color:#fff;border:none;width:100%" onclick="sendDirectOrder()">âš¡ ì¦‰ì‹œ í•˜ë‹¬ (ë°”ë¡œ ì ìš©)</button>
    </div>
    <div id="evo-status-filters" class="status-filter-row"></div>
    <div id="pending-evo-list"></div>
    <div id="live-agent-list"></div>
  </div>

  <!-- â‘¢ ê°œë°œ íƒ­ -->
  <div id="v-dev" style="display:none">
    <div class="card" style="border-left-color:var(--dev);background:#f5f0ff">
      <h3>ğŸ› ï¸ ìƒˆ ê°œë°œ ì•ˆê±´ ë“±ë¡</h3>
      <input id="d-title" placeholder="ì•ˆê±´ ì œëª©" style="width:100%;padding:11px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-size:.9rem;font-family:inherit">
      <textarea id="d-task" rows="4" placeholder="ìš”êµ¬ì‚¬í•­ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”."></textarea>
      <button class="btn" style="background:var(--dev);color:#fff;border:none;width:100%" onclick="addDev()">ğŸ“‹ ë°±ë¡œê·¸ ë“±ë¡</button>
    </div>
    <div id="dev-status-filters" class="status-filter-row"></div>
    <div id="dev-list"></div>
    <div class="card" style="border-left-color:#111">
      <h3>ğŸ§¾ ë¦´ë¦¬ì¦ˆ ì´ë ¥</h3>
      <div id="release-ledger-status-filters" class="status-filter-row"></div>
      <div id="release-ledger-box"><div class="empty">ë¦´ë¦¬ì¦ˆ ì´ë ¥ ë¡œë“œ ì¤‘...</div></div>
    </div>
  </div>

  <!-- â‘£ ì¸ì‚¬ íƒ­ (NEW) -->
  <div id="v-staff" style="display:none">
    <div class="hr-staff-section">
      <h3>ğŸ‘¥ ì—ì´ì „íŠ¸ë³„ ì§ì› í˜„í™©</h3>
      <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
        <select id="staff-agent-filter" onchange="renderStaffByAgent()" style="margin:0;width:auto;padding:8px 12px">
          <option value="">ì „ì²´ ì—ì´ì „íŠ¸</option>
        </select>
        <button class="btn" style="background:#f97316;color:#fff;border:none;padding:8px 16px" onclick="openAddStaffModal()">+ ì§ì› ì¶”ê°€</button>
      </div>
      <div id="staff-grid-wrap">ë¡œë“œ ì¤‘...</div>
    </div>
    <div class="hr-staff-section" style="border-left-color:#3b82f6">
      <h3>ğŸ“‹ HR ì¸ì‚¬ ì œì•ˆ ê²°ì¬í•¨</h3>
      <div style="font-size:.82rem;color:#64748b;margin-bottom:12px">
        BRIEF ì—ì´ì „íŠ¸ê°€ ì±„ìš©/í•´ê³ ë¥¼ ì œì•ˆ â†’ HR ê²€í†  â†’ ë§ˆìŠ¤í„° ìµœì¢… ê²°ì¬ (ë¯¸ê²° ì‹œ 23:30 ìë™ìŠ¹ì¸)
      </div>
      <div class="status-filter-row" id="hr-prop-filter-row">
        <span class="status-chip on"  data-f="ALL"            onclick="setHrFilter('ALL',this)">ì „ì²´ <span class="cnt" id="hf-all">0</span></span>
        <span class="status-chip"     data-f="PENDING_HR"     onclick="setHrFilter('PENDING_HR',this)">HR ê²€í† ì¤‘ <span class="cnt" id="hf-hr">0</span></span>
        <span class="status-chip"     data-f="PENDING_MASTER" onclick="setHrFilter('PENDING_MASTER',this)">ë§ˆìŠ¤í„° ê²°ì¬ <span class="cnt" id="hf-master">0</span></span>
        <span class="status-chip"     data-f="APPROVED"       onclick="setHrFilter('APPROVED',this)">ìŠ¹ì¸ <span class="cnt" id="hf-approved">0</span></span>
        <span class="status-chip"     data-f="AUTO_APPROVED"  onclick="setHrFilter('AUTO_APPROVED',this)">ìë™ìŠ¹ì¸ <span class="cnt" id="hf-auto">0</span></span>
        <span class="status-chip"     data-f="REJECTED"       onclick="setHrFilter('REJECTED',this)">ë°˜ë ¤ <span class="cnt" id="hf-rejected">0</span></span>
      </div>
      <div id="hr-proposal-list">ë¡œë“œ ì¤‘...</div>
    </div>
  </div>

  <!-- â‘¤ ì‚¬ì´íŠ¸ ì •ì±… íƒ­ (NEW) -->
  <div id="v-sites" style="display:none">
    <div class="agent-sites-section">
      <h3>ğŸŒ ì—ì´ì „íŠ¸ ì½˜í…ì¸  ìˆ˜ì§‘ ì‚¬ì´íŠ¸ & ì •ì±…</h3>
      <div style="font-size:.82rem;color:#64748b;margin-bottom:16px">ê° ì—ì´ì „íŠ¸ê°€ ë‰´ìŠ¤/ì½˜í…ì¸ ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì‚¬ì´íŠ¸ ëª©ë¡ê³¼ í—ˆìš©/ì°¨ë‹¨ ì •ì±…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
      <div id="agent-sites-list">ë¡œë“œ ì¤‘...</div>
    </div>
  </div>

  <!-- â‘¥ íšŒì› íƒ­ -->
  <div id="v-member" style="display:none">
    <div class="sr-warn" id="sr-warn-member">
      ğŸ”‘ ì¼ë¶€ ê¸°ëŠ¥(ê°œë³„ ì°¨ë‹¨/í•´ì œ)ì€ <b>service_role í‚¤</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
      ìœ„ ë³´ì•ˆë°”ì—ì„œ SR í‚¤ë¥¼ ì €ì¥í•˜ë©´ ëª¨ë“  ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
    </div>
    <div class="member-stat-grid">
      <div class="member-stat-card" style="border-top:3px solid #2563eb">
        <div class="member-stat-label">í˜„ì¬ íšŒì› ìˆ˜</div>
        <div class="member-stat-value" id="m-cur-count">â€”</div>
        <div class="member-stat-unit">ëª…</div>
      </div>
      <div class="member-stat-card" style="border-top:3px solid #7c3aed">
        <div class="member-stat-label">ìµœëŒ€ í—ˆìš©</div>
        <div class="member-stat-value" id="m-max-count">â€”</div>
        <div class="member-stat-unit">ëª…</div>
      </div>
      <div class="member-stat-card" style="border-top:3px solid #10b981">
        <div class="member-stat-label">ê°€ì… ìƒíƒœ</div>
        <div class="member-stat-value" id="m-auth-status" style="font-size:1.1rem">â€”</div>
        <div class="member-stat-unit">Supabase Auth</div>
      </div>
    </div>
    <div class="signup-control">
      <h3>ğŸšï¸ ê°€ì… ì œì–´ (ë ˆë²„ 2ê°œ)</h3>
      <p style="font-size:.82rem;color:#64748b;margin:-6px 0 14px">ë‘ ë ˆë²„ ëª¨ë‘ í—ˆìš©ì¼ ë•Œë§Œ ì‹¤ì œë¡œ ê°€ì…ì´ ì—´ë¦½ë‹ˆë‹¤.</p>
      <div class="signup-lever-row">
        <div class="lever-card">
          <div class="lever-label">ë ˆë²„ 1 â€” ìˆ˜ë™ ì œì–´</div>
          <div class="lever-value" id="lever1-val">ë¡œë”© ì¤‘...</div>
          <div class="lever-btns">
            <button class="sm" style="background:#10b981" onclick="setSignupStatus(true)">âœ… í—ˆìš©</button>
            <button class="sm" style="background:#ef4444" onclick="setSignupStatus(false)">ğŸ”’ ì œí•œ</button>
          </div>
        </div>
        <div class="lever-card">
          <div class="lever-label">ë ˆë²„ 2 â€” ìµœëŒ€ íšŒì› ìˆ˜</div>
          <div class="lever-value" id="lever2-val">ë¡œë”© ì¤‘...</div>
          <div style="display:flex;gap:6px;align-items:center">
            <input id="m-max-input" type="number" min="1" max="99999" placeholder="ì˜ˆ: 100"
                   style="width:90px;padding:6px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:.88rem;font-family:inherit">
            <button class="sm" style="background:#2563eb" onclick="saveMaxMembers()">ì €ì¥</button>
          </div>
        </div>
      </div>
      <div class="signup-status-row">
        <span style="font-size:.88rem;font-weight:700;color:#475569">ì‹¤ì œ Supabase Auth ìƒíƒœ:</span>
        <span class="signup-status-badge" id="signup-status-badge">í™•ì¸ ì¤‘...</span>
        <button class="btn" style="padding:6px 14px;font-size:.82rem" onclick="loadMemberSettings()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div class="card" style="border-left-color:#2563eb">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <h3 style="margin:0">ğŸ‘¤ íšŒì› ëª©ë¡</h3>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="member-search" placeholder="ì´ë©”ì¼ ê²€ìƒ‰..."
                 style="padding:6px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:.84rem;font-family:inherit;width:200px"
                 oninput="filterMembers()">
          <button class="sm" style="background:#475569" onclick="loadMemberList()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <div class="member-table-wrap" id="member-table-wrap">
        <div class="empty">SR í‚¤ë¥¼ ì €ì¥ í›„ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ í´ë¦­í•˜ì„¸ìš”.</div>
      </div>
    </div>
  </div>

  <!-- â‘¦ í¬ëŸ¼ íƒ­ -->
  <div id="v-log" style="display:none">
    <div id="forum-box"><span style="color:#8be9fd"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸</span><br>ë¡œë”© ì¤‘...</div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" onclick="loadLogs()">ğŸ”„ ë¡œê·¸ ê°±ì‹ </button>
      <button class="btn" style="background:#111;color:#fff;border:none" onclick="triggerRun()">ğŸš€ ì¦‰ì‹œ ì‹œìŠ¤í…œ ê°€ë™</button>
    </div>
  </div>

  <!-- â‘§ VOC íƒ­ -->
  <div id="v-voc" style="display:none">
    <div class="row" style="margin-bottom:14px">
      <h3 style="margin:0">ğŸ’¬ ì‚¬ìš©ì í”¼ë“œë°± (VOC)</h3>
      <button class="btn" onclick="loadVoc()">ğŸ”„ ê°±ì‹ </button>
    </div>
    <div id="voc-list"></div>
  </div>

  <!-- â‘¨ ë¹„ìš© íƒ­ -->
  <div id="v-cost" style="display:none">
    <h3>ğŸ’° API ë¹„ìš© í˜„í™©</h3>
    <div class="cost-grid">
      <div class="cost-card"><div class="cost-label">ì˜¤ëŠ˜ í† í°</div><div class="cost-value" id="c-tokens">â€”</div><div class="cost-unit">tokens</div></div>
      <div class="cost-card"><div class="cost-label">ì˜¤ëŠ˜ ë¹„ìš©(ì¶”ì •)</div><div class="cost-value" id="c-cost">â€”</div><div class="cost-unit">USD</div></div>
      <div class="cost-card"><div class="cost-label">ì´ë²ˆë‹¬ ëˆ„ì </div><div class="cost-value" id="c-month">â€”</div><div class="cost-unit">USD</div></div>
      <div class="cost-card"><div class="cost-label">DB rows</div><div class="cost-value" id="c-rows">â€”</div><div class="cost-unit">rows</div></div>
    </div>
    <div id="c-breakdown">ë¡œë“œ ì¤‘...</div>
    <div id="c-row-detail" style="margin-top:14px"></div>
  </div>
</div><!-- /wrap -->

<!-- ì§ì› ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-staff-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:18px;padding:28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <h3 style="margin:0 0 18px">ğŸ‘¤ ì§ì› ì¶”ê°€ (BRIEF ì œì•ˆ)</h3>
    <select id="add-staff-agent" style="margin-bottom:10px"><option value="">ì—ì´ì „íŠ¸ ì„ íƒ...</option></select>
    <input type="text" id="add-staff-name" placeholder="ì§ì› ì´ë¦„ (ì˜ˆ: ê¹€ë¯¼ì¤€)"
           style="width:100%;padding:11px 13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem">
    <input type="text" id="add-staff-title" placeholder="ì§ì±… (ì˜ˆ: ì„ ì„ ë¦¬ì„œì²˜)"
           style="width:100%;padding:11px 13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem">
    <textarea id="add-staff-reason" rows="3" placeholder="ì±„ìš© ì œì•ˆ ì‚¬ìœ ..." style="margin-bottom:10px"></textarea>
    <div style="display:flex;gap:8px">
      <button class="btn" style="flex:1;background:#111;color:#fff;border:none" onclick="submitStaffHireProposal()">ğŸ“¤ HRì— ì œì•ˆ</button>
      <button class="btn" style="flex:1" onclick="closeAddStaffModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
<div id="login-overlay" style="display:none;position:fixed;inset:0;background:#0f172a;z-index:9999;align-items:center;justify-content:center;flex-direction:column">
  <div style="background:#1e293b;border-radius:20px;padding:40px 36px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <div style="text-align:center;margin-bottom:28px">
      <div style="font-size:2.5rem;margin-bottom:10px">ğŸ”’</div>
      <div style="font-size:1.3rem;font-weight:800;color:#fff;letter-spacing:-0.5px">Sovereign HQ</div>
      <div style="font-size:.82rem;color:#94a3b8;margin-top:4px">ë§ˆìŠ¤í„° ì „ìš© ëŒ€ì‹œë³´ë“œ</div>
    </div>
    <div id="login-error" style="display:none;background:#fee2e2;color:#b91c1c;border-radius:8px;padding:10px 14px;font-size:.83rem;margin-bottom:14px;font-weight:600"></div>
    <input id="login-email" type="email" placeholder="ì´ë©”ì¼"
      style="width:100%;padding:13px 16px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:.95rem;font-family:inherit;margin-bottom:10px;outline:none"
      onkeydown="if(event.key==='Enter')document.getElementById('login-pw').focus()">
    <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
      style="width:100%;padding:13px 16px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:.95rem;font-family:inherit;margin-bottom:18px;outline:none"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()" id="login-btn"
      style="width:100%;padding:14px;background:#ef4444;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit">
      ë¡œê·¸ì¸
    </button>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CFG / Supabase ì´ˆê¸°í™”
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CFG = {
  url:          'https://zrlpwmpbrvohautldcon.supabase.co',
  key:          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybHB3bXBicnZvaGF1dGxkY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjk3NjQsImV4cCI6MjA4NjgwNTc2NH0.Ox5OZh1jJuhxUMd8zcLph08B5fERgNExAZfYZ24anJk',
  service_role: '',
  master:       'positivecha@gmail.com',
  owner:        'fitzcha',
  repo:         'newsbot',
  workflow:     'daily_run.yml',
};
const sc = supabase.createClient(CFG.url, CFG.key);
let me = null, autoTimer = null;
let directiveMode = 'single';
let allMembers = [];

/* â”€â”€ ì§€ëŠ¥ íƒ­ ìƒíƒœ â”€â”€ */
let evoPropsAll = [], evoStatusFilter = 'PENDING', evoPage = 1;
let evoAgentsAll = [], evoAgentPage = 1;
const EVO_PAGE_SIZE = 6, EVO_AGENT_PAGE_SIZE = 6;
const EVO_STATUS_BASE = ['ALL','PENDING','APPROVED','REJECTED'];

/* â”€â”€ ê°œë°œ íƒ­ ìƒíƒœ â”€â”€ */
let devRowsAll = [], devStatusFilter = 'ALL', devPage = 1;
const DEV_PAGE_SIZE = 6;
const DEV_STATUS_BASE = ['ALL','PENDING','PENDING_MASTER','CONFIRMED','DEVELOPING','COMPLETED','DEPLOYED','FAILED','REJECTED'];

/* â”€â”€ ë¦´ë¦¬ì¦ˆ ì´ë ¥ ìƒíƒœ â”€â”€ */
let releaseLedgerAll = [], releaseStatusFilter = 'ALL', releasePage = 1;
const RELEASE_PAGE_SIZE = 8;
const RELEASE_STATUS_BASE = ['ALL','RUNNING','SUCCEEDED','FAILED','UNKNOWN'];

/* â”€â”€ ì¸ì‚¬ íƒ­ ìƒíƒœ â”€â”€ */
let staffAll = [], hrProposalsAll = [], hrFilter = 'ALL';

/* â”€â”€ ì‚¬ì´íŠ¸ íƒ­ ìƒíƒœ â”€â”€ */
let sitesData = {};

const ROLE_COLORS = {BA:'#2563eb',STOCK:'#0891b2',PM:'#7c3aed',HR:'#f97316',BRIEF:'#10b981',KW:'#8b5cf6',DATA:'#f59e0b',INFO:'#06b6d4',DEV:'#64748b',QA:'#ec4899'};

const STATUS_KO = {
  ALL:'ì „ì²´', PENDING:'ëŒ€ê¸°', PENDING_HR:'HRê²€í† ì¤‘', PENDING_MASTER:'ë§ˆìŠ¤í„°ê²°ì¬',
  CONFIRMED:'í™•ì •', DEVELOPING:'ë°°í¬ì¤‘', COMPLETED:'ì™„ë£Œ', DEPLOYED:'ë°°í¬ì™„ë£Œ',
  RUNNING:'ì§„í–‰ì¤‘', SUCCEEDED:'ì„±ê³µ', UNKNOWN:'ì•Œìˆ˜ì—†ìŒ',
  APPROVED:'ìŠ¹ì¸', REJECTED:'ë°˜ë ¤', AUTO_APPROVED:'ìë™ìŠ¹ì¸',
  ACTIVE:'ì¬ì§', FIRED:'í•´ê³ ',
  FAILED:'ì‹¤íŒ¨', BACKUP_FAILED:'ë°±ì—…ì‹¤íŒ¨', SYNTAX_ERROR:'ë¬¸ë²•ì˜¤ë¥˜',
  VALIDATION_ERROR:'ê²€ì¦ì˜¤ë¥˜', DEPLOY_FAILED:'ë°°í¬ì‹¤íŒ¨',
};

const ROLE_BRIEF = {
  BA:'ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ê³¼ ê²½ìŸ êµ¬ë„ë¥¼ í•´ì„í•©ë‹ˆë‹¤.',
  STOCK:'ì‹œì¥ ë°˜ì‘ê³¼ íˆ¬ì ì‹œê·¸ë„ì„ ë¶„ì„í•©ë‹ˆë‹¤.',
  PM:'ì„œë¹„ìŠ¤ ê¸°íš ìš°ì„ ìˆœìœ„ì™€ ì‹¤í–‰ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.',
  HR:'ì¡°ì§ ìš´ì˜ê³¼ ì¸ì‚¬/ë¬¸í™” ê´€ì ì„ ì ê²€í•©ë‹ˆë‹¤.',
  DEV:'ê°œë°œ êµ¬í˜„ê³¼ ë°°í¬ ì•ˆì •ì„±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.',
  QA:'í’ˆì§ˆ ë¦¬ìŠ¤í¬ë¥¼ ì‚¬ì „ ê²€ì¦í•©ë‹ˆë‹¤.',
  BRIEF:'í•µì‹¬ ë¸Œë¦¬í•‘ì„ ì§§ê³  ëª…í™•í•˜ê²Œ ìš”ì•½í•©ë‹ˆë‹¤.',
  KW:'í‚¤ì›Œë“œ í™•ì¥/ì •ì œë¥¼ í†µí•´ íƒì§€ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.',
  DATA:'ë°ì´í„° ìˆ˜ì§‘ í’ˆì§ˆê³¼ ì»¤ë²„ë¦¬ì§€ë¥¼ ê°œì„ í•©ë‹ˆë‹¤.',
  INFO:'ì™¸ë¶€ ì •ë³´ì˜ ë§¥ë½ê³¼ ì‹ ë¢°ë„ë¥¼ ë³´ê°•í•©ë‹ˆë‹¤.',
  MASTER:'ì—ì´ì „íŠ¸ ìš´ì˜ì„ ì´ê´„ ì¡°ì •í•©ë‹ˆë‹¤.',
};

/* â”€â”€ ìœ í‹¸ â”€â”€ */
function toast(msg, dur=3000) {
  const el=$id('toast'); el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), dur);
}
function $id(id){ return document.getElementById(id); }
function render(id, html){ const el=$id(id); if(el) el.innerHTML=html; }
function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escJsStr(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n').replace(/\r/g,''); }
function statusLabel(s){ return STATUS_KO[s]||s; }
function getSrKey(){ return CFG.service_role||localStorage.getItem('sr_key')||''; }
function hasSrKey(){ return !!getSrKey(); }
function shortSha(v){ const s=String(v||'').trim(); return s?s.slice(0,8):'-'; }
function summarizeText(raw, maxLen=130){
  const txt=String(raw||'').replace(/\[PROPOSAL\]|\[REASON\]|\[NEEDS_DEV\]/gi,' ').replace(/\s+/g,' ').trim();
  if(!txt) return 'ìš”ì•½ ì •ë³´ ì—†ìŒ';
  if(txt.length<=maxLen) return txt;
  const cut=txt.slice(0,maxLen);
  const stop=Math.max(cut.lastIndexOf('. '),cut.lastIndexOf('! '),cut.lastIndexOf('? '),cut.lastIndexOf('ë‹¤.'));
  return (stop>40?cut.slice(0,stop+1):cut)+'â€¦';
}
function withExtraStatuses(base, counts){
  const extras=Object.keys(counts).filter(k=>k!=='ALL'&&!base.includes(k));
  return [...base,...extras];
}
function buildStatusFilterHTML(order, active, counts, clickFn){
  return order.map(st=>`
    <button class="status-chip ${st===active?'on':''}" onclick="${clickFn}('${st}')">
      ${statusLabel(st)} <span class="cnt">${counts[st]||0}</span>
    </button>`).join('');
}
function buildPagerHTML(page, totalPages, totalItems, pageSize, prevFn, nextFn){
  if(totalPages<=1) return '';
  const from=totalItems===0?0:((page-1)*pageSize+1), to=Math.min(page*pageSize,totalItems);
  return `<div class="list-pager">
    <button class="pbtn" onclick="${prevFn}()" ${page<=1?'disabled':''}>â—€ ì´ì „</button>
    <span class="pinfo">${page}/${totalPages} Â· ${from}-${to}</span>
    <button class="pbtn" onclick="${nextFn}()" ${page>=totalPages?'disabled':''}>ë‹¤ìŒ â–¶</button>
  </div>`;
}

/* â”€â”€ í† í° / SR í‚¤ â”€â”€ */
function saveToken(){
  const v=$id('ghp-token').value.trim();
  if(!v) return toast('âŒ GHP í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('ghp_token',v); updateTokenStatus(v); toast('âœ… GHP í† í° ì €ì¥ ì™„ë£Œ');
}
function getToken(){ return localStorage.getItem('ghp_token')||''; }
function updateTokenStatus(t){
  $id('token-status').textContent=t?'âœ… GHP í™œì„±':'âš ï¸ ë¯¸ì…ë ¥';
  $id('token-status').style.color=t?'#50fa7b':'#ffb86c';
}
function saveSrKey(){
  const v=$id('sr-key-input').value.trim();
  if(!v) return toast('âŒ service_role í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('sr_key',v); CFG.service_role=v; updateSrStatus(v); toast('âœ… Service Role í‚¤ ì €ì¥ ì™„ë£Œ');
  $id('sr-warn-member').classList.remove('show');
}
function updateSrStatus(k){
  const has=!!k;
  $id('sr-status').textContent=has?'âœ… SR í™œì„±':'âš ï¸ ë¯¸ì…ë ¥';
  $id('sr-status').style.color=has?'#a78bfa':'#ffb86c';
  $id('sr-badge').style.display=has?'':'none';
}

/* â”€â”€ íƒ­ â”€â”€ */
const ALL_TABS=['hr','evo','dev','staff','sites','member','log','voc','cost'];
function tab(t){
  ALL_TABS.forEach(x=>{
    const v=$id('v-'+x), tb=$id('t-'+x);
    if(v) v.style.display=x===t?'block':'none';
    if(tb) tb.classList.toggle('on',x===t);
  });
  if(t==='cost')   loadCost();
  if(t==='member') loadMemberSettings();
  if(t==='dev')    loadReleaseLedger();
  if(t==='staff')  loadStaffTab();
  if(t==='sites')  loadSitesTab();
  if(t==='log')    loadLogs();
  if(t==='voc')    loadVoc();
}

/* â”€â”€ ì‹œê³„ / ìë™ìŠ¹ì¸ íƒ€ì´ë¨¸ â”€â”€ */
function startClock(){
  const tick=()=>{
    const kst=new Date(Date.now()+(9*60-new Date().getTimezoneOffset())*60000);
    $id('now-time').textContent=kst.toLocaleTimeString('ko-KR');
  };
  tick(); setInterval(tick,1000);
}
function startAutoApprovalTimer(){
  $id('auto-badge').style.display='';
  if(autoTimer) clearInterval(autoTimer);
  autoTimer=setInterval(async()=>{
    const kst=new Date(Date.now()+(9*60-new Date().getTimezoneOffset())*60000);
    const [h,m,s]=[kst.getHours(),kst.getMinutes(),kst.getSeconds()];
    if(h===23&&m===30&&s<5){ await runAutoApproval(); await autoApproveStaffProposals(); return; }
    let now=h*3600+m*60+s, tgt=23*3600+30*60;
    if(now>=tgt) tgt+=86400;
    let d=tgt-now, rh=Math.floor(d/3600), rm=Math.floor((d%3600)/60), rs=d%60;
    const el=$id('countdown-timer');
    el.textContent=`${String(rh).padStart(2,'0')}:${String(rm).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
    el.className='timer'+(rh<1?(rm<30?' danger':' warn'):'');
  },1000);
}
async function runAutoApproval(){
  try {
    const {data:pending}=await sc.from('pending_approvals').select('*').eq('status','PENDING');
    if(!pending?.length) return;
    for(const p of pending){
      await sc.from('agents').update({instruction:p.proposed_instruction}).eq('agent_role',p.agent_role);
      await sc.from('pending_approvals').update({status:'APPROVED'}).eq('id',p.id);
    }
    toast(`â° 23:30 ìë™ìŠ¹ì¸ ì™„ë£Œ â€” ${pending.length}ê±´ ì ìš©ë¨`);
    loadEvo();
  } catch(e){ console.error('ìë™ìŠ¹ì¸ ì˜¤ë¥˜:',e); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘  ì „ëµ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadHrDates(){
  try {
    const {data,error}=await sc.from('reports').select('report_date').order('report_date',{ascending:false});
    if(error) throw error;
    const dates=[...new Set((data||[]).map(d=>d.report_date))];
    if(!dates.length){ render('hr-content','<div style="color:#aaa;text-align:center;padding:40px">ë¦¬í¬íŠ¸ ì—†ìŒ</div>'); return; }
    render('hr-date',dates.map(d=>`<option value="${d}">${d}</option>`).join(''));
    loadHrReport();
  } catch(e){
    console.error('loadHrDates ì˜¤ë¥˜:', e);
    render('hr-content',`<div style="color:#ef4444;text-align:center;padding:40px">âš ï¸ ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}<br><button onclick="loadHrDates()" style="margin-top:12px;padding:8px 20px;border-radius:8px;border:1px solid #ddd;cursor:pointer">ğŸ”„ ì¬ì‹œë„</button></div>`);
  }
}
async function loadHrReport(){
  const date=$id('hr-date')?.value; if(!date) return;
  try {
    const {data,error}=await sc.from('reports').select('content').eq('report_date',date).order('created_at',{ascending:false}).limit(1).maybeSingle();
    if(error) throw error;
    const c=data?.content; let html='';
    if(c?.hr_proposal)      html+=`<h2>ğŸ‘¤ HR ì œì•ˆ</h2>${marked.parse(c.hr_proposal)}`;
    if(c?.ba_brief)         html+=`<h2>ğŸ” BA ë¶„ì„</h2>${marked.parse(c.ba_brief)}`;
    if(c?.pm_brief)         html+=`<h2>ğŸ—‚ PM ë¸Œë¦¬í•‘</h2>${marked.parse(c.pm_brief)}`;
    if(c?.securities_brief) html+=`<h2>ğŸ“ˆ ì¦ê¶Œ ì¸ì‚¬ì´íŠ¸</h2>${marked.parse(c.securities_brief)}`;
    if(c?.by_keyword) Object.entries(c.by_keyword).forEach(([kw,kd])=>{
      html+=`<h2># ${kw}</h2>`;
      if(kd?.ba_brief?.summary)         html+=`<p><b>BA:</b> ${escHtml(kd.ba_brief.summary)}</p>`;
      if(kd?.securities_brief?.summary) html+=`<p><b>STOCK:</b> ${escHtml(kd.securities_brief.summary)}</p>`;
      if(kd?.pm_brief?.summary)         html+=`<p><b>PM:</b> ${escHtml(kd.pm_brief.summary)}</p>`;
    });
    render('hr-content',html||'<div style="color:#aaa;text-align:center;padding:40px">ë‚´ìš© ì—†ìŒ</div>');
  } catch(e){ render('hr-content',`<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¡ ì§€ëŠ¥ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setDirectiveMode(mode){
  directiveMode=mode;
  $id('mode-single').classList.toggle('on',mode==='single');
  $id('mode-all').classList.toggle('on',mode==='all');
  $id('directive-single').style.display=mode==='single'?'block':'none';
  $id('directive-all').style.display=mode==='all'?'block':'none';
}
function onDirectiveInput(el){
  const len=el.value.length;
  const cc=$id('char-count');
  cc.textContent=`${len}ì`;
  cc.className='char-count'+(len>300?' over':len>200?' warn':'');
  const multi=/(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  $id('one-rule-warn').classList.toggle('show',multi.test(el.value)&&el.value.length>30);
}
async function loadAgentSelect(){
  try {
    const {data}=await sc.from('agents').select('agent_role').order('agent_role');
    const roles=(data||[]).map(a=>a.agent_role);
    const icons={BA:'ğŸ”',STOCK:'ğŸ“ˆ',PM:'ğŸ—‚',HR:'ğŸ‘¤',DEV:'ğŸ’»',QA:'âœ…',BRIEF:'ğŸ“',KW:'ğŸ”‘',DATA:'ğŸ“‰',INFO:'ğŸŒ'};
    render('m-role',roles.length
      ?roles.map(r=>`<option value="${r}">${icons[r]||'ğŸ¤–'} ${r}</option>`).join('')
      :`<option value="BA">ğŸ” BA</option><option value="STOCK">ğŸ“ˆ STOCK</option><option value="PM">ğŸ—‚ PM</option>`
    );
  } catch { render('m-role','<option value="BA">ğŸ” BA</option>'); }
}
async function sendDirectOrder(){
  const text=$id('m-text').value.trim();
  if(!text) return toast('âŒ ì§€ì¹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
  const multi=/(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  if(multi.test(text)&&text.length>30&&!confirm('âš ï¸ ì—¬ëŸ¬ ì•ˆê±´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const applyMode=document.querySelector('input[name="apply-mode"]:checked').value;
  try {
    if(directiveMode==='single'){
      const role=$id('m-role').value;
      if(!role) return toast('âŒ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      await applyDirective(role,text,applyMode);
      toast(`âš¡ ${role} ì—ì´ì „íŠ¸ ì§€ì¹¨ í•˜ë‹¬ ì™„ë£Œ`);
    } else {
      const {data:agents}=await sc.from('agents').select('agent_role, instruction');
      if(!agents?.length) return toast('âŒ ë“±ë¡ëœ ì—ì´ì „íŠ¸ ì—†ìŒ');
      if(!confirm(`ğŸ“¢ ${agents.length}ëª… ì „ì²´ì—ê²Œ í•˜ë‹¬í•©ë‹ˆë‹¤. ê³„ì†?`)) return;
      for(const a of agents) await applyDirective(a.agent_role,text,applyMode,a.instruction);
      toast(`ğŸ“¢ ì „ì²´ ${agents.length}ê°œ ì—ì´ì „íŠ¸ í•˜ë‹¬ ì™„ë£Œ`);
    }
    $id('m-text').value=''; $id('char-count').textContent='0ì';
    $id('one-rule-warn').classList.remove('show');
    loadEvo();
  } catch(e){ toast('âŒ í•˜ë‹¬ ì‹¤íŒ¨: '+e.message); }
}
async function applyDirective(role,newText,mode,existingInstruction){
  let cur=existingInstruction;
  if(cur===undefined){
    const {data}=await sc.from('agents').select('instruction').eq('agent_role',role).single();
    cur=data?.instruction||'';
  }
  const final=mode==='append'
    ?(cur?cur+'\n\n---\n[ë§ˆìŠ¤í„° ì¶”ê°€ '+new Date().toLocaleDateString('ko-KR')+']\n'+newText:newText)
    :newText;
  const {error}=await sc.from('agents').update({instruction:final}).eq('agent_role',role);
  if(error) throw error;
  await sc.from('pending_approvals').insert([{
    agent_role:role, proposed_instruction:final,
    proposal_reason:`ë§ˆìŠ¤í„° ì§ì ‘ í•˜ë‹¬ (${mode==='append'?'ì¶”ê°€':'ëŒ€ì²´'})`, status:'APPROVED'
  }]);
}
function setEvoStatus(status){ evoStatusFilter=status; evoPage=1; renderEvoProposalList(); }
function evoPrevPage(){ if(evoPage>1){evoPage--;renderEvoProposalList();} }
function evoNextPage(){
  const tp=Math.max(1,Math.ceil(getEvoFilteredProps().length/EVO_PAGE_SIZE));
  if(evoPage<tp){evoPage++;renderEvoProposalList();}
}
function agentPrevPage(){ if(evoAgentPage>1){evoAgentPage--;renderLiveAgentList();} }
function agentNextPage(){
  const tp=Math.max(1,Math.ceil((evoAgentsAll||[]).length/EVO_AGENT_PAGE_SIZE));
  if(evoAgentPage<tp){evoAgentPage++;renderLiveAgentList();}
}
function getEvoFilteredProps(){
  const rows=evoPropsAll||[];
  return evoStatusFilter==='ALL'?rows:rows.filter(p=>(p.status||'PENDING')===evoStatusFilter);
}
function renderEvoStatusFilters(){
  const counts={ALL:(evoPropsAll||[]).length};
  (evoPropsAll||[]).forEach(p=>{ const st=(p.status||'PENDING').toUpperCase(); counts[st]=(counts[st]||0)+1; });
  const order=withExtraStatuses(EVO_STATUS_BASE,counts);
  render('evo-status-filters',buildStatusFilterHTML(order,evoStatusFilter,counts,'setEvoStatus'));
}
function renderEvoProposalList(){
  const filtered=getEvoFilteredProps();
  const totalItems=filtered.length, totalPages=Math.max(1,Math.ceil(totalItems/EVO_PAGE_SIZE));
  if(evoPage>totalPages) evoPage=totalPages; if(evoPage<1) evoPage=1;
  const rows=filtered.slice((evoPage-1)*EVO_PAGE_SIZE,evoPage*EVO_PAGE_SIZE);
  if(!totalItems){ render('pending-evo-list','<h3>ğŸ“„ ì§€ëŠ¥ ë°œì˜ ë¦¬ìŠ¤íŠ¸</h3><div class="empty">ì„ íƒí•œ ìƒíƒœì˜ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }
  render('pending-evo-list',
    `<h3>ğŸ“„ ì§€ëŠ¥ ë°œì˜ ë¦¬ìŠ¤íŠ¸</h3><div class="list-summary">ì´ ${totalItems}ê±´ Â· ìƒíƒœ: ${statusLabel(evoStatusFilter)}</div>`
    +rows.map(p=>{
      const st=(p.status||'PENDING').toUpperCase(), canDecide=st==='PENDING';
      const created=p.created_at?p.created_at.slice(0,16).replace('T',' '):'';
      return `<div class="evo-card">
        <div class="meta">ğŸ¤– ${p.agent_role} Â· ${created} Â· ${escHtml(p.proposal_reason||'ì—ì´ì „íŠ¸ ììœ¨ ì œì•ˆ')}
          <span class="s-tag s-${st}">${statusLabel(st)}</span>
        </div>
        <div class="box summary-box"><b>í•µì‹¬ ìš”ì•½</b><br>${escHtml(summarizeText(p.proposed_instruction,160))}</div>
        <details>
          <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ì „ì²´ ì œì•ˆ ë³´ê¸°</summary>
          <div class="box">${escHtml(p.proposed_instruction||'ë‚´ìš© ì—†ìŒ')}</div>
        </details>
        ${canDecide?`<div class="evo-actions">
          <button class="sm" style="background:var(--success)" onclick="decideEvo('${p.id}','${p.agent_role}','APPROVED')">âœ… ìŠ¹ì¸</button>
          <button class="sm" style="background:var(--admin)"   onclick="decideEvo('${p.id}','${p.agent_role}','REJECTED')">âŒ ë°˜ë ¤</button>
        </div>`:''}
      </div>`;
    }).join('')
    +buildPagerHTML(evoPage,totalPages,totalItems,EVO_PAGE_SIZE,'evoPrevPage','evoNextPage')
  );
}
function renderLiveAgentList(){
  const totalItems=(evoAgentsAll||[]).length;
  const totalPages=Math.max(1,Math.ceil(totalItems/EVO_AGENT_PAGE_SIZE));
  if(evoAgentPage>totalPages) evoAgentPage=totalPages; if(evoAgentPage<1) evoAgentPage=1;
  const rows=(evoAgentsAll||[]).slice((evoAgentPage-1)*EVO_AGENT_PAGE_SIZE,evoAgentPage*EVO_AGENT_PAGE_SIZE);
  render('live-agent-list',
    `<h3>ğŸš€ í˜„ì¬ ê°€ë™ ì¤‘ì¸ ì—ì´ì „íŠ¸ ì§€ì¹¨</h3><div class="list-summary">ì´ ${totalItems}ëª… ì—ì´ì „íŠ¸</div>`
    +(rows.length===0?'<div class="empty">ì—ì´ì „íŠ¸ ì •ë³´ ì—†ìŒ</div>':rows.map(a=>{
      const role=a.agent_role||'UNKNOWN', full=a.instruction||'ì§€ì¹¨ ì—†ìŒ';
      const empCnt=(staffAll||[]).filter(s=>s.agent_role===role&&s.status==='ACTIVE').length;
      return `<div class="card" style="border-left-color:#bbb">
        <strong>ğŸ¤– ${escHtml(role)}</strong>
        <span style="font-size:.75rem;color:#64748b;margin-left:8px">ì§ì› ${empCnt}ëª…</span>
        <div class="role-brief">ì—­í• : ${escHtml(ROLE_BRIEF[role]||'ì—­í•  ì„¤ëª… ì—†ìŒ')}</div>
        <div class="box summary-box"><b>í•µì‹¬ ì§€ì¹¨ ìš”ì•½</b><br>${escHtml(summarizeText(full,150))}</div>
        <details>
          <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ì§€ì¹¨ ì „ì²´ ë³´ê¸°</summary>
          <div class="box">${escHtml(full)}</div>
        </details>
      </div>`;
    }).join(''))
    +buildPagerHTML(evoAgentPage,totalPages,totalItems,EVO_AGENT_PAGE_SIZE,'agentPrevPage','agentNextPage')
  );
}
async function loadEvo(){
  try {
    const [agRes,prRes]=await Promise.all([
      sc.from('agents').select('agent_role, instruction').order('agent_role'),
      sc.from('pending_approvals').select('id,agent_role,proposed_instruction,proposal_reason,created_at,status')
        .order('created_at',{ascending:false}).limit(500)
    ]);
    evoAgentsAll=agRes.data||[];
    evoPropsAll=(prRes.data||[]).map(p=>({...p,status:(p.status||'PENDING').toUpperCase()}));
    const pendingCnt=evoPropsAll.filter(p=>p.status==='PENDING').length;
    $id('evo-cnt').style.display=pendingCnt?'':'none';
    if(pendingCnt) $id('evo-cnt').textContent=pendingCnt;
    renderEvoStatusFilters(); renderEvoProposalList(); renderLiveAgentList();
  } catch(e){ render('pending-evo-list',`<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`); }
}
async function decideEvo(id,role,status){
  try {
    if(status==='APPROVED'){
      const {data:p}=await sc.from('pending_approvals').select('proposed_instruction').eq('id',id).single();
      if(p){ const {error}=await sc.from('agents').update({instruction:p.proposed_instruction}).eq('agent_role',role); if(error) throw error; }
    }
    await sc.from('pending_approvals').update({status}).eq('id',id);
    toast(status==='APPROVED'?`âœ… ${role} ì§€ì¹¨ ìŠ¹ì¸ ì™„ë£Œ`:`âŒ ${role} ì•ˆê±´ ë°˜ë ¤ë¨`);
    loadEvo();
  } catch(e){ toast('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¢ ê°œë°œ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setDevStatus(status){ devStatusFilter=status; devPage=1; renderDevList(); }
function devPrevPage(){ if(devPage>1){devPage--;renderDevList();} }
function devNextPage(){
  const tp=Math.max(1,Math.ceil(getFilteredDevRows().length/DEV_PAGE_SIZE));
  if(devPage<tp){devPage++;renderDevList();}
}
function getFilteredDevRows(){
  const rows=devRowsAll||[];
  return devStatusFilter==='ALL'?rows:rows.filter(r=>(r.status||'PENDING')===devStatusFilter);
}
function renderDevStatusFilters(){
  const counts={ALL:(devRowsAll||[]).length};
  (devRowsAll||[]).forEach(r=>{ const st=(r.status||'PENDING').toUpperCase(); counts[st]=(counts[st]||0)+1; });
  const order=withExtraStatuses(DEV_STATUS_BASE,counts);
  render('dev-status-filters',buildStatusFilterHTML(order,devStatusFilter,counts,'setDevStatus'));
}
function renderDevList(){
  const filtered=getFilteredDevRows();
  const totalItems=filtered.length, totalPages=Math.max(1,Math.ceil(totalItems/DEV_PAGE_SIZE));
  if(devPage>totalPages) devPage=totalPages; if(devPage<1) devPage=1;
  const rows=filtered.slice((devPage-1)*DEV_PAGE_SIZE,devPage*DEV_PAGE_SIZE);
  if(!totalItems){ render('dev-list','<h3>ğŸ“‹ ê°œë°œ ë°±ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</h3><div class="empty">ì„ íƒí•œ ìƒíƒœì˜ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }
  render('dev-list',
    `<h3>ğŸ“‹ ê°œë°œ ë°±ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</h3><div class="list-summary">ì´ ${totalItems}ê±´ Â· ìƒíƒœ: ${statusLabel(devStatusFilter)}</div>`
    +rows.map(b=>{
      const st=(b.status||'PENDING').toUpperCase();
      const created=b.created_at?new Date(b.created_at).toLocaleString('ko-KR'):'';
      let btns='';
      if(st==='PENDING'||st==='PENDING_MASTER'){
        btns=`<button class="sm" style="background:var(--primary)" onclick="upDev('${b.id}','CONFIRMED')">âœ… ê°œë°œ í™•ì •</button>
              <button class="sm" style="background:var(--admin)"   onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>`;
      } else if(st==='CONFIRMED'){
        btns=`<button class="sm" style="background:var(--dev)" onclick="triggerDev('${b.id}')">ğŸš€ ë°°í¬ ì‹œì‘</button>
              <button class="sm" style="background:var(--admin)" onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>`;
      } else if(st==='DEVELOPING'){
        btns=`<span class="pulse" style="color:var(--dev);font-weight:700">â³ AI ë°°í¬ ì¤‘...</span>`;
      } else if(['FAILED','DEPLOY_FAILED','VALIDATION_ERROR','SYNTAX_ERROR','BACKUP_FAILED'].includes(st)){
        btns=`<button class="sm" style="background:#475569" onclick="upDev('${b.id}','CONFIRMED')">ğŸ” ì¬ì‹œë„ ì¤€ë¹„</button>
              <button class="sm" style="background:var(--admin)" onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>`;
      } else if(st==='REJECTED'){
        btns=`<button class="sm" style="background:#475569" onclick="upDev('${b.id}','PENDING')">â†©ï¸ ì¬ì˜¤í”ˆ</button>`;
      } else {
        btns=`<span style="color:var(--success);font-weight:700">âœ… ${statusLabel(st)}</span>`;
      }
      return `<div class="card" style="border-left-color:var(--dev)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
          <div><strong>${escHtml(b.title||'ë¬´ì œ')}</strong><span class="s-tag s-${st}">${statusLabel(st)}</span></div>
          <small style="color:#aaa">${created}</small>
        </div>
        <div class="box summary-box"><b>ìš”ì•½</b><br>${escHtml(summarizeText(b.task_detail||'',150))}</div>
        <details>
          <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ìš”êµ¬ì‚¬í•­ ì „ì²´ ë³´ê¸°</summary>
          <div class="box">${escHtml(b.task_detail||'')}</div>
        </details>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">${btns}</div>
      </div>`;
    }).join('')
    +buildPagerHTML(devPage,totalPages,totalItems,DEV_PAGE_SIZE,'devPrevPage','devNextPage')
  );
}
async function loadDev(){
  try {
    const {data,error}=await sc.from('dev_backlog').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    devRowsAll=(data||[]).map(d=>({...d,status:(d.status||'PENDING').toUpperCase()}));
    const openCnt=devRowsAll.filter(b=>['PENDING','PENDING_MASTER','CONFIRMED','DEVELOPING'].includes(b.status)).length;
    $id('dev-cnt').style.display=openCnt?'':'none';
    if(openCnt) $id('dev-cnt').textContent=openCnt;
    renderDevStatusFilters(); renderDevList();
  } catch(e){ render('dev-list',`<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`); }
}
async function addDev(){
  const title=$id('d-title').value.trim(), task=$id('d-task').value.trim();
  if(!title||!task) return toast('âŒ ì œëª©ê³¼ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').insert([{title,task_detail:task,status:'PENDING',priority:5}]);
    $id('d-title').value=''; $id('d-task').value='';
    toast('ğŸ“‹ ê°œë°œ ì•ˆê±´ ë“±ë¡ ì™„ë£Œ'); loadDev();
  } catch(e){ toast('âŒ ë“±ë¡ ì‹¤íŒ¨: '+e.message); }
}
async function rejectDev(id){ if(!confirm('í•´ë‹¹ ê°œë°œ ì•ˆê±´ì„ ë§ˆìŠ¤í„° ë°˜ë ¤ ì²˜ë¦¬í• ê¹Œìš”?')) return; await upDev(id,'REJECTED'); }
async function upDev(id,status){
  try { await sc.from('dev_backlog').update({status}).eq('id',id); toast(`âœ… ìƒíƒœ ì—…ë°ì´íŠ¸: ${statusLabel(status)}`); loadDev(); }
  catch(e){ toast('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: '+e.message); }
}
async function triggerDev(id){
  const token=getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').update({status:'DEVELOPING'}).eq('id',id);
    const res=await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {method:'POST',headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
       body:JSON.stringify({ref:'main',inputs:{backlog_id:String(id)}})}
    );
    if(res.status===204){ toast('ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!'); setTimeout(loadLogs,3000); }
    else { const e=await res.json().catch(()=>({})); await sc.from('dev_backlog').update({status:'CONFIRMED'}).eq('id',id); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
    loadDev();
  } catch(e){ toast('âŒ ë°°í¬ ì‹¤íŒ¨: '+e.message); }
}

/* â”€â”€ ë¦´ë¦¬ì¦ˆ ì´ë ¥ â”€â”€ */
function setReleaseStatus(status){ releaseStatusFilter=status; releasePage=1; renderReleaseLedger(); }
function releasePrevPage(){ if(releasePage>1){releasePage--;renderReleaseLedger();} }
function releaseNextPage(){
  const tp=Math.max(1,Math.ceil(getFilteredReleaseRows().length/RELEASE_PAGE_SIZE));
  if(releasePage<tp){releasePage++;renderReleaseLedger();}
}
function getFilteredReleaseRows(){
  const rows=releaseLedgerAll||[];
  return releaseStatusFilter==='ALL'?rows:rows.filter(r=>(r.status||'UNKNOWN')===releaseStatusFilter);
}
function renderReleaseStatusFilters(){
  const counts={ALL:(releaseLedgerAll||[]).length};
  (releaseLedgerAll||[]).forEach(r=>{ const st=(r.status||'UNKNOWN').toUpperCase(); counts[st]=(counts[st]||0)+1; });
  const order=withExtraStatuses(RELEASE_STATUS_BASE,counts);
  render('release-ledger-status-filters',buildStatusFilterHTML(order,releaseStatusFilter,counts,'setReleaseStatus'));
}
function renderReleaseLedger(){
  const filtered=getFilteredReleaseRows();
  const totalItems=filtered.length, totalPages=Math.max(1,Math.ceil(totalItems/RELEASE_PAGE_SIZE));
  if(releasePage>totalPages) releasePage=totalPages; if(releasePage<1) releasePage=1;
  const rows=filtered.slice((releasePage-1)*RELEASE_PAGE_SIZE,releasePage*RELEASE_PAGE_SIZE);
  if(!rows.length){ render('release-ledger-box','<div class="empty">ë¦´ë¦¬ì¦ˆ ì´ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }
  const tableRows=rows.map(r=>{
    const status=(r.status||'UNKNOWN').toUpperCase();
    const at=(r.released_at||r.executed_at||'').toString().slice(0,19).replace('T',' ')||'-';
    const runId=r.run_id||'-', branch=r.branch||'-';
    const rawSha=String(r.commit_sha||r.sha||'').trim(), sha=shortSha(rawSha);
    const backlog=r.backlog_id||'-', kind=r.release_type||r.action_type||'N/A';
    const memo=summarizeText(r.note||r.details||'',80);
    const rollbackAction=(status==='SUCCEEDED'&&branch==='main'&&/^[0-9a-f]{7,40}$/i.test(rawSha))
      ?`<button class="sm" style="background:#111" onclick="triggerRollback('${escJsStr(rawSha)}','${escJsStr(String(runId))}')">â†©ï¸ ì´ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±</button>`
      :`<span style="color:#94a3b8;font-size:.76rem">-</span>`;
    return `<tr>
      <td><span class="mono">${at}</span></td>
      <td><span class="s-tag s-${status}">${statusLabel(status)}</span></td>
      <td>${escHtml(kind)}</td>
      <td class="mono">${escHtml(branch)}</td>
      <td class="mono">${escHtml(sha)}</td>
      <td class="mono">${escHtml(String(backlog))}</td>
      <td class="mono">${escHtml(String(runId))}</td>
      <td>${escHtml(memo||'-')}</td>
      <td>${rollbackAction}</td>
    </tr>`;
  }).join('');
  render('release-ledger-box',
    `<div class="list-summary">ì´ ${totalItems}ê±´ Â· ìƒíƒœ: ${statusLabel(releaseStatusFilter)}</div>
     <div style="overflow-x:auto"><table class="ledger-table">
       <thead><tr><th>ì‹œê°</th><th>ìƒíƒœ</th><th>ìœ í˜•</th><th>ë¸Œëœì¹˜</th><th>ì»¤ë°‹</th><th>ë°±ë¡œê·¸</th><th>RUN ID</th><th>ë©”ëª¨</th><th>ì‘ì—…</th></tr></thead>
       <tbody>${tableRows}</tbody>
     </table></div>`
    +buildPagerHTML(releasePage,totalPages,totalItems,RELEASE_PAGE_SIZE,'releasePrevPage','releaseNextPage')
  );
}
async function loadReleaseLedger(){
  try {
    const {data,error}=await sc.from('release_ledger')
      .select('id,release_type,branch,commit_sha,backlog_id,run_id,status,released_at,completed_at,note')
      .order('released_at',{ascending:false}).limit(200);
    if(error) throw error;
    releaseLedgerAll=(data||[]).map(r=>({...r,status:(r.status||'UNKNOWN').toUpperCase()}));
  } catch(e){
    console.warn('release_ledger ì¡°íšŒ ì‹¤íŒ¨, action_logs í´ë°±:',e.message);
    try {
      const {data,error}=await sc.from('action_logs').select('id,action_type,details,executed_at')
        .order('executed_at',{ascending:false}).limit(120);
      if(error) throw error;
      const rows=(data||[]).filter(r=>{
        const at=String(r.action_type||'').toUpperCase(), dt=String(r.details||'');
        return at.includes('DEPLOY')||dt.includes('ë°°í¬');
      });
      releaseLedgerAll=rows.map(r=>{
        const details=String(r.details||'');
        const failed=details.includes('âŒ')||details.toLowerCase().includes('fail');
        return {run_id:'-',release_type:r.action_type||'ACTION_LOG',branch:'-',commit_sha:'',backlog_id:'-',
                status:failed?'FAILED':'SUCCEEDED',released_at:r.executed_at||'',note:details};
      });
    } catch(fbErr){
      releaseLedgerAll=[];
      render('release-ledger-status-filters','');
      render('release-ledger-box',`<div class="empty">ë¦´ë¦¬ì¦ˆ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ${escHtml(fbErr.message)}</div>`);
      return;
    }
  }
  renderReleaseStatusFilters(); renderReleaseLedger();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘£ ì¸ì‚¬(STAFF) íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadStaffTab(){
  try {
    const [sRes,pRes,aRes]=await Promise.all([
      sc.from('brief_employees').select('*').order('hired_at',{ascending:false}),
      sc.from('hr_staff_proposals').select('*').order('created_at',{ascending:false}),
      sc.from('agents').select('agent_role').order('agent_role'),
    ]);
    staffAll=sRes.data||[]; hrProposalsAll=pRes.data||[];
    const roles=(aRes.data||[]).map(a=>a.agent_role);
    const sf=$id('staff-agent-filter');
    if(sf){
      const cur=sf.value;
      sf.innerHTML='<option value="">ì „ì²´ ì—ì´ì „íŠ¸</option>'+roles.map(r=>`<option value="${r}">${r}</option>`).join('');
      sf.value=cur;
    }
    const as=$id('add-staff-agent');
    if(as) as.innerHTML='<option value="">ì—ì´ì „íŠ¸ ì„ íƒ...</option>'+roles.map(r=>`<option value="${r}">${r}</option>`).join('');
    renderStaffByAgent(); renderHrProposals(); updateHrBadgeCounts();
  } catch(e){ toast('âŒ ì¸ì‚¬ íƒ­ ë¡œë“œ ì‹¤íŒ¨: '+e.message); }
}
function renderStaffByAgent(){
  const filter=($id('staff-agent-filter')?.value)||'';
  const list=filter?staffAll.filter(s=>s.agent_role===filter):staffAll;
  if(!list.length){ render('staff-grid-wrap','<div class="empty">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }
  const groups={};
  list.forEach(s=>{ if(!groups[s.agent_role]) groups[s.agent_role]=[]; groups[s.agent_role].push(s); });
  let html='';
  for(const [role,members] of Object.entries(groups)){
    const col=ROLE_COLORS[role]||'#94a3b8';
    html+=`<div style="margin-bottom:20px">
      <div style="font-size:.8rem;font-weight:800;color:${col};letter-spacing:1px;margin-bottom:8px">ğŸ¤– ${escHtml(role)} (${members.length}ëª…)</div>
      <div class="staff-grid">${members.map(s=>`
        <div class="staff-card ${s.status==='FIRED'?'fired':''}">
          <div><span class="staff-role-badge" style="background:${col}22;color:${col}">${escHtml(role)}</span>
            <span class="s-tag s-${s.status||'ACTIVE'}">${s.status==='FIRED'?'í•´ê³ ':'ì¬ì§'}</span>
          </div>
          <div class="staff-name">${escHtml(s.name||'ì´ë¦„ì—†ìŒ')}</div>
          <div class="staff-title">${escHtml(s.role_title||'')}</div>
          <div style="font-size:.74rem;color:#94a3b8;margin-bottom:10px">
            ì…ì‚¬ ${s.hired_at?s.hired_at.slice(0,10):'â€”'}${s.status==='FIRED'&&s.fired_at?` Â· í‡´ì‚¬ ${s.fired_at.slice(0,10)}`:''}
          </div>
          ${s.status!=='FIRED'?`<div><button class="staff-btn staff-fire-btn" onclick="proposeFireStaff('${s.id}','${escJsStr(s.name||'')}','${escJsStr(role)}')">ğŸ”´ í•´ê³  ì œì•ˆ</button></div>`:''}
        </div>`).join('')}
      </div>
    </div>`;
  }
  render('staff-grid-wrap',html);
}
function setHrFilter(f,el){
  hrFilter=f;
  document.querySelectorAll('#hr-prop-filter-row .status-chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  renderHrProposals();
}
function updateHrBadgeCounts(){
  const c={ALL:0,PENDING_HR:0,PENDING_MASTER:0,APPROVED:0,AUTO_APPROVED:0,REJECTED:0};
  hrProposalsAll.forEach(p=>{ const s=(p.status||'PENDING_HR').toUpperCase(); c.ALL++; if(c[s]!==undefined) c[s]++; });
  $id('hf-all').textContent=c.ALL; $id('hf-hr').textContent=c.PENDING_HR;
  $id('hf-master').textContent=c.PENDING_MASTER; $id('hf-approved').textContent=c.APPROVED;
  $id('hf-auto').textContent=c.AUTO_APPROVED; $id('hf-rejected').textContent=c.REJECTED;
  const pending=c.PENDING_HR+c.PENDING_MASTER;
  const badge=$id('staff-cnt');
  if(badge){ badge.textContent=pending; badge.style.display=pending?'':'none'; }
}
function renderHrProposals(){
  const list=hrFilter==='ALL'?hrProposalsAll:hrProposalsAll.filter(p=>(p.status||'PENDING_HR').toUpperCase()===hrFilter);
  if(!list.length){ render('hr-proposal-list','<div class="empty">í•´ë‹¹ ìƒíƒœì˜ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }
  render('hr-proposal-list',list.map(p=>{
    const st=(p.status||'PENDING_HR').toUpperCase();
    const created=p.created_at?p.created_at.slice(0,16).replace('T',' '):'';
    const autoAt=p.auto_approve_at?p.auto_approve_at.slice(0,16).replace('T',' '):'';
    const isMasterPending=st==='PENDING_MASTER', isHrPending=st==='PENDING_HR';
    return `<div class="hr-proposal-card ${isMasterPending?'master-pending':''}">
      <div>
        <span class="hr-proposal-type ${p.proposal_type||'HIRE'}">${p.proposal_type==='FIRE'?'ğŸ”´ í•´ê³  ì œì•ˆ':'ğŸŸ¢ ì±„ìš© ì œì•ˆ'}</span>
        <span style="font-weight:700;font-size:.88rem">${escHtml(p.employee_name||'(ì´ë¦„ì—†ìŒ)')}</span>
        <span style="font-size:.8rem;color:#64748b"> â€” ${escHtml(p.agent_role||'')}</span>
        <span class="s-tag s-${st}">${statusLabel(st)}</span>
      </div>
      <div style="font-size:.78rem;color:#94a3b8;margin:6px 0">ì œì•ˆ: ${created} Â· ë°œì˜: ${escHtml(p.proposer||'BRIEF')}</div>
      <div class="hr-proposal-reason"><b>ì‚¬ìœ :</b> ${escHtml(p.reason||'â€”')}</div>
      ${p.hr_decision?`<div class="hr-proposal-reason" style="background:#f0f9ff;border-left:3px solid #3b82f6"><b>HR ê²€í†  ì˜ê²¬:</b> ${escHtml(p.hr_decision)}</div>`:''}
      ${isHrPending?`<div class="evo-actions">
        <textarea id="hr-opinion-${p.id}" rows="2" placeholder="HR ê²€í†  ì˜ê²¬ ì…ë ¥..." style="width:100%;margin-bottom:6px;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:.82rem;font-family:inherit;resize:vertical"></textarea>
        <button class="sm" style="background:var(--success)" onclick="hrDecide('${p.id}','APPROVED')">âœ… HR ìŠ¹ì¸ â†’ ë§ˆìŠ¤í„° ì „ë‹¬</button>
        <button class="sm" style="background:var(--admin)"   onclick="hrDecide('${p.id}','REJECTED')">âŒ HR ë°˜ë ¤</button>
      </div>`:''}
      ${isMasterPending?`<div class="evo-actions">
        <button class="sm" style="background:var(--success)" onclick="masterDecideStaff('${p.id}','APPROVED')">âœ… ë§ˆìŠ¤í„° ìŠ¹ì¸</button>
        <button class="sm" style="background:var(--admin)"   onclick="masterDecideStaff('${p.id}','REJECTED')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>
      </div>${autoAt?`<div class="auto-approve-note">â° ${autoAt} ì´í›„ ìë™ìŠ¹ì¸</div>`:''}`:''}
    </div>`;
  }).join(''));
}
async function hrDecide(id, decision) {
  const opinion = ($id(`hr-opinion-${id}`)?.value || '').trim();
  if (decision === 'APPROVED' && !opinion) {
    return toast('âŒ HR ê²€í†  ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  }
  try {
    const newStatus = decision === 'APPROVED' ? 'PENDING_MASTER' : 'REJECTED';
    const autoAt = new Date(Date.now() + 23.5 * 3600 * 1000).toISOString();
    await sc.from('hr_staff_proposals').update({
      status:      newStatus,
      hr_decision: opinion || null,
      ...(newStatus === 'PENDING_MASTER' ? { auto_approve_at: autoAt } : {}),
    }).eq('id', id);
    toast(decision === 'APPROVED'
      ? 'âœ… HR ìŠ¹ì¸ â†’ ë§ˆìŠ¤í„° ê²°ì¬ ëŒ€ê¸°ë¡œ ì „ë‹¬'
      : 'âŒ HR ë°˜ë ¤ ì™„ë£Œ');
    loadStaffTab();
  } catch(e) { toast('âŒ HR ê²°ì¬ ì‹¤íŒ¨: ' + e.message); }
}

async function masterDecideStaff(id, decision) {
  try {
    const { data: prop } = await sc
      .from('hr_staff_proposals').select('*').eq('id', id).single();
    if (!prop) throw new Error('ì œì•ˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

    await sc.from('hr_staff_proposals').update({ status: decision }).eq('id', id);

    if (decision === 'APPROVED') {
      if (prop.proposal_type === 'HIRE') {
        await sc.from('brief_employees').insert([{
          agent_role: prop.agent_role,
          name:       prop.employee_name,
          role_title: prop.role_title || '',
          status:     'ACTIVE',
          hired_at:   new Date().toISOString(),
        }]);
        toast(`âœ… ${prop.employee_name} ì±„ìš© ìŠ¹ì¸ ì™„ë£Œ â€” brief_employees ë“±ë¡`);
      } else if (prop.proposal_type === 'FIRE') {
        await sc.from('brief_employees')
          .update({ status: 'FIRED', fired_at: new Date().toISOString() })
          .eq('id', prop.employee_id);
        toast(`ğŸ”´ ${prop.employee_name} í•´ê³  ìŠ¹ì¸ ì™„ë£Œ`);
      }
    } else {
      toast(`âŒ ${prop.employee_name} ì œì•ˆ ë°˜ë ¤`);
    }
    loadStaffTab();
  } catch(e) { toast('âŒ ë§ˆìŠ¤í„° ê²°ì¬ ì‹¤íŒ¨: ' + e.message); }
}

/* 23:30 ìë™ìŠ¹ì¸ â€” staff proposals */
async function autoApproveStaffProposals() {
  try {
    const now = new Date().toISOString();
    const { data: pending } = await sc
      .from('hr_staff_proposals')
      .select('*')
      .eq('status', 'PENDING_MASTER')
      .lte('auto_approve_at', now);
    if (!pending?.length) return;
    for (const p of pending) {
      await masterDecideStaff(p.id, 'APPROVED');
    }
    toast(`â° ìë™ìŠ¹ì¸ ì™„ë£Œ â€” HR ì œì•ˆ ${pending.length}ê±´`);
  } catch(e) { console.error('ìë™ìŠ¹ì¸(staff) ì˜¤ë¥˜:', e); }
}

/* í•´ê³  ì œì•ˆ (ì§ì›ì¹´ë“œ ë²„íŠ¼) */
async function proposeFireStaff(employeeId, name, agentRole) {
  const reason = prompt(`[${name}] í•´ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
  if (!reason) return;
  try {
    await sc.from('hr_staff_proposals').insert([{
      proposal_type: 'FIRE',
      employee_id:   employeeId,
      employee_name: name,
      agent_role:    agentRole,
      proposer:      'MASTER',
      reason,
      status:        'PENDING_HR',
    }]);
    toast(`ğŸ”´ ${name} í•´ê³  ì œì•ˆ â€” HR ê²€í†  ëŒ€ê¸°`);
    loadStaffTab();
  } catch(e) { toast('âŒ í•´ê³  ì œì•ˆ ì‹¤íŒ¨: ' + e.message); }
}

/* ì§ì› ì¶”ê°€ ëª¨ë‹¬ */
function openAddStaffModal()  { $id('add-staff-modal').style.display = 'flex'; }
function closeAddStaffModal() { $id('add-staff-modal').style.display = 'none'; }

async function submitStaffHireProposal() {
  const agentRole = $id('add-staff-agent').value;
  const name      = $id('add-staff-name').value.trim();
  const title     = $id('add-staff-title').value.trim();
  const reason    = $id('add-staff-reason').value.trim();
  if (!agentRole) return toast('âŒ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
  if (!name)      return toast('âŒ ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
  if (!reason)    return toast('âŒ ì±„ìš© ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('hr_staff_proposals').insert([{
      proposal_type: 'HIRE',
      employee_name: name,
      role_title:    title,
      agent_role:    agentRole,
      proposer:      'MASTER',
      reason,
      status:        'PENDING_HR',
    }]);
    toast(`ğŸŸ¢ ${name} ì±„ìš© ì œì•ˆ ì™„ë£Œ â€” HR ê²€í†  ëŒ€ê¸°`);
    closeAddStaffModal();
    $id('add-staff-name').value = '';
    $id('add-staff-title').value = '';
    $id('add-staff-reason').value = '';
    loadStaffTab();
  } catch(e) { toast('âŒ ì±„ìš© ì œì•ˆ ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¤ ì‚¬ì´íŠ¸ ì •ì±… íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadSitesTab() {
  try {
    const { data, error } = await sc
      .from('agents').select('agent_role, crawl_sites').order('agent_role');
    if (error) throw error;
    sitesData = {};
    (data || []).forEach(a => {
      sitesData[a.agent_role] = Array.isArray(a.crawl_sites) ? a.crawl_sites : [];
    });
    renderSitesList();
  } catch(e) {
    render('agent-sites-list', `<div class="empty">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${escHtml(e.message)}</div>`);
  }
}

function renderSitesList() {
  const roles = Object.keys(sitesData);
  if (!roles.length) {
    render('agent-sites-list', '<div class="empty">ì—ì´ì „íŠ¸ ì—†ìŒ</div>');
    return;
  }
  const col = { BA:'#2563eb',STOCK:'#0891b2',PM:'#7c3aed',HR:'#f97316',
                BRIEF:'#10b981',KW:'#8b5cf6',DATA:'#f59e0b',
                INFO:'#06b6d4',DEV:'#64748b',QA:'#ec4899' };
  const html = roles.map(role => {
    const sites = sitesData[role] || [];
    const c = col[role] || '#64748b';
    const rows = sites.length
      ? sites.map((s, i) => `
          <tr>
            <td><span class="site-url">${escHtml(s.url || '')}</span></td>
            <td>${escHtml(s.label || '')}</td>
            <td><span class="site-policy-badge ${s.policy || 'allow'}">${
              s.policy === 'deny' ? 'ğŸš« ì°¨ë‹¨' : s.policy === 'limit' ? 'âš ï¸ ì œí•œ' : 'âœ… í—ˆìš©'
            }</span></td>
            <td>${escHtml(s.memo || '')}</td>
            <td><button class="site-remove-btn"
              onclick="removeSite('${escJsStr(role)}',${i})">ì‚­ì œ</button></td>
          </tr>`)
        .join('')
      : `<tr><td colspan="5" style="color:#aaa;font-style:italic;padding:12px">ë“±ë¡ëœ ì‚¬ì´íŠ¸ ì—†ìŒ</td></tr>`;

    return `
      <div class="site-agent-card">
        <div class="site-agent-header">
          <span class="site-agent-role"
            style="background:${c}22;color:${c}">ğŸ¤– ${escHtml(role)}</span>
          <span style="font-size:.78rem;color:#64748b">${sites.length}ê°œ ì‚¬ì´íŠ¸</span>
        </div>
        <table class="site-table">
          <thead><tr>
            <th>URL</th><th>ë¼ë²¨</th><th>ì •ì±…</th><th>ë©”ëª¨</th><th>ì‚­ì œ</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="site-add-row">
          <input  id="site-url-${escHtml(role)}"   placeholder="https://example.com">
          <input  id="site-label-${escHtml(role)}" placeholder="ë¼ë²¨ (ì˜ˆ: ë¡œì´í„°)" style="max-width:130px">
          <select id="site-pol-${escHtml(role)}" style="width:auto;padding:8px 10px;margin:0;font-size:.82rem">
            <option value="allow">âœ… í—ˆìš©</option>
            <option value="deny">ğŸš« ì°¨ë‹¨</option>
            <option value="limit">âš ï¸ ì œí•œ</option>
          </select>
          <input  id="site-memo-${escHtml(role)}"  placeholder="ë©”ëª¨" style="max-width:140px">
          <button class="site-add-btn"
            onclick="addSite('${escJsStr(role)}')">+ ì¶”ê°€</button>
        </div>
      </div>`;
  }).join('');
  render('agent-sites-list', html);
}

async function addSite(role) {
  const url   = ($id(`site-url-${role}`)?.value || '').trim();
  const label = ($id(`site-label-${role}`)?.value || '').trim();
  const policy= $id(`site-pol-${role}`)?.value || 'allow';
  const memo  = ($id(`site-memo-${role}`)?.value || '').trim();
  if (!url) return toast('âŒ URLì„ ì…ë ¥í•˜ì„¸ìš”');
  if (!/^https?:\/\//.test(url)) return toast('âŒ http:// ë˜ëŠ” https:// ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤');
  if (!sitesData[role]) sitesData[role] = [];
  if (sitesData[role].some(s => s.url === url))
    return toast('âš ï¸ ì´ë¯¸ ë“±ë¡ëœ URLì…ë‹ˆë‹¤');
  sitesData[role].push({ url, label, policy, memo });
  await saveSites(role);
}

async function removeSite(role, idx) {
  if (!confirm('ì´ ì‚¬ì´íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  sitesData[role].splice(idx, 1);
  await saveSites(role);
}

async function saveSites(role) {
  try {
    const { error } = await sc.from('agents')
      .update({ crawl_sites: sitesData[role] })
      .eq('agent_role', role);
    if (error) throw error;
    toast(`âœ… ${role} ì‚¬ì´íŠ¸ ì •ì±… ì €ì¥ ì™„ë£Œ`);
    renderSitesList();
  } catch(e) { toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¥ íšŒì› íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadMemberSettings() {
  try {
    // SR ê²½ê³  í‘œì‹œ
    if (!hasSrKey()) $id('sr-warn-member').classList.add('show');
    else             $id('sr-warn-member').classList.remove('show');

    const [openRes, maxRes, cntRes] = await Promise.all([
      sc.from('app_settings').select('value').eq('key','signup_open').single(),
      sc.from('app_settings').select('value').eq('key','max_members').single(),
      sc.from('profiles').select('id', { count:'exact', head:true }),
    ]);
    const isOpen  = openRes.data?.value === 'true';
    const maxVal  = Number(maxRes.data?.value ?? 999999);
    const current = cntRes.count ?? 0;

    $id('m-cur-count').textContent = current;
    $id('m-max-count').textContent = maxVal === 999999 ? 'ë¬´ì œí•œ' : maxVal;
    $id('lever1-val').textContent  = isOpen ? 'âœ… í—ˆìš©' : 'ğŸ”’ ì œí•œ';
    $id('lever1-val').style.color  = isOpen ? '#15803d' : '#b91c1c';
    $id('lever2-val').textContent  = `${current} / ${maxVal === 999999 ? 'ë¬´ì œí•œ' : maxVal}ëª…`;
    $id('lever2-val').style.color  = (current >= maxVal && maxVal !== 999999) ? '#b91c1c' : '#15803d';

    const allowed = await checkSignupAllowed();
    updateSignupStatusUI(isOpen, allowed);
  } catch(e) { toast('âš ï¸ íšŒì› ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + e.message); }
}

async function checkSignupAllowed() {
  const [openRes, maxRes, cntRes] = await Promise.all([
    sc.from('app_settings').select('value').eq('key','signup_open').single(),
    sc.from('app_settings').select('value').eq('key','max_members').single(),
    sc.from('profiles').select('id', { count:'exact', head:true }),
  ]);
  const isOpen  = openRes.data?.value === 'true';
  const maxVal  = Number(maxRes.data?.value ?? 999999);
  const current = cntRes.count ?? 0;
  return isOpen && current < maxVal;
}

async function setSupabaseSignup(enable) {
  const srKey = getSrKey();
  if (!srKey) throw new Error('service_role í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
  const res = await fetch(`${CFG.url}/auth/v1/admin/config`, {
    method:  'PATCH',
    headers: {
      'apikey': srKey, 'Authorization': `Bearer ${srKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ disable_signup: !enable }),
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(`Auth ì„¤ì • ì‹¤íŒ¨: ${err.msg || err.message || res.status}`);
  }
}

async function setSignupStatus(open) {
  try {
    await sc.from('app_settings')
      .upsert({ key:'signup_open', value: String(open) }, { onConflict:'key' });
    const allowed = await checkSignupAllowed();
    await setSupabaseSignup(allowed);
    updateSignupStatusUI(open, allowed);
    toast(allowed ? 'âœ… íšŒì›ê°€ì… í—ˆìš©' : 'ğŸ”’ íšŒì›ê°€ì… ì œí•œ');
  } catch(e) { toast('âŒ ë³€ê²½ ì‹¤íŒ¨: ' + e.message); }
}

async function saveMaxMembers() {
  const val = $id('m-max-input').value.trim();
  if (!val || isNaN(val) || Number(val) < 1) return toast('âŒ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('app_settings')
      .upsert({ key:'max_members', value: String(val) }, { onConflict:'key' });
    $id('m-max-count').textContent = val;
    const allowed = await checkSignupAllowed();
    await setSupabaseSignup(allowed);
    toast(allowed ? `âœ… ìµœëŒ€ ${val}ëª… ì €ì¥ â€” ê°€ì… í—ˆìš©` : `âœ… ìµœëŒ€ ${val}ëª… ì €ì¥ â€” ì´ˆê³¼ë¡œ ìë™ ì œí•œ`);
    loadMemberSettings();
  } catch(e) { toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
}

function updateSignupStatusUI(lever1Open, allowed) {
  $id('lever1-val').textContent = lever1Open ? 'âœ… í—ˆìš©' : 'ğŸ”’ ì œí•œ';
  $id('lever1-val').style.color = lever1Open ? '#15803d' : '#b91c1c';
  const badge  = $id('signup-status-badge');
  const authSt = $id('m-auth-status');
  if (allowed === undefined) {
    badge.textContent = 'í™•ì¸ ì¤‘...'; badge.className = 'signup-status-badge';
    authSt.textContent = 'â€”';
  } else if (allowed) {
    badge.textContent = 'ğŸŸ¢ ê°€ì… í—ˆìš© ì¤‘'; badge.className = 'signup-status-badge open';
    authSt.textContent = 'ğŸŸ¢ OPEN'; authSt.style.color = '#15803d';
  } else {
    badge.textContent = lever1Open ? 'ğŸŸ¡ ìµœëŒ€ ì¸ì› ì´ˆê³¼ ì œí•œ' : 'ğŸ”´ ìˆ˜ë™ ì œí•œ';
    badge.className = 'signup-status-badge ' + (lever1Open ? 'auto-closed' : 'closed');
    authSt.textContent = 'ğŸ”´ CLOSED'; authSt.style.color = '#b91c1c';
  }
}

async function loadMemberList() {
  const srKey = getSrKey();
  if (!srKey) return toast('âŒ SR í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  render('member-table-wrap', '<div class="empty" style="padding:30px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>');
  try {
    const res = await fetch(`${CFG.url}/auth/v1/admin/users?page=1&per_page=200`, {
      headers: { 'apikey': srKey, 'Authorization': `Bearer ${srKey}` },
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(`Auth API ì˜¤ë¥˜: ${err.msg || err.message || res.status}`);
    }
    const json = await res.json();
    allMembers = json.users || json || [];
    renderMemberTable(allMembers);
  } catch(e) {
    render('member-table-wrap', `<div class="empty" style="color:#ef4444">âŒ ${escHtml(e.message)}</div>`);
  }
}

function renderMemberTable(members) {
  if (!members.length) {
    render('member-table-wrap', '<div class="empty">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
    return;
  }
  const rows = members.map((u, i) => {
    const isBanned  = !!u.banned_until && new Date(u.banned_until) > new Date();
    const createdAt = u.created_at ? u.created_at.slice(0,10) : 'â€”';
    const lastSign  = u.last_sign_in_at
      ? u.last_sign_in_at.slice(0,16).replace('T',' ') : 'ë¯¸ë¡œê·¸ì¸';
    return `<tr>
      <td style="color:#94a3b8;font-size:.78rem">${i+1}</td>
      <td><span class="user-email">${escHtml(u.email||'(ì—†ìŒ)')}</span></td>
      <td><span class="user-date">${createdAt}</span></td>
      <td><span class="user-date">${lastSign}</span></td>
      <td><span class="ban-badge ${isBanned?'banned':'active'}">${isBanned?'ğŸš« ì°¨ë‹¨':'âœ… ì •ìƒ'}</span></td>
      <td>${isBanned
        ? `<button class="ban-btn do-unban" onclick="toggleBan('${escJsStr(u.id)}','${escJsStr(u.email||'')}',false)">í•´ì œ</button>`
        : `<button class="ban-btn do-ban"   onclick="toggleBan('${escJsStr(u.id)}','${escJsStr(u.email||'')}',true)">ì°¨ë‹¨</button>`
      }</td>
    </tr>`;
  }).join('');
  render('member-table-wrap', `
    <table class="member-table">
      <thead><tr>
        <th>#</th><th>ì´ë©”ì¼</th><th>ê°€ì…ì¼</th><th>ìµœê·¼ ë¡œê·¸ì¸</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`);
}

function filterMembers() {
  const q = ($id('member-search').value || '').toLowerCase();
  renderMemberTable(q ? allMembers.filter(u => (u.email||'').toLowerCase().includes(q)) : allMembers);
}

async function toggleBan(userId, email, ban) {
  const srKey = getSrKey();
  if (!srKey) return toast('âŒ SR í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  if (!confirm(`${email} ì„(ë¥¼) ${ban?'ì°¨ë‹¨':'í•´ì œ'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    const res = await fetch(`${CFG.url}/auth/v1/admin/users/${userId}`, {
      method: 'PUT',
      headers: {
        'apikey': srKey, 'Authorization': `Bearer ${srKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ban_duration: ban ? '876000h' : 'none' }),
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(`Auth API ì˜¤ë¥˜: ${err.msg || err.message || res.status}`);
    }
    toast(ban ? `ğŸš« ${email} ì°¨ë‹¨ ì™„ë£Œ` : `âœ… ${email} ì°¨ë‹¨ í•´ì œ ì™„ë£Œ`);
    const updated = await res.json();
    const idx = allMembers.findIndex(u => u.id === userId);
    if (idx >= 0) allMembers[idx] = updated;
    renderMemberTable(allMembers);
  } catch(e) { toast('âŒ ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¦ í¬ëŸ¼(ë¡œê·¸) íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLogs() {
  const box = $id('forum-box');
  if (!box) return;
  try {
    const { data } = await sc
      .from('action_logs').select('executed_at,action_type,details')
      .order('executed_at', { ascending: false }).limit(80);
    if (!data?.length) { box.innerHTML = '<span style="color:#8be9fd"># ë¡œê·¸ ì—†ìŒ</span>'; return; }
    box.innerHTML = data.map(l => {
      const t = (l.executed_at||'').slice(0,19).replace('T',' ');
      const d = escHtml(l.details||'');
      const cls = d.includes('âŒ')||d.toLowerCase().includes('fail') ? 'err'
                : d.includes('âš ï¸') ? 'warn' : 'info';
      return `<div><span class="${cls}">[${t}] ${escHtml(l.action_type||'')}</span> â€” ${d}</div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  } catch(e) { box.innerHTML = `<span class="err">ë¡œë“œ ì‹¤íŒ¨: ${escHtml(e.message)}</span>`; }
}

async function triggerRun() {
  const token = getToken();
  if (!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”');
  try {
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      { method:'POST',
        headers:{ 'Authorization':`Bearer ${token}`,
                  'Accept':'application/vnd.github.v3+json',
                  'Content-Type':'application/json' },
        body: JSON.stringify({ ref:'main' }) }
    );
    if (res.status === 204) toast('ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™ ì™„ë£Œ!');
    else { const e = await res.json().catch(()=>({})); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
  } catch(e) { toast('âŒ ê°€ë™ ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘§ VOC íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadVoc() {
  try {
    const { data } = await sc
      .from('user_feedback').select('*')
      .order('created_at', { ascending: false }).limit(60);
    if (!data?.length) { render('voc-list','<div class="empty">í”¼ë“œë°± ì—†ìŒ</div>'); return; }
    render('voc-list', data.map(f => {
      const t = (f.created_at||'').slice(0,16).replace('T',' ');
      const thumb = f.thumb === 'up' ? 'ğŸ‘' : f.thumb === 'down' ? 'ğŸ‘' : 'â€”';
      return `<div class="card" style="border-left-color:#6366f1">
        <div style="font-size:.78rem;color:#94a3b8;margin-bottom:6px">
          ${t} Â· ${escHtml(f.user_email||'ìµëª…')} ${thumb}
        </div>
        <div class="box">${escHtml(f.content||'(ë‚´ìš© ì—†ìŒ)')}</div>
      </div>`;
    }).join(''));
  } catch(e) { render('voc-list',`<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${escHtml(e.message)}</div>`); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¨ ë¹„ìš© íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadCost() {
  try {
    const today = new Date().toISOString().slice(0,10);
    // ì˜¤ëŠ˜ action_logs
    const { data: todayLogs } = await sc
      .from('action_logs').select('action_type,details,executed_at')
      .gte('executed_at', today + 'T00:00:00')
      .order('executed_at', { ascending: false });

    const calls = (todayLogs||[]).filter(l =>
      String(l.action_type||'').includes('LLM') ||
      String(l.details||'').includes('token') ||
      String(l.details||'').includes('Gemini')).length;

    const estCost = (calls * 0.0015).toFixed(4);
    $id('c-tokens').textContent = calls;
    $id('c-cost').textContent   = `$${estCost}`;

    // 7ì¼ ëˆ„ì 
    const w7 = new Date(Date.now() - 7*86400*1000).toISOString().slice(0,10);
    const { data: weekLogs } = await sc
      .from('action_logs').select('action_type,details')
      .gte('executed_at', w7 + 'T00:00:00');
    const wCalls = (weekLogs||[]).filter(l =>
      String(l.action_type||'').includes('LLM') ||
      String(l.details||'').includes('token') ||
      String(l.details||'').includes('Gemini')).length;
    $id('c-month').textContent = `$${(wCalls * 0.0015).toFixed(3)}`;

    // Supabase row counts
    const tables = ['agents','pending_approvals','dev_backlog','release_ledger',
                    'action_logs','brief_employees','hr_staff_proposals','reports'];
    const counts = await Promise.all(
      tables.map(t => sc.from(t).select('id',{count:'exact',head:true}))
    );
    const total = counts.reduce((s,r) => s + (r.count||0), 0);
    $id('c-rows').textContent = total.toLocaleString();

    // í…Œì´ë¸”ë³„ ìƒì„¸
    render('c-row-detail', `<table class="ledger-table">
      <thead><tr><th>í…Œì´ë¸”</th><th>rows</th></tr></thead>
      <tbody>${tables.map((t,i) =>
        `<tr><td class="mono">${t}</td><td>${(counts[i].count||0).toLocaleString()}</td></tr>`
      ).join('')}</tbody>
    </table>`);

    // ì˜¤ëŠ˜ í˜¸ì¶œ ìœ í˜•ë³„
    const types = {};
    (todayLogs||[]).forEach(l => {
      const k = l.action_type || 'UNKNOWN';
      types[k] = (types[k]||0) + 1;
    });
    render('c-breakdown', Object.keys(types).length
      ? `<table class="ledger-table">
          <thead><tr><th>ìœ í˜•</th><th>íšŸìˆ˜</th></tr></thead>
          <tbody>${Object.entries(types)
            .sort((a,b)=>b[1]-a[1])
            .map(([k,v])=>`<tr><td class="mono">${escHtml(k)}</td><td>${v}</td></tr>`)
            .join('')}</tbody>
        </table>`
      : '<div class="empty">ì˜¤ëŠ˜ ë¡œê·¸ ì—†ìŒ</div>');
  } catch(e) {
    ['c-tokens','c-cost','c-month','c-rows'].forEach(id => {
      if($id(id)) $id(id).textContent = 'â€”';
    });
    render('c-breakdown', `<div class="empty">ë¡œë“œ ì‹¤íŒ¨: ${escHtml(e.message)}</div>`);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¡¤ë°±
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function triggerRollback(sha, runId) {
  const token = getToken();
  if (!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”');
  if (!confirm(`ì»¤ë°‹ ${sha.slice(0,8)} ìœ¼ë¡œ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    const res = await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/rollback.yml/dispatches`,
      { method:'POST',
        headers:{ 'Authorization':`Bearer ${token}`,
                  'Accept':'application/vnd.github.v3+json',
                  'Content-Type':'application/json' },
        body: JSON.stringify({ ref:'main', inputs:{ target_sha: sha } }) }
    );
    if (res.status === 204) toast(`â†©ï¸ ë¡¤ë°± íŠ¸ë¦¬ê±° ì™„ë£Œ (SHA: ${sha.slice(0,8)})`);
    else { const e = await res.json().catch(()=>({})); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
  } catch(e) { toast('âŒ ë¡¤ë°± ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì´ˆê¸°í™”
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refreshAll() {
  const curTab = document.querySelector('.tab.on')?.id?.replace('t-','') || 'hr';
  if (curTab === 'hr')     await loadHrDates();
  if (curTab === 'evo')    await loadEvo();
  if (curTab === 'dev')  { await loadDev(); await loadReleaseLedger(); }
  if (curTab === 'staff')  await loadStaffTab();
  if (curTab === 'sites')  await loadSitesTab();
  if (curTab === 'member') await loadMemberSettings();
  if (curTab === 'log')    await loadLogs();
  if (curTab === 'voc')    await loadVoc();
  if (curTab === 'cost')   await loadCost();
  toast('ğŸ”„ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

async function doLogin() {
  const email = $id('login-email').value.trim();
  const pw    = $id('login-pw').value;
  const errEl = $id('login-error');
  const btn   = $id('login-btn');
  if (!email || !pw) { errEl.textContent='ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'; errEl.style.display='block'; return; }
  btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...'; btn.disabled = true;
  try {
    const { data, error } = await sc.auth.signInWithPassword({ email, password: pw });
    if (error) throw error;
    if (data.user?.email !== CFG.master) {
      await sc.auth.signOut();
      throw new Error('ë§ˆìŠ¤í„° ê³„ì •ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    }
    me = data.user;
    $id('login-overlay').style.display = 'none';
    startClock();
    startAutoApprovalTimer();
    await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadAgentSelect()]);
  } catch(e) {
    errEl.textContent = e.message === 'Invalid login credentials' ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤' : e.message;
    errEl.style.display = 'block';
    btn.textContent = 'ë¡œê·¸ì¸'; btn.disabled = false;
  }
}

async function init() {
  // ì €ì¥ëœ í‚¤ ë³µêµ¬
  const savedToken = localStorage.getItem('ghp_token') || '';
  const savedSr    = localStorage.getItem('sr_key')    || '';
  if (savedToken) { $id('ghp-token').value = savedToken; updateTokenStatus(savedToken); }
  if (savedSr)    { $id('sr-key-input').value = savedSr; CFG.service_role = savedSr; updateSrStatus(savedSr); }

  try {
    const { data, error } = await sc.auth.getUser();
    if (error) throw error;
    const user = data?.user;

    if (!user || user.email !== CFG.master) {
      // ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ í‘œì‹œ
      const overlay = $id('login-overlay');
      overlay.style.display = 'flex';
      return;
    }
    me = user;
    startClock();
    startAutoApprovalTimer();
    await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadAgentSelect()]);
  } catch(e) {
    console.error('init ì˜¤ë¥˜:', e);
    // ì—ëŸ¬ ì‹œì—ë„ ë¡œê·¸ì¸ í¼ í‘œì‹œ
    const overlay = $id('login-overlay');
    if (overlay) overlay.style.display = 'flex';
  }
}

document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
