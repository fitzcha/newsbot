<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Sovereign HQ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root{--admin:#ff4d4f;--primary:#007bff;--success:#28a745;--dev:#6f42c1;--dark:#1a1a2e;--warn:#fd7e14;--bg:#f8f9fa}
*{box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;margin:0;background:var(--bg);color:#222}
.wrap{max-width:1050px;margin:0 auto;padding:20px}

/* ë³´ì•ˆë°” */
.sec-bar{background:#111;color:#eee;padding:12px 20px;border-radius:14px;margin-bottom:18px;display:flex;gap:12px;align-items:center;font-size:.85rem;flex-wrap:wrap}
.sec-bar input{flex:1;min-width:200px;padding:6px 12px;background:rgba(255,255,255,.1);border:1px solid #444;color:#fff;border-radius:8px;font-size:.85rem}
.sec-bar input::placeholder{color:#888}
.sec-bar button{padding:6px 14px;background:#ff4d4f;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:.82rem;white-space:nowrap}
.sec-bar .sep{color:#444;font-size:1rem;user-select:none}
.auto-badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700;white-space:nowrap}
.sr-badge{background:#7c3aed;color:#fff;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:700;white-space:nowrap}

/* í—¤ë” */
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.hdr h1{margin:0;font-size:1.8rem;letter-spacing:-2px;cursor:pointer}
.hdr small{color:var(--admin);font-weight:700;display:block;font-size:.8rem}
.hdr-btns{display:flex;gap:8px}

/* íƒ­ */
.tabs{display:flex;gap:4px;border-bottom:2px solid #e9ecef;margin-bottom:22px;overflow-x:auto}
.tab{padding:12px 18px;cursor:pointer;font-weight:800;color:#999;border-bottom:4px solid transparent;margin-bottom:-2px;transition:.2s;white-space:nowrap;font-size:.9rem}
.tab.on{color:var(--admin);border-bottom-color:var(--admin)}
.badge{background:var(--admin);color:#fff;border-radius:20px;padding:1px 7px;font-size:.72rem;margin-left:5px;font-weight:700}

/* ê³µí†µ ì»´í¬ë„ŒíŠ¸ */
.card{background:#fff;border:1px solid #eee;padding:18px;border-radius:16px;margin-bottom:14px;border-left:6px solid var(--admin);box-shadow:0 2px 8px rgba(0,0,0,.04)}
.box{background:#f8f9fa;padding:13px;border-radius:10px;font-size:.88rem;border:1px solid #efefef;margin:8px 0;white-space:pre-wrap;line-height:1.6}
.btn{padding:9px 18px;border-radius:10px;border:1px solid #ddd;cursor:pointer;font-weight:700;transition:.2s;background:#fff;font-size:.88rem}
.btn:hover{opacity:.85}
.sm{padding:7px 13px;font-size:.82rem;border:none;color:#fff;border-radius:8px;cursor:pointer;font-weight:700}
textarea,select{width:100%;padding:13px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-family:inherit;font-size:.9rem;resize:vertical}
.row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
.row>*{flex:1;min-width:150px}
h3{margin:0 0 14px;font-size:1rem;color:#444}
.empty{color:#aaa;font-style:italic;padding:20px;text-align:center}

/* ìƒíƒœ ë±ƒì§€ */
.s-tag{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:700;margin-left:6px}
.s-PENDING{background:#fff3cd;color:#856404}
.s-PENDING_MASTER{background:#fff3cd;color:#856404}
.s-CONFIRMED{background:#cce5ff;color:#004085}
.s-DEVELOPING{background:#d4edda;color:#155724}
.s-DEPLOYED{background:#d1ecf1;color:#0c5460}
.s-COMPLETED{background:#d1ecf1;color:#0c5460}
.s-APPROVED{background:#d4edda;color:#155724}
.s-REJECTED{background:#f8d7da;color:#721c24}
.s-FAILED,.s-BACKUP_FAILED,.s-SYNTAX_ERROR,.s-VALIDATION_ERROR,.s-DEPLOY_FAILED{background:#f8d7da;color:#721c24}

/* ìƒíƒœ í•„í„° + í˜ì´ì§• */
.status-filter-row{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
.status-chip{border:1px solid #e2e8f0;background:#fff;color:#64748b;border-radius:999px;padding:6px 11px;cursor:pointer;font-size:.8rem;font-weight:700}
.status-chip .cnt{margin-left:5px;color:#94a3b8;font-weight:800}
.status-chip.on{background:#111;color:#fff;border-color:#111}
.status-chip.on .cnt{color:#d1d5db}
.list-summary{font-size:.78rem;color:#94a3b8;margin:0 0 8px}
.list-pager{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-top:10px}
.list-pager .pinfo{font-size:.76rem;color:#64748b;min-width:90px;text-align:center}
.list-pager .pbtn{padding:5px 11px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;font-size:.78rem;font-weight:700;color:#475569}
.list-pager .pbtn:disabled{opacity:.4;cursor:default}
.summary-box{background:#f8fafc}
.role-brief{font-size:.8rem;color:#475569;margin:6px 0 8px}

/* í¬ëŸ¼ */
#forum-box{background:#0d1117;color:#50fa7b;padding:18px;border-radius:14px;font-family:'Courier New',monospace;height:320px;overflow-y:auto;font-size:.82rem;line-height:1.7}
#forum-box .err{color:#ff5555}
#forum-box .warn{color:#ffb86c}
#forum-box .info{color:#8be9fd}

/* ì¹´ìš´íŠ¸ë‹¤ìš´ */
.countdown{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#eee;padding:14px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:14px;font-size:.88rem}
.countdown .timer{font-size:1.4rem;font-weight:900;color:#50fa7b;letter-spacing:1px;min-width:80px}
.countdown .timer.warn{color:#ffb86c}
.countdown .timer.danger{color:#ff5555}

/* ì§„í™” ê²°ì¬ */
.evo-card{background:#fff;border:1px solid #e0e0e0;border-left:6px solid var(--warn);padding:18px;border-radius:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.evo-card .meta{font-size:.78rem;color:#999;margin-bottom:6px}
.evo-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

/* í„ìŠ¤ */
.pulse{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ë‹¤í¬ ë¦¬í¬íŠ¸ */
#hr-content{background:var(--dark);color:#dde;padding:32px;border-radius:18px;min-height:260px;margin-top:14px;line-height:1.8;font-size:.92rem}
#hr-content h1,#hr-content h2,#hr-content h3{color:#7eb8ff}
#hr-content a{color:#50fa7b}

/* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
#toast{position:fixed;bottom:30px;right:30px;background:#222;color:#fff;padding:12px 22px;border-radius:12px;font-size:.88rem;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;max-width:360px;word-break:keep-all}
#toast.show{opacity:1}

/* ë¹„ìš© íƒ­ */
.cost-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.cost-card{background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.cost-label{font-size:.72rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.cost-value{font-size:2rem;font-weight:900;color:#111;line-height:1.1}
.cost-unit{font-size:.78rem;color:#6b7280;margin-top:4px}

/* ì§€ëŠ¥í•˜ë‹¬ */
.directive-section{background:#fff;border:1px solid #eee;border-left:6px solid #333;padding:18px;border-radius:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.directive-section h3{margin:0 0 14px;color:#222}
.mode-tabs{display:flex;gap:6px;margin-bottom:14px}
.mode-tab{padding:7px 16px;border-radius:20px;border:1.5px solid #ddd;background:#fff;font-size:.82rem;font-weight:700;cursor:pointer;transition:.15s;color:#666}
.mode-tab.on{background:#111;color:#fff;border-color:#111}
.char-count{font-size:.75rem;color:#aaa;text-align:right;margin-top:-8px;margin-bottom:8px}
.char-count.warn{color:#f59e0b;font-weight:700}
.char-count.over{color:#ef4444;font-weight:700}
.one-rule-warn{background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.82rem;color:#c2410c;margin-bottom:10px;display:none}
.one-rule-warn.show{display:block}

/* íšŒì› ê´€ë¦¬ íƒ­ */
.member-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.member-stat-card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.member-stat-label{font-size:.7rem;color:#9ca3af;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.member-stat-value{font-size:1.8rem;font-weight:900;color:#111}
.member-stat-unit{font-size:.75rem;color:#6b7280;margin-top:3px}

.signup-control{background:#fff;border:1px solid #eee;border-left:6px solid #10b981;border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.signup-status-row{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.signup-status-badge{padding:6px 18px;border-radius:20px;font-size:.88rem;font-weight:800}
.signup-status-badge.open{background:#dcfce7;color:#15803d}
.signup-status-badge.closed{background:#fee2e2;color:#b91c1c}
.signup-status-badge.auto-closed{background:#fef9c3;color:#854d0e}
.signup-lever-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.lever-card{background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:14px}
.lever-label{font-size:.72rem;font-weight:700;color:#64748b;letter-spacing:.5px;margin-bottom:8px;text-transform:uppercase}
.lever-value{font-size:1rem;font-weight:800;color:#0f172a;margin-bottom:8px}
.lever-btns{display:flex;gap:6px}

.member-table-wrap{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.member-table{width:100%;border-collapse:collapse;font-size:.84rem}
.member-table th{background:#f8fafc;padding:10px 14px;text-align:left;font-weight:700;color:#64748b;font-size:.76rem;letter-spacing:.5px;text-transform:uppercase;border-bottom:2px solid #e2e8f0}
.member-table td{padding:11px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.member-table tr:last-child td{border-bottom:none}
.member-table tr:hover td{background:#f8fafc}
.user-email{font-weight:600;color:#1e293b}
.user-date{color:#94a3b8;font-size:.78rem}
.ban-badge{padding:3px 10px;border-radius:20px;font-size:.74rem;font-weight:700}
.ban-badge.active{background:#dcfce7;color:#15803d}
.ban-badge.banned{background:#fee2e2;color:#b91c1c}
.ban-btn{padding:5px 12px;border-radius:8px;border:none;font-size:.78rem;font-weight:700;cursor:pointer;transition:.15s}
.ban-btn.do-ban{background:#fee2e2;color:#b91c1c}
.ban-btn.do-unban{background:#dcfce7;color:#15803d}
.ban-btn:hover{opacity:.8}
.sr-warn{background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:12px 16px;font-size:.84rem;color:#92400e;margin-bottom:14px;display:none}
.sr-warn.show{display:block}
</style>
</head>
<body>
<div class="wrap">

  <!-- â”€â”€ ë³´ì•ˆë°” (GHP í† í° + Service Role í‚¤) â”€â”€ -->
  <div class="sec-bar">
    <span>ğŸ”’ <b>Auth Center</b></span>

    <!-- GHP í† í° -->
    <input type="password" id="ghp-token" placeholder="ghp_... GitHub PAT">
    <button onclick="saveToken()">GHP ì €ì¥</button>
    <span id="token-status" style="color:#aaa">GHP ë¯¸ì…ë ¥</span>

    <span class="sep">â”‚</span>

    <!-- Service Role í‚¤ (ì‹ ê·œ) -->
    <input type="password" id="sr-key-input" placeholder="eyJ... Supabase service_role key">
    <button onclick="saveSrKey()" style="background:#7c3aed">SR ì €ì¥</button>
    <span id="sr-status" style="color:#aaa">SR ë¯¸ì…ë ¥</span>

    <span class="auto-badge" id="auto-badge" style="display:none">â± ìë™ìŠ¹ì¸ ON</span>
    <span class="sr-badge" id="sr-badge" style="display:none">ğŸ”‘ SR í™œì„±í™”</span>
  </div>

  <!-- í—¤ë” -->
  <div class="hdr">
    <div>
      <h1 onclick="location.href='index.html'">Sovereign HQ</h1>
      <small>v20.0 Â· <span id="now-time"></span></small>
    </div>
    <div class="hdr-btns">
      <button class="btn" onclick="location.href='index.html'">ğŸŒ í™ˆ</button>
      <button class="btn" onclick="location.href='app.html'">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn" onclick="refreshAll()" style="background:#111;color:#fff;border:none">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- íƒ­ -->
  <div class="tabs">
    <div id="t-hr"     class="tab on" onclick="tab('hr')">ğŸ•µï¸ ì „ëµ</div>
    <div id="t-evo"    class="tab"    onclick="tab('evo')">ğŸ§  ì§€ëŠ¥ <span class="badge" id="evo-cnt" style="display:none">0</span></div>
    <div id="t-dev"    class="tab"    onclick="tab('dev')">ğŸ› ï¸ ê°œë°œ <span class="badge" id="dev-cnt" style="display:none">0</span></div>
    <div id="t-member" class="tab"    onclick="tab('member')">ğŸ‘¥ íšŒì›</div>
    <div id="t-log"    class="tab"    onclick="tab('log')">ğŸ“‹ í¬ëŸ¼</div>
    <div id="t-voc"    class="tab"    onclick="tab('voc')">ğŸ’¬ VOC</div>
    <div id="t-cost"   class="tab"    onclick="tab('cost')">ğŸ’° ë¹„ìš©</div>
  </div>

  <!-- â‘  ì „ëµ íƒ­ -->
  <div id="v-hr">
    <div class="row" style="align-items:center;margin-bottom:14px">
      <h3 style="margin:0">ğŸ“… ë§ˆìŠ¤í„° ë¦¬í¬íŠ¸</h3>
      <select id="hr-date" onchange="loadHrReport()" style="margin:0;max-width:200px"></select>
    </div>
    <div id="hr-content">ë¡œë“œ ì¤‘...</div>
  </div>

  <!-- â‘¡ ì§€ëŠ¥ íƒ­ -->
  <div id="v-evo" style="display:none">
    <div class="countdown" id="countdown-bar">
      <div>
        <div style="font-weight:700;margin-bottom:2px">â³ 23:30 ìë™ìŠ¹ì¸ê¹Œì§€</div>
        <div style="font-size:.78rem;color:#aaa">ë¯¸ê²° ì•ˆê±´ì€ ìë™ìœ¼ë¡œ APPROVED ì²˜ë¦¬ë©ë‹ˆë‹¤</div>
      </div>
      <div class="timer" id="countdown-timer">--:--:--</div>
    </div>

    <div class="directive-section">
      <h3>âœï¸ ì§€ëŠ¥ í•˜ë‹¬</h3>
      <div class="mode-tabs">
        <button class="mode-tab on" id="mode-single" onclick="setDirectiveMode('single')">ğŸ¯ ê°œë³„ ì—ì´ì „íŠ¸</button>
        <button class="mode-tab"    id="mode-all"    onclick="setDirectiveMode('all')">ğŸ“¢ ì „ì²´ ë™ì‹œ í•˜ë‹¬</button>
      </div>
      <div id="directive-single">
        <select id="m-role" style="margin:0 0 10px"><option value="">â³ ì—ì´ì „íŠ¸ ë¡œë”© ì¤‘...</option></select>
      </div>
      <div id="directive-all" style="display:none;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;font-size:.84rem;color:#92400e;margin-bottom:10px;">
        ğŸ“¢ ì•„ë˜ ì§€ì¹¨ì´ <b>í˜„ì¬ ë“±ë¡ëœ ëª¨ë“  ì—ì´ì „íŠ¸</b>ì—ê²Œ ë™ì‹œ ì ìš©ë©ë‹ˆë‹¤.
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="append" checked> â• ê¸°ì¡´ ì§€ì¹¨ì— ì¶”ê°€
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:.84rem;font-weight:700;cursor:pointer">
          <input type="radio" name="apply-mode" value="replace"> ğŸ”„ ê¸°ì¡´ ì§€ì¹¨ ëŒ€ì²´
        </label>
      </div>
      <div class="one-rule-warn" id="one-rule-warn">
        âš ï¸ ì§€ì¹¨ì€ <b>1ê°œ ì•ˆê±´ë§Œ</b> ì…ë ¥í•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ ë‚´ìš©ì„ ë™ì‹œì— ì…ë ¥í•˜ë©´ ë°˜ì˜ íš¨ê³¼ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.
      </div>
      <textarea id="m-text" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ì§ì ‘ ì§€ì¹¨ì„ í•˜ë‹¬í•˜ì„¸ìš”. (ì˜ˆ: 'ë¶„ì„ ê²°ë¡ ì„ í•­ìƒ ì²« ë¬¸ì¥ì— ë°°ì¹˜í•  ê²ƒ')" oninput="onDirectiveInput(this)"></textarea>
      <div class="char-count" id="char-count">0ì</div>
      <button class="btn" style="background:#111;color:#fff;border:none;width:100%" onclick="sendDirectOrder()">âš¡ ì¦‰ì‹œ í•˜ë‹¬ (ë°”ë¡œ ì ìš©)</button>
    </div>

    <div id="evo-status-filters" class="status-filter-row"></div>
    <div id="pending-evo-list"></div>
    <div id="live-agent-list"></div>
  </div>

  <!-- â‘¢ ê°œë°œ íƒ­ -->
  <div id="v-dev" style="display:none">
    <div class="card" style="border-left-color:var(--dev);background:#f5f0ff">
      <h3>ğŸ› ï¸ ìƒˆ ê°œë°œ ì•ˆê±´ ë“±ë¡</h3>
      <input id="d-title" placeholder="ì•ˆê±´ ì œëª©" style="width:100%;padding:11px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px;font-size:.9rem">
      <textarea id="d-task" rows="4" placeholder="ìš”êµ¬ì‚¬í•­ì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”."></textarea>
      <button class="btn" style="background:var(--dev);color:#fff;border:none;width:100%" onclick="addDev()">ğŸ“‹ ë°±ë¡œê·¸ ë“±ë¡</button>
    </div>
    <div id="dev-status-filters" class="status-filter-row"></div>
    <div id="dev-list"></div>
  </div>

  <!-- â‘£ íšŒì› ê´€ë¦¬ íƒ­ (ì‹ ê·œ) -->
  <div id="v-member" style="display:none">

    <!-- service_role í‚¤ ì—†ì„ ë•Œ ê²½ê³  -->
    <div class="sr-warn" id="sr-warn-member">
      ğŸ”‘ ì¼ë¶€ ê¸°ëŠ¥(ê°œë³„ ì°¨ë‹¨/í•´ì œ)ì€ <b>service_role í‚¤</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
      ìœ„ ë³´ì•ˆë°”ì—ì„œ SR í‚¤ë¥¼ ì €ì¥í•˜ë©´ ëª¨ë“  ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="member-stat-grid">
      <div class="member-stat-card" style="border-top:3px solid #2563eb">
        <div class="member-stat-label">í˜„ì¬ íšŒì› ìˆ˜</div>
        <div class="member-stat-value" id="m-cur-count">â€”</div>
        <div class="member-stat-unit">ëª…</div>
      </div>
      <div class="member-stat-card" style="border-top:3px solid #7c3aed">
        <div class="member-stat-label">ìµœëŒ€ í—ˆìš©</div>
        <div class="member-stat-value" id="m-max-count">â€”</div>
        <div class="member-stat-unit">ëª…</div>
      </div>
      <div class="member-stat-card" style="border-top:3px solid #10b981">
        <div class="member-stat-label">ê°€ì… ìƒíƒœ</div>
        <div class="member-stat-value" id="m-auth-status" style="font-size:1.1rem">â€”</div>
        <div class="member-stat-unit">Supabase Auth</div>
      </div>
    </div>

    <!-- ê°€ì… ì œì–´ ë ˆë²„ 2ê°œ -->
    <div class="signup-control">
      <h3>ğŸšï¸ ê°€ì… ì œì–´ (ë ˆë²„ 2ê°œ)</h3>
      <p style="font-size:.82rem;color:#64748b;margin:-6px 0 14px">ë‘ ë ˆë²„ ëª¨ë‘ í—ˆìš©ì¼ ë•Œë§Œ ì‹¤ì œë¡œ ê°€ì…ì´ ì—´ë¦½ë‹ˆë‹¤.</p>

      <div class="signup-lever-row">
        <!-- ë ˆë²„ 1: ìˆ˜ë™ ON/OFF -->
        <div class="lever-card">
          <div class="lever-label">ë ˆë²„ 1 â€” ìˆ˜ë™ ì œì–´</div>
          <div class="lever-value" id="lever1-val">ë¡œë”© ì¤‘...</div>
          <div class="lever-btns">
            <button class="sm" style="background:#10b981" onclick="setSignupStatus(true)">âœ… í—ˆìš©</button>
            <button class="sm" style="background:#ef4444" onclick="setSignupStatus(false)">ğŸ”’ ì œí•œ</button>
          </div>
        </div>
        <!-- ë ˆë²„ 2: ìµœëŒ€ íšŒì› ìˆ˜ -->
        <div class="lever-card">
          <div class="lever-label">ë ˆë²„ 2 â€” ìµœëŒ€ íšŒì› ìˆ˜</div>
          <div class="lever-value" id="lever2-val">ë¡œë”© ì¤‘...</div>
          <div style="display:flex;gap:6px;align-items:center">
            <input id="m-max-input" type="number" min="1" max="99999" placeholder="ì˜ˆ: 100"
                   style="width:90px;padding:6px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:.88rem;font-family:inherit">
            <button class="sm" style="background:#2563eb" onclick="saveMaxMembers()">ì €ì¥</button>
          </div>
        </div>
      </div>

      <!-- ì‹¤ì œ Auth ìƒíƒœ í‘œì‹œ -->
      <div class="signup-status-row">
        <span style="font-size:.88rem;font-weight:700;color:#475569">ì‹¤ì œ Supabase Auth ìƒíƒœ:</span>
        <span class="signup-status-badge" id="signup-status-badge">í™•ì¸ ì¤‘...</span>
        <button class="btn" style="padding:6px 14px;font-size:.82rem" onclick="loadMemberSettings()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <!-- íšŒì› ëª©ë¡ -->
    <div class="card" style="border-left-color:#2563eb">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <h3 style="margin:0">ğŸ‘¤ íšŒì› ëª©ë¡</h3>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="member-search" placeholder="ì´ë©”ì¼ ê²€ìƒ‰..." style="padding:6px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:.84rem;font-family:inherit;width:200px" oninput="filterMembers()">
          <button class="sm" style="background:#475569" onclick="loadMemberList()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <div class="member-table-wrap" id="member-table-wrap">
        <div class="empty">SR í‚¤ë¥¼ ì €ì¥ í›„ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ í´ë¦­í•˜ì„¸ìš”.</div>
      </div>
    </div>
  </div>

  <!-- â‘¤ í¬ëŸ¼ íƒ­ -->
  <div id="v-log" style="display:none">
    <div id="forum-box"><span style="color:#8be9fd"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸</span><br>ë¡œë”© ì¤‘...</div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" style="flex:1;background:var(--admin);color:#fff;border:none;padding:15px" onclick="triggerRun()">ğŸš€ ì‹œìŠ¤í…œ ì¦‰ì‹œ ê°€ë™</button>
      <button class="btn" style="background:#333;color:#fff;border:none;padding:15px" onclick="loadLogs()">ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- â‘¥ VOC íƒ­ -->
  <div id="v-voc" style="display:none">
    <div id="voc-list"></div>
  </div>

  <!-- â‘¦ ë¹„ìš© íƒ­ -->
  <div id="v-cost" style="display:none">
    <div class="cost-grid">
      <div class="cost-card" style="border-top:3px solid #f59e0b">
        <div class="cost-label">ì˜¤ëŠ˜ Gemini í˜¸ì¶œ</div>
        <div class="cost-value" id="c-calls">â€”</div>
        <div class="cost-unit">íšŒ</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #10b981">
        <div class="cost-label">ì˜¤ëŠ˜ ì¶”ì • ë¹„ìš©</div>
        <div class="cost-value" id="c-cost" style="color:#059669">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #6366f1">
        <div class="cost-label">Supabase ì´ rows</div>
        <div class="cost-value" id="c-rows">â€”</div>
        <div class="cost-unit">/ 500,000 ë¬´ë£Œ í•œë„</div>
      </div>
      <div class="cost-card" style="border-top:3px solid #ec4899">
        <div class="cost-label">7ì¼ ëˆ„ì  ë¹„ìš©</div>
        <div class="cost-value" id="c-week">â€”</div>
        <div class="cost-unit">USD</div>
      </div>
    </div>
    <div class="card" style="border-left-color:#f59e0b">
      <h3>ğŸ“ˆ 7ì¼ Gemini í˜¸ì¶œ ì¶”ì´</h3>
      <canvas id="cost-chart" height="180"></canvas>
    </div>
    <div class="card" style="border-left-color:#6366f1">
      <h3>ğŸ—„ï¸ Supabase í…Œì´ë¸”ë³„ row ìˆ˜</h3>
      <div id="c-row-detail">ë¡œë“œ ì¤‘...</div>
    </div>
    <div class="card" style="border-left-color:#e5e7eb">
      <h3>ğŸ“‹ ì˜¤ëŠ˜ í˜¸ì¶œ ìœ í˜•ë³„ ë‚´ì—­</h3>
      <div id="c-breakdown">ë¡œë“œ ì¤‘...</div>
    </div>
  </div>

</div><!-- /wrap -->

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CFG â€” service_roleì€ ëŸ°íƒ€ì„ì— localStorageì—ì„œ ì£¼ì…
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CFG = {
  url:          'https://zrlpwmpbrvohautldcon.supabase.co',
  key:          'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G',
  service_role: '',   // saveSrKey() í˜¸ì¶œ ì‹œ ì±„ì›Œì§
  master:       'positivecha@gmail.com',
  owner:        'fitzcha',
  repo:         'newsbot',
  workflow:     'daily_run.yml'
};

const sc = supabase.createClient(CFG.url, CFG.key);
let me = null, autoTimer = null, costChartInstance = null;
let directiveMode = 'single';
let allMembers = [];   // íšŒì› ëª©ë¡ ìºì‹œ
let evoPropsAll = [], evoStatusFilter = 'PENDING', evoPage = 1;
let evoAgentsAll = [], evoAgentPage = 1;
let devRowsAll = [], devStatusFilter = 'ALL', devPage = 1;
const EVO_PAGE_SIZE = 6;
const EVO_AGENT_PAGE_SIZE = 6;
const DEV_PAGE_SIZE = 6;

const STATUS_KO = {
  ALL: 'ì „ì²´',
  PENDING: 'ëŒ€ê¸°',
  PENDING_MASTER: 'ëŒ€í‘œìŠ¹ì¸ëŒ€ê¸°',
  CONFIRMED: 'í™•ì •',
  DEVELOPING: 'ë°°í¬ì¤‘',
  COMPLETED: 'ì™„ë£Œ',
  DEPLOYED: 'ë°°í¬ì™„ë£Œ',
  APPROVED: 'ìŠ¹ì¸',
  REJECTED: 'ë°˜ë ¤',
  FAILED: 'ì‹¤íŒ¨',
  BACKUP_FAILED: 'ë°±ì—…ì‹¤íŒ¨',
  SYNTAX_ERROR: 'ë¬¸ë²•ì˜¤ë¥˜',
  VALIDATION_ERROR: 'ê²€ì¦ì˜¤ë¥˜',
  DEPLOY_FAILED: 'ë°°í¬ì‹¤íŒ¨',
};
const EVO_STATUS_BASE = ['ALL','PENDING','APPROVED','REJECTED'];
const DEV_STATUS_BASE = ['ALL','PENDING','PENDING_MASTER','CONFIRMED','DEVELOPING','COMPLETED','DEPLOYED','FAILED','REJECTED'];
const ROLE_BRIEF = {
  BA: 'ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ê³¼ ê²½ìŸ êµ¬ë„ë¥¼ í•´ì„í•©ë‹ˆë‹¤.',
  STOCK: 'ì‹œì¥ ë°˜ì‘ê³¼ íˆ¬ì ì‹œê·¸ë„ì„ ë¶„ì„í•©ë‹ˆë‹¤.',
  PM: 'ì„œë¹„ìŠ¤ ê¸°íš ìš°ì„ ìˆœìœ„ì™€ ì‹¤í–‰ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.',
  HR: 'ì¡°ì§ ìš´ì˜ê³¼ ì¸ì‚¬/ë¬¸í™” ê´€ì ì„ ì ê²€í•©ë‹ˆë‹¤.',
  DEV: 'ê°œë°œ êµ¬í˜„ê³¼ ë°°í¬ ì•ˆì •ì„±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.',
  QA: 'í’ˆì§ˆ ë¦¬ìŠ¤í¬ë¥¼ ì‚¬ì „ ê²€ì¦í•©ë‹ˆë‹¤.',
  BRIEF: 'í•µì‹¬ ë¸Œë¦¬í•‘ì„ ì§§ê³  ëª…í™•í•˜ê²Œ ìš”ì•½í•©ë‹ˆë‹¤.',
  KW: 'í‚¤ì›Œë“œ í™•ì¥/ì •ì œë¥¼ í†µí•´ íƒì§€ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.',
  DATA: 'ë°ì´í„° ìˆ˜ì§‘ í’ˆì§ˆê³¼ ì»¤ë²„ë¦¬ì§€ë¥¼ ê°œì„ í•©ë‹ˆë‹¤.',
  INFO: 'ì™¸ë¶€ ì •ë³´ì˜ ë§¥ë½ê³¼ ì‹ ë¢°ë„ë¥¼ ë³´ê°•í•©ë‹ˆë‹¤.',
  MASTER: 'ì—ì´ì „íŠ¸ ìš´ì˜ì„ ì´ê´„ ì¡°ì •í•©ë‹ˆë‹¤.',
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìœ í‹¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, dur=3000) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
}
function $id(id) { return document.getElementById(id); }
function render(id, html) { const el=$id(id); if(el) el.innerHTML=html; }
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function getSrKey() { return CFG.service_role || localStorage.getItem('sr_key') || ''; }
function hasSrKey() { return !!getSrKey(); }
function statusLabel(s) { return STATUS_KO[s] || s; }
function summarizeText(raw, maxLen=130) {
  const txt = String(raw || '')
    .replace(/\[PROPOSAL\]|\[REASON\]|\[NEEDS_DEV\]/gi, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  if(!txt) return 'ìš”ì•½ ì •ë³´ ì—†ìŒ';
  if(txt.length <= maxLen) return txt;
  const cut = txt.slice(0, maxLen);
  const stop = Math.max(cut.lastIndexOf('. '), cut.lastIndexOf('! '), cut.lastIndexOf('? '), cut.lastIndexOf('ë‹¤.'));
  return (stop > 40 ? cut.slice(0, stop + 1) : cut) + 'â€¦';
}
function withExtraStatuses(base, counts) {
  const extras = Object.keys(counts).filter(k => k !== 'ALL' && !base.includes(k));
  return [...base, ...extras];
}
function buildStatusFilterHTML(order, active, counts, clickFn) {
  return order.map(st => `
    <button class="status-chip ${st===active?'on':''}" onclick="${clickFn}('${st}')">
      ${statusLabel(st)} <span class="cnt">${counts[st] || 0}</span>
    </button>
  `).join('');
}
function buildPagerHTML(page, totalPages, totalItems, pageSize, prevFn, nextFn) {
  if(totalPages <= 1) return '';
  const from = totalItems === 0 ? 0 : ((page - 1) * pageSize + 1);
  const to = Math.min(page * pageSize, totalItems);
  return `
    <div class="list-pager">
      <button class="pbtn" onclick="${prevFn}()" ${page<=1?'disabled':''}>â—€ ì´ì „</button>
      <span class="pinfo">${page}/${totalPages} Â· ${from}-${to}</span>
      <button class="pbtn" onclick="${nextFn}()" ${page>=totalPages?'disabled':''}>ë‹¤ìŒ â–¶</button>
    </div>
  `;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   í† í° / SR í‚¤ ê´€ë¦¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveToken() {
  const v = $id('ghp-token').value.trim();
  if(!v) return toast('âŒ GHP í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('ghp_token', v);
  updateTokenStatus(v);
  toast('âœ… GHP í† í° ì €ì¥ ì™„ë£Œ');
}
function getToken() { return localStorage.getItem('ghp_token') || ''; }
function updateTokenStatus(t) {
  $id('token-status').textContent = t ? 'âœ… GHP í™œì„±' : 'âš ï¸ ë¯¸ì…ë ¥';
  $id('token-status').style.color = t ? '#50fa7b' : '#ffb86c';
}

function saveSrKey() {
  const v = $id('sr-key-input').value.trim();
  if(!v) return toast('âŒ service_role í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  localStorage.setItem('sr_key', v);
  CFG.service_role = v;
  updateSrStatus(v);
  toast('âœ… Service Role í‚¤ ì €ì¥ ì™„ë£Œ');
  // SR í‚¤ ì €ì¥ ì‹œ íšŒì› íƒ­ ê²½ê³  ìˆ¨ê¹€
  $id('sr-warn-member').classList.remove('show');
}
function updateSrStatus(k) {
  const has = !!k;
  $id('sr-status').textContent = has ? 'âœ… SR í™œì„±' : 'âš ï¸ ë¯¸ì…ë ¥';
  $id('sr-status').style.color  = has ? '#a78bfa' : '#ffb86c';
  $id('sr-badge').style.display  = has ? '' : 'none';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   íƒ­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function tab(t) {
  ['hr','evo','dev','member','log','voc','cost'].forEach(x => {
    $id('v-'+x).style.display = x===t ? 'block' : 'none';
    $id('t-'+x).classList.toggle('on', x===t);
  });
  if(t === 'cost')   loadCost();
  if(t === 'member') loadMemberSettings();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì‹œê³„ / ìë™ìŠ¹ì¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startClock() {
  const tick = () => {
    const kst = new Date(Date.now() + (9*60 - new Date().getTimezoneOffset())*60000);
    $id('now-time').textContent = kst.toLocaleTimeString('ko-KR');
  };
  tick(); setInterval(tick, 1000);
}
function startAutoApprovalTimer() {
  $id('auto-badge').style.display = '';
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(async () => {
    const kst = new Date(Date.now() + (9*60 - new Date().getTimezoneOffset())*60000);
    const [h,m,s] = [kst.getHours(), kst.getMinutes(), kst.getSeconds()];
    if(h===23 && m===30 && s<5) { await runAutoApproval(); return; }
    let now = h*3600+m*60+s, tgt = 23*3600+30*60;
    if(now >= tgt) tgt += 86400;
    let d = tgt-now, rh=Math.floor(d/3600), rm=Math.floor((d%3600)/60), rs=d%60;
    const el = $id('countdown-timer');
    el.textContent = `${String(rh).padStart(2,'0')}:${String(rm).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
    el.className = 'timer'+(rh<1?(rm<30?' danger':' warn'):'');
  }, 1000);
}
async function runAutoApproval() {
  try {
    const { data: pending } = await sc.from('pending_approvals').select('*').eq('status','PENDING');
    if(!pending?.length) return;
    for(const p of pending) {
      await sc.from('agents').update({ instruction: p.proposed_instruction }).eq('agent_role', p.agent_role);
      await sc.from('pending_approvals').update({ status:'APPROVED' }).eq('id', p.id);
    }
    toast(`â° 23:30 ìë™ìŠ¹ì¸ ì™„ë£Œ â€” ${pending.length}ê±´ ì ìš©ë¨`);
    loadEvo();
  } catch(e) { console.error('ìë™ìŠ¹ì¸ ì˜¤ë¥˜:', e); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íšŒì› ê´€ë¦¬ â€” í•µì‹¬ í•¨ìˆ˜ë“¤
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ ë ˆë²„ 2ê°œ í•©ì‚°í•´ì„œ ì‹¤ì œ ê°€ì… í—ˆìš© ì—¬ë¶€ ë°˜í™˜ â”€â”€ */
async function checkSignupAllowed() {
  const [countRes, maxRes, openRes] = await Promise.all([
    sc.from('member_count_view').select('count').single(),
    sc.from('app_settings').select('value').eq('key','max_members').maybeSingle(),
    sc.from('app_settings').select('value').eq('key','signup_open').maybeSingle(),
  ]);
  const current = Number(countRes.data?.count ?? 0);
  const maxVal  = Number(maxRes.data?.value   ?? 999999);
  const isOpen  = openRes.data?.value === 'true';
  return isOpen && current < maxVal;
}

/* â”€â”€ Supabase Auth ì „ì—­ ê°€ì… ON/OFF (service_role í•„ìš”) â”€â”€ */
async function setSupabaseSignup(enable) {
  const srKey = getSrKey();
  if(!srKey) throw new Error('service_role í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë³´ì•ˆë°”ì—ì„œ SR í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.');
  const res = await fetch(`${CFG.url}/auth/v1/admin/config`, {
    method: 'PATCH',
    headers: {
      'apikey':        srKey,
      'Authorization': `Bearer ${srKey}`,
      'Content-Type':  'application/json',
    },
    body: JSON.stringify({ disable_signup: !enable }),
  });
  if(!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(`Auth ì„¤ì • ì‹¤íŒ¨: ${err.msg || err.message || res.status}`);
  }
}

/* â”€â”€ ë ˆë²„1 (ìˆ˜ë™) ë³€ê²½ â†’ Auth í† ê¸€ ë™ê¸°í™” â”€â”€ */
async function setSignupStatus(open) {
  try {
    await sc.from('app_settings').upsert(
      { key: 'signup_open', value: String(open) },
      { onConflict: 'key' }
    );
    const allowed = await checkSignupAllowed();
    await setSupabaseSignup(allowed);
    updateSignupStatusUI(open, allowed);

    const reason = !open        ? 'ğŸ”’ ìˆ˜ë™ ì œí•œ'
                 : !allowed     ? 'âš ï¸ ìµœëŒ€ íšŒì› ìˆ˜ ì´ˆê³¼ë¡œ ìë™ ì œí•œ'
                 :                'âœ… í—ˆìš©';
    toast(allowed
      ? `âœ… íšŒì›ê°€ì… í—ˆìš© (Supabase Auth í™œì„±í™”)`
      : `ğŸ”’ íšŒì›ê°€ì… ì œí•œ (Supabase Auth ë¹„í™œì„±í™”) â€” ${reason}`
    );
  } catch(e) { toast('âŒ ë³€ê²½ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ ë ˆë²„2 (ìµœëŒ€ íšŒì› ìˆ˜) ë³€ê²½ â†’ Auth í† ê¸€ ë™ê¸°í™” â”€â”€ */
async function saveMaxMembers() {
  const val = $id('m-max-input').value.trim();
  if(!val || isNaN(val) || Number(val) < 1) return toast('âŒ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('app_settings').upsert(
      { key: 'max_members', value: String(val) },
      { onConflict: 'key' }
    );
    $id('m-max-count').textContent = val;
    const allowed = await checkSignupAllowed();
    await setSupabaseSignup(allowed);
    toast(allowed
      ? `âœ… ìµœëŒ€ íšŒì› ìˆ˜ ${val}ëª… ì €ì¥ â€” ê°€ì… í—ˆìš© ìœ ì§€`
      : `âœ… ìµœëŒ€ íšŒì› ìˆ˜ ${val}ëª… ì €ì¥ â€” í˜„ì¬ íšŒì› ìˆ˜ ì´ˆê³¼ë¡œ ìë™ ì œí•œ`
    );
    loadMemberSettings();
  } catch(e) { toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
}

/* â”€â”€ UI ì—…ë°ì´íŠ¸ í—¬í¼ â”€â”€ */
function updateSignupStatusUI(lever1Open, allowed) {
  $id('lever1-val').textContent    = lever1Open ? 'âœ… í—ˆìš©' : 'ğŸ”’ ì œí•œ';
  $id('lever1-val').style.color    = lever1Open ? '#15803d' : '#b91c1c';

  const badge = $id('signup-status-badge');
  const authSt = $id('m-auth-status');
  if(allowed === undefined) {
    badge.textContent  = 'í™•ì¸ ì¤‘...';
    badge.className    = 'signup-status-badge';
    authSt.textContent = 'â€”';
  } else if(allowed) {
    badge.textContent  = 'ğŸŸ¢ ê°€ì… í—ˆìš© ì¤‘';
    badge.className    = 'signup-status-badge open';
    authSt.textContent = 'ğŸŸ¢ OPEN';
    authSt.style.color = '#15803d';
  } else {
    badge.textContent  = lever1Open ? 'ğŸŸ¡ ìµœëŒ€ ì¸ì› ì´ˆê³¼ ì œí•œ' : 'ğŸ”´ ìˆ˜ë™ ì œí•œ';
    badge.className    = 'signup-status-badge ' + (lever1Open ? 'auto-closed' : 'closed');
    authSt.textContent = 'ğŸ”´ CLOSED';
    authSt.style.color = '#b91c1c';
  }
}

/* â”€â”€ íšŒì› ì„¤ì • ë¡œë“œ (íƒ­ ì§„ì… ì‹œ ìë™ í˜¸ì¶œ) â”€â”€ */
async function loadMemberSettings() {
  // SR í‚¤ ê²½ê³ 
  if(!hasSrKey()) $id('sr-warn-member').classList.add('show');
  else            $id('sr-warn-member').classList.remove('show');

  try {
    const [countRes, maxRes, openRes] = await Promise.all([
      sc.from('member_count_view').select('count').single(),
      sc.from('app_settings').select('value').eq('key','max_members').maybeSingle(),
      sc.from('app_settings').select('value').eq('key','signup_open').maybeSingle(),
    ]);
    const current = Number(countRes.data?.count ?? 0);
    const maxVal  = Number(maxRes.data?.value   ?? 999999);
    const isOpen  = openRes.data?.value === 'true';
    const allowed = isOpen && current < maxVal;

    $id('m-cur-count').textContent = current;
    $id('m-max-count').textContent = maxVal === 999999 ? 'ë¬´ì œí•œ' : maxVal;
    $id('lever2-val').textContent  = `${current} / ${maxVal === 999999 ? 'ë¬´ì œí•œ' : maxVal}ëª…`;
    $id('lever2-val').style.color  = (current >= maxVal && maxVal !== 999999) ? '#b91c1c' : '#15803d';

    updateSignupStatusUI(isOpen, allowed);
  } catch(e) {
    toast('âš ï¸ íšŒì› ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  }
}

/* â”€â”€ íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Auth Admin API) â”€â”€ */
async function loadMemberList() {
  const srKey = getSrKey();
  if(!srKey) return toast('âŒ SR í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë³´ì•ˆë°”ì—ì„œ SR í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.');

  render('member-table-wrap', '<div class="empty" style="padding:30px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>');
  try {
    // Supabase Auth Admin API: ìµœëŒ€ 1000ëª… ë‹¨ìˆœ í˜ì´ì§€
    const res = await fetch(`${CFG.url}/auth/v1/admin/users?page=1&per_page=200`, {
      headers: {
        'apikey':        srKey,
        'Authorization': `Bearer ${srKey}`,
      }
    });
    if(!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(`Auth API ì˜¤ë¥˜: ${err.msg || err.message || res.status}`);
    }
    const json = await res.json();
    // Supabase returns { users: [...] } or just [...]
    allMembers = json.users || json || [];
    renderMemberTable(allMembers);
  } catch(e) {
    render('member-table-wrap', `<div class="empty" style="color:#ef4444">âŒ ${escHtml(e.message)}</div>`);
  }
}

/* â”€â”€ íšŒì› í…Œì´ë¸” ë Œë”ë§ â”€â”€ */
function renderMemberTable(members) {
  if(!members.length) {
    render('member-table-wrap', '<div class="empty">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
    return;
  }
  const rows = members.map((u, i) => {
    const isBanned = !!u.banned_until && new Date(u.banned_until) > new Date();
    const createdAt = u.created_at ? u.created_at.slice(0,10) : 'â€”';
    const lastSign  = u.last_sign_in_at ? u.last_sign_in_at.slice(0,16).replace('T',' ') : 'ë¯¸ë¡œê·¸ì¸';
    return `<tr>
      <td style="color:#94a3b8;font-size:.78rem">${i+1}</td>
      <td><span class="user-email">${escHtml(u.email||'(ì´ë©”ì¼ ì—†ìŒ)')}</span></td>
      <td><span class="user-date">${createdAt}</span></td>
      <td><span class="user-date">${lastSign}</span></td>
      <td><span class="ban-badge ${isBanned?'banned':'active'}">${isBanned?'ğŸš« ì°¨ë‹¨':'âœ… ì •ìƒ'}</span></td>
      <td>
        ${isBanned
          ? `<button class="ban-btn do-unban" onclick="toggleBan('${escHtml(u.id)}','${escHtml(u.email||'')}',false)">í•´ì œ</button>`
          : `<button class="ban-btn do-ban"   onclick="toggleBan('${escHtml(u.id)}','${escHtml(u.email||'')}',true)">ì°¨ë‹¨</button>`
        }
      </td>
    </tr>`;
  }).join('');

  render('member-table-wrap', `
    <table class="member-table">
      <thead><tr>
        <th>#</th><th>ì´ë©”ì¼</th><th>ê°€ì…ì¼</th><th>ìµœê·¼ ë¡œê·¸ì¸</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `);
}

/* â”€â”€ ê²€ìƒ‰ í•„í„° â”€â”€ */
function filterMembers() {
  const q = ($id('member-search').value || '').toLowerCase();
  const filtered = q ? allMembers.filter(u => (u.email||'').toLowerCase().includes(q)) : allMembers;
  renderMemberTable(filtered);
}

/* â”€â”€ ê°œë³„ ì°¨ë‹¨ / í•´ì œ (Auth Admin API PATCH) â”€â”€ */
async function toggleBan(userId, email, ban) {
  const srKey = getSrKey();
  if(!srKey) return toast('âŒ SR í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  if(!confirm(`${email} ì„(ë¥¼) ${ban ? 'ì°¨ë‹¨' : 'í•´ì œ'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    // ban: banned_untilì„ ë¨¼ ë¯¸ë˜ë¡œ, unban: null ë˜ëŠ” ê³¼ê±°
    const body = ban
      ? { ban_duration: '876000h' }   // ~100ë…„
      : { ban_duration: 'none' };
    const res = await fetch(`${CFG.url}/auth/v1/admin/users/${userId}`, {
      method:  'PUT',
      headers: {
        'apikey':        srKey,
        'Authorization': `Bearer ${srKey}`,
        'Content-Type':  'application/json',
      },
      body: JSON.stringify(body),
    });
    if(!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(`Auth API ì˜¤ë¥˜: ${err.msg || err.message || res.status}`);
    }
    toast(ban ? `ğŸš« ${email} ì°¨ë‹¨ ì™„ë£Œ` : `âœ… ${email} ì°¨ë‹¨ í•´ì œ ì™„ë£Œ`);
    // ìºì‹œ ì—…ë°ì´íŠ¸
    const updated = await res.json();
    const idx = allMembers.findIndex(u => u.id === userId);
    if(idx >= 0) allMembers[idx] = updated;
    renderMemberTable(allMembers);
  } catch(e) { toast('âŒ ì‹¤íŒ¨: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì§€ëŠ¥ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setDirectiveMode(mode) {
  directiveMode = mode;
  $id('mode-single').classList.toggle('on', mode==='single');
  $id('mode-all').classList.toggle('on', mode==='all');
  $id('directive-single').style.display = mode==='single' ? 'block' : 'none';
  $id('directive-all').style.display    = mode==='all'    ? 'block' : 'none';
}
function onDirectiveInput(el) {
  const len = el.value.length;
  const cc = $id('char-count');
  cc.textContent = `${len}ì`;
  cc.className = 'char-count' + (len>300?' over':len>200?' warn':'');
  const multi = /(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  $id('one-rule-warn').classList.toggle('show', multi.test(el.value) && el.value.length>30);
}
async function loadAgentSelect() {
  try {
    const { data } = await sc.from('agents').select('agent_role').order('agent_role');
    const roles = (data||[]).map(a => a.agent_role);
    const icons = {BA:'ğŸ”',STOCK:'ğŸ“ˆ',PM:'ğŸ—‚',HR:'ğŸ‘¤',DEV:'ğŸ’»',QA:'âœ…',BRIEF:'ğŸ“',KW:'ğŸ”‘',DATA:'ğŸ“‰',INFO:'ğŸŒ'};
    render('m-role', roles.length
      ? roles.map(r=>`<option value="${r}">${icons[r]||'ğŸ¤–'} ${r}</option>`).join('')
      : `<option value="BA">ğŸ” BA</option><option value="STOCK">ğŸ“ˆ STOCK</option><option value="PM">ğŸ—‚ PM</option>`
    );
  } catch { render('m-role','<option value="BA">ğŸ” BA</option>'); }
}
async function sendDirectOrder() {
  const text = $id('m-text').value.trim();
  if(!text) return toast('âŒ ì§€ì¹¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
  const multi = /(\d+\.\s|\n{2,}|;\s*[^\n]|[ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜]\.\s)/;
  if(multi.test(text) && text.length>30 && !confirm('âš ï¸ ì—¬ëŸ¬ ì•ˆê±´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const applyMode = document.querySelector('input[name="apply-mode"]:checked').value;
  try {
    if(directiveMode === 'single') {
      const role = $id('m-role').value;
      if(!role) return toast('âŒ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      await applyDirective(role, text, applyMode);
      toast(`âš¡ ${role} ì—ì´ì „íŠ¸ ì§€ì¹¨ í•˜ë‹¬ ì™„ë£Œ`);
    } else {
      const { data: agents } = await sc.from('agents').select('agent_role, instruction');
      if(!agents?.length) return toast('âŒ ë“±ë¡ëœ ì—ì´ì „íŠ¸ ì—†ìŒ');
      if(!confirm(`ğŸ“¢ ${agents.length}ëª… ì „ì²´ì—ê²Œ í•˜ë‹¬í•©ë‹ˆë‹¤. ê³„ì†?`)) return;
      for(const a of agents) await applyDirective(a.agent_role, text, applyMode, a.instruction);
      toast(`ğŸ“¢ ì „ì²´ ${agents.length}ê°œ ì—ì´ì „íŠ¸ í•˜ë‹¬ ì™„ë£Œ`);
    }
    $id('m-text').value=''; $id('char-count').textContent='0ì';
    $id('one-rule-warn').classList.remove('show');
    loadEvo();
  } catch(e) { toast('âŒ í•˜ë‹¬ ì‹¤íŒ¨: '+e.message); }
}
async function applyDirective(role, newText, mode, existingInstruction) {
  let cur = existingInstruction;
  if(cur === undefined) {
    const { data } = await sc.from('agents').select('instruction').eq('agent_role',role).single();
    cur = data?.instruction || '';
  }
  const final = mode==='append'
    ? (cur ? cur+'\n\n---\n[ë§ˆìŠ¤í„° ì¶”ê°€ '+new Date().toLocaleDateString('ko-KR')+']\n'+newText : newText)
    : newText;
  const { error } = await sc.from('agents').update({ instruction: final }).eq('agent_role',role);
  if(error) throw error;
  await sc.from('pending_approvals').insert([{
    agent_role: role, proposed_instruction: final,
    proposal_reason: `ë§ˆìŠ¤í„° ì§ì ‘ í•˜ë‹¬ (${mode==='append'?'ì¶”ê°€':'ëŒ€ì²´'})`, status: 'APPROVED'
  }]);
}
function setEvoStatus(status) { evoStatusFilter = status; evoPage = 1; renderEvoProposalList(); }
function evoPrevPage() { if(evoPage > 1) { evoPage--; renderEvoProposalList(); } }
function evoNextPage() {
  const totalPages = Math.max(1, Math.ceil(getEvoFilteredProps().length / EVO_PAGE_SIZE));
  if(evoPage < totalPages) { evoPage++; renderEvoProposalList(); }
}
function agentPrevPage() { if(evoAgentPage > 1) { evoAgentPage--; renderLiveAgentList(); } }
function agentNextPage() {
  const totalPages = Math.max(1, Math.ceil((evoAgentsAll||[]).length / EVO_AGENT_PAGE_SIZE));
  if(evoAgentPage < totalPages) { evoAgentPage++; renderLiveAgentList(); }
}
function getEvoFilteredProps() {
  const rows = evoPropsAll || [];
  if(evoStatusFilter === 'ALL') return rows;
  return rows.filter(p => (p.status || 'PENDING') === evoStatusFilter);
}
function renderEvoStatusFilters() {
  const counts = { ALL: (evoPropsAll || []).length };
  (evoPropsAll || []).forEach(p => {
    const st = (p.status || 'PENDING').toUpperCase();
    counts[st] = (counts[st] || 0) + 1;
  });
  const order = withExtraStatuses(EVO_STATUS_BASE, counts);
  render('evo-status-filters', buildStatusFilterHTML(order, evoStatusFilter, counts, 'setEvoStatus'));
}
function renderEvoProposalList() {
  const filtered = getEvoFilteredProps();
  const totalItems = filtered.length;
  const totalPages = Math.max(1, Math.ceil(totalItems / EVO_PAGE_SIZE));
  if(evoPage > totalPages) evoPage = totalPages;
  if(evoPage < 1) evoPage = 1;
  const start = (evoPage - 1) * EVO_PAGE_SIZE;
  const rows = filtered.slice(start, start + EVO_PAGE_SIZE);

  if(!totalItems) {
    render('pending-evo-list', `<h3>ğŸ“„ ì§€ëŠ¥ ë°œì˜ ë¦¬ìŠ¤íŠ¸</h3><div class="empty">ì„ íƒí•œ ìƒíƒœì˜ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>`);
    return;
  }

  render('pending-evo-list',
    `<h3>ğŸ“„ ì§€ëŠ¥ ë°œì˜ ë¦¬ìŠ¤íŠ¸</h3>
     <div class="list-summary">ì´ ${totalItems}ê±´ Â· ìƒíƒœ: ${statusLabel(evoStatusFilter)}</div>`
    + rows.map(p => {
      const st = (p.status || 'PENDING').toUpperCase();
      const canDecide = st === 'PENDING';
      const created = p.created_at ? p.created_at.slice(0,16).replace('T',' ') : '';
      return `<div class="evo-card">
        <div class="meta">ğŸ¤– ${p.agent_role} Â· ${created} Â· ${escHtml(p.proposal_reason || 'ì—ì´ì „íŠ¸ ììœ¨ ì œì•ˆ')}
          <span class="s-tag s-${st}">${statusLabel(st)}</span>
        </div>
        <div class="box summary-box"><b>í•µì‹¬ ìš”ì•½</b><br>${escHtml(summarizeText(p.proposed_instruction, 160))}</div>
        <details>
          <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ì „ì²´ ì œì•ˆ ë³´ê¸°</summary>
          <div class="box">${escHtml(p.proposed_instruction || 'ë‚´ìš© ì—†ìŒ')}</div>
        </details>
        ${canDecide ? `
          <div class="evo-actions">
            <button class="sm" style="background:var(--success)" onclick="decideEvo('${p.id}','${p.agent_role}','APPROVED')">âœ… ìŠ¹ì¸</button>
            <button class="sm" style="background:var(--admin)"   onclick="decideEvo('${p.id}','${p.agent_role}','REJECTED')">âŒ ë°˜ë ¤</button>
          </div>
        ` : ``}
      </div>`;
    }).join('')
    + buildPagerHTML(evoPage, totalPages, totalItems, EVO_PAGE_SIZE, 'evoPrevPage', 'evoNextPage')
  );
}
function renderLiveAgentList() {
  const totalItems = (evoAgentsAll || []).length;
  const totalPages = Math.max(1, Math.ceil(totalItems / EVO_AGENT_PAGE_SIZE));
  if(evoAgentPage > totalPages) evoAgentPage = totalPages;
  if(evoAgentPage < 1) evoAgentPage = 1;
  const start = (evoAgentPage - 1) * EVO_AGENT_PAGE_SIZE;
  const rows = (evoAgentsAll || []).slice(start, start + EVO_AGENT_PAGE_SIZE);

  render('live-agent-list',
    `<h3>ğŸš€ í˜„ì¬ ê°€ë™ ì¤‘ì¸ ì—ì´ì „íŠ¸ ì§€ì¹¨</h3>
     <div class="list-summary">ì´ ${totalItems}ëª… ì—ì´ì „íŠ¸</div>`
    + (rows.length===0
      ? `<div class="empty">ì—ì´ì „íŠ¸ ì •ë³´ ì—†ìŒ</div>`
      : rows.map(a => {
          const role = a.agent_role || 'UNKNOWN';
          const full = a.instruction || 'ì§€ì¹¨ ì—†ìŒ';
          return `<div class="card" style="border-left-color:#bbb">
            <strong>ğŸ¤– ${escHtml(role)}</strong>
            <div class="role-brief">ì—­í•  ìš”ì•½: ${escHtml(ROLE_BRIEF[role] || 'ì—­í•  ì„¤ëª…ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')}</div>
            <div class="box summary-box"><b>í•µì‹¬ ì§€ì¹¨ ìš”ì•½</b><br>${escHtml(summarizeText(full, 150))}</div>
            <details>
              <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ì§€ì¹¨ ì „ì²´ ë³´ê¸°</summary>
              <div class="box">${escHtml(full)}</div>
            </details>
          </div>`;
        }).join('')
    )
    + buildPagerHTML(evoAgentPage, totalPages, totalItems, EVO_AGENT_PAGE_SIZE, 'agentPrevPage', 'agentNextPage')
  );
}
async function loadEvo() {
  try {
    const [agRes, prRes] = await Promise.all([
      sc.from('agents').select('agent_role, instruction').order('agent_role'),
      sc.from('pending_approvals').select('id,agent_role,proposed_instruction,proposal_reason,created_at,status')
        .order('created_at',{ascending:false}).limit(500)
    ]);
    evoAgentsAll = agRes.data || [];
    evoPropsAll  = (prRes.data || []).map(p => ({ ...p, status: (p.status || 'PENDING').toUpperCase() }));
    const pendingCnt = evoPropsAll.filter(p => p.status === 'PENDING').length;
    $id('evo-cnt').style.display = pendingCnt ? '' : 'none';
    if(pendingCnt) $id('evo-cnt').textContent = pendingCnt;

    renderEvoStatusFilters();
    renderEvoProposalList();
    renderLiveAgentList();
  } catch(e) {
    render('evo-status-filters', '');
    render('pending-evo-list', `<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
    render('live-agent-list', `<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}
async function decideEvo(id, role, status) {
  try {
    if(status==='APPROVED') {
      const { data: p } = await sc.from('pending_approvals').select('proposed_instruction').eq('id',id).single();
      if(p) { const {error}=await sc.from('agents').update({instruction:p.proposed_instruction}).eq('agent_role',role); if(error) throw error; }
    }
    await sc.from('pending_approvals').update({status}).eq('id',id);
    toast(status==='APPROVED'?`âœ… ${role} ì§€ì¹¨ ìŠ¹ì¸ ì™„ë£Œ`:`âŒ ${role} ì•ˆê±´ ë°˜ë ¤ë¨`);
    loadEvo();
  } catch(e) { toast('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê°œë°œ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setDevStatus(status) { devStatusFilter = status; devPage = 1; renderDevList(); }
function devPrevPage() { if(devPage > 1) { devPage--; renderDevList(); } }
function devNextPage() {
  const totalPages = Math.max(1, Math.ceil(getFilteredDevRows().length / DEV_PAGE_SIZE));
  if(devPage < totalPages) { devPage++; renderDevList(); }
}
function getFilteredDevRows() {
  const rows = devRowsAll || [];
  if(devStatusFilter === 'ALL') return rows;
  return rows.filter(r => (r.status || 'PENDING') === devStatusFilter);
}
function renderDevStatusFilters() {
  const counts = { ALL: (devRowsAll || []).length };
  (devRowsAll || []).forEach(r => {
    const st = (r.status || 'PENDING').toUpperCase();
    counts[st] = (counts[st] || 0) + 1;
  });
  const order = withExtraStatuses(DEV_STATUS_BASE, counts);
  render('dev-status-filters', buildStatusFilterHTML(order, devStatusFilter, counts, 'setDevStatus'));
}
function renderDevList() {
  const filtered = getFilteredDevRows();
  const totalItems = filtered.length;
  const totalPages = Math.max(1, Math.ceil(totalItems / DEV_PAGE_SIZE));
  if(devPage > totalPages) devPage = totalPages;
  if(devPage < 1) devPage = 1;
  const start = (devPage - 1) * DEV_PAGE_SIZE;
  const rows = filtered.slice(start, start + DEV_PAGE_SIZE);

  if(!totalItems) {
    render('dev-list', `<h3>ğŸ“‹ ê°œë°œ ë°±ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</h3><div class="empty">ì„ íƒí•œ ìƒíƒœì˜ ì•ˆê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>`);
    return;
  }

  render('dev-list',
    `<h3>ğŸ“‹ ê°œë°œ ë°±ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</h3>
     <div class="list-summary">ì´ ${totalItems}ê±´ Â· ìƒíƒœ: ${statusLabel(devStatusFilter)}</div>`
    + rows.map(b => {
      const st = (b.status || 'PENDING').toUpperCase();
      const created = b.created_at ? new Date(b.created_at).toLocaleString('ko-KR') : '';
      let btns = '';
      if(st === 'PENDING' || st === 'PENDING_MASTER') {
        btns = `
          <button class="sm" style="background:var(--primary)" onclick="upDev('${b.id}','CONFIRMED')">âœ… ê°œë°œ í™•ì •</button>
          <button class="sm" style="background:var(--admin)" onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>
        `;
      } else if(st === 'CONFIRMED') {
        btns = `
          <button class="sm" style="background:var(--dev)" onclick="triggerDev('${b.id}')">ğŸš€ ë°°í¬ ì‹œì‘</button>
          <button class="sm" style="background:var(--admin)" onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>
        `;
      } else if(st === 'DEVELOPING') {
        btns = `<span class="pulse" style="color:var(--dev);font-weight:700">â³ AI ë°°í¬ ì¤‘...</span>`;
      } else if(['FAILED','DEPLOY_FAILED','VALIDATION_ERROR','SYNTAX_ERROR','BACKUP_FAILED'].includes(st)) {
        btns = `
          <button class="sm" style="background:#475569" onclick="upDev('${b.id}','CONFIRMED')">ğŸ” ì¬ì‹œë„ ì¤€ë¹„</button>
          <button class="sm" style="background:var(--admin)" onclick="rejectDev('${b.id}')">âŒ ë§ˆìŠ¤í„° ë°˜ë ¤</button>
        `;
      } else if(st === 'REJECTED') {
        btns = `<button class="sm" style="background:#475569" onclick="upDev('${b.id}','PENDING')">â†©ï¸ ì¬ì˜¤í”ˆ</button>`;
      } else {
        btns = `<span style="color:var(--success);font-weight:700">âœ… ${statusLabel(st)}</span>`;
      }

      return `<div class="card" style="border-left-color:var(--dev)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
          <div><strong>${escHtml(b.title || 'ë¬´ì œ')}</strong><span class="s-tag s-${st}">${statusLabel(st)}</span></div>
          <small style="color:#aaa">${created}</small>
        </div>
        <div class="box summary-box"><b>ìš”ì•½</b><br>${escHtml(summarizeText(b.task_detail || '', 150))}</div>
        <details>
          <summary style="cursor:pointer;font-size:.82rem;font-weight:700;color:#64748b">ìš”êµ¬ì‚¬í•­ ì „ì²´ ë³´ê¸°</summary>
          <div class="box">${escHtml(b.task_detail || '')}</div>
        </details>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">${btns}</div>
      </div>`;
    }).join('')
    + buildPagerHTML(devPage, totalPages, totalItems, DEV_PAGE_SIZE, 'devPrevPage', 'devNextPage')
  );
}
async function loadDev() {
  try {
    const { data, error } = await sc.from('dev_backlog').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    devRowsAll = (data || []).map(d => ({ ...d, status: (d.status || 'PENDING').toUpperCase() }));
    const openCnt = devRowsAll.filter(b => ['PENDING','PENDING_MASTER','CONFIRMED','DEVELOPING'].includes(b.status)).length;
    $id('dev-cnt').style.display = openCnt ? '' : 'none';
    if(openCnt) $id('dev-cnt').textContent = openCnt;
    renderDevStatusFilters();
    renderDevList();
  } catch(e) {
    render('dev-status-filters', '');
    render('dev-list',`<div class="card">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`);
  }
}
async function addDev() {
  const title=$id('d-title').value.trim(), task=$id('d-task').value.trim();
  if(!title||!task) return toast('âŒ ì œëª©ê³¼ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').insert([{title,task_detail:task,status:'PENDING',priority:5}]);
    $id('d-title').value=''; $id('d-task').value='';
    toast('ğŸ“‹ ê°œë°œ ì•ˆê±´ ë“±ë¡ ì™„ë£Œ'); loadDev();
  } catch(e) { toast('âŒ ë“±ë¡ ì‹¤íŒ¨: '+e.message); }
}
async function rejectDev(id) {
  if(!confirm('í•´ë‹¹ ê°œë°œ ì•ˆê±´ì„ ë§ˆìŠ¤í„° ë°˜ë ¤ ì²˜ë¦¬í• ê¹Œìš”?')) return;
  await upDev(id, 'REJECTED');
}
async function upDev(id, status) {
  try {
    await sc.from('dev_backlog').update({status}).eq('id',id);
    toast(`âœ… ìƒíƒœ ì—…ë°ì´íŠ¸: ${statusLabel(status)}`);
    loadDev();
  } catch(e) {
    toast('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.message);
  }
}
async function triggerDev(id) {
  const token=getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”');
  try {
    await sc.from('dev_backlog').update({status:'DEVELOPING'}).eq('id',id);
    const res=await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {method:'POST',headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
       body:JSON.stringify({ref:'main',inputs:{backlog_id:String(id)}})}
    );
    if(res.status===204) { toast('ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!'); }
    else { const e=await res.json().catch(()=>({})); await sc.from('dev_backlog').update({status:'CONFIRMED'}).eq('id',id); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
    loadDev();
  } catch(e) { toast('âŒ ë°°í¬ ì‹¤íŒ¨: '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í¬ëŸ¼ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLogs() {
  try {
    const { data } = await sc.from('action_logs').select('*').order('executed_at',{ascending:false}).limit(30);
    const lines=(data||[]).map(l=>{
      const t=l.executed_at?l.executed_at.slice(11,19):'??:??:??';
      const msg=l.memo||l.details||(l.target_word?l.target_word+' ë¶„ì„ ì™„ë£Œ':'ì‹œìŠ¤í…œ ì´ë²¤íŠ¸');
      const cls=msg.includes('âŒ')||msg.includes('ì‹¤íŒ¨')?'err':msg.includes('âš ï¸')?'warn':'info';
      return `<div class="${cls}">[${t} KST] ${escHtml(String(msg))}</div>`;
    });
    render('forum-box',`<span class="info"># Sovereign HQ â€” ì‘ì „ ë¡œê·¸ (${lines.length}ê±´)</span><br>`+(lines.join('')||'<span style="color:#aaa">ë¡œê·¸ ì—†ìŒ</span>'));
  } catch(e) { render('forum-box',`<span class="err">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}
async function triggerRun() {
  const token=getToken();
  if(!token) return toast('âŒ GHP í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”');
  if(!confirm('ì „ì²´ ì‹œìŠ¤í…œì„ ì¦‰ì‹œ ê°€ë™í•©ë‹ˆë‹¤. ê³„ì†?')) return;
  try {
    const res=await fetch(
      `https://api.github.com/repos/${CFG.owner}/${CFG.repo}/actions/workflows/${CFG.workflow}/dispatches`,
      {method:'POST',headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
       body:JSON.stringify({ref:'main',inputs:{}})}
    );
    if(res.status===204) { toast('ğŸš€ ì‹œìŠ¤í…œ ê°€ë™ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ!'); setTimeout(loadLogs,3000); }
    else { const e=await res.json().catch(()=>({})); throw new Error(`${res.status}: ${e.message||'ì˜¤ë¥˜'}`); }
  } catch(e) { toast('âŒ ê°€ë™ ì‹¤íŒ¨: '+e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ëµ íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadHrDates() {
  try {
    const { data } = await sc.from('reports').select('report_date').eq('user_id',me.id).order('report_date',{ascending:false});
    const dates=[...new Set((data||[]).map(d=>d.report_date))];
    if(!dates.length) { render('hr-content','<div style="color:#aaa;text-align:center;padding:40px">ë¦¬í¬íŠ¸ ì—†ìŒ</div>'); return; }
    render('hr-date', dates.map(d=>`<option value="${d}">${d}</option>`).join(''));
    loadHrReport();
  } catch(e) { console.error(e); }
}
async function loadHrReport() {
  const date=$id('hr-date')?.value; if(!date) return;
  try {
    const { data } = await sc.from('reports').select('content').eq('report_date',date).eq('user_id',me.id).single();
    const c=data?.content; let html='';
    if(c?.hr_proposal)      html+=`<h2>ğŸ‘¤ HR ì œì•ˆ</h2>${marked.parse(c.hr_proposal)}`;
    if(c?.ba_brief)         html+=`<h2>ğŸ” BA ë¶„ì„</h2>${marked.parse(c.ba_brief)}`;
    if(c?.pm_brief)         html+=`<h2>ğŸ—‚ PM ë¸Œë¦¬í•‘</h2>${marked.parse(c.pm_brief)}`;
    if(c?.securities_brief) html+=`<h2>ğŸ“ˆ ì¦ê¶Œ ì¸ì‚¬ì´íŠ¸</h2>${marked.parse(c.securities_brief)}`;
    render('hr-content', html||'<div style="color:#aaa;text-align:center;padding:40px">ë‚´ìš© ì—†ìŒ</div>');
  } catch(e) { render('hr-content',`<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOC íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadVoc() {
  try {
    const { data } = await sc.from('report_feedback').select('*').order('created_at',{ascending:false}).limit(15);
    render('voc-list', (data||[]).length===0
      ? `<div class="empty">VOC ì—†ìŒ</div>`
      : (data||[]).map(v=>`<div class="card" style="border-left-color:${v.is_positive?'var(--success)':'var(--admin)'}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:1.5rem">${v.is_positive?'ğŸ‘':'ğŸ‘'}</span>
            <small style="color:#aaa">${v.created_at?.slice(0,10)||''}</small>
          </div>
          ${v.feedback_text?`<div class="box" style="margin-top:8px">${escHtml(v.feedback_text)}</div>`:'<div style="color:#aaa;font-size:.82rem;padding:6px 0">ì˜ê²¬ ì—†ìŒ</div>'}
          ${v.target_agent?`<small style="color:#999">ëŒ€ìƒ: ${v.target_agent}</small>`:''}
        </div>`).join('')
    );
  } catch(e) { render('voc-list','<div class="card">âš ï¸ VOC ë¡œë“œ ì‹¤íŒ¨</div>'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¹„ìš© íƒ­
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadCost() {
  try {
    const todayFmt=new Date(Date.now()+9*60*60*1000).toISOString().slice(0,10);
    const { data: todayLogs }=await sc.from('cost_log').select('call_type,call_count,cost_usd').eq('log_date',todayFmt);
    const totalCalls=(todayLogs||[]).reduce((s,r)=>s+(r.call_count||0),0);
    const totalCost =(todayLogs||[]).reduce((s,r)=>s+(r.cost_usd||0),0);
    $id('c-calls').textContent=totalCalls.toLocaleString();
    $id('c-cost').textContent=`$${totalCost.toFixed(4)}`;
    const byType={};
    (todayLogs||[]).forEach(r=>{byType[r.call_type]=(byType[r.call_type]||0)+(r.call_count||0);});
    const typeIcon={text:'ğŸ“',json:'ğŸ“Š',batch:'ğŸ—ï¸'};
    $id('c-breakdown').innerHTML=Object.keys(byType).length===0
      ?'<span style="color:#aaa">ì˜¤ëŠ˜ ë°ì´í„° ì—†ìŒ</span>'
      :`<table style="width:100%;border-collapse:collapse"><tr style="background:#f8fafc;font-weight:700"><td style="padding:8px">ìœ í˜•</td><td style="padding:8px;text-align:right">í˜¸ì¶œ ìˆ˜</td></tr>
        ${Object.entries(byType).map(([k,v])=>`<tr style="border-top:1px solid #f0f0f0"><td style="padding:8px">${typeIcon[k]||'â€¢'} ${k}</td><td style="padding:8px;text-align:right;font-weight:700">${v.toLocaleString()}íšŒ</td></tr>`).join('')}</table>`;
    const since7=new Date(Date.now()+9*60*60*1000-6*86400*1000).toISOString().slice(0,10);
    const { data: weekLogs }=await sc.from('cost_log').select('log_date,call_count,cost_usd').gte('log_date',since7);
    $id('c-week').textContent=`$${((weekLogs||[]).reduce((s,r)=>s+(r.cost_usd||0),0)).toFixed(3)}`;
    const days=Array.from({length:7},(_,i)=>{const d=new Date(Date.now()+9*60*60*1000-(6-i)*86400*1000);return d.toISOString().slice(0,10);});
    const callByDay={};
    (weekLogs||[]).forEach(r=>{callByDay[r.log_date]=(callByDay[r.log_date]||0)+(r.call_count||0);});
    const ctx=$id('cost-chart').getContext('2d');
    if(costChartInstance) costChartInstance.destroy();
    costChartInstance=new Chart(ctx,{type:'bar',data:{labels:days.map(d=>d.slice(5)),datasets:[{label:'Gemini í˜¸ì¶œ ìˆ˜',data:days.map(d=>callByDay[d]||0),backgroundColor:'rgba(245,158,11,0.7)',borderColor:'#f59e0b',borderWidth:2,borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});
    const { data: sbStats }=await sc.from('supabase_stats').select('row_counts,total_rows').eq('stat_date',todayFmt).maybeSingle();
    if(sbStats) {
      const total=sbStats.total_rows||0, pct=((total/500000)*100).toFixed(1);
      const color=total>400000?'#dc2626':total>250000?'#d97706':'#16a34a';
      $id('c-rows').textContent=total.toLocaleString(); $id('c-rows').style.color=color;
      const counts=sbStats.row_counts||{};
      $id('c-row-detail').innerHTML=`<div style="margin-bottom:10px"><div style="background:#f3f4f6;border-radius:8px;height:12px;overflow:hidden"><div style="background:${color};height:100%;width:${Math.min(pct,100)}%;border-radius:8px;transition:.5s"></div></div><div style="font-size:.8rem;color:#6b7280;margin-top:4px">${pct}% ì‚¬ìš© ì¤‘</div></div>
        <table style="width:100%;border-collapse:collapse;font-size:.88rem">${Object.entries(counts).map(([t,n])=>`<tr style="border-top:1px solid #f0f0f0"><td style="padding:6px 8px;color:#555">${t}</td><td style="padding:6px 8px;text-align:right;font-weight:700;color:${n>100000?'#dc2626':'#111'}">${n.toLocaleString()}</td></tr>`).join('')}</table>`;
    } else { $id('c-rows').textContent='â€”'; $id('c-row-detail').innerHTML='<span style="color:#aaa">ì˜¤ëŠ˜ í†µê³„ ì—†ìŒ</span>'; }
  } catch(e) { console.error('loadCost ì˜¤ë¥˜:',e); $id('c-breakdown').innerHTML=`<span style="color:#f55">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ ìƒˆë¡œê³ ì¹¨ / ì´ˆê¸°í™”
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refreshAll() {
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc()]);
  toast('ğŸ”„ ì „ì²´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

async function init() {
  startClock();

  // GHP í† í° ë³µì›
  const tok = getToken();
  if(tok) { $id('ghp-token').value=tok; updateTokenStatus(tok); } else { updateTokenStatus(''); }

  // SR í‚¤ ë³µì›
  const srk = localStorage.getItem('sr_key') || '';
  if(srk) { $id('sr-key-input').value=srk; CFG.service_role=srk; updateSrStatus(srk); } else { updateSrStatus(''); }

  try {
    const { data:{ session } } = await sc.auth.getSession();
    if(!session || session.user.email !== CFG.master) {
      toast('âŒ ë§ˆìŠ¤í„° ê¶Œí•œ ì—†ìŒ. ì´ë™í•©ë‹ˆë‹¤.');
      setTimeout(()=>location.href='app.html', 1500); return;
    }
    me = session.user;
  } catch(e) { me={id:'master',email:CFG.master}; console.warn('ì„¸ì…˜ ì—†ìŒ:', e.message); }

  startAutoApprovalTimer();
  await Promise.all([loadHrDates(), loadEvo(), loadDev(), loadLogs(), loadVoc()]);
  loadAgentSelect();

  // ì‹¤ì‹œê°„ êµ¬ë…
  sc.channel('evo-updates').on('postgres_changes',{event:'*',schema:'public',table:'pending_approvals'},()=>loadEvo()).subscribe();
  sc.channel('dev-updates').on('postgres_changes',{event:'*',schema:'public',table:'dev_backlog'},()=>loadDev()).subscribe();
  sc.channel('agent-updates').on('postgres_changes',{event:'*',schema:'public',table:'agents'},()=>loadAgentSelect()).subscribe();
}

init();
</script>
</body>
</html>
