name: Daily News Analysis & Governance Bot

on:
  schedule:
    # 1. í•œêµ­ ì‹œê°„ ì˜¤ì „ 09:00 (KST) - ì •ê¸° ë¸Œë¦¬í•‘ ë° ë°ì´í„° ë™ê¸°í™”
    - cron: '0 0 * * *'
    # 2. í•œêµ­ ì‹œê°„ ë°¤ 23:30 (KST) - ì§€ëŠ¥ ìë™ ìŠ¹ì¸ ë° ë§ˆê° ì‘ì—…
    - cron: '30 14 * * *'
  workflow_dispatch:
    # [í•µì‹¬] ì‚¬ë ¹ë¶€(HQ)ì—ì„œ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë°±ë¡œê·¸ IDë¥¼ ì „ë‹¬ë°›ìŒ
    inputs:
      backlog_id:
        description: 'ì²˜ë¦¬í•  ê°œë°œ ë°±ë¡œê·¸ ID (HQ ì—°ë™)'
        required: false
        default: ''

jobs:
  execute-bot:
    runs-on: ubuntu-latest
    # [v14.5 ì¶”ê°€] ë´‡ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  í‘¸ì‹œí•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ ì¶©ëŒ ì—†ì´ í‘¸ì‹œ ê°€ëŠ¥

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ì„¤ì¹˜ (ì•ˆì „ì¥ì¹˜)
          pip install supabase google-genai gnews resend

      - name: Run news_bot.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # ë´‡ ë‚´ë¶€ì—ì„œ git pushë¥¼ ìˆ˜í–‰í•  ë•Œ ì‚¬ìš©í•  ë§ˆìŠ¤í„° í† í°
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }} 
          # [í•µì‹¬] ë°±ì—”ë“œ ì½”ë“œì—ì„œ ì´ IDë¥¼ ì½ì–´ ì²˜ë¦¬ ìƒíƒœë¥¼ ê¸°ë¡
          CURRENT_BACKLOG_ID: ${{ github.event.inputs.backlog_id }}
        run: python news_bot.py

      # [ì•ˆì „ì¥ì¹˜] ë§Œì•½ íŒŒì´ì¬ ì½”ë“œ ë‚´ë¶€ì—ì„œ í‘¸ì‹œí•˜ì§€ ëª»í•œ íŒŒì¼ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ìµœì¢… í‘¸ì‹œ
      - name: Final Git Sync
        run: |
          git config --global user.name "Fitz Intelligence Bot"
          git config --global user.email "positivecha@gmail.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– [System Evolution] $(date +'%Y-%m-%d %H:%M') KST Update"
            git push origin main
          else
            echo "No file changes detected to push."
          fi

      # [ìë™í™” ë³´ê³ ] ë°°í¬ ì„±ê³µ ì‹œ ì‚¬ë ¹ë¶€ì— ì¦‰ì‹œ ë³´ê³  (ë°±ë¡œê·¸ IDê°€ ìˆì„ ë•Œë§Œ)
      - name: Notify Sovereign HQ (Success)
        if: success() && github.event.inputs.backlog_id != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${{ github.event.inputs.backlog_id }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "DEPLOYED", "completed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "âœ… AI ë°°í¬ ì™„ë£Œ: ë°±ë¡œê·¸ #${{ github.event.inputs.backlog_id }}ê°€ ì„±ê³µì ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."}'

      # [ìë™í™” ë³´ê³ ] ë°°í¬ ì‹¤íŒ¨ ì‹œ ì‚¬ë ¹ë¶€ì— ì¦‰ì‹œ ê²½ê³ 
      - name: Notify Sovereign HQ (Failure)
        if: failure() && github.event.inputs.backlog_id != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${{ github.event.inputs.backlog_id }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "FAILED"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "âŒ AI ë°°í¬ ì‹¤íŒ¨: ë°±ë¡œê·¸ #${{ github.event.inputs.backlog_id }} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"}'
