name: Daily News Analysis & Governance Bot

on:
  schedule:
    # 1. ÌïúÍµ≠ ÏãúÍ∞Ñ Ïò§Ï†Ñ 06:00 (KST) = UTC 21:00 Ï†ÑÎÇ† - ÏÇ∞ÏóÖÍµ∞ Î™®ÎãàÌÑ∞ÎßÅ
    - cron: '0 21 * * *'
   # 2. ÌïúÍµ≠ ÏãúÍ∞Ñ Ïò§Ï†Ñ 09:00 (KST) = UTC 22:30 Ï†ÑÎÇ† - Ï†ïÍ∏∞ Î∏åÎ¶¨Ìïë Î∞è Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
    - cron: '30 22 * * *'
    # 3. ÌïúÍµ≠ ÏãúÍ∞Ñ Î∞§ 23:30 (KST) = UTC 14:30 - ÏßÄÎä• ÏûêÎèô ÏäπÏù∏ Î∞è ÎßàÍ∞ê ÏûëÏóÖ
    - cron: '30 14 * * *'
  workflow_dispatch:
    inputs:
      backlog_id:
        description: 'Ï≤òÎ¶¨Ìï† Í∞úÎ∞ú Î∞±Î°úÍ∑∏ ID (HQ Ïó∞Îèô)'
        required: false
        default: ''
      force_cron_type:
        description: 'Í∞ïÏ†ú Ïã§Ìñâ ÌÉÄÏûÖ (BRIEFING / INDUSTRY / GOVERNANCE)'
        required: false
        default: ''

jobs:
  execute-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install supabase google-genai gnews resend

      # CRON_TYPE Í≤∞Ï†ï: Ïä§ÏºÄÏ§ÑÎ≥ÑÎ°ú Î™ÖÌôïÌûà Î∂ÑÎ¶¨
      - name: Determine CRON_TYPE
        id: cron_type
        run: |
          SCHEDULE="${{ github.event.schedule }}"
          FORCE="${{ github.event.inputs.force_cron_type }}"

          if [ -n "$FORCE" ]; then
            echo "CRON_TYPE=$FORCE" >> $GITHUB_ENV
            echo "‚úÖ Í∞ïÏ†ú Ïã§Ìñâ ÌÉÄÏûÖ: $FORCE"
          elif [ "$SCHEDULE" = "30 14 * * *" ]; then
            echo "CRON_TYPE=GOVERNANCE" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: GOVERNANCE (23:30 KST)"
          elif [ "$SCHEDULE" = "0 21 * * *" ]; then
            echo "CRON_TYPE=INDUSTRY" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: INDUSTRY (06:00 KST)"
          elif [ "$SCHEDULE" = "0 0 * * *" ]; then
            echo "CRON_TYPE=BRIEFING" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: BRIEFING (09:00 KST)"
          else
            echo "CRON_TYPE=BRIEFING" >> $GITHUB_ENV
            echo "‚úÖ ÏàòÎèô Ïã§Ìñâ Í∏∞Î≥∏Í∞í: BRIEFING"
          fi

      - name: Run news_bot.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          CURRENT_BACKLOG_ID: ${{ github.event.inputs.backlog_id }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          CRON_TYPE: ${{ env.CRON_TYPE }}
        run: |
          echo "üöÄ Ïã§Ìñâ ÌÉÄÏûÖ: $CRON_TYPE"
          python news_bot.py

      - name: Final Git Sync
        run: |
          git config --global user.name "Fitz Intelligence Bot"
          git config --global user.email "positivecha@gmail.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ü§ñ [System Evolution] $(date +'%Y-%m-%d %H:%M') KST - ${{ env.CRON_TYPE }}"
            git push origin main
          else
            echo "No file changes detected to push."
          fi

      - name: Notify Sovereign HQ (Success)
        if: success() && github.event.inputs.backlog_id != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${{ github.event.inputs.backlog_id }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "DEPLOYED", "completed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "‚úÖ AI Î∞∞Ìè¨ ÏôÑÎ£å: Î∞±Î°úÍ∑∏ #${{ github.event.inputs.backlog_id }}Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞òÏòÅÎêòÏóàÏäµÎãàÎã§."}'

      - name: Notify Sovereign HQ (Failure)
        if: failure() && github.event.inputs.backlog_id != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${{ github.event.inputs.backlog_id }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "FAILED"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "‚ùå AI Î∞∞Ìè¨ Ïã§Ìå®: Î∞±Î°úÍ∑∏ #${{ github.event.inputs.backlog_id }} Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù"}'
