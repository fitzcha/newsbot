name: Daily News Analysis & Governance Bot

on:
  schedule:
    - cron: '0 21 * * *'    # 06:00 KST - ÏÇ∞ÏóÖÍµ∞ Î™®ÎãàÌÑ∞ÎßÅ
    - cron: '0 0 * * *'     # 09:00 KST - Ï†ïÍ∏∞ Î∏åÎ¶¨Ìïë
    - cron: '30 14 * * *'   # 23:30 KST - ÏßÄÎä• ÏûêÎèô ÏäπÏù∏
  workflow_dispatch:
    inputs:
      backlog_id:
        description: 'Ï≤òÎ¶¨Ìï† Í∞úÎ∞ú Î∞±Î°úÍ∑∏ ID (HQ Ïó∞Îèô)'
        required: false
        default: ''
      force_cron_type:
        description: 'Í∞ïÏ†ú Ïã§Ìñâ ÌÉÄÏûÖ (BRIEFING / INDUSTRY / GOVERNANCE)'
        required: false
        default: ''
      rollback_to_sha:
        description: 'Î°§Î∞± ÎåÄÏÉÅ Ïª§Î∞ã SHA (ÏûÖÎ†• Ïãú Î°§Î∞± Î™®Îìú Ïã§Ìñâ)'
        required: false
        default: ''
      rollback_reason:
        description: 'Î°§Î∞± ÏÇ¨Ïú† (ÏÑ†ÌÉù)'
        required: false
        default: ''

concurrency:
  group: daily-news-bot-${{ github.ref }}
  cancel-in-progress: false

jobs:
  execute-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install supabase google-genai gnews resend

      - name: Install Playwright browser (Chromium)
        run: |
          python -m playwright install --with-deps chromium

      - name: E2E smoke gate (login/onboarding/keyword)
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.rollback_to_sha == '' }}
        run: |
          python scripts/e2e_smoke_gate.py

      - name: Determine execution mode
        id: cron_type
        run: |
          SCHEDULE="${{ github.event.schedule }}"
          FORCE="${{ github.event.inputs.force_cron_type }}"
          ROLLBACK_TO_SHA="$(echo '${{ github.event.inputs.rollback_to_sha }}' | xargs)"
          BACKLOG_ID="${{ github.event.inputs.backlog_id }}"

          # DEV Î∞∞Ìè¨ Î™®Îìú (ÏµúÏö∞ÏÑ†)
          if [ -n "$BACKLOG_ID" ]; then
            echo "RUN_MODE=DEV_DEPLOY" >> $GITHUB_ENV
            echo "RELEASE_TYPE=DEV_DEPLOY" >> $GITHUB_ENV
            echo "CRON_TYPE=DEV" >> $GITHUB_ENV
            echo "BACKLOG_ID=$BACKLOG_ID" >> $GITHUB_ENV
            echo "‚úÖ DEV Î∞∞Ìè¨ Î™®Îìú: backlog_id=$BACKLOG_ID"
          # Î°§Î∞± Î™®Îìú
          elif [ -n "$ROLLBACK_TO_SHA" ]; then
            echo "RUN_MODE=ROLLBACK" >> $GITHUB_ENV
            echo "RELEASE_TYPE=ROLLBACK" >> $GITHUB_ENV
            echo "CRON_TYPE=ROLLBACK" >> $GITHUB_ENV
            echo "ROLLBACK_TO_SHA=$ROLLBACK_TO_SHA" >> $GITHUB_ENV
            echo "ROLLBACK_REASON=${{ github.event.inputs.rollback_reason }}" >> $GITHUB_ENV
            echo "‚úÖ Î°§Î∞± Î™®Îìú Ïã§Ìñâ: target=$ROLLBACK_TO_SHA"
          # Í∞ïÏ†ú Ïã§Ìñâ Î™®Îìú
          elif [ -n "$FORCE" ]; then
            echo "RUN_MODE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "RELEASE_TYPE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "CRON_TYPE=$FORCE" >> $GITHUB_ENV
            echo "‚úÖ Í∞ïÏ†ú Ïã§Ìñâ ÌÉÄÏûÖ: $FORCE"
          # Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ
          elif [ "$SCHEDULE" = "30 14 * * *" ]; then
            echo "RUN_MODE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "RELEASE_TYPE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "CRON_TYPE=GOVERNANCE" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: GOVERNANCE (23:30 KST)"
          elif [ "$SCHEDULE" = "0 21 * * *" ]; then
            echo "RUN_MODE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "RELEASE_TYPE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "CRON_TYPE=INDUSTRY" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: INDUSTRY (06:00 KST)"
          elif [ "$SCHEDULE" = "0 0 * * *" ]; then
            echo "RUN_MODE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "RELEASE_TYPE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "CRON_TYPE=BRIEFING" >> $GITHUB_ENV
            echo "‚úÖ Ïä§ÏºÄÏ§Ñ Í∞êÏßÄ: BRIEFING (09:00 KST)"
          else
            echo "RUN_MODE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "RELEASE_TYPE=BOT_EXECUTION" >> $GITHUB_ENV
            echo "CRON_TYPE=BRIEFING" >> $GITHUB_ENV
            echo "‚úÖ ÏàòÎèô Ïã§Ìñâ Í∏∞Î≥∏Í∞í: BRIEFING"
          fi

      - name: Record release ledger (start)
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "release_ledger skipped: missing secrets"
            exit 0
          fi
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BACKLOG_ID_VAL="${BACKLOG_ID:-}"
          PAYLOAD=$(cat <<JSON
          [{
            "run_id":"${GITHUB_RUN_ID}",
            "release_type":"${RELEASE_TYPE:-BOT_EXECUTION}",
            "trigger_type":"${GITHUB_EVENT_NAME}",
            "cron_type":"${CRON_TYPE}",
            "branch":"${GITHUB_REF_NAME:-main}",
            "commit_sha":"${GITHUB_SHA}",
            "backlog_id":"${BACKLOG_ID_VAL}",
            "status":"RUNNING",
            "note":"workflow started (backlog_id=${BACKLOG_ID_VAL}, rollback=${ROLLBACK_TO_SHA:-none})",
            "released_at":"${TS}"
          }]
          JSON
          )
          curl -sS -X POST "${SUPABASE_URL}/rest/v1/release_ledger?on_conflict=run_id" \
          -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Content-Type: application/json" \
          -H "Prefer: resolution=merge-duplicates,return=minimal" \
          -d "${PAYLOAD}" || echo "release_ledger start write failed (non-blocking)"

      - name: Prepare rollback snapshot
        if: ${{ env.RUN_MODE == 'ROLLBACK' }}
        run: |
          TARGET="${ROLLBACK_TO_SHA}"
          if [ -z "$TARGET" ]; then
            echo "ROLLBACK_NOOP=1" >> $GITHUB_ENV
            echo "No rollback target supplied."
            exit 0
          fi
          git cat-file -e "${TARGET}^{commit}" || { echo "Invalid rollback_to_sha: $TARGET"; exit 1; }
          TARGET_FULL="$(git rev-parse "$TARGET")"
          TARGET_SHORT="$(git rev-parse --short "$TARGET_FULL")"
          HEAD_FULL="$(git rev-parse HEAD)"
          echo "ROLLBACK_TARGET_FULL=${TARGET_FULL}" >> $GITHUB_ENV
          echo "ROLLBACK_TARGET_SHORT=${TARGET_SHORT}" >> $GITHUB_ENV

          if [ "$TARGET_FULL" = "$HEAD_FULL" ]; then
            echo "ROLLBACK_NOOP=1" >> $GITHUB_ENV
            echo "Rollback target equals HEAD. Nothing to do."
            exit 0
          fi

          if ! git merge-base --is-ancestor "$TARGET_FULL" "$HEAD_FULL"; then
            echo "rollback_to_sha must be an ancestor of main HEAD."
            exit 1
          fi

          git restore --source "$TARGET_FULL" --staged --worktree -- \
            app.html index.html master.html news_bot.py requirements.txt data.json

          if git diff --quiet && git diff --cached --quiet; then
            echo "ROLLBACK_NOOP=1" >> $GITHUB_ENV
            echo "No file changes after rollback snapshot restore."
          else
            echo "ROLLBACK_NOOP=0" >> $GITHUB_ENV
            echo "Rollback snapshot prepared for commit."
          fi

      - name: E2E smoke gate (rollback snapshot)
        if: ${{ env.RUN_MODE == 'ROLLBACK' && env.ROLLBACK_NOOP != '1' }}
        run: |
          python scripts/e2e_smoke_gate.py

      - name: Commit and push rollback snapshot
        if: ${{ env.RUN_MODE == 'ROLLBACK' && env.ROLLBACK_NOOP != '1' }}
        run: |
          git config --global user.name "Fitz-Dev"
          git config --global user.email "positivecha@gmail.com"
          REASON="${ROLLBACK_REASON:-manual rollback}"
          SAFE_REASON="$(printf '%s' "$REASON" | tr '\n\r' ' ' | sed 's/\"/ /g' | cut -c1-80)"
          TARGET_SHORT="${ROLLBACK_TARGET_SHORT:-unknown}"
          git commit -m "‚Ü©Ô∏è [Rollback] to ${TARGET_SHORT} - ${SAFE_REASON}"
          git push origin HEAD:${GITHUB_REF_NAME:-main}
          echo "ROLLBACK_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Run Python Bot (DEV Î∞∞Ìè¨ Î™®Îìú)
        if: ${{ env.RUN_MODE == 'DEV_DEPLOY' && env.ROLLBACK_NOOP != '1' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "üõ†Ô∏è DEV Î∞∞Ìè¨ Î™®Îìú Ïã§Ìñâ: backlog_id=${BACKLOG_ID}"
          python news_bot.py --mode dev --backlog-id "${BACKLOG_ID}"

      - name: Run Python Bot (ÏùºÎ∞ò Î™®Îìú)
        if: ${{ env.RUN_MODE == 'BOT_EXECUTION' && env.ROLLBACK_NOOP != '1' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          CRON_TYPE: ${{ env.CRON_TYPE }}
        run: |
          echo "ü§ñ Bot Ïã§Ìñâ Î™®Îìú: ${CRON_TYPE}"
          python news_bot.py --mode "${CRON_TYPE}"

      - name: Final Data Sync
        if: ${{ env.ROLLBACK_NOOP != '1' }}
        run: |
          git config --global user.name "Fitz-Dev"
          git config --global user.email "positivecha@gmail.com"
          if [ -f data.json ]; then
            git add data.json
          fi
          if ! git diff --cached --quiet -- data.json; then
            git commit -m "üìä [Workflow Sync] $(date +'%Y-%m-%d %H:%M') KST - ${{ env.CRON_TYPE }}"
            git push origin HEAD:${GITHUB_REF_NAME:-main}
          else
            echo "No data.json changes detected to push."
          fi

      - name: Record release ledger (success)
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "release_ledger success skipped: missing secrets"
            exit 0
          fi
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BACKLOG_ID_VAL="${BACKLOG_ID:-}"
          PAYLOAD=$(cat <<JSON
          {
            "status":"SUCCEEDED",
            "completed_at":"${TS}",
            "commit_sha":"$(git rev-parse HEAD)",
            "note":"workflow completed successfully (backlog_id=${BACKLOG_ID_VAL})"
          }
          JSON
          )
          curl -sS -X PATCH "${SUPABASE_URL}/rest/v1/release_ledger?run_id=eq.${GITHUB_RUN_ID}" \
          -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Content-Type: application/json" \
          -d "${PAYLOAD}" || echo "release_ledger success write failed (non-blocking)"

      - name: Record release ledger (failure)
        if: failure()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "release_ledger failure skipped: missing secrets"
            exit 0
          fi
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          PAYLOAD=$(cat <<JSON
          {
            "status":"FAILED",
            "completed_at":"${TS}",
            "commit_sha":"$(git rev-parse HEAD)",
            "note":"workflow failed: ${RUN_URL}"
          }
          JSON
          )
          curl -sS -X PATCH "${SUPABASE_URL}/rest/v1/release_ledger?run_id=eq.${GITHUB_RUN_ID}" \
          -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Content-Type: application/json" \
          -d "${PAYLOAD}" || echo "release_ledger failure write failed (non-blocking)"

      - name: Notify Sovereign HQ (Success)
        if: success() && env.BACKLOG_ID != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${BACKLOG_ID}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "DEPLOYED", "completed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "‚úÖ AI Î∞∞Ìè¨ ÏôÑÎ£å: Î∞±Î°úÍ∑∏ #'"${BACKLOG_ID}"'Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞òÏòÅÎêòÏóàÏäµÎãàÎã§."}'

      - name: Notify Sovereign HQ (Failure)
        if: failure() && env.BACKLOG_ID != ''
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/dev_backlog?id=eq.${BACKLOG_ID}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "FAILED"}'

          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/action_logs" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action_type": "DEV_DEPLOY", "target_word": "SYSTEM", "details": "‚ùå AI Î∞∞Ìè¨ Ïã§Ìå®: Î∞±Î°úÍ∑∏ #'"${BACKLOG_ID}"' Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù"}'
