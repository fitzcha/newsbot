<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root {
  --primary:#4f46e5; --primary-light:#eef2ff; --success:#10b981;
  --danger:#ef4444; --g50:#f9fafb; --g100:#f3f4f6; --g200:#e5e7eb;
  --g400:#9ca3af; --g600:#4b5563; --g800:#1f2937; --g900:#111827;
  --r:14px; --shadow:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.04);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Pretendard',sans-serif;background:var(--g50);color:var(--g800);line-height:1.6;-webkit-tap-highlight-color:transparent;}

/* NAV */
.nav{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--g200);padding:0 16px;height:56px;display:flex;align-items:center;justify-content:space-between;}
.nav-logo{font-size:.95rem;font-weight:800;color:var(--g900);letter-spacing:-.5px;cursor:pointer;line-height:1.2;}
.nav-right{display:flex;align-items:center;gap:6px;}
.nav-user{font-size:.75rem;color:var(--g600);font-weight:600;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-ghost{background:none;border:1px solid var(--g200);color:var(--g600);padding:5px 11px;border-radius:8px;font-size:.75rem;cursor:pointer;font-family:inherit;font-weight:600;}
.btn-hq{background:none;border:1px solid var(--danger);color:var(--danger);padding:4px 9px;border-radius:6px;font-size:.72rem;cursor:pointer;font-family:inherit;font-weight:700;display:none;}

/* PAGE */
.page{max-width:640px;margin:0 auto;padding:20px 14px 80px;}
.card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);border:1px solid var(--g200);overflow:hidden;}

/* â”€â”€ ONBOARDING â”€â”€ */
.ob-wrap{padding:32px 20px;text-align:center;}
.ob-badge{display:inline-block;background:var(--primary-light);color:var(--primary);font-size:.72rem;font-weight:700;padding:3px 12px;border-radius:20px;letter-spacing:.5px;margin-bottom:14px;}
.ob-wrap h2{font-size:1.4rem;font-weight:800;color:var(--g900);letter-spacing:-.5px;margin-bottom:6px;}
.ob-wrap .sub{color:var(--g400);font-size:.85rem;margin-bottom:24px;}
.kw-row{display:flex;gap:8px;margin-bottom:12px;}
.kw-input{flex:1;padding:11px 14px;border:1.5px solid var(--g200);border-radius:10px;font-size:.9rem;font-family:inherit;outline:none;min-width:0;}
.kw-input:focus{border-color:var(--primary);}
.btn-add{background:var(--primary);color:#fff;border:none;padding:11px 18px;border-radius:10px;font-size:.88rem;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;}
.tag-list{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;min-height:32px;}
.tag{background:var(--primary-light);color:var(--primary);padding:5px 13px;border-radius:20px;font-size:.8rem;font-weight:700;display:flex;align-items:center;gap:5px;}
.tag-del{cursor:pointer;color:#a5b4fc;font-size:.95rem;}
.tag-del:hover{color:var(--danger);}
.ob-hint{margin-top:10px;font-size:.75rem;color:var(--g400);}
.ob-warn{color:var(--danger);font-size:.78rem;margin-top:8px;display:none;}

/* ì˜¨ë³´ë”© ë‹¨ê³„ ë©”ì‹œì§€ */
.ob-step{display:none;margin-top:20px;padding:18px;background:var(--g50);border-radius:12px;border:1px solid var(--g200);text-align:left;}
.ob-step-icon{font-size:1.4rem;margin-bottom:6px;}
.ob-step h3{font-size:.95rem;font-weight:800;color:var(--g900);margin-bottom:4px;}
.ob-step p{font-size:.82rem;color:var(--g600);line-height:1.6;}
.btn-tour{display:block;width:100%;margin-top:14px;padding:13px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:.9rem;font-weight:700;cursor:pointer;font-family:inherit;}

/* KW BAR (ê¸°ì¡´ ìœ ì €) */
.kw-bar{padding:14px 16px;display:flex;align-items:center;flex-wrap:wrap;gap:8px;border-bottom:1px solid var(--g100);}
.kw-bar-label{font-size:.72rem;font-weight:700;color:var(--g400);letter-spacing:.5px;white-space:nowrap;}
.kw-bar-tags{display:flex;flex-wrap:wrap;gap:6px;flex:1;}
.kw-bar-add{display:flex;gap:6px;width:100%;}
.kw-bar-input{flex:1;padding:8px 12px;border:1.5px solid var(--g200);border-radius:9px;font-size:.82rem;font-family:inherit;outline:none;min-width:0;}
.kw-bar-input:focus{border-color:var(--primary);}
.btn-add-sm{background:var(--primary);color:#fff;border:none;padding:8px 14px;border-radius:9px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;}

/* REPORT */
.report-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--g100);flex-wrap:wrap;}
.tab-group{display:flex;gap:4px;background:var(--g100);padding:3px;border-radius:9px;flex:1;}
.tab-btn{flex:1;padding:7px 4px;border-radius:7px;border:none;background:none;font-size:.75rem;font-weight:600;color:var(--g600);cursor:pointer;font-family:inherit;transition:.15s;white-space:nowrap;}
.tab-btn.active{background:#fff;color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.08);}
.date-select{border:1px solid var(--g200);background:#fff;padding:7px 10px;border-radius:8px;font-size:.78rem;font-family:inherit;font-weight:600;cursor:pointer;color:var(--g600);max-width:130px;}

/* KW TABS (í‚¤ì›Œë“œë³„ íƒ­) */
.kw-tabs{padding:12px 16px 0;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--g100);}
.kw-tabs::-webkit-scrollbar{display:none;}
.kw-tab{padding:6px 14px;border-radius:20px;border:1.5px solid var(--g200);background:#fff;font-size:.78rem;font-weight:700;color:var(--g600);cursor:pointer;white-space:nowrap;font-family:inherit;transition:.15s;flex-shrink:0;margin-bottom:12px;}
.kw-tab.active{background:var(--primary);border-color:var(--primary);color:#fff;}

/* BRIEFING */
.briefing-card{margin:14px;background:var(--g900);border-radius:13px;padding:20px;}
.briefing-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;gap:8px;}
.briefing-label{font-size:.78rem;font-weight:700;color:#a5b4fc;flex:1;}
.eval-btns{display:flex;gap:5px;flex-shrink:0;}
.eval-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.6);padding:5px 10px;border-radius:18px;cursor:pointer;font-size:.74rem;font-family:inherit;transition:.15s;white-space:nowrap;}
.eval-btn.up{background:var(--primary);color:#fff;border-color:var(--primary);}
.eval-btn.dn{background:var(--danger);color:#fff;border-color:var(--danger);}
.voc-area{display:none;margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.1);}
.voc-input{width:100%;background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.15);padding:10px 13px;border-radius:9px;font-size:.83rem;font-family:inherit;resize:none;}
.btn-voc-sub{margin-top:7px;background:#fff;color:var(--g900);border:none;padding:8px 18px;border-radius:8px;font-weight:700;font-size:.8rem;cursor:pointer;font-family:inherit;}
.ok-msg{display:none;color:#6ee7b7;font-size:.78rem;font-weight:700;text-align:center;margin-bottom:8px;}
#briefing-content{font-size:.88rem;line-height:1.85;color:rgba(255,255,255,.88);}
#briefing-content p{margin-bottom:10px;}

/* NEWS */
.news-section{padding:14px;}
.news-section-title{font-size:.72rem;font-weight:700;color:var(--g400);letter-spacing:.5px;margin-bottom:10px;}
.news-card{background:var(--g50);border:1px solid var(--g200);border-radius:11px;padding:14px 16px;margin-bottom:9px;}
.news-kw{display:inline-block;background:var(--primary-light);color:var(--primary);font-size:.7rem;font-weight:700;padding:2px 9px;border-radius:18px;margin-bottom:7px;}
.news-title{font-size:.85rem;font-weight:700;color:var(--g900);text-decoration:none;line-height:1.5;display:block;margin-bottom:5px;}
.news-title:hover{color:var(--primary);}
.news-sum{font-size:.78rem;color:var(--g600);margin-bottom:3px;}
.news-imp{font-size:.74rem;color:var(--g400);}

/* EMPTY */
.empty{padding:50px 20px;text-align:center;color:var(--g400);}
.empty .ico{font-size:2rem;margin-bottom:10px;}
.empty p{font-size:.85rem;}
</style>
</head>
<body>

<nav class="nav">
  <span class="nav-logo" onclick="location.href='index.html'">Fitz<br>Intelligence</span>
  <div class="nav-right">
    <span class="nav-user" id="nav-user"></span>
    <button class="btn-hq" id="btn-hq" onclick="location.href='master.html'">ğŸ”´ HQ</button>
    <button class="btn-ghost" onclick="location.href='index.html'">í™ˆ</button>
    <button class="btn-ghost" id="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</nav>

<div class="page">

  <!-- â”€â”€ ì˜¨ë³´ë”© ì¹´ë“œ (ì‹ ê·œ ìœ ì €) â”€â”€ -->
  <div class="card" id="ob-card" style="margin-bottom:18px;display:none;">
    <div class="ob-wrap">
      <div class="ob-badge">WELCOME</div>
      <h2>ì²« ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”</h2>
      <p class="sub">ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ë“±ë¡í•˜ë©´ ë§¤ì¼ ì˜¤ì „ 9ì‹œ<br>AI ë¸Œë¦¬í•‘ì´ ì´ë©”ì¼ë¡œ ë„ì°©í•©ë‹ˆë‹¤</p>
      <div class="kw-row">
        <input class="kw-input" id="ob-kw" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì, í…ŒìŠ¬ë¼, AIë°˜ë„ì²´" onkeydown="if(event.key==='Enter')obAdd()">
        <button class="btn-add" onclick="obAdd()">ì¶”ê°€</button>
      </div>
      <div class="ob-warn" id="ob-warn">í‚¤ì›Œë“œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.<br>ê¸°ì¡´ í‚¤ì›Œë“œë¥¼ ì‚­ì œí•œ í›„ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š</div>
      <div class="tag-list" id="ob-tags"></div>
      <p class="ob-hint" id="ob-hint">ì•„ì§ í‚¤ì›Œë“œê°€ ì—†ì–´ìš”</p>

      <!-- Step 1: ë“±ë¡ ì„±ê³µ -->
      <div class="ob-step" id="ob-s1">
        <div class="ob-step-icon">âœ…</div>
        <h3>í‚¤ì›Œë“œ ë“±ë¡ ì„±ê³µ!</h3>
        <p>í‚¤ì›Œë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì¶”ê°€ë¡œ ë” ë“±ë¡í•˜ê±°ë‚˜ ì™„ë£Œí•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</p>
      </div>

      <!-- Step 2: ì™„ë£Œ + ë°œì†¡ ì•ˆë‚´ -->
      <div class="ob-step" id="ob-s2" style="background:#ecfdf5;border-color:#a7f3d0;">
        <div class="ob-step-icon">ğŸ“¬</div>
        <h3 style="color:var(--success);">í‚¤ì›Œë“œ ì…ë ¥ ì™„ë£Œ</h3>
        <p style="color:#065f46;"><b>ë‚´ì¼ ì˜¤ì „ 9ì‹œ</b>ì— ì²« ë¦¬í¬íŠ¸ê°€<br>ì´ë©”ì¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.</p>
        <button class="btn-tour" onclick="finishOnboarding()">ë¦¬í¬íŠ¸ í™”ë©´ ë‘˜ëŸ¬ë³´ê¸° â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ í‚¤ì›Œë“œ ë°” (ê¸°ì¡´ ìœ ì €) â”€â”€ -->
  <div class="card" id="kw-bar-card" style="margin-bottom:18px;display:none;">
    <div class="kw-bar">
      <span class="kw-bar-label">ğŸ“Œ ë‚´ í‚¤ì›Œë“œ</span>
      <div class="kw-bar-tags" id="kw-bar-tags"></div>
      <div class="kw-bar-add">
        <input class="kw-bar-input" id="bar-kw" placeholder="í‚¤ì›Œë“œ ì¶”ê°€ (ìµœëŒ€ 5ê°œ)" onkeydown="if(event.key==='Enter')barAdd()">
        <button class="btn-add-sm" onclick="barAdd()">ì¶”ê°€</button>
      </div>
      <div class="ob-warn" id="bar-warn" style="width:100%;">í‚¤ì›Œë“œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.<br>ê¸°ì¡´ í‚¤ì›Œë“œë¥¼ ì‚­ì œí•œ í›„ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š</div>
    </div>
  </div>

  <!-- â”€â”€ ë¦¬í¬íŠ¸ ì˜ì—­ â”€â”€ -->
  <div id="main-area" style="display:none;">
    <div class="card">

      <!-- ì—ì´ì „íŠ¸ íƒ­ + ë‚ ì§œ -->
      <div class="report-header">
        <div class="tab-group">
          <button class="tab-btn active" id="role-BA" onclick="setRole('BA')">ë¹„ì¦ˆë‹ˆìŠ¤</button>
          <button class="tab-btn" id="role-Stock" onclick="setRole('Stock')">ì¦ê¶ŒÂ·íˆ¬ì</button>
          <button class="tab-btn" id="role-PM" onclick="setRole('PM')">ì „ëµê¸°íš</button>
        </div>
        <select class="date-select" id="date-sel" onchange="loadDay()"></select>
      </div>

      <!-- í‚¤ì›Œë“œ íƒ­ -->
      <div class="kw-tabs" id="kw-tabs"></div>

      <!-- ë¸Œë¦¬í•‘ -->
      <div class="briefing-card">
        <div class="briefing-top">
          <span class="briefing-label" id="b-label">ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</span>
          <div class="eval-btns">
            <button class="eval-btn" id="btn-up" onclick="thumb(true)">ğŸ‘</button>
            <button class="eval-btn" id="btn-dn" onclick="thumb(false)">ğŸ‘</button>
          </div>
        </div>
        <div class="voc-area" id="voc-area">
          <div class="ok-msg" id="ok-msg">âœ… ì˜ê²¬ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
          <textarea class="voc-input" id="voc-txt" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ë°”ë¼ëŠ” ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
          <button class="btn-voc-sub" onclick="submitFb()">ì œì¶œ</button>
        </div>
        <div id="briefing-content">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ë‰´ìŠ¤ -->
      <div class="news-section">
        <div class="news-section-title">ê´€ë ¨ ë‰´ìŠ¤</div>
        <div id="news-list"></div>
      </div>

    </div>
  </div>

  <!-- í‚¤ì›Œë“œëŠ” ìˆì§€ë§Œ ë¦¬í¬íŠ¸ ì—†ìŒ -->
  <div id="wait-area" style="display:none;">
    <div class="card empty">
      <div class="ico">â³</div>
      <p>ì˜¤ëŠ˜ ë¦¬í¬íŠ¸ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br><b>ë§¤ì¼ ì˜¤ì „ 9ì‹œ</b>ì— ìë™ ë°œì†¡ë©ë‹ˆë‹¤.</p>
    </div>
  </div>

</div>

<script>
const SB_URL='https://zrlpwmpbrvohautldcon.supabase.co', SB_KEY='sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G', MASTER='positivecha@gmail.com';
const sc=supabase.createClient(SB_URL,SB_KEY);
let cu,curReport,curReportId,curRole='BA',curKw='ALL',kwList=[],fbVal=null;
const ROLE_LABEL={BA:'ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„',Stock:'ğŸ“ˆ ì¦ê¶ŒÂ·íˆ¬ì',PM:'ğŸ¯ ì „ëµê¸°íš'};
const ROLE_KEY={BA:'ba_brief',Stock:'securities_brief',PM:'pm_brief'};

async function init(){
  const{data:{session}}=await sc.auth.getSession();
  if(!session)return location.href='index.html';
  cu=session.user;
  document.getElementById('nav-user').textContent=cu.email.split('@')[0]+'ë‹˜';
  document.getElementById('btn-logout').onclick=()=>sc.auth.signOut().then(()=>location.href='index.html');
  if(cu.email===MASTER)document.getElementById('btn-hq').style.display='';
  await fetchKw();
  await decideView();
}

/* â”€â”€ í‚¤ì›Œë“œ â”€â”€ */
async function fetchKw(){
  const{data}=await sc.from('user_settings').select('keywords').eq('id',cu.id).maybeSingle();
  kwList=data?.keywords||[];
}
async function saveKw(){
  await sc.from('user_settings').upsert({id:cu.id,keywords:kwList,email:cu.email});
}

/* â”€â”€ ë·° ê²°ì • â”€â”€ */
async function decideView(){
  const{data}=await sc.from('reports').select('report_date').eq('user_id',cu.id).order('report_date',{ascending:false});
  const hasReport=data&&data.length>0;
  const hasKw=kwList.length>0;
  const toured=localStorage.getItem('fitz_toured_'+cu.id);

  if(hasReport||(hasKw&&toured)){
    showKwBar();
    document.getElementById('main-area').style.display=hasReport?'block':'none';
    document.getElementById('wait-area').style.display=hasReport?'none':'block';
    if(hasReport){
      const dates=[...new Set(data.map(d=>d.report_date))];
      document.getElementById('date-sel').innerHTML=dates.map(d=>`<option value="${d}">${d}</option>`).join('');
      await loadDay();
    }
  } else {
    document.getElementById('ob-card').style.display='block';
    renderObTags();
    if(hasKw)showObStep();
  }
}

function showKwBar(){
  document.getElementById('kw-bar-card').style.display='block';
  renderBarTags();
}

/* â”€â”€ ì˜¨ë³´ë”© â”€â”€ */
function renderObTags(){
  document.getElementById('ob-tags').innerHTML=kwList.map(k=>`
    <span class="tag">#${k}<span class="tag-del" onclick="obRemove('${k}')">Ã—</span></span>`).join('');
  const hint=document.getElementById('ob-hint');
  hint.textContent=kwList.length?`${kwList.length}/5ê°œ ë“±ë¡ë¨`:'ì•„ì§ í‚¤ì›Œë“œê°€ ì—†ì–´ìš”';
}

async function obAdd(){
  const el=document.getElementById('ob-kw'),v=el.value.trim();
  const warn=document.getElementById('ob-warn');
  if(kwList.length>=5){warn.style.display='block';return;}
  warn.style.display='none';
  if(!v||kwList.includes(v))return;
  kwList.push(v);el.value='';
  await saveKw();renderObTags();showObStep();
}

async function obRemove(k){
  kwList=kwList.filter(x=>x!==k);
  await saveKw();renderObTags();
  if(!kwList.length){
    document.getElementById('ob-s1').style.display='none';
    document.getElementById('ob-s2').style.display='none';
  }
}

function showObStep(){
  document.getElementById('ob-s1').style.display='block';
  setTimeout(()=>{document.getElementById('ob-s2').style.display='block';},800);
}

function finishOnboarding(){
  localStorage.setItem('fitz_toured_'+cu.id,'1');
  document.getElementById('ob-card').style.display='none';
  document.getElementById('wait-area').style.display='block';
  showKwBar();
}

/* â”€â”€ í‚¤ì›Œë“œë°” â”€â”€ */
function renderBarTags(){
  document.getElementById('kw-bar-tags').innerHTML=kwList.map(k=>`
    <span class="tag" style="font-size:.75rem;padding:4px 11px;">#${k}
      <span class="tag-del" onclick="barRemove('${k}')">Ã—</span>
    </span>`).join('');
}

async function barAdd(){
  const el=document.getElementById('bar-kw'),v=el.value.trim();
  const warn=document.getElementById('bar-warn');
  if(kwList.length>=5){warn.style.display='block';return;}
  warn.style.display='none';
  if(!v||kwList.includes(v))return;
  kwList.push(v);el.value='';
  await saveKw();renderBarTags();
  renderKwTabs();renderReport();
}

async function barRemove(k){
  kwList=kwList.filter(x=>x!==k);
  await saveKw();renderBarTags();
  if(curKw===k)curKw=kwList[0]||'ALL';
  renderKwTabs();renderReport();
}

/* â”€â”€ ë¦¬í¬íŠ¸ ë¡œë“œ â”€â”€ */
async function loadDay(){
  const d=document.getElementById('date-sel').value;
  const{data}=await sc.from('reports').select('*').eq('report_date',d).eq('user_id',cu.id).limit(1);
  if(data&&data.length){
    curReport=data[0].content;curReportId=data[0].id;
    curKw='ALL';
    renderKwTabs();renderReport();
  }
}

/* â”€â”€ í‚¤ì›Œë“œ íƒ­ â”€â”€ */
function renderKwTabs(){
  const arts=curReport?.articles||[];
  const kws=[...new Set(arts.map(a=>a.keyword).filter(Boolean))];
  const tabs=[{id:'ALL',label:'ì „ì²´'},...kws.map(k=>({id:k,label:'#'+k}))];
  document.getElementById('kw-tabs').innerHTML=tabs.map(t=>`
    <button class="kw-tab${curKw===t.id?' active':''}" onclick="setKw('${t.id}')">${t.label}</button>`).join('');
}

function setKw(k){curKw=k;renderKwTabs();renderReport();}

/* â”€â”€ ì—ì´ì „íŠ¸ íƒ­ â”€â”€ */
function setRole(r){
  curRole=r;fbVal=null;
  ['BA','Stock','PM'].forEach(x=>document.getElementById('role-'+x).className='tab-btn'+(x===r?' active':''));
  document.getElementById('b-label').textContent=ROLE_LABEL[r]+' ì¸ì‚¬ì´íŠ¸';
  document.getElementById('btn-up').className='eval-btn';
  document.getElementById('btn-dn').className='eval-btn';
  document.getElementById('voc-area').style.display='none';
  document.getElementById('ok-msg').style.display='none';
  renderReport();
}

/* â”€â”€ ë¦¬í¬íŠ¸ ë Œë” â”€â”€ */
function renderReport(){
  if(!curReport)return;
  const k=ROLE_KEY[curRole];

  // í‚¤ì›Œë“œ íƒ­ ì„ íƒ ì‹œ by_keyword ìš°ì„ , ì—†ìœ¼ë©´ ì „ì²´ fallback
  let txt;
  if(curKw==='ALL'){
    txt=curReport[k]||'ë¶„ì„ ì¤‘...';
  } else {
    txt=curReport?.by_keyword?.[curKw]?.[k]
      ||curReport[k]
      ||'ë¶„ì„ ì¤‘...';
  }
  txt=txt.replace(/\[PROPOSAL\][\s\S]*|\[REASON\][\s\S]*/g,'');
  document.getElementById('briefing-content').innerHTML=marked.parse(txt);

  // ë‰´ìŠ¤: í‚¤ì›Œë“œ í•„í„°
  const arts=curReport.articles||[];
  const filtered=curKw==='ALL'?arts:arts.filter(a=>a.keyword===curKw);
  document.getElementById('news-list').innerHTML=filtered.length
    ?filtered.map(a=>`
        <div class="news-card">
          <span class="news-kw">#${a.keyword||''}</span>
          <a class="news-title" href="${a.url||'#'}" target="_blank">${a.title||''}</a>
          <p class="news-sum">ğŸ’¡ ${a.pm_summary||''}</p>
          <p class="news-imp">ğŸ“ˆ ${a.impact||''}</p>
        </div>`).join('')
    :'<div style="color:var(--g400);font-size:.82rem;padding:10px 0;">í•´ë‹¹ í‚¤ì›Œë“œì˜ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

/* â”€â”€ í”¼ë“œë°± â”€â”€ */
function thumb(pos){
  fbVal=pos;
  document.getElementById('btn-up').className='eval-btn'+(pos?' up':'');
  document.getElementById('btn-dn').className='eval-btn'+(!pos?' dn':'');
  document.getElementById('voc-area').style.display='block';
}

async function submitFb(){
  const txt=document.getElementById('voc-txt').value;
  const rm={BA:'BA',Stock:'STOCK',PM:'PM'};
  await sc.from('report_feedback').insert([{
    user_id:cu.id,report_id:curReportId,is_positive:fbVal,
    feedback_text:txt||'ë§Œì¡±',target_agent:rm[curRole]
  }]);
  document.getElementById('ok-msg').style.display='block';
  document.getElementById('voc-area').style.display='none';
  document.getElementById('voc-txt').value='';
}

init();
</script>
</body>
</html>
