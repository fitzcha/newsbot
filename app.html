<!DOCTYPE html>
<html lang="ko">
<head >
  <script>
(function() {
  var ua = navigator.userAgent || '';
  var isKakao    = /KAKAOTALK/i.test(ua);
  var isNaver    = /NAVER/i.test(ua);
  var isInsta    = /Instagram/i.test(ua);
  var isFacebook = /FBAN|FBAV/i.test(ua);
  var isInApp    = isKakao || isNaver || isInsta || isFacebook;

  if (!isInApp) return; // ì¼ë°˜ ë¸Œë¼ìš°ì €ë©´ ê·¸ëƒ¥ í†µê³¼

  var currentUrl = location.href;
  var isAndroid  = /Android/i.test(ua);
  var isIOS      = /iPhone|iPad|iPod/i.test(ua);

  if (isAndroid) {
    // Android: intent ìŠ¤í‚´ìœ¼ë¡œ Chrome ê°•ì œ ì‹¤í–‰
    var intentUrl = 'intent://' + currentUrl.replace(/^https?:\/\//, '')
      + '#Intent;scheme=https;package=com.android.chrome;end';
    location.href = intentUrl;

    // intent ì‹¤íŒ¨ ì‹œ (Chrome ë¯¸ì„¤ì¹˜) ì•ˆë‚´ í˜ì´ì§€ë¡œ fallback
    setTimeout(function() {
      showGuide('Android');
    }, 1500);

  } else if (isIOS) {
    // iOS: ì¹´ì¹´ì˜¤í†¡ì€ window.openìœ¼ë¡œ Safari ê°•ì œ ë¶ˆê°€ â†’ ì•ˆë‚´ í˜ì´ì§€ í‘œì‹œ
    showGuide('iOS');
  } else {
    showGuide('');
  }

  function showGuide(os) {
    function render() {
      document.body.innerHTML = `
        <div style="
          display:flex; flex-direction:column; align-items:center; justify-content:center;
          min-height:100vh; padding:32px 24px; background:#f8fafc;
          font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
          text-align:center; box-sizing:border-box;
        ">
          <div style="font-size:52px; margin-bottom:20px">ğŸŒ</div>
          <h2 style="font-size:20px; font-weight:800; color:#0f172a; margin:0 0 12px">
            ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”
          </h2>
          <p style="font-size:14px; color:#64748b; line-height:1.7; margin:0 0 28px">
            ì¹´ì¹´ì˜¤í†¡ ë‚´ì—ì„œëŠ” ë¡œê·¸ì¸ì´ ì •ìƒ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ <b>Safari</b> ë˜ëŠ” <b>Chrome</b>ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.
          </p>

          ${os === 'iOS' ? `
          <!-- iOS: ìš°í•˜ë‹¨ Â·Â·Â· ë©”ë‰´ ì•ˆë‚´ -->
          <div style="
            background:#fff; border:1px solid #e2e8f0; border-radius:16px;
            padding:20px 24px; max-width:320px; width:100%; margin-bottom:20px;
            box-shadow:0 2px 12px rgba(0,0,0,.06);
          ">
            <div style="font-size:13px; font-weight:700; color:#475569; margin-bottom:12px">
              ğŸ“± iPhone ì‚¬ìš©ì
            </div>
            <ol style="font-size:13px; color:#475569; text-align:left; margin:0; padding-left:18px; line-height:2">
              <li>í™”ë©´ í•˜ë‹¨ ì˜¤ë¥¸ìª½ <b>Â·Â·Â·</b> ë²„íŠ¼ íƒ­</li>
              <li><b>ê¸°ë³¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°</b> ì„ íƒ</li>
            </ol>
          </div>
          ` : ''}

          <!-- URL ë³µì‚¬ ë²„íŠ¼ (ê³µí†µ) -->
          <button onclick="
            navigator.clipboard.writeText('${currentUrl}')
              .then(function(){ this.textContent='âœ… ë³µì‚¬ ì™„ë£Œ!'; }.bind(this))
              .catch(function(){ this.textContent='âŒ ë³µì‚¬ ì‹¤íŒ¨'; }.bind(this));
          " style="
            background:#2563eb; color:#fff; border:none; border-radius:14px;
            padding:16px 32px; font-size:15px; font-weight:700; cursor:pointer;
            width:100%; max-width:320px; margin-bottom:12px;
          ">ğŸ”— ë§í¬ ë³µì‚¬í•˜ê¸°</button>

          <p style="font-size:12px; color:#94a3b8">
            ë³µì‚¬ í›„ Safari ë˜ëŠ” Chrome ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”
          </p>
        </div>
      `;
    }
    // DOMContentLoadedê°€ ì´ë¯¸ ë°œìƒí–ˆì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¶„ê¸° ì²˜ë¦¬
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', render);
    } else {
      render();
    }
  }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fitz Intelligence</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { -webkit-text-size-adjust:100%; }
body { background:#f8fafc; color:#1e293b; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; overflow-x:hidden; }

/* â”€â”€ ìƒë‹¨ë°” â”€â”€ */
.top-bar { position:sticky; top:0; z-index:200; background:#fff; border-bottom:1px solid #e2e8f0; }
.header-row { display:flex; justify-content:space-between; align-items:center; padding:14px 20px 10px; }
.brand { font-size:14px; font-weight:800; color:#1e293b; }
.collapse-btn { background:none; border:none; cursor:pointer; padding:8px 12px; border-radius:8px; color:#94a3b8; font-size:12px; font-weight:600; min-height:36px; }
.master-nav { display:flex; align-items:center; gap:6px; }
.master-nav-btn { font-size:11px; font-weight:700; padding:5px 10px; border-radius:8px; cursor:pointer; min-height:30px; }
.master-nav-btn.home { background:#f1f5f9; border:1px solid #e2e8f0; color:#475569; }
.master-nav-btn.hq   { background:none; border:1px solid #ef4444; color:#ef4444; }
.logout-btn { font-size:11px; font-weight:700; padding:5px 10px; border-radius:8px; cursor:pointer; min-height:30px; background:#f1f5f9; border:1px solid #e2e8f0; color:#475569; }

.collapsed-bar { display:none; padding:6px 20px 10px; align-items:center; gap:0; }
.collapsed-bar.hidden { display:none; }
.c-chip { position:relative; display:inline-flex; align-items:center; gap:4px; flex-shrink:0; font-size:11px; font-weight:600; padding:6px 12px; border-radius:8px; cursor:pointer; white-space:nowrap; border:1px solid #e2e8f0; background:#f8fafc; color:#475569; user-select:none; min-height:34px; }
.c-chip .arrow { font-size:8px; color:#94a3b8; margin-left:2px; }
.c-chip.date-c  { background:#f1f5f9; border-color:#e2e8f0; color:#475569; }
.c-chip.agent-c { background:#eff6ff; border-color:#bfdbfe; color:#2563eb; }
.c-chip.agent-c[data-a="STOCK"] { background:#ecfeff; border-color:#a5f3fc; color:#0891b2; }
.c-chip.agent-c[data-a="PM"]    { background:#f5f3ff; border-color:#ddd6fe; color:#7c3aed; }
.c-chip.kw-c { background:#f1f5f9; border-color:#e2e8f0; color:#1e293b; }
.c-sep { color:#cbd5e1; padding:0 4px; font-size:11px; }
.c-dropdown { display:none; position:absolute; top:calc(100% + 6px); left:0; background:#fff; border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.1); min-width:130px; z-index:300; overflow:hidden; }
.c-dropdown.open { display:block; }
.c-dd-item { padding:10px 14px; font-size:13px; font-weight:600; color:#475569; cursor:pointer; display:flex; align-items:center; gap:8px; min-height:40px; }
.c-dd-item:active, .c-dd-item.active { background:#f8fafc; color:#1e293b; }
.c-dd-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; background:#94a3b8; }

/* â”€â”€ í•„í„° í–‰ ë ˆì´ì•„ì›ƒ â”€â”€ */
.filter-grid { display:grid; grid-template-columns:60px 1fr; row-gap:0; padding:6px 16px 4px; }
.filter-label { display:flex; align-items:center; font-size:10px; font-weight:700; color:#94a3b8; letter-spacing:.5px; padding:6px 0; white-space:nowrap; min-height:34px; }
.filter-chips { display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; padding:6px 0; align-items:center; }
.filter-chips::-webkit-scrollbar { display:none; }
.date-chip { flex-shrink:0; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600; color:#94a3b8; background:#f8fafc; border:1px solid #e2e8f0; cursor:pointer; min-height:34px; display:flex; align-items:center; }
.date-chip.active { background:#1e293b; color:#fff; border-color:#1e293b; }
.agent-chip { flex-shrink:0; display:flex; align-items:center; gap:5px; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700; color:#94a3b8; background:#f8fafc; border:1.5px solid #e2e8f0; cursor:pointer; min-height:34px; }
.agent-chip.active[data-a="BA"]    { background:#eff6ff; color:#2563eb; border-color:#bfdbfe; }
.agent-chip.active[data-a="STOCK"] { background:#ecfeff; color:#0891b2; border-color:#a5f3fc; }
.agent-chip.active[data-a="PM"]    { background:#f5f3ff; color:#7c3aed; border-color:#ddd6fe; }
.agent-dot { width:6px; height:6px; border-radius:50%; background:currentColor; }
.kw-chip { flex-shrink:0; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600; color:#94a3b8; background:#f8fafc; border:1px solid #e2e8f0; cursor:pointer; min-height:34px; display:flex; align-items:center; }
.kw-chip.active { background:#1e293b; color:#fff; border-color:#1e293b; }
.kw-edit-btn { flex-shrink:0; margin-left:4px; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600; border:1.5px dashed #94a3b8; color:#94a3b8; background:transparent; cursor:pointer; display:flex; align-items:center; gap:4px; min-height:36px; }
.filter-grid-bottom { padding-bottom:10px; }
.collapsible {}
.top-bar.collapsed .collapsible { display:none; }
.top-bar.collapsed .collapsed-bar { display:flex; }
.top-bar.collapsed .collapsed-bar.hidden { display:none; }

/* â”€â”€ ë¡œë”© â”€â”€ */
.feed-state { padding:60px 20px; text-align:center; color:#94a3b8; font-size:14px; }
.skeleton { background:#f1f5f9; border-radius:14px; height:180px; margin-bottom:28px; animation:pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

/* â”€â”€ ì˜¨ë³´ë”© â”€â”€ */
.onboarding-wrap { padding:80px 20px; text-align:center; }
.onboarding-emoji { font-size:56px; margin-bottom:20px; }
.onboarding-title { font-size:22px; font-weight:800; color:#0f172a; margin-bottom:10px; letter-spacing:-.5px; }
.onboarding-sub { font-size:14px; color:#64748b; line-height:1.7; margin-bottom:32px; }
.onboarding-btn { display:inline-flex; align-items:center; gap:8px; background:#1e293b; color:#fff; border:none; border-radius:14px; padding:16px 28px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
.onboarding-btn:active { opacity:.85; }

/* â”€â”€ í”¼ë“œ â”€â”€ */
.feed { padding:16px; display:flex; flex-direction:column; gap:24px; padding-bottom:100px; }
.kw-section { display:flex; flex-direction:column; gap:12px; }
.kw-section-header { display:flex; align-items:center; justify-content:space-between; padding:0 4px; }
.kw-title { font-size:20px; font-weight:800; color:#0f172a; }
.kw-meta { font-size:11px; color:#94a3b8; }
.brief-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; }
.brief-card[data-a="BA"]    { border-top:3px solid #2563eb; }
.brief-card[data-a="STOCK"] { border-top:3px solid #0891b2; }
.brief-card[data-a="PM"]    { border-top:3px solid #7c3aed; }
.brief-header { padding:18px 18px 12px; }
.brief-agent-label { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:8px; }
.brief-agent-label[data-a="BA"]    { color:#2563eb; }
.brief-agent-label[data-a="STOCK"] { color:#0891b2; }
.brief-agent-label[data-a="PM"]    { color:#7c3aed; }
.brief-summary { font-size:16px; font-weight:700; color:#0f172a; line-height:1.55; }
.brief-points { padding:4px 18px 16px; display:flex; flex-direction:column; gap:10px; }
.brief-point { display:flex; gap:10px; align-items:flex-start; }
.brief-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; margin-top:8px; }
.brief-dot[data-a="BA"]    { background:#2563eb; }
.brief-dot[data-a="STOCK"] { background:#0891b2; }
.brief-dot[data-a="PM"]    { background:#7c3aed; }
.brief-text { font-size:14px; color:#475569; line-height:1.75; }

/* â”€â”€ ë´‰íˆ¬ ë²„íŠ¼ â”€â”€ */
.secret-btn { margin:0 14px 16px; border:1.5px solid #e2e8f0; display:inline-flex; align-items:center; gap:10px; background:#fff; border-radius:12px; padding:12px 16px; cursor:pointer; transition:background .15s; max-width:280px; min-height:52px; }
.secret-btn:active { background:#f8fafc; }
.envelope-wrap { position:relative; width:32px; height:24px; flex-shrink:0; }
.envelope-wrap svg { width:32px; height:24px; }
.env-lid { transform-origin:50% 0%; transition:transform .35s ease; }
.secret-btn.open .env-lid { transform:rotateX(160deg); }
.secret-text-wrap { display:flex; flex-direction:column; align-items:flex-start; gap:2px; }
.secret-title { font-size:13px; font-weight:700; color:#334155; }
.secret-sub { font-size:11px; color:#94a3b8; }
.secret-chevron { font-size:10px; color:#cbd5e1; transition:transform .3s; }
.secret-btn.open .secret-chevron { transform:rotate(180deg); }
.secret-panel { max-height:0; overflow:hidden; transition:max-height .4s ease; background:#f8fafc; border-top:1px solid #e2e8f0; }
.secret-panel.open { max-height:700px; }
.secret-inner { padding:18px; display:flex; flex-direction:column; gap:12px; }
.secret-agent-header { display:flex; align-items:center; gap:8px; padding-bottom:12px; border-bottom:1px solid #e2e8f0; }
.secret-agent-badge { font-size:10px; font-weight:700; letter-spacing:.8px; padding:4px 10px; border-radius:20px; }
.secret-agent-badge[data-a="BA"]    { background:#eff6ff; color:#2563eb; }
.secret-agent-badge[data-a="STOCK"] { background:#ecfeff; color:#0891b2; }
.secret-agent-badge[data-a="PM"]    { background:#f5f3ff; color:#7c3aed; }
.secret-agent-sub { font-size:11px; color:#94a3b8; font-weight:600; }
.s-point { display:flex; gap:10px; align-items:flex-start; }
.s-point-dot { width:4px; height:4px; border-radius:50%; flex-shrink:0; margin-top:9px; background:#94a3b8; }
.s-text { font-size:14px; color:#475569; line-height:1.75; }

/* â”€â”€ ì‚°ì—…êµ° ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ â”€â”€ */
.industry-card { background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%); border-radius:16px; padding:18px; color:#fff; position:relative; overflow:hidden; }
.industry-card::before { content:''; position:absolute; top:-30px; right:-30px; width:120px; height:120px; background:radial-gradient(circle,rgba(99,102,241,.25) 0%,transparent 70%); pointer-events:none; }
.industry-card-label { font-size:9px; font-weight:700; letter-spacing:2px; color:#6366f1; margin-bottom:8px; text-transform:uppercase; }
.industry-card-title { font-size:13px; font-weight:700; color:#a5b4fc; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.industry-trend-list { display:flex; flex-direction:column; gap:8px; }
.industry-trend-item { display:flex; gap:10px; align-items:flex-start; }
.industry-trend-dot { width:4px; height:4px; border-radius:50%; background:#6366f1; flex-shrink:0; margin-top:8px; }
.industry-trend-text { font-size:13px; color:rgba(255,255,255,.75); line-height:1.65; }

/* â”€â”€ KW ì¶”ì²œ ì¹´ë“œ â”€â”€ */
.kw-suggest-card { background:#fff; border:1px solid #e2e8f0; border-left:3px solid #10b981; border-radius:16px; padding:16px 18px; }
.kw-suggest-label { font-size:9px; font-weight:700; letter-spacing:2px; color:#10b981; margin-bottom:6px; text-transform:uppercase; }
.kw-suggest-title { font-size:13px; font-weight:700; color:#334155; margin-bottom:12px; }
.kw-suggest-chips { display:flex; flex-wrap:wrap; gap:8px; }
.kw-suggest-chip { display:inline-flex; align-items:center; gap:5px; padding:7px 13px; background:#f0fdf4; border:1.5px solid #bbf7d0; border-radius:20px; font-size:12px; font-weight:600; color:#065f46; cursor:pointer; transition:all .15s; min-height:36px; }
.kw-suggest-chip:active { background:#dcfce7; transform:scale(.96); }
.kw-suggest-chip.added { background:#1e293b; border-color:#1e293b; color:#fff; }

/* â”€â”€ ë‰´ìŠ¤/YouTube íƒ­ â”€â”€ */
.headlines-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; }
.content-tabs { display:flex; border-bottom:2px solid #f1f5f9; }
.tab-btn { flex:1; padding:12px 8px; font-size:13px; font-weight:700; color:#94a3b8; background:none; border:none; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .15s; min-height:44px; }
.tab-btn.active { color:#1e293b; border-bottom-color:#1e293b; }
.tab-btn.yt-tab.active { color:#e8472a; border-bottom-color:#e8472a; }
.hl-label { padding:14px 18px 8px; font-size:10px; font-weight:700; color:#94a3b8; letter-spacing:1.5px; text-transform:uppercase; }
.hl-item { padding:14px 18px; border-top:1px solid #f1f5f9; display:flex; gap:12px; align-items:flex-start; cursor:pointer; min-height:60px; }
.hl-item:active { background:#f8fafc; }
.hl-num { font-size:11px; font-weight:700; color:#cbd5e1; flex-shrink:0; padding-top:2px; }
.hl-title { font-size:14px; font-weight:600; color:#334155; line-height:1.5; margin-bottom:3px; }
.hl-summary { font-size:12px; color:#94a3b8; line-height:1.55; }
.yt-item { padding:14px 18px; border-top:1px solid #f1f5f9; display:flex; gap:12px; align-items:flex-start; cursor:pointer; min-height:60px; }
.yt-item:active { background:#f8fafc; }
.yt-badge { font-size:9px; font-weight:700; padding:2px 7px; border-radius:10px; flex-shrink:0; margin-top:3px; white-space:nowrap; }
.yt-badge.expert { background:#fff0ee; color:#e8472a; }
.yt-badge.normal { background:#f1f5f9; color:#94a3b8; }
.yt-title { font-size:14px; font-weight:600; color:#334155; line-height:1.5; margin-bottom:3px; }
.yt-meta  { font-size:12px; color:#94a3b8; line-height:1.55; }
.yt-empty { padding:32px 18px; text-align:center; color:#94a3b8; font-size:13px; }

/* â”€â”€ FAB â”€â”€ */
.fab { position:fixed; bottom:32px; right:20px; background:#1e293b; color:#fff; border:none; border-radius:50px; padding:14px 20px; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; box-shadow:0 4px 24px rgba(0,0,0,.18); z-index:100; min-height:50px; }
.fab:active { transform:scale(.97); }

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:300; align-items:flex-end; }
.modal-overlay.open { display:flex; }
.modal { background:#fff; border-radius:24px 24px 0 0; padding:28px 20px 48px; width:100%; max-height:90vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.modal-handle { width:36px; height:4px; background:#e2e8f0; border-radius:2px; margin:0 auto 20px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
.modal-title { font-size:17px; font-weight:700; color:#0f172a; }
.modal-close { font-size:20px; color:#94a3b8; border:none; background:none; cursor:pointer; padding:8px; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }
.modal-notice { font-size:12px; color:#f59e0b; background:#fffbeb; border:1px solid #fde68a; border-radius:10px; padding:10px 14px; margin-bottom:18px; display:flex; align-items:center; gap:6px; line-height:1.5; }
.form-label { font-size:13px; font-weight:600; color:#64748b; margin-bottom:8px; display:block; }
.form-textarea { width:100%; border:1.5px solid #e2e8f0; border-radius:12px; padding:12px 16px; font-size:15px; color:#1e293b; margin-bottom:16px; outline:none; font-family:inherit; resize:none; height:110px; -webkit-appearance:none; }
.form-textarea:focus { border-color:#2563eb; }
.thumb-row { display:flex; gap:12px; margin-bottom:20px; }
.thumb-btn { flex:1; padding:18px 12px; border-radius:16px; border:2px solid #e2e8f0; background:#fff; font-size:28px; cursor:pointer; transition:all .15s; display:flex; flex-direction:column; align-items:center; gap:6px; min-height:80px; }
.thumb-btn span.thumb-label { font-size:12px; font-weight:700; color:#94a3b8; }
.thumb-btn:active { transform:scale(.95); }
.thumb-btn.selected-up   { border-color:#10b981; background:#f0fdf4; }
.thumb-btn.selected-up   span.thumb-label { color:#10b981; }
.thumb-btn.selected-down { border-color:#ef4444; background:#fef2f2; }
.thumb-btn.selected-down span.thumb-label { color:#ef4444; }
.submit-btn { width:100%; background:#2563eb; color:#fff; border:none; border-radius:14px; padding:16px; font-size:15px; font-weight:700; cursor:pointer; min-height:52px; transition:background .15s; }
.submit-btn:active { background:#1d4ed8; }
.submit-btn:disabled { background:#94a3b8; cursor:default; }
.feedback-done { text-align:center; padding:32px 0 16px; }
.feedback-done-icon { font-size:48px; margin-bottom:12px; }
.feedback-done-title { font-size:17px; font-weight:700; color:#0f172a; margin-bottom:6px; }
.feedback-done-sub { font-size:13px; color:#94a3b8; margin-bottom:28px; line-height:1.6; }
.feedback-new-btn { width:100%; background:#f1f5f9; color:#475569; border:none; border-radius:14px; padding:16px; font-size:15px; font-weight:600; cursor:pointer; min-height:52px; }
.feedback-new-btn:active { background:#e2e8f0; }

/* â”€â”€ í‚¤ì›Œë“œ ê´€ë¦¬ â”€â”€ */
.kw-list { display:flex; flex-direction:column; gap:8px; margin-bottom:18px; }
.kw-manage-item { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; min-height:52px; }
.kw-manage-name { font-size:15px; font-weight:600; color:#1e293b; }
.kw-del-btn { background:none; border:none; color:#94a3b8; font-size:18px; cursor:pointer; padding:8px; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }
.kw-add-row { display:flex; gap:8px; }
.kw-add-input { flex:1; border:1.5px solid #e2e8f0; border-radius:12px; padding:12px 16px; font-size:15px; outline:none; font-family:inherit; min-height:50px; -webkit-appearance:none; }
.kw-add-input:focus { border-color:#2563eb; }
.kw-add-btn { background:#2563eb; color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:14px; font-weight:700; cursor:pointer; min-height:50px; white-space:nowrap; }
.kw-add-btn:active { background:#1d4ed8; }

@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="top-bar" id="topBar">
  <div class="header-row">
    <span class="brand">Fitz Intelligence</span>
    <div style="display:flex; align-items:center; gap:8px;">
      <div class="master-nav" id="master-nav" style="display:none;">
        <button class="master-nav-btn home" onclick="location.href='index.html'">ğŸŒ í™ˆ</button>
        <button class="master-nav-btn hq"   onclick="location.href='master.html'">âš™ï¸ HQ</button>
      </div>
      <button class="logout-btn" id="logout-btn" style="display:none;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <button class="collapse-btn" onclick="toggleTopBar()" id="collapseBtn">ì ‘ê¸° â–²</button>
    </div>
  </div>

  <div class="collapsed-bar hidden" id="collapsedBar">
    <div class="c-chip date-c" id="chip-date" onclick="toggleDD('dd-date',event)">
      <span id="chip-date-txt">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-date"></div>
    </div>
    <span class="c-sep">Â·</span>
    <div class="c-chip agent-c" id="chip-agent" data-a="BA" onclick="toggleDD('dd-agent',event)">
      <span id="chip-agent-txt">ë¹„ì¦ˆë‹ˆìŠ¤</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-agent">
        <div class="c-dd-item active" onclick="selectAgentDD('BA','ë¹„ì¦ˆë‹ˆìŠ¤',event)"><span class="c-dd-dot" style="background:#2563eb"></span>ë¹„ì¦ˆë‹ˆìŠ¤</div>
        <div class="c-dd-item" onclick="selectAgentDD('STOCK','ì£¼ì‹',event)"><span class="c-dd-dot" style="background:#0891b2"></span>ì£¼ì‹</div>
        <div class="c-dd-item" onclick="selectAgentDD('PM','ê¸°íš',event)"><span class="c-dd-dot" style="background:#7c3aed"></span>ê¸°íš</div>
      </div>
    </div>
    <span class="c-sep">Â·</span>
    <div class="c-chip kw-c" id="chip-kw" onclick="toggleDD('dd-kw',event)">
      <span id="chip-kw-txt">-</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-kw"></div>
    </div>
  </div>

  <div class="collapsible">
    <div class="filter-grid">
      <div class="filter-label">ë‚ ì§œ</div>
      <div class="filter-chips" id="date-row"></div>
    </div>
    <div class="filter-grid">
      <div class="filter-label">ë¸Œë¦¬í•‘</div>
      <div class="filter-chips">
        <div class="agent-chip active" data-a="BA"    onclick="selectAgent('BA','ë¹„ì¦ˆë‹ˆìŠ¤',this)"><span class="agent-dot"></span>ë¹„ì¦ˆë‹ˆìŠ¤</div>
        <div class="agent-chip"        data-a="STOCK" onclick="selectAgent('STOCK','ì£¼ì‹',this)"><span class="agent-dot"></span>ì£¼ì‹</div>
        <div class="agent-chip"        data-a="PM"    onclick="selectAgent('PM','ê¸°íš',this)"><span class="agent-dot"></span>ê¸°íš</div>
      </div>
    </div>
    <div class="filter-grid filter-grid-bottom">
      <div class="filter-label">í‚¤ì›Œë“œ</div>
      <div class="filter-chips" id="kw-nav"></div>
    </div>
  </div>
</div>

<div id="feed-wrap">
  <div class="feed-state">
    <div class="skeleton"></div>
    <div class="skeleton" style="height:140px;opacity:.6"></div>
  </div>
</div>

<button class="fab" onclick="openModal('feedback-modal')">ğŸ’¬ í”¼ë“œë°±</button>

<!-- í”¼ë“œë°± ëª¨ë‹¬ -->
<div class="modal-overlay" id="feedback-modal" onclick="closeModal('feedback-modal',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì–´ë– ì…¨ë‚˜ìš”?</span>
      <button class="modal-close" onclick="closeModal('feedback-modal')">âœ•</button>
    </div>
    <div id="feedback-form-view">
      <div class="modal-notice">âš ï¸ í”¼ë“œë°±ì€ AI ì—ì´ì „íŠ¸ ê°œì„ ì— ì§ì ‘ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <label class="form-label">ë§Œì¡±ë„</label>
      <div class="thumb-row">
        <button class="thumb-btn" id="thumb-up" onclick="selectThumb('up')">
          ğŸ‘<span class="thumb-label">ë„ì›€ì´ ëì–´ìš”</span>
        </button>
        <button class="thumb-btn" id="thumb-down" onclick="selectThumb('down')">
          ğŸ‘<span class="thumb-label">ì•„ì‰¬ì› ì–´ìš”</span>
        </button>
      </div>
      <label class="form-label">ììœ  ì˜ê²¬ <span style="font-weight:400;color:#94a3b8">(ì„ íƒ)</span></label>
      <textarea class="form-textarea" id="feedback-text" placeholder="ì–´ë–¤ ì ì´ ì¢‹ì•˜ë‚˜ìš”? ê°œì„ í•  ì ì´ ìˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”. ì—ì´ì „íŠ¸ ê°œì„ ì— ë°˜ì˜ë©ë‹ˆë‹¤."></textarea>
      <button class="submit-btn" id="feedback-submit-btn" onclick="submitFeedback()">ì œì¶œí•˜ê¸°</button>
    </div>
    <div id="feedback-done-view" style="display:none;">
      <div class="feedback-done">
        <div class="feedback-done-icon">âœ…</div>
        <div class="feedback-done-title">ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <div class="feedback-done-sub">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•´ìš”.<br>ì—ì´ì „íŠ¸ ê°œì„ ì— ë°˜ì˜í•˜ê² ìŠµë‹ˆë‹¤.</div>
        <button class="feedback-new-btn" onclick="resetFeedback()">+ ìƒˆ ì˜ê²¬ ë‚¨ê¸°ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- í‚¤ì›Œë“œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal-overlay" id="kw-modal" onclick="closeModal('kw-modal',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">í‚¤ì›Œë“œ ê´€ë¦¬</span>
      <button class="modal-close" onclick="closeModal('kw-modal')">âœ•</button>
    </div>
    <div class="modal-notice">âš ï¸ í‚¤ì›Œë“œëŠ” ìµœëŒ€ 5ê°œ. ë³€ê²½ì‚¬í•­ì€ ë‹¤ìŒ ë¸Œë¦¬í•‘ë¶€í„° ë°˜ì˜ë©ë‹ˆë‹¤.</div>
    <div class="kw-list" id="kw-manage-list"></div>
    <div class="kw-add-row">
      <input class="kw-add-input" id="kw-add-input" placeholder="ìƒˆ í‚¤ì›Œë“œ ì…ë ¥" maxlength="20"
             onkeydown="if(event.key==='Enter')addKeyword()">
      <button class="kw-add-btn" onclick="addKeyword()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<script>
const sc = supabase.createClient(
  'https://zrlpwmpbrvohautldcon.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybHB3bXBicnZvaGF1dGxkY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjk3NjQsImV4cCI6MjA4NjgwNTc2NH0.Ox5OZh1jJuhxUMd8zcLph08B5fERgNExAZfYZ24anJk'
);

const MASTER_EMAIL = 'positivecha@gmail.com';

const AGENT_BRIEF_KEYS = { BA:'ba_brief', STOCK:'securities_brief', PM:'pm_brief' };
const AGENT_DEFAULT_META = {
  BA:    { key:'ba_brief',         name:'ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„', icon:'ğŸ“Š', color:'#2563eb' },
  STOCK: { key:'securities_brief', name:'ì£¼ì‹ ë¸Œë¦¬í•‘',   icon:'ğŸ“ˆ', color:'#0891b2' },
  PM:    { key:'pm_brief',         name:'ê¸°íš ë¸Œë¦¬í•‘',   icon:'ğŸ¯', color:'#7c3aed' },
};
let AGENT_META = { ...AGENT_DEFAULT_META };

const COLOR_POOL = ['#2563eb','#0891b2','#7c3aed','#10b981','#f59e0b','#ef4444','#06b6d4','#8b5cf6','#f97316','#ec4899'];
const ICON_MAP   = { BA:'ğŸ“Š',STOCK:'ğŸ“ˆ',PM:'ğŸ¯',HR:'ğŸ‘¤',BRIEF:'ğŸ“°',KW:'ğŸ”‘',DATA:'ğŸ“‰',INFO:'ğŸŒ',DEV:'ğŸ’»',QA:'âœ…' };
const NAME_MAP   = { BA:'ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„',STOCK:'ì£¼ì‹ ë¸Œë¦¬í•‘',PM:'ê¸°íš ë¸Œë¦¬í•‘',HR:'ì¸ì‚¬ ë¶„ì„',BRIEF:'ë‰´ìŠ¤ ë¸Œë¦¬í•‘',KW:'í‚¤ì›Œë“œ ë¶„ì„',DATA:'ë°ì´í„° ë¶„ì„',INFO:'ì •ë³´ ë¶„ì„' };

async function loadDynamicAgents() {
  try {
    const [empRes, agRes] = await Promise.all([
      sc.from('brief_employees').select('agent_role').eq('status','ACTIVE'),
      sc.from('agents').select('agent_role').order('agent_role'),
    ]);
    const activeRoles = new Set((empRes.data||[]).map(e => e.agent_role));
    const newMeta = {};
    let colorIdx = 3;
    (agRes.data||[]).forEach(a => {
      const role = a.agent_role;
      if (AGENT_DEFAULT_META[role]) {
        newMeta[role] = { ...AGENT_DEFAULT_META[role] };
      } else if (activeRoles.has(role)) {
        newMeta[role] = {
          key:   AGENT_BRIEF_KEYS[role] || (role.toLowerCase() + '_brief'),
          name:  NAME_MAP[role] || role,
          icon:  ICON_MAP[role] || 'ğŸ¤–',
          color: COLOR_POOL[colorIdx++ % COLOR_POOL.length],
        };
      }
    });
    ['BA','STOCK','PM'].forEach(r => { if (!newMeta[r]) newMeta[r] = AGENT_DEFAULT_META[r]; });
    AGENT_META = newMeta;
    if (!AGENT_META[curAgent]) curAgent = Object.keys(AGENT_META)[0] || 'BA';
    rebuildAgentChips();
  } catch(e) { console.warn('[app] loadDynamicAgents ì‹¤íŒ¨:', e.message); }
}

function rebuildAgentChips() {
  // ë¸Œë¦¬í•‘ í•„í„° í–‰ ì¹© ì¬êµ¬ì„±
  const filterChips = document.querySelector('.filter-chips:has(.agent-chip)') 
    || document.querySelectorAll('.filter-chips')[1];
  if (filterChips) {
    filterChips.innerHTML = Object.entries(AGENT_META).map(([role, meta]) =>
      `<div class="agent-chip ${role===curAgent?'active':''}" data-a="${role}"
            onclick="selectAgent('${role}','${meta.name}',this)">
         <span class="agent-dot"></span>${meta.name}
       </div>`
    ).join('');
  }
  // collapsed bar DD ì¬êµ¬ì„±
  const ddAgent = document.getElementById('dd-agent');
  if (ddAgent) {
    ddAgent.innerHTML = Object.entries(AGENT_META).map(([role, meta]) =>
      `<div class="c-dd-item ${role===curAgent?'active':''}"
            onclick="selectAgentDD('${role}','${meta.name}',event)">
         <span class="c-dd-dot" style="background:${meta.color}"></span>${meta.name}
       </div>`
    ).join('');
  }
  // ì‹ ê·œ ì—ì´ì „íŠ¸ ìƒ‰ìƒ ë™ì  CSS ì£¼ì…
  Object.entries(AGENT_META).forEach(([role, meta]) => {
    if (document.getElementById(`agent-color-${role}`)) return;
    const s = document.createElement('style');
    s.id = `agent-color-${role}`;
    s.textContent = `
      .agent-chip.active[data-a="${role}"] { background:${meta.color}11; color:${meta.color}; border-color:${meta.color}44; }
      .brief-card[data-a="${role}"]        { border-top:3px solid ${meta.color}; }
      .brief-agent-label[data-a="${role}"] { color:${meta.color}; }
      .brief-dot[data-a="${role}"]         { background:${meta.color}; }
      .secret-agent-badge[data-a="${role}"]{ background:${meta.color}11; color:${meta.color}; }
      .c-chip.agent-c[data-a="${role}"]    { background:${meta.color}11; border-color:${meta.color}44; color:${meta.color}; }
    `;
    document.head.appendChild(s);
  });
}

window.CURRENT_USER = { email:'', userName:'', id:'' };
let curAgent      = 'BA';
let curDate       = '';
let allDates      = [];
let reportData    = null;
let kwNames       = [];
let userKeywords  = [];
let selectedThumb = null;

/* â”€â”€ XSS ë°©ì§€ â”€â”€ */
function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escJsStr(s) {
  return String(s)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '');
}

/* â”€â”€ ì˜¨ë³´ë”© í™”ë©´ â”€â”€ */
function showOnboarding(userName) {
  document.getElementById('feed-wrap').innerHTML = `
    <div class="onboarding-wrap">
      <div class="onboarding-emoji">ğŸ‘‹</div>
      <div class="onboarding-title">í™˜ì˜í•©ë‹ˆë‹¤, ${escHtml(userName)}ë‹˜!</div>
      <div class="onboarding-sub">
        ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ë“±ë¡í•˜ë©´<br>
        AI ì—ì´ì „íŠ¸ê°€ ë§¤ì¼ ì•„ì¹¨ 9ì‹œì—<br>
        ë§ì¶¤ ë¸Œë¦¬í•‘ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
      </div>
      <button class="onboarding-btn" onclick="openModal('kw-modal')">
        ğŸ”‘ í‚¤ì›Œë“œ ë“±ë¡í•˜ê¸°
      </button>
    </div>`;
  openModal('kw-modal');
}

/* â”€â”€ í”¼ë“œë°± â”€â”€ */
function selectThumb(type) {
  selectedThumb = (type === 'up');
  document.getElementById('thumb-up').className   = 'thumb-btn' + (type==='up'   ? ' selected-up'   : '');
  document.getElementById('thumb-down').className = 'thumb-btn' + (type==='down' ? ' selected-down' : '');
}

/* â”€â”€ í‚¤ì›Œë“œ í•œë„ ì²´í¬ â”€â”€ */
function checkKwLimit(context) {
  if (userKeywords.length >= 5) {
    if (context === 'suggest') {
      alert('í‚¤ì›Œë“œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní‚¤ì›Œë“œë¥¼ ë³€ê²½í•˜ë ¤ë©´ [âœï¸ ìˆ˜ì •í•˜ê¸°] ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
    } else {
      alert('í‚¤ì›Œë“œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê¸°ì¡´ í‚¤ì›Œë“œë¥¼ ì‚­ì œí•œ í›„ ë‹¤ì‹œ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
    }
    return false;
  }
  return true;
}

async function addSuggestedKw(kw, el) {
  if (!checkKwLimit('suggest')) return;
  userKeywords.push(kw);
  try {
    const { error } = await sc.from('user_settings')
      .upsert({ id: window.CURRENT_USER.id, keywords: userKeywords });
    if (error) throw error;
    el.classList.add('added');
    el.textContent = 'âœ“ ' + kw;
    renderKwManage();
  } catch (e) {
    userKeywords = userKeywords.filter(k => k !== kw);
    alert('í‚¤ì›Œë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    console.error('addSuggestedKw ì˜¤ë¥˜:', e);
  }
}

async function addKeyword() {
  const v = document.getElementById('kw-add-input').value.trim();
  if (!v) return;
  if (!checkKwLimit('manage')) { document.getElementById('kw-add-input').value=''; return; }
  userKeywords.push(v);
  try {
    const { error } = await sc.from('user_settings')
      .upsert({ id: window.CURRENT_USER.id, keywords: userKeywords });
    if (error) throw error;
    document.getElementById('kw-add-input').value = '';
    renderKwManage();
  } catch (e) {
    userKeywords = userKeywords.filter(k => k !== v);
    alert('í‚¤ì›Œë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    console.error('addKeyword ì˜¤ë¥˜:', e);
  }
}

/* â”€â”€ ë¸Œë¦¬í”„ íŒŒì‹± â”€â”€ */
function getSummary(b) {
  if (!b) return 'ë¶„ì„ ì¤‘...';
  if (typeof b === 'object') return b.summary || 'ë¶„ì„ ì¤‘...';
  return b.split('\n').find(l => l.trim().length > 20)?.trim() || 'ë¶„ì„ ì¤‘...';
}
function getPoints(b)    { return (typeof b === 'object' && b?.points) ? b.points : []; }
function getDeepLines(b) { return (typeof b === 'object' && b?.deep)   ? b.deep   : []; }

/* â”€â”€ ê¸°ì‚¬ ìš”ì•½ ì •ì œ â”€â”€ **ìƒí™©:**, **Situation:** ë“± LLM ë ˆì´ë¸” ì œê±° */
function cleanSummary(text) {
  if (!text) return '';
  return text
    // **ë ˆì´ë¸”:** ë³¼ë“œ ë§ˆí¬ë‹¤ìš´ íŒ¨í„´ ì œê±° (ì˜ˆ: **ìƒí™©:**, **Situation:**)
    .replace(/\*\*[^*:]{1,20}:\*\*\s*/g, '')
    // **ë ˆì´ë¸”** ë‹¨ë… íŒ¨í„´ + ì½œë¡  ì œê±°
    .replace(/\*\*[^*]{1,20}\*\*\s*[:ï¼š]?\s*/g, '')
    // ì¤„ ì• í•œê¸€/ì˜ë¬¸ ë ˆì´ë¸”: ì½œë¡  íŒ¨í„´ ì œê±°
    .replace(/^(ìƒí™©|ì œì•ˆ|ë°°ê²½|ìš”ì•½|ë¶„ì„|ê²°ë¡ |Situation|Summary|Proposal|Background|Analysis|Conclusion)\s*[:ï¼š]\s*/i, '')
    .trim();
}

/* â”€â”€ ë´‰íˆ¬ SVG â”€â”€ */
function makeSVG(a) {
  const c = AGENT_META[a]?.color || '#64748b';
  return `<svg viewBox="0 0 32 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="1" y="5" width="30" height="18" rx="2.5" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1.2"/>
    <path class="env-lid" d="M1 7 L16 16 L31 7 L31 5.5 Q31 4 29.5 4 L2.5 4 Q1 4 1 5.5 Z" fill="${c}" opacity="0.9"/>
    <path d="M1 7 L13 15" stroke="${c}" stroke-width="1" stroke-opacity="0.3"/>
    <path d="M31 7 L19 15" stroke="${c}" stroke-width="1" stroke-opacity="0.3"/>
    <circle cx="26" cy="5" r="3.5" fill="#ef4444" stroke="#fff" stroke-width="1.2"/>
    <line x1="10" y1="9" x2="22" y2="9" stroke="#fff" stroke-width="1" stroke-opacity="0.5" stroke-linecap="round"/>
  </svg>`;
}

/* â”€â”€ YouTube í—¬í¼ â”€â”€ */
function fmtNum(n) {
  if (!n) return '0';
  return n >= 10000 ? `${Math.floor(n/10000)}ë§Œ` : n.toLocaleString();
}
function buildYtItems(vids) {
  if (!vids?.length) return `<div class="yt-empty">ìˆ˜ì§‘ëœ YouTube ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  return vids.map(v => `
    <div class="yt-item" onclick="window.open('${escJsStr(v.url)}','_blank')">
      <span class="yt-badge ${v.is_expert?'expert':'normal'}">${v.is_expert?'â­ì „ë¬¸ê°€':'ì¼ë°˜'}</span>
      <div>
        <div class="yt-title">${escHtml(v.title)}</div>
        <div class="yt-meta">${escHtml(v.channel)} Â· êµ¬ë… ${fmtNum(v.subscriber_count)} Â· ì¡°íšŒ ${fmtNum(v.view_count)}</div>
      </div>
    </div>`).join('');
}

/* â”€â”€ ì‚°ì—…êµ° â”€â”€ */
let INDUSTRY_MAP = [];
async function loadIndustryMap() {
  try {
    const { data, error } = await sc.from('industry_map')
      .select('industry, icon, color, keywords, expand_kws')
      .eq('is_active', true).order('sort_order');
    if (error) throw error;
    INDUSTRY_MAP = (data||[]).map(r => ({
      industry: r.industry, icon: r.icon, color: r.color,
      keys: r.keywords, expand_kws: r.expand_kws,
    }));
  } catch(e) { console.warn('industry_map ë¡œë“œ ì‹¤íŒ¨:', e.message); INDUSTRY_MAP = []; }
}

function detectIndustry(kw) {
  const kl = kw.toLowerCase();
  return INDUSTRY_MAP.find(m => m.keys.some(k => kl.includes(k.toLowerCase()))) || null;
}

function buildIndustryCard(kw, kwData) {
  const ind = detectIndustry(kw);
  if (!ind) return '';
  const pts = [...getPoints(kwData.ba_brief), ...getPoints(kwData.securities_brief)].slice(0,3);
  if (!pts.length) return '';
  return `
    <div class="industry-card">
      <div class="industry-card-label">INDUSTRY INSIGHT</div>
      <div class="industry-card-title">
        <span>${ind.icon}</span>
        <span style="color:#a5b4fc">${ind.industry} ì‚°ì—…</span>
        <span style="margin-left:auto;font-size:10px;color:rgba(255,255,255,.3);font-weight:400">ì˜¤ëŠ˜ ë™í–¥</span>
      </div>
      <div class="industry-trend-list">
        ${pts.map(p=>`
          <div class="industry-trend-item">
            <div class="industry-trend-dot" style="background:${ind.color}"></div>
            <div class="industry-trend-text">${escHtml(p)}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

function buildKwSuggestCard(kw, kwData, i) {
  const ind = detectIndustry(kw);
  const pool = ind?.expand_kws || [];
  const extracted = [];
  (kwData.articles||[]).forEach(a => {
    (a.title||'').replace(/[^\wê°€-í£\s]/g,'').split(/\s+/).forEach(w => {
      if (w.length >= 3 && !userKeywords.includes(w) && !extracted.includes(w) && w !== kw)
        extracted.push(w);
    });
  });
  const sugs = [...new Set([...pool, ...extracted.slice(0,2)])]
    .filter(s => !userKeywords.includes(s)).slice(0,4);
  if (!sugs.length) return '';
  return `
    <div class="kw-suggest-card">
      <div class="kw-suggest-label">KW AGENT ì¶”ì²œ</div>
      <div class="kw-suggest-title">ğŸ’¡ ì´ í‚¤ì›Œë“œë„ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
      <div class="kw-suggest-chips">
        ${sugs.map(s=>`
          <div class="kw-suggest-chip" id="sugchip-${i}-${s.replace(/\s/g,'_')}"
               onclick="addSuggestedKw('${escJsStr(s)}',this)">+ ${escHtml(s)}</div>`).join('')}
      </div>
    </div>`;
}

/* â”€â”€ íƒ­ ì „í™˜ â”€â”€ */
function switchTab(i, type) {
  const isNews = type === 'news';
  document.getElementById(`panel-news-${i}`).style.display = isNews ? '' : 'none';
  document.getElementById(`panel-yt-${i}`).style.display   = isNews ? 'none' : '';
  document.getElementById(`tab-news-${i}`).classList.toggle('active', isNews);
  document.getElementById(`tab-yt-${i}`).classList.toggle('active', !isNews);
}

function buildCardInner(i, brief) {
  const a      = curAgent;
  const meta   = AGENT_META[a];
  const points = getPoints(brief);
  const deep   = getDeepLines(brief);
  return {
    labelHtml:   `â— ${meta.name}`,
    summaryHtml: escHtml(getSummary(brief)),
    pointsHtml:  points.map(p=>`
      <div class="brief-point">
        <div class="brief-dot" data-a="${a}"></div>
        <div class="brief-text">${escHtml(p)}</div>
      </div>`).join(''),
    secretHtml: `
      <div class="secret-agent-header">
        <span class="secret-agent-badge" data-a="${a}">${meta.icon} ${meta.name}</span>
        <span class="secret-agent-sub">ì‹¬ì¸µ ë¶„ì„</span>
      </div>
      ${deep.length
        ? deep.map(l=>`<div class="s-point"><div class="s-point-dot"></div><div class="s-text">${escHtml(l)}</div></div>`).join('')
        : `<div class="s-text" style="color:#94a3b8">ì¶”ê°€ ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`}`,
  };
}

/* â”€â”€ í”¼ë“œ ë Œë”ë§ â”€â”€ */
function renderFeed() {
  if (!reportData || !kwNames.length) {
    document.getElementById('feed-wrap').innerHTML = '<div class="feed-state">ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const nav = document.getElementById('kw-nav');
  nav.innerHTML = kwNames.map((kw,i) =>
    `<div class="kw-chip${i===0?' active':''}" id="nav-kw-${i}" onclick="scrollToKw('kw-${i}',this)"># ${escHtml(kw)}</div>`
  ).join('') + `<button class="kw-edit-btn" onclick="openModal('kw-modal')">âœï¸ ìˆ˜ì •í•˜ê¸°</button>`;

  document.getElementById('dd-kw').innerHTML = kwNames.map((kw,i) =>
    `<div class="c-dd-item${i===0?' active':''}" onclick="jumpKwDD(${i},event)"># ${escHtml(kw)}</div>`
  ).join('');
  document.getElementById('chip-kw-txt').textContent = `# ${kwNames[0]}`;

  const feed = document.createElement('div');
  feed.className = 'feed';
  const userName = window.CURRENT_USER.userName || 'ì‚¬ìš©ì';

  kwNames.forEach((kw, i) => {
    const kwData   = reportData[kw];
    if (!kwData) return;
    const brief    = kwData[AGENT_META[curAgent].key];
    const arts     = kwData.articles || [];
    const ytVideos = kwData.youtube_videos || [];
    const { labelHtml, summaryHtml, pointsHtml, secretHtml } = buildCardInner(i, brief);

    const sec = document.createElement('div');
    sec.className = 'kw-section';
    sec.id = `kw-${i}`;
    sec.innerHTML = `
      <div class="kw-section-header">
        <span class="kw-title"># ${escHtml(kw)}</span>
        <span class="kw-meta">ê¸°ì‚¬ ${arts.length}ê±´ Â· YouTube ${ytVideos.length}ê°œ</span>
      </div>
      <div class="brief-card" id="card-${i}" data-a="${curAgent}">
        <div class="brief-header">
          <div class="brief-agent-label" data-a="${curAgent}" id="alabel-${i}">${labelHtml}</div>
          <div class="brief-summary" id="summary-${i}">${summaryHtml}</div>
        </div>
        <div class="brief-points" id="points-${i}">${pointsHtml}</div>
        <button class="secret-btn" id="sbtn-${i}" onclick="toggleSecret(${i})">
          <div class="envelope-wrap">${makeSVG(curAgent)}</div>
          <div class="secret-text-wrap">
            <span class="secret-title">ë§ì¶¤ ë¸Œë¦¬í•‘ ë„ì°©</span>
            <span class="secret-sub">${escHtml(userName)}ë‹˜ì„ ìœ„í•´ ì •ë¦¬í–ˆì–´ìš”.</span>
          </div>
          <span class="secret-chevron">â–¼</span>
        </button>
        <div class="secret-panel" id="s-${i}">
          <div class="secret-inner" id="sinner-${i}">${secretHtml}</div>
        </div>
      </div>
      ${buildIndustryCard(kw, kwData)}
      ${buildKwSuggestCard(kw, kwData, i)}
      <div class="headlines-card">
        <div class="content-tabs">
          <button class="tab-btn active" id="tab-news-${i}" onclick="switchTab(${i},'news')">ğŸ“° ë‰´ìŠ¤ ${arts.length}ê±´</button>
          <button class="tab-btn yt-tab"  id="tab-yt-${i}"   onclick="switchTab(${i},'yt')">ğŸ¬ YouTube ${ytVideos.length}ê°œ</button>
        </div>
        <div id="panel-news-${i}">
          <div class="hl-label">ì˜¤ëŠ˜ì˜ í—¤ë“œë¼ì¸</div>
          ${arts.map((a,n)=>`
            <div class="hl-item" onclick="window.open('${escJsStr(a.url)}','_blank')">
              <span class="hl-num">0${n+1}</span>
              <div>
                <div class="hl-title">${escHtml(a.title)}</div>
                <div class="hl-summary">${escHtml(cleanSummary(a.pm_summary||a.description||''))}</div>
              </div>
            </div>`).join('')}
        </div>
        <div id="panel-yt-${i}" style="display:none;">
          <div class="hl-label">YouTube ì¸ì‚¬ì´íŠ¸</div>
          ${buildYtItems(ytVideos)}
        </div>
      </div>`;
    feed.appendChild(sec);
  });

  document.getElementById('feed-wrap').innerHTML = '';
  document.getElementById('feed-wrap').appendChild(feed);
  bindScroll();
}

/* â”€â”€ ì—ì´ì „íŠ¸ ì „í™˜ â”€â”€ */
function switchAgent() {
  if (!reportData) return;
  kwNames.forEach((kw, i) => {
    const kwData = reportData[kw];
    if (!kwData) return;
    const brief = kwData[AGENT_META[curAgent].key];
    const card  = document.getElementById(`card-${i}`);
    if (!card) return;
    const { labelHtml, summaryHtml, pointsHtml, secretHtml } = buildCardInner(i, brief);
    card.setAttribute('data-a', curAgent);
    document.getElementById(`alabel-${i}`).setAttribute('data-a', curAgent);
    document.getElementById(`alabel-${i}`).textContent = `â— ${AGENT_META[curAgent].name}`;
    document.getElementById(`summary-${i}`).textContent = getSummary(brief);
    document.getElementById(`points-${i}`).innerHTML = pointsHtml;
    card.querySelector('.envelope-wrap').innerHTML = makeSVG(curAgent);
    document.getElementById(`sinner-${i}`).innerHTML = secretHtml;
    card.style.animation = 'none'; card.offsetHeight; card.style.animation = 'fadeUp .2s ease';
  });
}

/* â”€â”€ ë‚ ì§œ â”€â”€ */
async function loadDates(userId) {
  const { data } = await sc.from('reports').select('report_date')
    .eq('user_id', userId).order('report_date', { ascending: false });
  if (!data?.length) return;
  allDates = [...new Set(data.map(d => d.report_date))];
  curDate  = allDates[0];
  renderDateUI();
}

function renderDateUI() {
  document.getElementById('date-row').innerHTML = allDates.map((d,i) => {
    const lbl = i===0 ? `${fmtDate(d)} ì˜¤ëŠ˜` : fmtDate(d);
    return `<div class="date-chip${d===curDate?' active':''}" onclick="selectDate('${d}',this)">${lbl}</div>`;
  }).join('');
  document.getElementById('dd-date').innerHTML = allDates.map((d,i) => {
    const lbl = i===0 ? `${fmtDate(d)} ì˜¤ëŠ˜` : fmtDate(d);
    return `<div class="c-dd-item${d===curDate?' active':''}" onclick="selectDateDD('${d}',event)">${lbl}</div>`;
  }).join('');
  const idx = allDates.indexOf(curDate);
  document.getElementById('chip-date-txt').textContent = idx===0 ? `${fmtDate(curDate)} ì˜¤ëŠ˜` : fmtDate(curDate);
}

function fmtDate(iso) {
  const [,m,d] = iso.split('-');
  return `${m}.${d}`;
}

async function fetchReport(userId, date) {
  document.getElementById('feed-wrap').innerHTML =
    '<div class="feed-state"><div class="skeleton"></div><div class="skeleton" style="height:140px;opacity:.6"></div></div>';
  const { data } = await sc.from('reports').select('content')
    .eq('user_id', userId).eq('report_date', date).limit(1);
  if (!data?.length || !data[0].content?.by_keyword) {
    document.getElementById('feed-wrap').innerHTML = `<div class="feed-state">ğŸ“­ ${date} ë¸Œë¦¬í•‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  reportData = data[0].content.by_keyword;
  kwNames    = Object.keys(reportData);
  renderFeed();
  renderKwManage();
}

async function selectDate(date, el) {
  curDate = date;
  document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#dd-date .c-dd-item').forEach(it =>
    it.classList.toggle('active', it.textContent.trim().startsWith(fmtDate(date)))
  );
  const idx = allDates.indexOf(date);
  document.getElementById('chip-date-txt').textContent = idx===0 ? `${fmtDate(date)} ì˜¤ëŠ˜` : fmtDate(date);
  await fetchReport(window.CURRENT_USER.id, date);
}

async function selectDateDD(date, e) {
  e.stopPropagation(); closeAllDD();
  const chip = document.querySelector(`.date-chip[onclick*="${date}"]`);
  if (chip) await selectDate(date, chip);
  else { curDate = date; await fetchReport(window.CURRENT_USER.id, date); }
}

/* â”€â”€ ì—ì´ì „íŠ¸ â”€â”€ */
function selectAgent(key, label, el) {
  curAgent = key;
  document.querySelectorAll('.agent-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const chip = document.getElementById('chip-agent');
  chip.setAttribute('data-a', key);
  document.getElementById('chip-agent-txt').textContent = label;
  document.querySelectorAll('#dd-agent .c-dd-item').forEach(it =>
  it.classList.toggle('active', it.querySelector('.c-dd-dot') 
    ? it.textContent.trim() === (AGENT_META[key]?.name || key)
    : false)
);
  switchAgent();
}

function selectAgentDD(key, label, e) {
  e.stopPropagation(); closeAllDD();
  const chip = document.querySelector(`.agent-chip[data-a="${key}"]`);
  if (chip) selectAgent(key, label, chip);
  else { curAgent = key; rebuildAgentChips(); switchAgent(); }
}

/* â”€â”€ í‚¤ì›Œë“œ DD â”€â”€ */
function jumpKwDD(i, e) {
  e.stopPropagation(); closeAllDD();
  document.getElementById('chip-kw-txt').textContent = `# ${kwNames[i]}`;
  document.querySelectorAll('#dd-kw .c-dd-item').forEach((it,j) => it.classList.toggle('active', j===i));
  const navChip = document.getElementById(`nav-kw-${i}`);
  if (navChip) scrollToKw(`kw-${i}`, navChip);
}

/* â”€â”€ í‚¤ì›Œë“œ ê´€ë¦¬ â”€â”€ */
function renderKwManage() {
  document.getElementById('kw-manage-list').innerHTML = userKeywords.map(kw => `
    <div class="kw-manage-item">
      <span class="kw-manage-name"># ${escHtml(kw)}</span>
      <button class="kw-del-btn" onclick="removeKeyword('${escJsStr(kw)}')">âœ•</button>
    </div>`).join('');
}

async function removeKeyword(kw) {
  const prev = [...userKeywords];
  userKeywords = userKeywords.filter(k => k !== kw);
  try {
    const { error } = await sc.from('user_settings')
      .upsert({ id: window.CURRENT_USER.id, keywords: userKeywords });
    if (error) throw error;
    renderKwManage();
  } catch (e) {
    userKeywords = prev;
    alert('í‚¤ì›Œë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    console.error('removeKeyword ì˜¤ë¥˜:', e);
  }
}

/* â”€â”€ í”¼ë“œë°± â”€â”€ */
async function submitFeedback() {
  const text = document.getElementById('feedback-text').value.trim();
  const btn  = document.getElementById('feedback-submit-btn');
  if (selectedThumb === null && !text) {
    alert('ğŸ‘ ë˜ëŠ” ğŸ‘ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  btn.disabled = true; btn.textContent = 'ì œì¶œ ì¤‘...';
  try {
    await sc.from('report_feedback').insert({
      user_id:       window.CURRENT_USER.id,
      user_email:    window.CURRENT_USER.email,
      is_positive:   selectedThumb,
      feedback_text: text || null,
      report_date:   curDate || null,
      created_at:    new Date().toISOString()
    });
    document.getElementById('feedback-form-view').style.display = 'none';
    document.getElementById('feedback-done-view').style.display = 'block';
  } catch(e) {
    console.error('í”¼ë“œë°± ì €ì¥ ì˜¤ë¥˜:', e);
    alert(JSON.stringify(e));
    btn.disabled = false;
    btn.textContent = 'ì œì¶œí•˜ê¸°';
  }
}
function resetFeedback() {
  selectedThumb = null;
  document.getElementById('thumb-up').className   = 'thumb-btn';
  document.getElementById('thumb-down').className = 'thumb-btn';
  document.getElementById('feedback-text').value  = '';
  const btn = document.getElementById('feedback-submit-btn');
  btn.disabled = false; btn.textContent = 'ì œì¶œí•˜ê¸°';
  document.getElementById('feedback-done-view').style.display = 'none';
  document.getElementById('feedback-form-view').style.display = 'block';
}

/* â”€â”€ ë¡œê·¸ì•„ì›ƒ â”€â”€ */
async function logout() {
  await sc.auth.signOut();
  location.href = 'index.html';
}

/* â”€â”€ DD / ì ‘ê¸° / ìŠ¤í¬ë¡¤ â”€â”€ */
function toggleDD(id, e) {
  e.stopPropagation();
  const el = document.getElementById(id);
  const isOpen = el.classList.contains('open');
  closeAllDD();
  if (!isOpen) el.classList.add('open');
}
function closeAllDD() { document.querySelectorAll('.c-dropdown').forEach(d => d.classList.remove('open')); }
document.addEventListener('click', closeAllDD);

function toggleTopBar() {
  const bar  = document.getElementById('topBar');
  const btn  = document.getElementById('collapseBtn');
  const cBar = document.getElementById('collapsedBar');
  bar.classList.toggle('collapsed');
  const c = bar.classList.contains('collapsed');
  btn.textContent = c ? 'í¼ì¹˜ê¸° â–¼' : 'ì ‘ê¸° â–²';
  cBar.classList.toggle('hidden', !c);
}

function scrollToKw(id, el) {
  document.querySelectorAll('.kw-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const target = document.getElementById(id);
  if (!target) return;
  const offset = document.getElementById('topBar').offsetHeight + 12;
  window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - offset, behavior:'smooth' });
}

function bindScroll() {
  window.onscroll = () => {
    const topH = document.getElementById('topBar').offsetHeight;
    let active = 0;
    kwNames.forEach((_,i) => {
      const s = document.getElementById(`kw-${i}`);
      if (s && s.getBoundingClientRect().top <= topH + 40) active = i;
    });
    document.querySelectorAll('.kw-chip').forEach((c,i) => c.classList.toggle('active', i===active));
    if (kwNames[active]) {
      document.getElementById('chip-kw-txt').textContent = `# ${kwNames[active]}`;
      document.querySelectorAll('#dd-kw .c-dd-item').forEach((it,j) => it.classList.toggle('active', j===active));
    }
  };
}

function toggleSecret(i) {
  document.getElementById(`s-${i}`).classList.toggle('open');
  document.getElementById(`sbtn-${i}`).classList.toggle('open');
}

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
function openModal(id) {
  document.getElementById(id).classList.add('open');
  if (id === 'feedback-modal') {
    document.getElementById('feedback-form-view').style.display = 'block';
    document.getElementById('feedback-done-view').style.display = 'none';
  }
}
function closeModal(id, e) {
  if (!e || e.target.classList.contains('modal-overlay'))
    document.getElementById(id).classList.remove('open');
}

/* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
async function init() {
  try {
    const { data:{ session } } = await sc.auth.getSession();
    if (!session) { location.href = 'index.html'; return; }

    const { email, id: userId } = session.user;
    const userName = email.split('@')[0];
    window.CURRENT_USER = { email, userName, id: userId };

    if (email === MASTER_EMAIL) document.getElementById('master-nav').style.display = 'flex';
    document.getElementById('logout-btn').style.display = 'block';

   const [uSettingsRes] = await Promise.all([
      sc.from('user_settings').select('keywords').eq('id', userId).maybeSingle(),
      loadIndustryMap(),
      loadDynamicAgents(),   // â† ì¶”ê°€
    ]);

    // ì‹¤ì‹œê°„ ì§ì› ë³€ê²½ êµ¬ë… (ì±„ìš©/í•´ê³  ì‹œ ì¹© ì¦‰ì‹œ ë°˜ì˜)
    sc.channel('emp-updates')
      .on('postgres_changes', { event:'*', schema:'public', table:'brief_employees' },
          () => loadDynamicAgents())
      .subscribe();           // â† ì¶”ê°€
    userKeywords = uSettingsRes?.data?.keywords || [];

    // â”€â”€ í‚¤ì›Œë“œ ì—†ëŠ” ì‹ ê·œ ìœ ì € â†’ ì˜¨ë³´ë”© í™”ë©´ í‘œì‹œ
    if (userKeywords.length === 0) {
      showOnboarding(userName);
      return;
    }

    await loadDates(userId);
    if (allDates.length > 0) {
      await fetchReport(userId, allDates[0]);
    } else {
      document.getElementById('feed-wrap').innerHTML =
        '<div class="feed-state">ì•„ì§ ë°œì†¡ëœ ë¸Œë¦¬í•‘ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë‚´ì¼ ì˜¤ì „ 9ì‹œì— ì²« ë¸Œë¦¬í•‘ì´ ë„ì°©í•©ë‹ˆë‹¤.</div>';
    }
  } catch(err) {
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
    window.CURRENT_USER = { email:'', userName:'ì‚¬ìš©ì', id:'' };
    document.getElementById('feed-wrap').innerHTML =
      '<div class="feed-state">ì„¸ì…˜ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</div>';
  }
}

init();
</script>
</body>
</html>
