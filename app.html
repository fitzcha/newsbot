<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
  :root {
    --primary: #4f46e5;
    --primary-light: #eef2ff;
    --success: #10b981;
    --danger: #ef4444;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-400: #9ca3af;
    --gray-600: #4b5563;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius: 16px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; }
  body { font-family: 'Pretendard', sans-serif; margin: 0; background: var(--gray-50); color: var(--gray-800); line-height: 1.6; }

  /* NAV */
  .nav { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--gray-200); padding: 0 24px; height: 60px; display: flex; align-items: center; justify-content: space-between; }
  .nav-logo { font-size: 1rem; font-weight: 800; color: var(--gray-900); letter-spacing: -0.5px; cursor: pointer; }
  .nav-right { display: flex; align-items: center; gap: 8px; }
  .nav-user { font-size: 0.8rem; color: var(--gray-600); font-weight: 600; }
  .btn-ghost { background: none; border: 1px solid var(--gray-200); color: var(--gray-600); padding: 6px 14px; border-radius: 8px; font-size: 0.78rem; cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.15s; }
  .btn-ghost:hover { background: var(--gray-100); }
  .btn-hq { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; font-family: inherit; font-weight: 700; }

  /* LAYOUT */
  .page { max-width: 860px; margin: 0 auto; padding: 32px 20px 60px; }

  /* CARD */
  .card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--gray-200); }

  /* â”€â”€ ONBOARDING â”€â”€ */
  .onboarding { padding: 48px 40px; text-align: center; }
  .onboarding-badge { display: inline-block; background: var(--primary-light); color: var(--primary); font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 20px; letter-spacing: 0.5px; margin-bottom: 16px; }
  .onboarding h2 { font-size: 1.6rem; font-weight: 800; color: var(--gray-900); margin: 0 0 8px; letter-spacing: -0.5px; }
  .onboarding p { color: var(--gray-400); font-size: 0.9rem; margin: 0 0 32px; }
  .kw-input-row { display: flex; gap: 8px; max-width: 400px; margin: 0 auto 16px; }
  .kw-input { flex: 1; padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 0.9rem; font-family: inherit; outline: none; transition: 0.15s; }
  .kw-input:focus { border-color: var(--primary); }
  .btn-primary { background: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; font-family: inherit; white-space: nowrap; transition: 0.15s; }
  .btn-primary:hover { background: #4338ca; }
  .tag-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; min-height: 36px; }
  .tag { background: var(--primary-light); color: var(--primary); padding: 6px 14px; border-radius: 20px; font-size: 0.82rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .tag-del { cursor: pointer; color: #a5b4fc; font-size: 1rem; line-height: 1; }
  .tag-del:hover { color: var(--danger); }
  .onboarding-hint { margin-top: 12px; font-size: 0.78rem; color: var(--gray-400); }

  /* ì™„ë£Œ ìƒíƒœ */
  .onboarding-done { background: linear-gradient(135deg, #ecfdf5, #d1fae5); border: 1.5px solid #a7f3d0; padding: 28px; border-radius: var(--radius); text-align: center; display: none; }
  .onboarding-done h3 { margin: 0 0 6px; color: var(--success); font-size: 1.1rem; }
  .onboarding-done p { margin: 0; color: #065f46; font-size: 0.85rem; }

  /* â”€â”€ KEYWORD BAR (ë¦¬í¬íŠ¸ ìˆëŠ” ìœ ì €ìš©) â”€â”€ */
  .kw-bar { padding: 16px 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid var(--gray-100); }
  .kw-bar-label { font-size: 0.78rem; font-weight: 700; color: var(--gray-400); letter-spacing: 0.5px; }

  /* â”€â”€ REPORT AREA â”€â”€ */
  #main-content-area { display: none; }
  .report-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; border-bottom: 1px solid var(--gray-100); }
  .tab-group { display: flex; gap: 4px; background: var(--gray-100); padding: 4px; border-radius: 10px; }
  .tab-btn { padding: 7px 16px; border-radius: 8px; border: none; background: none; font-size: 0.82rem; font-weight: 600; color: var(--gray-600); cursor: pointer; font-family: inherit; transition: 0.15s; }
  .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .date-select { border: 1px solid var(--gray-200); background: #fff; padding: 7px 12px; border-radius: 8px; font-size: 0.82rem; font-family: inherit; font-weight: 600; cursor: pointer; color: var(--gray-600); }

  /* BRIEFING */
  .briefing-card { margin: 16px; background: var(--gray-900); border-radius: 14px; padding: 24px; color: #fff; }
  .briefing-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .briefing-label { font-size: 0.82rem; font-weight: 700; color: #a5b4fc; }
  .eval-btns { display: flex; gap: 6px; }
  .eval-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.6); padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.78rem; font-family: inherit; transition: 0.15s; }
  .eval-btn.up { background: var(--primary); color: #fff; border-color: var(--primary); }
  .eval-btn.down { background: var(--danger); color: #fff; border-color: var(--danger); }
  .voc-area { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
  .voc-input { width: 100%; background: rgba(255,255,255,0.06); color: #fff; border: 1px solid rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; font-size: 0.85rem; font-family: inherit; resize: none; }
  .btn-voc-submit { margin-top: 8px; background: #fff; color: var(--gray-900); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 700; font-size: 0.82rem; cursor: pointer; font-family: inherit; }
  .success-msg { display: none; color: #6ee7b7; font-size: 0.82rem; font-weight: 700; text-align: center; margin-bottom: 8px; }
  #briefing-content { font-size: 0.95rem; line-height: 1.8; color: rgba(255,255,255,0.88); }

  /* NEWS CARDS */
  .news-section { padding: 16px; }
  .news-section-title { font-size: 0.78rem; font-weight: 700; color: var(--gray-400); letter-spacing: 0.5px; margin-bottom: 12px; }
  .news-card { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px 18px; margin-bottom: 10px; }
  .news-kw-tag { display: inline-block; background: var(--primary-light); color: var(--primary); font-size: 0.72rem; font-weight: 700; padding: 2px 10px; border-radius: 20px; margin-bottom: 8px; }
  .news-title { font-size: 0.9rem; font-weight: 700; color: var(--gray-900); text-decoration: none; line-height: 1.5; display: block; margin-bottom: 6px; }
  .news-title:hover { color: var(--primary); }
  .news-summary { font-size: 0.82rem; color: var(--gray-600); margin-bottom: 4px; }
  .news-impact { font-size: 0.78rem; color: var(--gray-400); }

  /* EMPTY */
  .empty-state { padding: 60px 20px; text-align: center; color: var(--gray-400); }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.88rem; }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <span class="nav-logo" onclick="location.href='index.html'">Fitz Intelligence</span>
  <div class="nav-right">
    <span class="nav-user" id="nav-user"></span>
    <button class="btn-ghost" id="btn-hq" style="display:none;" onclick="location.href='master.html'">ğŸ”´ HQ</button>
    <button class="btn-ghost" onclick="location.href='index.html'">í™ˆ</button>
    <button class="btn-ghost" id="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</nav>

<div class="page">

  <!-- í‚¤ì›Œë“œ ì„¤ì • ì¹´ë“œ (í•­ìƒ ìƒë‹¨ ë…¸ì¶œ) -->
  <div class="card" style="margin-bottom:20px;">

    <!-- ì˜¨ë³´ë”© (í‚¤ì›Œë“œ ì—†ëŠ” ì‹ ê·œ ìœ ì €) -->
    <div id="onboarding-new" class="onboarding">
      <div class="onboarding-badge">WELCOME</div>
      <h2>ì²« ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”</h2>
      <p>ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ìµœëŒ€ 5ê°œ ë“±ë¡í•˜ë©´<br>ë§¤ì¼ ì˜¤ì „ 9ì‹œì— AI ë¸Œë¦¬í•‘ì´ ì´ë©”ì¼ë¡œ ë„ì°©í•©ë‹ˆë‹¤.</p>
      <div class="kw-input-row">
        <input class="kw-input" id="new-kw" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì, AIë°˜ë„ì²´, í…ŒìŠ¬ë¼" onkeydown="if(event.key==='Enter') addKw()">
        <button class="btn-primary" onclick="addKw()">ì¶”ê°€</button>
      </div>
      <div class="tag-list" id="tag-list-onboarding"></div>
      <p class="onboarding-hint" id="kw-count-hint">ì•„ì§ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</p>
    </div>

    <!-- ë“±ë¡ ì™„ë£Œ ë©”ì‹œì§€ -->
    <div id="onboarding-done" class="onboarding-done" style="margin:16px;">
      <h3>âœ… í‚¤ì›Œë“œ ë“±ë¡ ì™„ë£Œ!</h3>
      <p>ë‚´ì¼ ì˜¤ì „ 9ì‹œì— ì²« ë¦¬í¬íŠ¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.<br>ì˜¤ëŠ˜ ë¦¬í¬íŠ¸ëŠ” ì•„ì§ ì¤€ë¹„ ì¤‘ì´ì—ìš”.</p>
    </div>

    <!-- í‚¤ì›Œë“œ ë°” (ê¸°ì¡´ ìœ ì €: ë¦¬í¬íŠ¸ ìˆìŒ) -->
    <div id="kw-bar" class="kw-bar" style="display:none;">
      <span class="kw-bar-label">ğŸ“Œ ë‚´ í‚¤ì›Œë“œ</span>
      <div id="tag-list-bar" style="display:flex; flex-wrap:wrap; gap:6px; flex:1;"></div>
      <div style="display:flex; gap:6px; align-items:center;">
        <input class="kw-input" id="new-kw-bar" placeholder="í‚¤ì›Œë“œ ì¶”ê°€" style="width:130px; padding:7px 12px; font-size:0.82rem;" onkeydown="if(event.key==='Enter') addKwBar()">
        <button class="btn-primary" style="padding:7px 14px; font-size:0.82rem;" onclick="addKwBar()">ì¶”ê°€</button>
      </div>
    </div>

  </div>

  <!-- ë¦¬í¬íŠ¸ ì˜ì—­ -->
  <div id="main-content-area">
    <div class="card">

      <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
      <div class="report-header">
        <div class="tab-group">
          <button class="tab-btn active" id="role-BA" onclick="changeRole('BA')">ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„</button>
          <button class="tab-btn" id="role-Stock" onclick="changeRole('Stock')">ì¦ê¶ŒÂ·íˆ¬ì</button>
          <button class="tab-btn" id="role-PM" onclick="changeRole('PM')">ì „ëµ ê¸°íš</button>
        </div>
        <select class="date-select" id="date-select" onchange="fetchDayData()"></select>
      </div>

      <!-- ë¸Œë¦¬í•‘ -->
      <div class="briefing-card">
        <div class="briefing-top">
          <span class="briefing-label" id="eval-role-name">ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</span>
          <div class="eval-btns">
            <button class="eval-btn" id="btn-up" onclick="handleThumb(true)">ğŸ‘ ë„ì›€ë¼ìš”</button>
            <button class="eval-btn" id="btn-down" onclick="handleThumb(false)">ğŸ‘ ì•„ì‰¬ì›Œìš”</button>
          </div>
        </div>
        <div class="voc-area" id="voc-area">
          <div class="success-msg" id="success-msg">âœ… ì˜ê²¬ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
          <textarea class="voc-input" id="voc-text" rows="3" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ë°”ë¼ëŠ” ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
          <button class="btn-voc-submit" onclick="submitFeedback()">ì œì¶œ</button>
        </div>
        <div id="briefing-content">ë¶„ì„ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ë‰´ìŠ¤ ì¹´ë“œ -->
      <div class="news-section">
        <div class="news-section-title">ì˜¤ëŠ˜ì˜ ìˆ˜ì§‘ ë‰´ìŠ¤</div>
        <div id="news-list"></div>
      </div>

    </div>
  </div>

  <!-- ë¦¬í¬íŠ¸ ì—†ëŠ” ê¸°ì¡´ ìœ ì € (í‚¤ì›Œë“œëŠ” ìˆì§€ë§Œ ì˜¤ëŠ˜ ë¦¬í¬íŠ¸ ì—†ìŒ) -->
  <div id="empty-report" style="display:none;">
    <div class="card empty-state">
      <div class="icon">â³</div>
      <p>ì˜¤ëŠ˜ ë¦¬í¬íŠ¸ê°€ ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br><b>ë§¤ì¼ ì˜¤ì „ 9ì‹œ</b>ì— ìë™ ë°œì†¡ë©ë‹ˆë‹¤.</p>
    </div>
  </div>

</div>

<script>
const SB_URL = 'https://zrlpwmpbrvohautldcon.supabase.co';
const SB_KEY = 'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G';
const MASTER = 'positivecha@gmail.com';
const sc = supabase.createClient(SB_URL, SB_KEY);

let cu, curReport, curReportId, curRole = 'BA', kwList = [], fbVal = null;

async function init() {
  const { data: { session } } = await sc.auth.getSession();
  if (!session) return location.href = 'index.html';
  cu = session.user;

  document.getElementById('nav-user').textContent = cu.email.split('@')[0] + 'ë‹˜';
  document.getElementById('btn-logout').onclick = () => sc.auth.signOut().then(() => location.href = 'index.html');
  if (cu.email === MASTER) document.getElementById('btn-hq').style.display = '';

  await fetchKw();
  await loadDates();
}

/* â”€â”€ í‚¤ì›Œë“œ â”€â”€ */
async function fetchKw() {
  const { data } = await sc.from('user_settings').select('keywords').eq('id', cu.id).maybeSingle();
  kwList = data?.keywords || [];
  renderKw();
}

function renderKw() {
  const hasKw = kwList.length > 0;
  const tagHtml = kwList.map(k => `
    <span class="tag">#${k}
      <span class="tag-del" onclick="removeKw('${k}')">Ã—</span>
    </span>`).join('');

  // ì˜¨ë³´ë”© ìƒíƒœ ì œì–´ëŠ” loadDates() ì´í›„ì— ê²°ì •
  document.getElementById('tag-list-onboarding').innerHTML = tagHtml;
  document.getElementById('tag-list-bar').innerHTML = tagHtml;
  const hint = document.getElementById('kw-count-hint');
  if (hint) hint.textContent = hasKw ? `${kwList.length}/5ê°œ ë“±ë¡ë¨` : 'ì•„ì§ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤';
}

async function saveKw() {
  await sc.from('user_settings').upsert({ id: cu.id, keywords: kwList, email: cu.email });
}

async function addKw() {
  const el = document.getElementById('new-kw');
  const v = el.value.trim();
  if (v && kwList.length < 5 && !kwList.includes(v)) {
    kwList.push(v); el.value = '';
    await saveKw(); renderKw();
    // ì²˜ìŒ ë“±ë¡ ì‹œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
    document.getElementById('onboarding-done').style.display = 'block';
  }
}

async function addKwBar() {
  const el = document.getElementById('new-kw-bar');
  const v = el.value.trim();
  if (v && kwList.length < 5 && !kwList.includes(v)) {
    kwList.push(v); el.value = '';
    await saveKw(); renderKw();
  }
}

async function removeKw(k) {
  kwList = kwList.filter(x => x !== k);
  await saveKw(); renderKw();
}

/* â”€â”€ ë¦¬í¬íŠ¸ ë¡œë“œ â”€â”€ */
async function loadDates() {
  const { data } = await sc.from('reports').select('report_date').eq('user_id', cu.id).order('report_date', { ascending: false });
  const hasReport = data && data.length > 0;
  const hasKw = kwList.length > 0;

  if (hasReport) {
    // ê¸°ì¡´ ìœ ì €: í‚¤ì›Œë“œë°” + ë¦¬í¬íŠ¸
    document.getElementById('onboarding-new').style.display = 'none';
    document.getElementById('kw-bar').style.display = 'flex';
    document.getElementById('main-content-area').style.display = 'block';
    const dates = [...new Set(data.map(d => d.report_date))];
    document.getElementById('date-select').innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
    await fetchDayData();
  } else if (hasKw) {
    // í‚¤ì›Œë“œëŠ” ìˆì§€ë§Œ ë¦¬í¬íŠ¸ ì—†ìŒ (ì˜¤ëŠ˜ ê°€ì…)
    document.getElementById('onboarding-new').style.display = 'none';
    document.getElementById('kw-bar').style.display = 'flex';
    document.getElementById('empty-report').style.display = 'block';
    document.getElementById('onboarding-done').style.display = 'block';
  } else {
    // ì™„ì „ ì‹ ê·œ: ì˜¨ë³´ë”©
    document.getElementById('onboarding-new').style.display = 'block';
    document.getElementById('kw-bar').style.display = 'none';
  }
}

async function fetchDayData() {
  const d = document.getElementById('date-select').value;
  const { data } = await sc.from('reports').select('*').eq('report_date', d).eq('user_id', cu.id).limit(1);
  if (data && data.length > 0) { curReport = data[0].content; curReportId = data[0].id; renderReport(); }
}

/* â”€â”€ íƒ­ & ë Œë” â”€â”€ */
function changeRole(r) {
  curRole = r;
  ['BA','Stock','PM'].forEach(x => {
    document.getElementById('role-' + x).className = 'tab-btn' + (x === r ? ' active' : '');
  });
  const labels = { BA: 'ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸', Stock: 'ğŸ“ˆ ì¦ê¶ŒÂ·íˆ¬ì ì¸ì‚¬ì´íŠ¸', PM: 'ğŸ¯ ì „ëµ ê¸°íš ì¸ì‚¬ì´íŠ¸' };
  document.getElementById('eval-role-name').textContent = labels[r];
  fbVal = null;
  document.getElementById('btn-up').className = 'eval-btn';
  document.getElementById('btn-down').className = 'eval-btn';
  document.getElementById('voc-area').style.display = 'none';
  document.getElementById('success-msg').style.display = 'none';
  renderReport();
}

function renderReport() {
  if (!curReport) return;
  const k = curRole === 'BA' ? 'ba_brief' : curRole === 'Stock' ? 'securities_brief' : 'pm_brief';
  const txt = (curReport[k] || 'ë¶„ì„ ì¤‘...').replace(/\[PROPOSAL\].*|\[REASON\].*/gs, '');
  document.getElementById('briefing-content').innerHTML = marked.parse(txt);

  const arts = curReport.articles || [];
  document.getElementById('news-list').innerHTML = arts.length
    ? arts.map(a => `
        <div class="news-card">
          <span class="news-kw-tag">#${a.keyword || ''}</span>
          <a class="news-title" href="${a.url||'#'}" target="_blank">${a.title||''}</a>
          <p class="news-summary">ğŸ’¡ ${a.pm_summary||''}</p>
          <p class="news-impact">ğŸ“ˆ ${a.impact||''}</p>
        </div>`).join('')
    : '<div style="color:var(--gray-400); font-size:0.85rem;">ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

/* â”€â”€ í”¼ë“œë°± â”€â”€ */
function handleThumb(pos) {
  fbVal = pos;
  document.getElementById('btn-up').className = 'eval-btn' + (pos ? ' up' : '');
  document.getElementById('btn-down').className = 'eval-btn' + (!pos ? ' down' : '');
  document.getElementById('voc-area').style.display = 'block';
}

async function submitFeedback() {
  const txt = document.getElementById('voc-text').value;
  const roleMap = { BA: 'BA', Stock: 'STOCK', PM: 'PM' };
  await sc.from('report_feedback').insert([{
    user_id: cu.id, report_id: curReportId,
    is_positive: fbVal, feedback_text: txt || 'ë§Œì¡±',
    target_agent: roleMap[curRole]
  }]);
  document.getElementById('success-msg').style.display = 'block';
  document.getElementById('voc-area').style.display = 'none';
  document.getElementById('voc-text').value = '';
}

init();
</script>
</body>
</html>
