<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fitz Intelligence</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { -webkit-text-size-adjust:100%; }
body { background:#f8fafc; color:#1e293b; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; overflow-x:hidden; }

/* â”€â”€ ìƒë‹¨ë°” â”€â”€ */
.top-bar { position:sticky; top:0; z-index:200; background:#fff; border-bottom:1px solid #e2e8f0; }
.header-row { display:flex; justify-content:space-between; align-items:center; padding:14px 20px 10px; }
.brand { font-size:14px; font-weight:800; color:#1e293b; }
.collapse-btn { background:none; border:none; cursor:pointer; padding:8px 12px; border-radius:8px; color:#94a3b8; font-size:12px; font-weight:600; min-height:36px; }

.collapsed-bar { display:none; padding:6px 20px 10px; align-items:center; gap:0; }
.collapsed-bar.hidden { display:none; }
.c-chip { position:relative; display:inline-flex; align-items:center; gap:4px; flex-shrink:0; font-size:11px; font-weight:600; padding:6px 12px; border-radius:8px; cursor:pointer; white-space:nowrap; border:1px solid #e2e8f0; background:#f8fafc; color:#475569; user-select:none; min-height:34px; }
.c-chip .arrow { font-size:8px; color:#94a3b8; margin-left:2px; }
.c-chip.date-c  { background:#f1f5f9; border-color:#e2e8f0; color:#475569; }
.c-chip.agent-c { background:#eff6ff; border-color:#bfdbfe; color:#2563eb; }
.c-chip.agent-c[data-a="STOCK"] { background:#ecfeff; border-color:#a5f3fc; color:#0891b2; }
.c-chip.agent-c[data-a="PM"]    { background:#f5f3ff; border-color:#ddd6fe; color:#7c3aed; }
.c-chip.kw-c { background:#f1f5f9; border-color:#e2e8f0; color:#1e293b; }
.c-sep { color:#e2e8f0; font-size:14px; padding:0 5px; flex-shrink:0; }

.c-dropdown { display:none; position:absolute; top:calc(100% + 6px); left:0; background:#fff; border:1px solid #e2e8f0; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,.1); z-index:400; min-width:140px; overflow:hidden; }
.c-dropdown.open { display:block; }
.c-dd-item { padding:12px 16px; font-size:13px; font-weight:600; color:#334155; cursor:pointer; display:flex; align-items:center; gap:8px; min-height:44px; }
.c-dd-item:hover, .c-dd-item:active { background:#f8fafc; }
.c-dd-item.active { color:#2563eb; background:#eff6ff; }
.c-dd-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }

.date-row { padding:0 20px 10px; display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
.date-row::-webkit-scrollbar { display:none; }
.date-chip { flex-shrink:0; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600; border:1px solid #e2e8f0; color:#64748b; background:#fff; cursor:pointer; min-height:34px; display:flex; align-items:center; }
.date-chip.active { background:#1e293b; color:#fff; border-color:#1e293b; }

.agent-row { padding:0 20px 10px; display:flex; gap:8px; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
.agent-row::-webkit-scrollbar { display:none; }
.agent-chip { flex-shrink:0; display:flex; align-items:center; gap:6px; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; border:1.5px solid #e2e8f0; color:#64748b; background:#fff; cursor:pointer; transition:all .15s; min-height:38px; }
.agent-chip[data-a="BA"].active    { background:#2563eb; border-color:#2563eb; color:#fff; }
.agent-chip[data-a="STOCK"].active { background:#0891b2; border-color:#0891b2; color:#fff; }
.agent-chip[data-a="PM"].active    { background:#7c3aed; border-color:#7c3aed; color:#fff; }
.agent-dot { width:6px; height:6px; border-radius:50%; background:currentColor; }

.kw-nav { padding:0 20px 12px; display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; border-bottom:1px solid #f1f5f9; align-items:center; -webkit-overflow-scrolling:touch; }
.kw-nav::-webkit-scrollbar { display:none; }
.kw-chip { flex-shrink:0; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; border:1.5px solid #e2e8f0; color:#94a3b8; background:#fff; cursor:pointer; transition:all .2s; min-height:36px; display:flex; align-items:center; }
.kw-chip.active { background:#f1f5f9; color:#1e293b; border-color:#cbd5e1; }
.kw-edit-btn { flex-shrink:0; margin-left:4px; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600; border:1.5px dashed #94a3b8; color:#94a3b8; background:transparent; cursor:pointer; display:flex; align-items:center; gap:4px; min-height:36px; }

.collapsible {}
.top-bar.collapsed .collapsible { display:none; }
.top-bar.collapsed .collapsed-bar { display:flex; }
.top-bar.collapsed .collapsed-bar.hidden { display:none; }

/* â”€â”€ ë¡œë”© â”€â”€ */
.feed-state { padding:60px 20px; text-align:center; color:#94a3b8; font-size:14px; }
.skeleton { background:#f1f5f9; border-radius:14px; height:180px; margin-bottom:28px; animation:pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

/* â”€â”€ í”¼ë“œ â”€â”€ */
.feed { padding:16px; display:flex; flex-direction:column; gap:24px; padding-bottom:100px; }
.kw-section { display:flex; flex-direction:column; gap:12px; }
.kw-section-header { display:flex; align-items:center; justify-content:space-between; padding:0 4px; }
.kw-title { font-size:20px; font-weight:800; color:#0f172a; }
.kw-meta { font-size:11px; color:#94a3b8; }

.brief-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; }
.brief-card[data-a="BA"]    { border-top:3px solid #2563eb; }
.brief-card[data-a="STOCK"] { border-top:3px solid #0891b2; }
.brief-card[data-a="PM"]    { border-top:3px solid #7c3aed; }
.brief-header { padding:18px 18px 12px; }
.brief-agent-label { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:8px; }
.brief-agent-label[data-a="BA"]    { color:#2563eb; }
.brief-agent-label[data-a="STOCK"] { color:#0891b2; }
.brief-agent-label[data-a="PM"]    { color:#7c3aed; }
.brief-summary { font-size:16px; font-weight:700; color:#0f172a; line-height:1.55; }
.brief-points { padding:4px 18px 16px; display:flex; flex-direction:column; gap:10px; }
.brief-point { display:flex; gap:10px; align-items:flex-start; }
.brief-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; margin-top:8px; }
.brief-dot[data-a="BA"]    { background:#2563eb; }
.brief-dot[data-a="STOCK"] { background:#0891b2; }
.brief-dot[data-a="PM"]    { background:#7c3aed; }
.brief-text { font-size:14px; color:#475569; line-height:1.75; }

/* â”€â”€ ë´‰íˆ¬ ë²„íŠ¼ â”€â”€ */
.secret-btn {
  margin: 0 14px 16px;
  border: 1.5px solid #e2e8f0;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background: #fff;
  border-radius: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background .15s;
  max-width: 280px;
  min-height: 52px;
}
.secret-btn:active { background:#f8fafc; }
.envelope-wrap { position:relative; width:32px; height:24px; flex-shrink:0; }
.envelope-wrap svg { width:32px; height:24px; }
.env-lid { transform-origin:50% 0%; transition:transform .35s ease; }
.secret-btn.open .env-lid { transform:rotateX(160deg); }
.secret-text-wrap { display:flex; flex-direction:column; align-items:flex-start; gap:2px; }
.secret-title { font-size:13px; font-weight:700; color:#334155; }
.secret-sub { font-size:11px; color:#94a3b8; }
.secret-chevron { font-size:10px; color:#cbd5e1; transition:transform .3s; }
.secret-btn.open .secret-chevron { transform:rotate(180deg); }

.secret-panel { max-height:0; overflow:hidden; transition:max-height .4s ease; background:#f8fafc; border-top:1px solid #e2e8f0; }
.secret-panel.open { max-height:700px; }
.secret-inner { padding:18px; display:flex; flex-direction:column; gap:12px; }
.secret-agent-header { display:flex; align-items:center; gap:8px; padding-bottom:12px; border-bottom:1px solid #e2e8f0; }
.secret-agent-badge { font-size:10px; font-weight:700; letter-spacing:.8px; padding:4px 10px; border-radius:20px; }
.secret-agent-badge[data-a="BA"]    { background:#eff6ff; color:#2563eb; }
.secret-agent-badge[data-a="STOCK"] { background:#ecfeff; color:#0891b2; }
.secret-agent-badge[data-a="PM"]    { background:#f5f3ff; color:#7c3aed; }
.secret-agent-sub { font-size:11px; color:#94a3b8; font-weight:600; }
.s-point { display:flex; gap:10px; align-items:flex-start; }
.s-point-dot { width:4px; height:4px; border-radius:50%; flex-shrink:0; margin-top:9px; background:#94a3b8; }
.s-text { font-size:14px; color:#475569; line-height:1.75; }

/* â”€â”€ í—¤ë“œë¼ì¸ â”€â”€ */
.headlines-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; }
.hl-label { padding:14px 18px 8px; font-size:10px; font-weight:700; color:#94a3b8; letter-spacing:1.5px; text-transform:uppercase; }
.hl-item { padding:14px 18px; border-top:1px solid #f1f5f9; display:flex; gap:12px; align-items:flex-start; cursor:pointer; min-height:60px; }
.hl-item:active { background:#f8fafc; }
.hl-num { font-size:11px; font-weight:700; color:#cbd5e1; flex-shrink:0; padding-top:2px; }
.hl-title { font-size:14px; font-weight:600; color:#334155; line-height:1.5; margin-bottom:3px; }
.hl-summary { font-size:12px; color:#94a3b8; line-height:1.55; }

/* â”€â”€ FAB â”€â”€ */
.fab { position:fixed; bottom:32px; right:20px; background:#1e293b; color:#fff; border:none; border-radius:50px; padding:14px 20px; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; box-shadow:0 4px 24px rgba(0,0,0,.18); z-index:100; min-height:50px; }
.fab:active { transform:scale(.97); }

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:300; align-items:flex-end; }
.modal-overlay.open { display:flex; }
.modal { background:#fff; border-radius:24px 24px 0 0; padding:28px 20px 48px; width:100%; max-height:90vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.modal-handle { width:36px; height:4px; background:#e2e8f0; border-radius:2px; margin:0 auto 20px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
.modal-title { font-size:17px; font-weight:700; color:#0f172a; }
.modal-close { font-size:20px; color:#94a3b8; border:none; background:none; cursor:pointer; padding:8px; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }
.modal-notice { font-size:12px; color:#f59e0b; background:#fffbeb; border:1px solid #fde68a; border-radius:10px; padding:10px 14px; margin-bottom:18px; display:flex; align-items:center; gap:6px; line-height:1.5; }
.form-label { font-size:13px; font-weight:600; color:#64748b; margin-bottom:8px; display:block; }
.form-textarea { width:100%; border:1.5px solid #e2e8f0; border-radius:12px; padding:12px 16px; font-size:15px; color:#1e293b; margin-bottom:16px; outline:none; font-family:inherit; resize:none; height:110px; -webkit-appearance:none; }
.form-textarea:focus { border-color:#2563eb; }
.rating-row { display:flex; gap:8px; margin-bottom:18px; }
.rating-btn { flex:1; padding:12px 6px; border:1.5px solid #e2e8f0; border-radius:12px; font-size:22px; background:#fff; cursor:pointer; min-height:52px; }
.rating-btn.selected { border-color:#2563eb; background:#eff6ff; }
.rating-btn:active { transform:scale(.94); }
.submit-btn { width:100%; background:#2563eb; color:#fff; border:none; border-radius:14px; padding:16px; font-size:15px; font-weight:700; cursor:pointer; min-height:52px; transition:background .15s; }
.submit-btn:active { background:#1d4ed8; }
.submit-btn:disabled { background:#94a3b8; cursor:default; }

/* í”¼ë“œë°± ì ‘ìˆ˜ ì™„ë£Œ ìƒíƒœ */
.feedback-done { text-align:center; padding:32px 0 16px; }
.feedback-done-icon { font-size:48px; margin-bottom:12px; }
.feedback-done-title { font-size:17px; font-weight:700; color:#0f172a; margin-bottom:6px; }
.feedback-done-sub { font-size:13px; color:#94a3b8; margin-bottom:28px; line-height:1.6; }
.feedback-new-btn { width:100%; background:#f1f5f9; color:#475569; border:none; border-radius:14px; padding:16px; font-size:15px; font-weight:600; cursor:pointer; min-height:52px; }
.feedback-new-btn:active { background:#e2e8f0; }

/* â”€â”€ í‚¤ì›Œë“œ ê´€ë¦¬ â”€â”€ */
.kw-list { display:flex; flex-direction:column; gap:8px; margin-bottom:18px; }
.kw-manage-item { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; min-height:52px; }
.kw-manage-name { font-size:15px; font-weight:600; color:#1e293b; }
.kw-del-btn { background:none; border:none; color:#94a3b8; font-size:18px; cursor:pointer; padding:8px; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }
.kw-add-row { display:flex; gap:8px; }
.kw-add-input { flex:1; border:1.5px solid #e2e8f0; border-radius:12px; padding:12px 16px; font-size:15px; outline:none; font-family:inherit; min-height:50px; -webkit-appearance:none; }
.kw-add-input:focus { border-color:#2563eb; }
.kw-add-btn { background:#2563eb; color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:14px; font-weight:700; cursor:pointer; min-height:50px; white-space:nowrap; }
.kw-add-btn:active { background:#1d4ed8; }

@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="top-bar" id="topBar">
  <div class="header-row">
    <span class="brand">Fitz Intelligence</span>
    <button class="collapse-btn" onclick="toggleTopBar()" id="collapseBtn">ì ‘ê¸° â–²</button>
  </div>

  <div class="collapsed-bar hidden" id="collapsedBar">
    <div class="c-chip date-c" id="chip-date" onclick="toggleDD('dd-date',event)">
      <span id="chip-date-txt">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-date"></div>
    </div>
    <span class="c-sep">Â·</span>
    <div class="c-chip agent-c" id="chip-agent" data-a="BA" onclick="toggleDD('dd-agent',event)">
      <span id="chip-agent-txt">ë¹„ì¦ˆë‹ˆìŠ¤</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-agent">
        <div class="c-dd-item active" onclick="selectAgentDD('BA','ë¹„ì¦ˆë‹ˆìŠ¤',event)"><span class="c-dd-dot" style="background:#2563eb"></span>ë¹„ì¦ˆë‹ˆìŠ¤</div>
        <div class="c-dd-item" onclick="selectAgentDD('STOCK','ì£¼ì‹',event)"><span class="c-dd-dot" style="background:#0891b2"></span>ì£¼ì‹</div>
        <div class="c-dd-item" onclick="selectAgentDD('PM','ê¸°íš',event)"><span class="c-dd-dot" style="background:#7c3aed"></span>ê¸°íš</div>
      </div>
    </div>
    <span class="c-sep">Â·</span>
    <div class="c-chip kw-c" id="chip-kw" onclick="toggleDD('dd-kw',event)">
      <span id="chip-kw-txt">-</span><span class="arrow">â–¼</span>
      <div class="c-dropdown" id="dd-kw"></div>
    </div>
  </div>

  <div class="collapsible">
    <div class="date-row" id="date-row"></div>
    <div class="agent-row">
      <div class="agent-chip active" data-a="BA"    onclick="selectAgent('BA','ë¹„ì¦ˆë‹ˆìŠ¤',this)"><span class="agent-dot"></span>ë¹„ì¦ˆë‹ˆìŠ¤</div>
      <div class="agent-chip"        data-a="STOCK" onclick="selectAgent('STOCK','ì£¼ì‹',this)"><span class="agent-dot"></span>ì£¼ì‹</div>
      <div class="agent-chip"        data-a="PM"    onclick="selectAgent('PM','ê¸°íš',this)"><span class="agent-dot"></span>ê¸°íš</div>
    </div>
    <div class="kw-nav" id="kw-nav">
      <button class="kw-edit-btn" onclick="openModal('kw-modal')">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="feed-wrap">
  <div class="feed-state">
    <div class="skeleton"></div>
    <div class="skeleton" style="height:140px;opacity:.6"></div>
    <div class="skeleton" style="height:160px;opacity:.4"></div>
  </div>
</div>

<button class="fab" onclick="openModal('feedback-modal')">ğŸ’¬ í”¼ë“œë°±</button>

<!-- í‚¤ì›Œë“œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal-overlay" id="kw-modal" onclick="closeModal('kw-modal',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">í‚¤ì›Œë“œ ê´€ë¦¬</span>
      <button class="modal-close" onclick="closeModal('kw-modal')">âœ•</button>
    </div>
    <div class="modal-notice">â° ë³€ê²½ ì‚¬í•­ì€ ë‚´ì¼ ì˜¤ì „ 9ì‹œ ë¸Œë¦¬í•‘ë¶€í„° ì ìš©ë©ë‹ˆë‹¤.</div>
    <label class="form-label">ë“±ë¡ëœ í‚¤ì›Œë“œ (ìµœëŒ€ 5ê°œ)</label>
    <div class="kw-list" id="kw-manage-list"></div>
    <label class="form-label">í‚¤ì›Œë“œ ì¶”ê°€</label>
    <div class="kw-add-row">
      <input class="kw-add-input" id="kw-add-input" type="text" placeholder="ìƒˆ í‚¤ì›Œë“œ ì…ë ¥">
      <button class="kw-add-btn" onclick="addKeyword()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<!-- í”¼ë“œë°± ëª¨ë‹¬ -->
<div class="modal-overlay" id="feedback-modal" onclick="closeModal('feedback-modal',event)">
  <div class="modal" id="feedback-modal-inner">
    <div class="modal-handle"></div>
    <div id="feedback-form-view">
      <div class="modal-header">
        <span class="modal-title">ë§Œì¡±ë„ & ê±´ì˜ì‚¬í•­</span>
        <button class="modal-close" onclick="closeModal('feedback-modal')">âœ•</button>
      </div>
      <label class="form-label">ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ì€ ì–´ë– ì…¨ë‚˜ìš”?</label>
      <div class="rating-row" id="rating-row">
        <button class="rating-btn" onclick="selectRating(this,1)">ğŸ˜</button>
        <button class="rating-btn" onclick="selectRating(this,2)">ğŸ˜</button>
        <button class="rating-btn" onclick="selectRating(this,3)">ğŸ™‚</button>
        <button class="rating-btn" onclick="selectRating(this,4)">ğŸ˜Š</button>
        <button class="rating-btn" onclick="selectRating(this,5)">ğŸ¤©</button>
      </div>
      <label class="form-label">ê±´ì˜ì‚¬í•­ ë˜ëŠ” ê°œì„  ìš”ì²­</label>
      <textarea class="form-textarea" id="feedback-text" placeholder="ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”. ì—ì´ì „íŠ¸ ê°œì„ ì— ë°˜ì˜ë©ë‹ˆë‹¤."></textarea>
      <button class="submit-btn" id="feedback-submit-btn" onclick="submitFeedback()">ì œì¶œí•˜ê¸°</button>
    </div>
    <div id="feedback-done-view" style="display:none;">
      <div class="feedback-done">
        <div class="feedback-done-icon">âœ…</div>
        <div class="feedback-done-title">ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        <div class="feedback-done-sub">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•´ìš”.<br>ì—ì´ì „íŠ¸ ê°œì„ ì— ë°˜ì˜í•˜ê² ìŠµë‹ˆë‹¤.</div>
        <button class="feedback-new-btn" onclick="resetFeedback()">+ ìƒˆ ì˜ê²¬ ë‚¨ê¸°ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
const sc = supabase.createClient(
  'https://zrlpwmpbrvohautldcon.supabase.co',
  'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G'
);

window.CURRENT_USER = { email:'', userName:'', id:'' };
let curAgent     = 'BA';
let curDate      = '';
let allDates     = [];
let reportData   = null;
let kwNames      = [];
let userKeywords = [];
let selectedRating = 0;

const AGENT_KEY  = { BA:'ba_brief', STOCK:'securities_brief', PM:'pm_brief' };
const AGENT_NAME = { BA:'ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„', STOCK:'ì£¼ì‹ ë¸Œë¦¬í•‘', PM:'ê¸°íš ë¸Œë¦¬í•‘' };
const AGENT_ICON = { BA:'ğŸ“Š', STOCK:'ğŸ“ˆ', PM:'ğŸ¯' };

/* â”€â”€ JSON ë¸Œë¦¬í”„ íŒŒì‹± â”€â”€ */
function getSummary(brief) {
  if (!brief) return 'ë¶„ì„ ì¤‘...';
  if (typeof brief === 'object') return brief.summary || 'ë¶„ì„ ì¤‘...';
  return brief.split('\n').find(l => l.trim().length > 20)?.trim() || 'ë¶„ì„ ì¤‘...';
}
function getPoints(brief) {
  if (!brief) return [];
  if (typeof brief === 'object') return brief.points || [];
  return [];
}
function getDeepLines(brief) {
  if (!brief) return [];
  if (typeof brief === 'object') return brief.deep || [];
  return [];
}

/* â”€â”€ ë´‰íˆ¬ SVG â”€â”€ */
function makeSVG(a) {
  const c = { BA:'#2563eb', STOCK:'#0891b2', PM:'#7c3aed' }[a] || '#64748b';
  return `<svg viewBox="0 0 32 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="1" y="5" width="30" height="18" rx="2.5" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1.2"/>
    <path class="env-lid" d="M1 7 L16 16 L31 7 L31 5.5 Q31 4 29.5 4 L2.5 4 Q1 4 1 5.5 Z" fill="${c}" opacity="0.9"/>
    <path d="M1 7 L13 15" stroke="${c}" stroke-width="1" stroke-opacity="0.3"/>
    <path d="M31 7 L19 15" stroke="${c}" stroke-width="1" stroke-opacity="0.3"/>
    <circle cx="26" cy="5" r="3.5" fill="#ef4444" stroke="#fff" stroke-width="1.2"/>
    <line x1="10" y1="9" x2="22" y2="9" stroke="#fff" stroke-width="1" stroke-opacity="0.5" stroke-linecap="round"/>
  </svg>`;
}

/* â”€â”€ í”¼ë“œ ë Œë”ë§ â”€â”€ */
function renderFeed() {
  if (!reportData || kwNames.length === 0) {
    document.getElementById('feed-wrap').innerHTML =
      '<div class="feed-state">ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const nav = document.getElementById('kw-nav');
  nav.innerHTML = kwNames.map((kw, i) =>
    `<div class="kw-chip${i===0?' active':''}" id="nav-kw-${i}" onclick="scrollToKw('kw-${i}',this)"># ${kw}</div>`
  ).join('') + `<button class="kw-edit-btn" onclick="openModal('kw-modal')">âœï¸ ìˆ˜ì •í•˜ê¸°</button>`;

  document.getElementById('dd-kw').innerHTML = kwNames.map((kw, i) =>
    `<div class="c-dd-item${i===0?' active':''}" onclick="jumpKwDD(${i},event)"># ${kw}</div>`
  ).join('');
  document.getElementById('chip-kw-txt').textContent = `# ${kwNames[0]}`;

  const feed = document.createElement('div');
  feed.className = 'feed';

  kwNames.forEach((kw, i) => {
    const kwData    = reportData[kw];
    if (!kwData) return;
    const brief     = kwData[AGENT_KEY[curAgent]];
    const arts      = kwData.articles || [];
    const summary   = getSummary(brief);
    const points    = getPoints(brief);
    const deepLines = getDeepLines(brief);
    const userName  = window.CURRENT_USER.userName || 'ì‚¬ìš©ì';

    const section = document.createElement('div');
    section.className = 'kw-section';
    section.id = `kw-${i}`;
    section.innerHTML = `
      <div class="kw-section-header">
        <span class="kw-title"># ${kw}</span>
        <span class="kw-meta">ê¸°ì‚¬ ${arts.length}ê±´</span>
      </div>
      <div class="brief-card" id="card-${i}" data-a="${curAgent}">
        <div class="brief-header">
          <div class="brief-agent-label" data-a="${curAgent}">â— ${AGENT_NAME[curAgent]}</div>
          <div class="brief-summary" id="summary-${i}">${summary}</div>
        </div>
        <div class="brief-points" id="points-${i}">
          ${points.map(p => `
            <div class="brief-point">
              <div class="brief-dot" data-a="${curAgent}"></div>
              <div class="brief-text">${p}</div>
            </div>`).join('')}
        </div>
        <button class="secret-btn" id="sbtn-${i}" onclick="toggleSecret(${i})">
          <div class="envelope-wrap">${makeSVG(curAgent)}</div>
          <div class="secret-text-wrap">
            <span class="secret-title">ë§ì¶¤ ë¸Œë¦¬í•‘ ë„ì°©</span>
            <span class="secret-sub">${userName}ë‹˜ì„ ìœ„í•´ ì •ë¦¬í–ˆì–´ìš”.</span>
          </div>
          <span class="secret-chevron">â–¼</span>
        </button>
        <div class="secret-panel" id="s-${i}">
          <div class="secret-inner">
            <div class="secret-agent-header">
              <span class="secret-agent-badge" data-a="${curAgent}">${AGENT_ICON[curAgent]} ${AGENT_NAME[curAgent]}</span>
              <span class="secret-agent-sub">ì‹¬ì¸µ ë¶„ì„</span>
            </div>
            ${deepLines.length > 0
              ? deepLines.map(l => `
                  <div class="s-point">
                    <div class="s-point-dot"></div>
                    <div class="s-text">${l}</div>
                  </div>`).join('')
              : `<div class="s-text" style="color:#94a3b8">ì¶”ê°€ ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
            }
          </div>
        </div>
      </div>
      <div class="headlines-card">
        <div class="hl-label">ì˜¤ëŠ˜ì˜ í—¤ë“œë¼ì¸</div>
        ${arts.map((a, n) => `
          <div class="hl-item" onclick="window.open('${a.url}','_blank')">
            <span class="hl-num">0${n+1}</span>
            <div>
              <div class="hl-title">${a.title}</div>
              <div class="hl-summary">${a.pm_summary || a.description || ''}</div>
            </div>
          </div>`).join('')}
      </div>`;
    feed.appendChild(section);
  });

  document.getElementById('feed-wrap').innerHTML = '';
  document.getElementById('feed-wrap').appendChild(feed);
  bindScroll();
}

/* â”€â”€ ì—ì´ì „íŠ¸ ì „í™˜ â”€â”€ */
function switchAgent() {
  if (!reportData) return;
  kwNames.forEach((kw, i) => {
    const kwData    = reportData[kw];
    if (!kwData) return;
    const brief     = kwData[AGENT_KEY[curAgent]];
    const summary   = getSummary(brief);
    const points    = getPoints(brief);
    const deepLines = getDeepLines(brief);

    const card = document.getElementById(`card-${i}`);
    if (!card) return;
    card.setAttribute('data-a', curAgent);
    card.querySelector('.brief-agent-label').setAttribute('data-a', curAgent);
    card.querySelector('.brief-agent-label').textContent = `â— ${AGENT_NAME[curAgent]}`;
    card.querySelector(`#summary-${i}`).textContent = summary;
    card.querySelector(`#points-${i}`).innerHTML = points.map(p => `
      <div class="brief-point">
        <div class="brief-dot" data-a="${curAgent}"></div>
        <div class="brief-text">${p}</div>
      </div>`).join('');
    card.querySelector('.envelope-wrap').innerHTML = makeSVG(curAgent);
    const inner = card.querySelector('.secret-inner');
    inner.innerHTML = `
      <div class="secret-agent-header">
        <span class="secret-agent-badge" data-a="${curAgent}">${AGENT_ICON[curAgent]} ${AGENT_NAME[curAgent]}</span>
        <span class="secret-agent-sub">ì‹¬ì¸µ ë¶„ì„</span>
      </div>
      ${deepLines.length > 0
        ? deepLines.map(l => `<div class="s-point"><div class="s-point-dot"></div><div class="s-text">${l}</div></div>`).join('')
        : `<div class="s-text" style="color:#94a3b8">ì¶”ê°€ ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
      }`;
    card.style.animation = 'none'; card.offsetHeight; card.style.animation = 'fadeUp .2s ease';
  });
}

/* â”€â”€ ë‚ ì§œ â”€â”€ */
async function loadDates(userId) {
  const { data } = await sc.from('reports').select('report_date')
    .eq('user_id', userId).order('report_date', { ascending: false });
  if (!data || !data.length) return;
  allDates = [...new Set(data.map(d => d.report_date))];
  curDate  = allDates[0];
  renderDateUI();
}

function renderDateUI() {
  document.getElementById('date-row').innerHTML = allDates.map((d, i) => {
    const label = i === 0 ? `${fmtDate(d)} ì˜¤ëŠ˜` : fmtDate(d);
    return `<div class="date-chip${d===curDate?' active':''}" onclick="selectDate('${d}',this)">${label}</div>`;
  }).join('');
  document.getElementById('dd-date').innerHTML = allDates.map((d, i) => {
    const label = i === 0 ? `${fmtDate(d)} ì˜¤ëŠ˜` : fmtDate(d);
    return `<div class="c-dd-item${d===curDate?' active':''}" onclick="selectDateDD('${d}',event)">${label}</div>`;
  }).join('');
  const i0label = allDates.indexOf(curDate) === 0 ? `${fmtDate(curDate)} ì˜¤ëŠ˜` : fmtDate(curDate);
  document.getElementById('chip-date-txt').textContent = i0label;
}

function fmtDate(iso) {
  const [,m,d] = iso.split('-');
  return `${m}.${d}`;
}

async function fetchReport(userId, date) {
  document.getElementById('feed-wrap').innerHTML =
    '<div class="feed-state"><div class="skeleton"></div><div class="skeleton" style="height:140px;opacity:.6"></div></div>';
  const { data } = await sc.from('reports').select('content')
    .eq('user_id', userId).eq('report_date', date).limit(1);
  if (!data || !data.length || !data[0].content?.by_keyword) {
    document.getElementById('feed-wrap').innerHTML =
      `<div class="feed-state">ğŸ“­ ${date} ë¸Œë¦¬í•‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  reportData = data[0].content.by_keyword;
  kwNames    = Object.keys(reportData);
  renderFeed();
  renderKwManage();
}

async function selectDate(date, el) {
  curDate = date;
  document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#dd-date .c-dd-item').forEach(it =>
    it.classList.toggle('active', it.textContent.trim().startsWith(fmtDate(date)))
  );
  const idx = allDates.indexOf(date);
  document.getElementById('chip-date-txt').textContent =
    idx === 0 ? `${fmtDate(date)} ì˜¤ëŠ˜` : fmtDate(date);
  await fetchReport(window.CURRENT_USER.id, date);
}

async function selectDateDD(date, e) {
  e.stopPropagation(); closeAllDD();
  const chip = document.querySelector(`.date-chip[onclick*="${date}"]`);
  if (chip) await selectDate(date, chip);
  else { curDate = date; await fetchReport(window.CURRENT_USER.id, date); }
}

/* â”€â”€ ì—ì´ì „íŠ¸ â”€â”€ */
function selectAgent(key, label, el) {
  curAgent = key;
  document.querySelectorAll('.agent-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const chip = document.getElementById('chip-agent');
  chip.setAttribute('data-a', key);
  document.getElementById('chip-agent-txt').textContent = label;
  document.querySelectorAll('#dd-agent .c-dd-item').forEach((it, idx) =>
    it.classList.toggle('active', ['BA','STOCK','PM'][idx] === key)
  );
  switchAgent();
}

function selectAgentDD(key, label, e) {
  e.stopPropagation(); closeAllDD();
  selectAgent(key, label, document.querySelector(`.agent-chip[data-a="${key}"]`));
}

/* â”€â”€ í‚¤ì›Œë“œ DD â”€â”€ */
function jumpKwDD(i, e) {
  e.stopPropagation(); closeAllDD();
  document.getElementById('chip-kw-txt').textContent = `# ${kwNames[i]}`;
  document.querySelectorAll('#dd-kw .c-dd-item').forEach((it, j) => it.classList.toggle('active', j===i));
  const navChip = document.getElementById(`nav-kw-${i}`);
  if (navChip) scrollToKw(`kw-${i}`, navChip);
}

/* â”€â”€ í‚¤ì›Œë“œ ê´€ë¦¬ â”€â”€ */
function renderKwManage() {
  document.getElementById('kw-manage-list').innerHTML = userKeywords.map(kw => `
    <div class="kw-manage-item">
      <span class="kw-manage-name"># ${kw}</span>
      <button class="kw-del-btn" onclick="removeKeyword('${kw}')">âœ•</button>
    </div>`).join('');
}

async function addKeyword() {
  const v = document.getElementById('kw-add-input').value.trim();
  if (!v || userKeywords.length >= 5) return;
  userKeywords.push(v);
  await sc.from('user_settings').upsert({ id: window.CURRENT_USER.id, keywords: userKeywords });
  document.getElementById('kw-add-input').value = '';
  renderKwManage();
}

async function removeKeyword(kw) {
  userKeywords = userKeywords.filter(k => k !== kw);
  await sc.from('user_settings').upsert({ id: window.CURRENT_USER.id, keywords: userKeywords });
  renderKwManage();
}

/* â”€â”€ í”¼ë“œë°± â”€â”€ */
function selectRating(el, score) {
  selectedRating = score;
  document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

async function submitFeedback() {
  const text   = document.getElementById('feedback-text').value.trim();
  const btn    = document.getElementById('feedback-submit-btn');

  if (!selectedRating && !text) return;

  btn.disabled = true;
  btn.textContent = 'ì œì¶œ ì¤‘...';

  try {
    await sc.from('feedback').insert({
      user_id:       window.CURRENT_USER.id,
      user_email:    window.CURRENT_USER.email,
      rating:        selectedRating || null,
      feedback_text: text || null,
      report_date:   curDate,
      created_at:    new Date().toISOString()
    });
  } catch(e) {
    console.error('í”¼ë“œë°± ì €ì¥ ì˜¤ë¥˜:', e);
  }

  // ì ‘ìˆ˜ ì™„ë£Œ í™”ë©´ ì „í™˜
  document.getElementById('feedback-form-view').style.display = 'none';
  document.getElementById('feedback-done-view').style.display = 'block';
}

function resetFeedback() {
  selectedRating = 0;
  document.getElementById('feedback-text').value = '';
  document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
  const btn = document.getElementById('feedback-submit-btn');
  btn.disabled = false;
  btn.textContent = 'ì œì¶œí•˜ê¸°';
  document.getElementById('feedback-done-view').style.display = 'none';
  document.getElementById('feedback-form-view').style.display = 'block';
}

/* â”€â”€ DD / ì ‘ê¸° / ìŠ¤í¬ë¡¤ â”€â”€ */
function toggleDD(id, e) {
  e.stopPropagation();
  const el = document.getElementById(id);
  const isOpen = el.classList.contains('open');
  closeAllDD();
  if (!isOpen) el.classList.add('open');
}
function closeAllDD() { document.querySelectorAll('.c-dropdown').forEach(d => d.classList.remove('open')); }
document.addEventListener('click', closeAllDD);

function toggleTopBar() {
  const bar  = document.getElementById('topBar');
  const btn  = document.getElementById('collapseBtn');
  const cBar = document.getElementById('collapsedBar');
  bar.classList.toggle('collapsed');
  const c = bar.classList.contains('collapsed');
  btn.textContent = c ? 'í¼ì¹˜ê¸° â–¼' : 'ì ‘ê¸° â–²';
  cBar.classList.toggle('hidden', !c);
}

function scrollToKw(id, el) {
  document.querySelectorAll('.kw-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const target = document.getElementById(id);
  if (!target) return;
  const offset = document.getElementById('topBar').offsetHeight + 12;
  window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - offset, behavior:'smooth' });
}

function bindScroll() {
  window.onscroll = () => {
    const topH = document.getElementById('topBar').offsetHeight;
    let active = 0;
    kwNames.forEach((_, i) => {
      const s = document.getElementById(`kw-${i}`);
      if (s && s.getBoundingClientRect().top <= topH + 40) active = i;
    });
    document.querySelectorAll('.kw-chip').forEach((c, i) => c.classList.toggle('active', i===active));
    if (kwNames[active]) {
      document.getElementById('chip-kw-txt').textContent = `# ${kwNames[active]}`;
      document.querySelectorAll('#dd-kw .c-dd-item').forEach((it, j) => it.classList.toggle('active', j===active));
    }
  };
}

function toggleSecret(i) {
  document.getElementById(`s-${i}`).classList.toggle('open');
  document.getElementById(`sbtn-${i}`).classList.toggle('open');
}

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
function openModal(id) {
  document.getElementById(id).classList.add('open');
  // í”¼ë“œë°± ëª¨ë‹¬ ì—´ ë•Œ í•­ìƒ í¼ ìƒíƒœë¡œ
  if (id === 'feedback-modal') {
    document.getElementById('feedback-form-view').style.display = 'block';
    document.getElementById('feedback-done-view').style.display = 'none';
  }
}
function closeModal(id, e) {
  if (!e || e.target.classList.contains('modal-overlay'))
    document.getElementById(id).classList.remove('open');
}

/* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
async function init() {
  try {
    const { data: { session } } = await sc.auth.getSession();
    if (!session) { location.href = 'index.html'; return; }

    const email    = session.user.email;
    const userName = email.split('@')[0];
    const userId   = session.user.id;
    window.CURRENT_USER = { email, userName, id: userId };

    const { data: uSettings } = await sc.from('user_settings').select('keywords')
      .eq('id', userId).maybeSingle();
    userKeywords = uSettings?.keywords || [];

    await loadDates(userId);

    if (allDates.length > 0) {
      await fetchReport(userId, allDates[0]);
    } else {
      document.getElementById('feed-wrap').innerHTML =
        '<div class="feed-state">ì•„ì§ ë°œì†¡ëœ ë¸Œë¦¬í•‘ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë‚´ì¼ ì˜¤ì „ 9ì‹œì— ì²« ë¸Œë¦¬í•‘ì´ ë„ì°©í•©ë‹ˆë‹¤.</div>';
    }
  } catch (err) {
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
    window.CURRENT_USER = { email:'', userName:'ì‚¬ìš©ì', id:'' };
  }
}

init();
</script>
</body>
</html>
