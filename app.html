<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitz Intelligence | Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
:root{--primary:#007bff;--admin:#ff4d4f;--success:#28a745;--bg:#f8f9fa}
*{box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;margin:0;padding:20px;background:#fff;color:#333;line-height:1.6}
.container{max-width:950px;margin:0 auto}
.nav-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;background:#fff;padding:15px;border-radius:16px;border:1px solid #eee;flex-wrap:wrap;gap:10px}
.auth-btn{padding:9px 20px;border-radius:8px;border:1px solid var(--primary);background:#fff;color:var(--primary);cursor:pointer;font-weight:bold;font-size:.88rem;transition:.2s}
.auth-btn.active{background:var(--primary);color:#fff;border:none}
.keyword-manager{background:#fff;padding:25px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.05);margin-bottom:20px;border-top:5px solid #ccc}
.tag{background:#eef2f7;padding:8px 16px;border-radius:25px;font-size:.85em;color:var(--primary);font-weight:bold;display:flex;align-items:center}
.briefing-box{background:#343a40;color:#fff;padding:25px;border-radius:16px;margin-bottom:20px;position:relative}
.news-card{background:#fff;padding:25px;border-radius:20px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,.05);border-left:6px solid #eee;color:#333}

/* â”€â”€ í”¼ë“œë°± ì„¹ì…˜ â”€â”€ */
.feedback-section{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:20px;padding:28px;margin-top:10px;margin-bottom:30px}
.feedback-section h4{font-size:1rem;font-weight:700;color:#fff;margin-bottom:6px}
.feedback-section p{font-size:.82rem;color:#888;margin-bottom:20px}
.agent-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.agent-card{background:#111827;border:1px solid #2a2a4a;border-radius:12px;padding:16px;cursor:pointer;transition:.2s;text-align:center}
.agent-card:hover{border-color:#555}
.agent-card.selected-good{border-color:#28a745;background:rgba(40,167,69,.12)}
.agent-card.selected-bad{border-color:#ff4d4f;background:rgba(255,77,79,.12)}
.agent-name{font-size:.88rem;font-weight:700;color:#fff;margin-bottom:8px}
.agent-btns{display:flex;gap:6px;justify-content:center}
.agent-eval{background:transparent;border:1px solid #333;color:#888;padding:5px 10px;border-radius:20px;cursor:pointer;font-size:.78rem;transition:.2s}
.agent-eval:hover{border-color:#777;color:#fff}
.agent-eval.good{background:rgba(40,167,69,.2);border-color:#28a745;color:#28a745}
.agent-eval.bad{background:rgba(255,77,79,.2);border-color:#ff4d4f;color:#ff4d4f}
.feedback-text-wrap{margin-bottom:16px}
.feedback-text-wrap label{font-size:.82rem;color:#aaa;display:block;margin-bottom:8px}
.feedback-textarea{width:100%;background:rgba(0,0,0,.3);color:#fff;border:1px solid #333;padding:13px;border-radius:12px;font-size:.88rem;resize:none;font-family:inherit;transition:.2s}
.feedback-textarea:focus{outline:none;border-color:#555}
.feedback-submit{width:100%;padding:13px;border-radius:12px;background:#fff;color:#000;border:none;font-weight:700;font-size:.9rem;cursor:pointer;transition:.2s}
.feedback-submit:hover{background:#e5e5e5}
.feedback-submit:disabled{background:#333;color:#666;cursor:default}
.feedback-done{display:none;text-align:center;padding:16px;color:#28a745;font-weight:700;font-size:.95rem}
.feedback-done span{display:block;font-size:.82rem;color:#888;font-weight:400;margin-top:4px}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
    <h2 style="letter-spacing:-1px;cursor:pointer;margin:0" onclick="location.href='index.html'">Fitz Intelligence</h2>
    <div id="user-display"></div>
  </div>

  <section class="keyword-manager">
    <strong>ğŸ“Œ ë‚´ ê´€ì‹¬ í‚¤ì›Œë“œ (ìµœëŒ€ 5ê°œ)</strong>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <input type="text" id="new-kw" placeholder="í‚¤ì›Œë“œ ì…ë ¥" style="width:150px;padding:10px;border-radius:8px;border:1px solid #ddd">
      <button class="auth-btn active" onclick="addKw()">ì¶”ê°€</button>
    </div>
    <div id="tag-list" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:15px"></div>
  </section>

  <div id="main-content-area" style="display:none">
    <div class="nav-bar">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="role-BA" class="auth-btn active" onclick="changeRole('BA')">ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„</button>
        <button id="role-Stock" class="auth-btn" onclick="changeRole('Stock')">ì£¼ì‹</button>
        <button id="role-PM" class="auth-btn" onclick="changeRole('PM')">PM</button>
      </div>
      <select id="date-select" onchange="fetchDayData()" style="font-weight:bold;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer"></select>
    </div>

    <div class="briefing-box">
      <div style="margin-bottom:15px">
        <span id="eval-role-name" style="font-weight:bold">ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</span>
      </div>
      <div id="briefing-content" style="font-size:1.05rem;line-height:1.8"></div>
    </div>

    <div id="news-list"></div>

    <!-- â”€â”€ í”¼ë“œë°± ì„¹ì…˜ â”€â”€ -->
    <div class="feedback-section" id="feedback-section">
      <h4>ğŸ’¬ ì˜¤ëŠ˜ ë¦¬í¬íŠ¸ëŠ” ì–´ë– ì…¨ë‚˜ìš”?</h4>
      <p>ì—ì´ì „íŠ¸ë³„ë¡œ í‰ê°€í•´ì£¼ì‹œë©´ AIê°€ ì§ì ‘ í•™ìŠµí•´ì„œ ë‚´ì¼ ë” ë‚˜ì€ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.</p>

      <div class="agent-grid">
        <div class="agent-card" id="card-BA">
          <div class="agent-name">ğŸ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„</div>
          <div class="agent-btns">
            <button class="agent-eval" id="eval-BA-good" onclick="evalAgent('BA',true)">ğŸ‘ ì¢‹ì•„ìš”</button>
            <button class="agent-eval" id="eval-BA-bad"  onclick="evalAgent('BA',false)">ğŸ‘ ì•„ì‰¬ì›Œìš”</button>
          </div>
        </div>
        <div class="agent-card" id="card-STOCK">
          <div class="agent-name">ğŸ“ˆ ì£¼ì‹ ì¸ì‚¬ì´íŠ¸</div>
          <div class="agent-btns">
            <button class="agent-eval" id="eval-STOCK-good" onclick="evalAgent('STOCK',true)">ğŸ‘ ì¢‹ì•„ìš”</button>
            <button class="agent-eval" id="eval-STOCK-bad"  onclick="evalAgent('STOCK',false)">ğŸ‘ ì•„ì‰¬ì›Œìš”</button>
          </div>
        </div>
        <div class="agent-card" id="card-PM">
          <div class="agent-name">ğŸ—‚ PM ë¸Œë¦¬í•‘</div>
          <div class="agent-btns">
            <button class="agent-eval" id="eval-PM-good" onclick="evalAgent('PM',true)">ğŸ‘ ì¢‹ì•„ìš”</button>
            <button class="agent-eval" id="eval-PM-bad"  onclick="evalAgent('PM',false)">ğŸ‘ ì•„ì‰¬ì›Œìš”</button>
          </div>
        </div>
      </div>

      <div class="feedback-text-wrap">
        <label>ì—ì´ì „íŠ¸ì—ê²Œ ì§ì ‘ ì „ë‹¬í•  ë©”ì‹œì§€ (ì„ íƒ)</label>
        <textarea class="feedback-textarea" id="voc-text" rows="3" placeholder="ì˜ˆ: ì£¼ì‹ ë¶„ì„ì— ETF ê´€ë ¨ ë‚´ìš©ë„ í¬í•¨í•´ì¤¬ìœ¼ë©´ í•´ìš”"></textarea>
      </div>

      <button class="feedback-submit" id="feedback-submit-btn" onclick="submitAllFeedback()">í”¼ë“œë°± ì „ë‹¬í•˜ê¸°</button>
      <div class="feedback-done" id="feedback-done">
        âœ… í”¼ë“œë°±ì´ ì—ì´ì „íŠ¸ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤
        <span>ë‚´ì¼ ë¦¬í¬íŠ¸ì— ë°˜ì˜ë  ê±°ì˜ˆìš”. ê°ì‚¬í•©ë‹ˆë‹¤!</span>
      </div>
    </div>
  </div>

  <div id="onboarding-guide" style="display:none;background:#343a40;color:#fff;padding:50px;border-radius:30px;text-align:center">
    <h3>ğŸŒ± í™˜ì˜í•©ë‹ˆë‹¤!</h3>
    <p>ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ë“±ë¡í•˜ì‹œë©´ ë§¤ì¼ ì˜¤ì „ 09ì‹œ AI ë¦¬í¬íŠ¸ê°€ ë°œì†¡ë©ë‹ˆë‹¤.</p>
  </div>
</div>

<script>
const SUPABASE_URL='https://zrlpwmpbrvohautldcon.supabase.co', SUPABASE_KEY='sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G', MASTER_EMAIL='positivecha@gmail.com';
const sc = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser, currentReport, currentReportId, currentRole='BA', userKeywords=[];

// ì—ì´ì „íŠ¸ë³„ í‰ê°€ ìƒíƒœ ì €ì¥
const agentEvals = { BA: null, STOCK: null, PM: null };

async function init() {
  const {data:{session}} = await sc.auth.getSession();
  if(!session){ location.href='index.html'; return; }
  currentUser = session.user;
  document.getElementById('user-display').innerHTML = `
    <button class="auth-btn" style="font-size:.7em;margin-right:5px" onclick="location.href='index.html'">ë¸Œëœë“œ í™ˆ</button>
    ğŸ‘¤ <b>${currentUser.email.split('@')[0]}ë‹˜</b>
    <button class="auth-btn" style="font-size:.7em;margin-left:10px" onclick="sc.auth.signOut().then(()=>location.href='index.html')">Logout</button>`;
  if(currentUser.email===MASTER_EMAIL)
    document.getElementById('user-display').innerHTML += ` <button onclick="location.href='master.html'" style="color:red;font-weight:bold;border:1px solid red;border-radius:5px;padding:2px 5px;cursor:pointer;font-size:.7em">HQ</button>`;
  await fetchUserKeywords();
  await loadDates();
}

/* â”€â”€ ì—ì´ì „íŠ¸ ê°œë³„ í‰ê°€ â”€â”€ */
function evalAgent(role, isGood) {
  agentEvals[role] = isGood;
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  ['good','bad'].forEach(t => {
    const btn = document.getElementById(`eval-${role}-${t}`);
    btn.className = 'agent-eval' + (isGood && t==='good' ? ' good' : (!isGood && t==='bad' ? ' bad' : ''));
  });
  // ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
  const card = document.getElementById(`card-${role}`);
  card.className = 'agent-card ' + (isGood ? 'selected-good' : 'selected-bad');
  updateSubmitBtn();
}

function updateSubmitBtn() {
  const hasAny = Object.values(agentEvals).some(v => v !== null);
  const btn = document.getElementById('feedback-submit-btn');
  btn.disabled = !hasAny;
}

/* â”€â”€ ì „ì²´ í”¼ë“œë°± ì œì¶œ â”€â”€ */
async function submitAllFeedback() {
  const text = document.getElementById('voc-text').value.trim();
  const inserts = [];

  for(const [role, val] of Object.entries(agentEvals)) {
    if(val === null) continue;
    inserts.push({
      user_id: currentUser.id,
      report_id: currentReportId,
      is_positive: val,
      feedback_text: text || (val ? 'ë§Œì¡±' : 'ê°œì„  í•„ìš”'),
      target_agent: role
    });
  }

  // í…ìŠ¤íŠ¸ë§Œ ìˆê³  ì—ì´ì „íŠ¸ ì„ íƒ ì—†ì„ ë•Œë„ ì €ì¥ (general í”¼ë“œë°±)
  if(inserts.length === 0 && text) {
    inserts.push({
      user_id: currentUser.id,
      report_id: currentReportId,
      is_positive: true,
      feedback_text: text,
      target_agent: 'GENERAL'
    });
  }

  if(inserts.length === 0) return;

  try {
    await sc.from('report_feedback').insert(inserts);
    document.getElementById('feedback-submit-btn').style.display = 'none';
    document.getElementById('feedback-done').style.display = 'block';
    // í‰ê°€ ë²„íŠ¼ ë¹„í™œì„±í™”
    document.querySelectorAll('.agent-eval').forEach(b => b.disabled = true);
  } catch(e) {
    alert('ì œì¶œ ì‹¤íŒ¨: ' + e.message);
  }
}

/* â”€â”€ ì˜¤ëŠ˜ ì´ë¯¸ í”¼ë“œë°± í–ˆëŠ”ì§€ í™•ì¸ â”€â”€ */
async function checkExistingFeedback() {
  if(!currentReportId) return;
  const {data} = await sc.from('report_feedback').select('id').eq('report_id', currentReportId).eq('user_id', currentUser.id);
  if(data?.length > 0) {
    document.getElementById('feedback-submit-btn').style.display = 'none';
    document.getElementById('feedback-done').style.display = 'block';
    document.getElementById('feedback-done').innerHTML = 'âœ… ì´ë¯¸ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì…¨ì–´ìš” <span>ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤!</span>';
    document.querySelectorAll('.agent-eval').forEach(b => b.disabled = true);
  } else {
    // ì´ˆê¸°í™”
    document.getElementById('feedback-submit-btn').style.display = 'block';
    document.getElementById('feedback-submit-btn').disabled = true;
    document.getElementById('feedback-done').style.display = 'none';
    Object.keys(agentEvals).forEach(k => agentEvals[k] = null);
    document.querySelectorAll('.agent-card').forEach(c => c.className = 'agent-card');
    document.querySelectorAll('.agent-eval').forEach(b => { b.className='agent-eval'; b.disabled=false; });
    document.getElementById('voc-text').value = '';
  }
}

async function fetchUserKeywords(){
  const {data}=await sc.from('user_settings').select('keywords').eq('id',currentUser.id).maybeSingle();
  userKeywords=data?.keywords||[]; renderTags();
  document.getElementById('main-content-area').style.display=(userKeywords.length>0)?'block':'none';
  document.getElementById('onboarding-guide').style.display=(userKeywords.length===0)?'block':'none';
}

function renderTags(){ document.getElementById('tag-list').innerHTML=userKeywords.map(k=>`<span class="tag">#${k} <span onclick="removeKw('${k}')" style="cursor:pointer;margin-left:8px;color:red">Ã—</span></span>`).join(''); }
async function addKw(){ const v=document.getElementById('new-kw').value.trim(); if(v&&userKeywords.length<5){ userKeywords.push(v); await sc.from('user_settings').upsert({id:currentUser.id,keywords:userKeywords,email:currentUser.email}); document.getElementById('new-kw').value=''; fetchUserKeywords(); } }
async function removeKw(k){ userKeywords=userKeywords.filter(x=>x!==k); await sc.from('user_settings').upsert({id:currentUser.id,keywords:userKeywords}); fetchUserKeywords(); }

async function loadDates(){
  const {data}=await sc.from('reports').select('report_date').eq('user_id',currentUser.id).order('report_date',{ascending:false});
  if(data?.length>0){ document.getElementById('date-select').innerHTML=[...new Set(data.map(d=>d.report_date))].map(d=>`<option value="${d}">${d}</option>`).join(''); await fetchDayData(); }
}

async function fetchDayData(){
  const d=document.getElementById('date-select').value;
  const {data}=await sc.from('reports').select('*').eq('report_date',d).eq('user_id',currentUser.id).limit(1);
  if(data?.length>0){ currentReport=data[0].content; currentReportId=data[0].id; renderDisplay(); await checkExistingFeedback(); }
}

function renderDisplay(){
  if(!currentReport) return;
  const k=currentRole==='BA'?'ba_brief':currentRole==='Stock'?'securities_brief':'pm_brief';
  const roleNames={BA:'ğŸ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸',Stock:'ğŸ“ˆ ì£¼ì‹ ì¸ì‚¬ì´íŠ¸',PM:'ğŸ—‚ PM ë¸Œë¦¬í•‘'};
  document.getElementById('eval-role-name').textContent = roleNames[currentRole]||'';
  let txt=(currentReport[k]||'ë¶„ì„ ì¤‘...').replace(/\[PROPOSAL\].*|\[REASON\].*/gs,"").trim();
  document.getElementById('briefing-content').innerHTML=marked.parse(txt);
  document.getElementById('news-list').innerHTML=(currentReport.articles||[]).map(a=>`<div class="news-card"><small class="tag">#${a.keyword}</small><h3>${a.title}</h3><div>${marked.parse(a.pm_summary||a.impact||'')}</div><a href="${a.url}" target="_blank" style="font-size:.8em;color:var(--primary);text-decoration:none;font-weight:bold">ì›ë¬¸ â†—</a></div>`).join('');
}

function changeRole(r){ currentRole=r; ['BA','Stock','PM'].forEach(x=>document.getElementById(`role-${x}`).classList.toggle('active',x===r)); renderDisplay(); }

init();
</script>
</body>
</html>
