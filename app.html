<!DOCTYPE html>

<html lang="ko">

<head>

    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Fitz Intelligence | Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>

        :root { --primary: #007bff; --bg: #f8f9fa; --black: #111; --white: #fff; --admin: #ff4d4f; --success: #28a745; }

        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; background: #fff; color: #333; line-height: 1.6; }

        .container { max-width: 950px; margin: 0 auto; }

        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 16px; border: 1px solid #eee; }

        .auth-btn { padding: 9px 20px; border-radius: 8px; border: 1px solid var(--primary); background: #fff; color: var(--primary); cursor: pointer; font-weight: bold; }

        .auth-btn.active { background: var(--primary); color: #fff; border: none; }

        .keyword-manager { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #ccc; }

        .tag { background: #eef2f7; padding: 8px 16px; border-radius: 25px; font-size: 0.85em; color: var(--primary); font-weight: bold; display: flex; align-items: center; }

        .briefing-box { background: #343a40; color: #fff; padding: 25px; border-radius: 16px; margin-bottom: 30px; position: relative; }

        .voc-area { display: none; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }

        .voc-input { width: 100%; background: rgba(0,0,0,0.2); color: #fff; border: 1px solid #555; padding: 12px; border-radius: 12px; font-size: 0.9rem; resize: none; margin-bottom: 10px; box-sizing: border-box; }

        .news-card { background: #fff; padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border-left: 6px solid #eee; color: #333; }

        .eval-btn { background: none; border: 1px solid #666; color: #ccc; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8em; margin-left: 5px; }

        .eval-btn.active-up { background: var(--primary); color: #fff; border: none; }

        .eval-btn.active-down { background: var(--admin); color: #fff; border: none; }

    </style>

</head>

<body>

<div class="container">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">

        <h2 style="letter-spacing:-1px; cursor:pointer;" onclick="location.href='index.html'">Fitz Intelligence</h2>

        <div id="user-display"></div>

    </div>

    <section class="keyword-manager">

        <strong>ğŸ“Œ ë‚´ ê´€ì‹¬ í‚¤ì›Œë“œ (ìµœëŒ€ 5ê°œ)</strong>

        <div style="display:flex; gap:8px; margin-top:10px;">

            <input type="text" id="new-kw" placeholder="í‚¤ì›Œë“œ ì…ë ¥" style="width:150px; padding:10px; border-radius:8px; border:1px solid #ddd;">

            <button class="auth-btn active" onclick="addKw()">ì¶”ê°€</button>

        </div>

        <div id="tag-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px;"></div>

    </section>

    <div id="main-content-area" style="display:none;">

        <div class="nav-bar">

            <div style="display:flex; gap:10px;">

                <button id="role-BA" class="auth-btn active" onclick="changeRole('BA')">ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„</button>

                <button id="role-Stock" class="auth-btn" onclick="changeRole('Stock')">ì£¼ì‹</button>

                <button id="role-PM" class="auth-btn" onclick="changeRole('PM')">PM</button>

            </div>

            <select id="date-select" onchange="fetchDayData()" style="font-weight:bold; border:none; cursor:pointer;"></select>

        </div>

        <div class="briefing-box">

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">

                <span id="eval-role-name" style="font-weight:bold;">ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</span>

                <div style="display:flex; gap:5px;">

                    <button id="btn-up" class="eval-btn" onclick="handleThumb(true)">ğŸ‘ ë„ì›€ì´ ë¼ìš”</button>

                    <button id="btn-down" class="eval-btn" onclick="handleThumb(false)">ğŸ‘ ì•„ì‰¬ì›Œìš”</button>

                </div>

            </div>

            <div id="voc-area" class="voc-area">

                <textarea id="voc-text" class="voc-input" placeholder="ì—ì´ì „íŠ¸ì—ê²Œ ë°”ë¼ëŠ” ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>

                <button class="auth-btn active" style="width:100%; background:#fff; color:#000;" onclick="submitFeedback()">í”¼ë“œë°± ì œì¶œ</button>

            </div>

            <div id="success-msg" style="display:none; color:var(--success); font-weight:bold; text-align:center; margin-bottom:10px;">ì˜ê²¬ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

            <div id="briefing-content" style="font-size:1.1rem; line-height:1.7;"></div>

        </div>

        <div id="news-list"></div>

    </div>

    <div id="onboarding-guide" style="display:none; background:#343a40; color:#fff; padding:50px; border-radius:30px; text-align:center;">

        <h3>ğŸŒ± í™˜ì˜í•©ë‹ˆë‹¤!</h3><p>ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ë“±ë¡í•˜ì‹œë©´ ë§¤ì¼ ì˜¤ì „ 09ì‹œ AI ë¦¬í¬íŠ¸ê°€ ë°œì†¡ë©ë‹ˆë‹¤.</p>

    </div>

</div>

<script>

    const SUPABASE_URL = 'https://zrlpwmpbrvohautldcon.supabase.co', SUPABASE_KEY = 'sb_publishable_nIc584au5zdVZkC7uCe2kg_sEFEMD-G', MASTER_EMAIL = 'positivecha@gmail.com';

    const sc = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser, currentReport, currentReportId, currentRole='BA', userKeywords=[], feedbackValue=null;



    async function init() {

        const {data:{session}} = await sc.auth.getSession();

        if(!session) { location.href='index.html'; return; }

        currentUser = session.user;

        // [ë³µêµ¬] ë¸Œëœë“œ í™ˆ ë²„íŠ¼ ì¶”ê°€

        document.getElementById('user-display').innerHTML = `

            <button class="auth-btn" style="font-size:0.7em; margin-right:5px;" onclick="location.href='index.html'">ë¸Œëœë“œ í™ˆ</button>

            ğŸ‘¤ <b>${currentUser.email.split('@')[0]}ë‹˜</b> 

            <button class="auth-btn" style="font-size:0.7em; margin-left:10px;" onclick="sc.auth.signOut().then(()=>location.href='index.html')">Logout</button>`;

        if(currentUser.email === MASTER_EMAIL) document.getElementById('user-display').innerHTML += ` <button onclick="location.href='master.html'" style="color:red; font-weight:bold; border:1px solid red; border-radius:5px; padding:2px 5px; cursor:pointer; font-size:0.7em;">HQ</button>`;

        await fetchUserKeywords(); await loadDates();

    }

    function handleThumb(isPositive) {

        feedbackValue = isPositive;

        document.getElementById('btn-up').className = isPositive ? 'eval-btn active-up' : 'eval-btn';

        document.getElementById('btn-down').className = !isPositive ? 'eval-btn active-down' : 'eval-btn';

        document.getElementById('voc-area').style.display = 'block';

    }

    async function submitFeedback() {

        const text = document.getElementById('voc-text').value;

        await sc.from('report_feedback').insert([{ user_id: currentUser.id, report_id: currentReportId, is_positive: feedbackValue, feedback_text: text || "ë§Œì¡±", target_agent: currentRole }]);

        document.getElementById('voc-area').style.display = 'none';

        document.getElementById('success-msg').style.display = 'block';

    }

    async function fetchUserKeywords(){

        const {data}=await sc.from('user_settings').select('keywords').eq('id',currentUser.id).maybeSingle();

        userKeywords=data?.keywords||[]; renderTags();

        document.getElementById('main-content-area').style.display = (userKeywords.length > 0) ? 'block' : 'none';

        document.getElementById('onboarding-guide').style.display = (userKeywords.length === 0) ? 'block' : 'none';

    }

    function renderTags(){ document.getElementById('tag-list').innerHTML=userKeywords.map(k=>`<span class="tag">#${k} <span onclick="removeKw('${k}')" style="cursor:pointer; margin-left:8px; color:red;">Ã—</span></span>`).join(''); }

    async function addKw(){ const v=document.getElementById('new-kw').value.trim(); if(v && userKeywords.length<5){ userKeywords.push(v); await sc.from('user_settings').upsert({id:currentUser.id, keywords:userKeywords, email:currentUser.email}); document.getElementById('new-kw').value=''; fetchUserKeywords(); } }

    async function removeKw(k){ userKeywords=userKeywords.filter(x=>x!==k); await sc.from('user_settings').upsert({id:currentUser.id, keywords:userKeywords}); fetchUserKeywords(); }

    async function loadDates(){ const {data}=await sc.from('reports').select('report_date').eq('user_id',currentUser.id).order('report_date',{ascending:false}); if(data?.length>0){ document.getElementById('date-select').innerHTML=[...new Set(data.map(d=>d.report_date))].map(d=>`<option value="${d}">${d}</option>`).join(''); await fetchDayData(); }}

    async function fetchDayData(){ 

        const d=document.getElementById('date-select').value; 

        const {data}=await sc.from('reports').select('*').eq('report_date',d).eq('user_id',currentUser.id).limit(1); 

        if(data.length>0){ currentReport=data[0].content; currentReportId=data[0].id; renderDisplay(); }

    }

    function renderDisplay(){

        if(!currentReport) return;

        const k = currentRole==='BA'?'ba_brief':currentRole==='Stock'?'securities_brief':'pm_brief';

        let txt = (currentReport[k]||'ë¶„ì„ ì¤‘...').replace(/\[PROPOSAL\].*|\[REASON\].*/gs,"").trim();

        document.getElementById('briefing-content').innerHTML=marked.parse(txt);

        document.getElementById('news-list').innerHTML=(currentReport.articles||[]).map(a=>`<div class="news-card"><small class="tag">#${a.keyword}</small><h3>${a.title}</h3><div>${marked.parse(a.pm_summary||a.impact||'')}</div><a href="${a.url}" target="_blank" style="font-size:0.8em; color:var(--primary); text-decoration:none; font-weight:bold;">ì›ë¬¸ â†—</a></div>`).join('');

    }

    function changeRole(r){ currentRole=r; ['BA','Stock','PM'].forEach(x=>document.getElementById(`role-${x}`).classList.toggle('active',x===r)); renderDisplay(); }

    init();

</script>

</body>

</html>
